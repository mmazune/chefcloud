# M13.1 Menu + Catalog Foundation - COMPLETION REPORT

## Summary
Successfully implemented the Menu + Catalog Foundation module providing comprehensive CRUD operations for categories, menu items, modifier groups, options, and availability rules.

**Status:** ✅ COMPLETE  
**Date:** 2026-01-08  
**Tests:** 37 M13.1 E2E tests + 7/7 release gate tests PASS

---

## Deliverables

### A) Catalog Master Data
- **Categories** - Hierarchical (parent-child), org/branch scoped, sortOrder auto-assignment
- **Menu Items** - SKU uniqueness per org, pricing, trackInventory, isActive flags
- **Modifier Groups** - Selection type (SINGLE/MULTI), min/max constraints validation
- **Modifier Options** - Price deltas, auto-incrementing sortOrder

### B) Availability/Scheduling
- **MenuAvailabilityRule model** - Separate categoryId/itemId columns (fixed FK issue)
- **Day-of-week scheduling** - 0-6 (Sun-Sat) with HH:MM time windows
- **Branch-specific overrides** - branchId nullable for org-wide rules
- **Evaluation engine** - `isAvailable()` and `getAvailableItems()` with timezone awareness

### C) API Endpoints with RBAC
| Endpoint | Method | RBAC |
|----------|--------|------|
| `/menu/categories` | GET, POST | L2+ read, L3+ write |
| `/menu/categories/:id` | GET, PATCH | L2+ read, L3+ write |
| `/menu/items` | GET, POST | L2+ read, L3+ write |
| `/menu/items/:id` | GET, PATCH | L2+ read, L3+ write |
| `/menu/items/available` | GET | L2+ |
| `/menu/items/:id/modifier-groups` | POST | L4+ |
| `/menu/items/:id/modifier-groups/:groupId` | DELETE | L4+ |
| `/menu/modifier-groups` | GET, POST | L2+ read, L4+ write |
| `/menu/modifier-groups/:id` | GET, PATCH | L2+ read, L4+ write |
| `/menu/modifier-options` | POST | L4+ |
| `/menu/modifier-options/:id` | PATCH | L4+ |
| `/menu/availability-rules` | GET, POST | L2+ read, L4+ write |
| `/menu/availability-rules/:id` | PATCH | L4+ |
| `/menu/export/items.csv` | GET | L4+ |
| `/menu/export/modifiers.csv` | GET | L4+ |

### D) CSV Exports
- UTF-8 BOM (\uFEFF) for Excel compatibility
- LF line normalization
- SHA-256 hash in `X-Nimbus-Export-Hash` header
- Stable ordering by sortOrder, then id

### E) E2E Tests (37 tests)
- Categories CRUD (6 tests)
- Menu Items CRUD (6 tests)
- Modifier Groups CRUD (5 tests)
- Modifier Options CRUD (3 tests)
- Attach/Detach Modifier Groups (4 tests)
- Availability Rules (4 tests)
- Available Items Query (2 tests)
- CSV Exports (3 tests)
- Cross-Org Isolation (4 tests)

---

## Schema Changes

### New Enums
```prisma
enum ModifierSelectionType {
  SINGLE
  MULTI
}

enum AvailabilityTargetType {
  CATEGORY
  ITEM
}
```

### Enhanced Models
- **Category** - Added: orgId, description, parentCategoryId, sortOrder, isActive
- **MenuItem** - Added: orgId, sku, basePriceCents, isActive, trackInventory, sortOrder
- **ModifierGroup** - Added: description, selectionType, sortOrder, isActive
- **ModifierOption** - Added: sortOrder, isActive
- **MenuItemOnGroup** - Added: sortOrder

### New Model
```prisma
model MenuAvailabilityRule {
  id         String                 @id @default(cuid())
  orgId      String
  branchId   String?
  targetType AvailabilityTargetType
  categoryId String?
  itemId     String?
  daysOfWeek Int[]                  @default([0, 1, 2, 3, 4, 5, 6])
  startTime  String                 @default("00:00")
  endTime    String                 @default("23:59")
  isActive   Boolean                @default(true)
  ...
}
```

---

## Hypotheses Addressed

| # | Hypothesis | Resolution |
|---|------------|------------|
| H1 | Cross-org leakage | orgId filter on all queries + E2E isolation tests |
| H2 | Modifier min/max constraints | Service validates min <= max, returns 400 |
| H4 | SKU uniqueness per org | Service validates, returns 400 on duplicate |
| H5 | sortOrder auto-assignment | Auto-increment on create (max + 1) |
| H6 | Route ordering | Static routes (/items/available) before parameterized (/items/:id) |
| H7 | RBAC enforcement | Decorators @Roles('L2'), @Roles('L3'), @Roles('L4') |
| H9 | CSV export hash | SHA-256 hex in X-Nimbus-Export-Hash header |

---

## Files Modified

### Schema
- `packages/db/prisma/schema.prisma` - Enums, enhanced models, new MenuAvailabilityRule

### API Service
- `services/api/src/menu/menu.service.ts` - ~775 lines, comprehensive CRUD + exports
- `services/api/src/menu/menu.dto.ts` - ~330 lines, validation DTOs
- `services/api/src/menu/menu.controller.ts` - ~305 lines, endpoints with RBAC

### Tests
- `services/api/test/e2e/menu-m131-foundation.e2e-spec.ts` - ~565 lines, 37 tests

### Seed Files (orgId fixes)
- `services/api/prisma/seed.ts` - Added orgId to menu item creates
- `services/api/prisma/demo/tapas/menu.ts` - Added orgId to category/item creates
- `services/api/prisma/demo/cafesserie/menu.ts` - Added orgId to category/item creates

---

## Verification Gates

| Gate | Status |
|------|--------|
| pnpm build | ✅ PASS (0 errors) |
| pnpm lint | ✅ PASS (0 errors, 236 warnings pre-existing) |
| M13.1 E2E Tests | ✅ PASS (37/37) |
| Release Gate Tests | ✅ PASS (7/7) |

---

## Technical Notes

1. **FK constraint issue**: Initial schema had single `targetId` column with dual FK relations to Category and MenuItem. Fixed by using separate `categoryId` and `itemId` columns.

2. **TypeScript TS2742**: Prisma type inference issues resolved by using `Promise<unknown>` return types on all service and controller methods.

3. **Decimal serialization**: Prisma Decimal fields serialize as strings. E2E tests use `Number()` wrapper for comparisons.

4. **Route ordering**: NestJS registers routes in declaration order. Static routes (`/items/available`, `/items/export`) must be declared before parameterized routes (`/items/:id`).

---

## Next Steps (M13.2+)

- Web UI pages: /menu/categories, /menu/items, /menu/modifiers, /menu/availability
- Recipe linking (MenuItem → InventoryItem consumption)
- Menu versioning/history
- Bulk import/export
