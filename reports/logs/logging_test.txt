  console.warn
    A function to advance timers was called but the timers APIs are not replaced with fake timers. Call `jest.useFakeTimers()` in this test file or enable fake timers for all tests by setting 'fakeTimers': {'enableGlobally': true} in Jest configuration file.
    Stack Trace:
    
          17 | afterEach(async () => {
          18 |   // Run all pending timers to avoid leaks
        > 19 |   jest.runOnlyPendingTimers();
             |        ^
          20 |   // Clear all timers
          21 |   jest.clearAllTimers();
          22 |   // Restore all mocks
    
          Error: 
          at FakeTimers._checkFakeTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:158:13)
          at FakeTimers.runOnlyPendingTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:59:14)
          at Object.<anonymous> (../jest.setup.ts:19:8)

      17 | afterEach(async () => {
      18 |   // Run all pending timers to avoid leaks
    > 19 |   jest.runOnlyPendingTimers();
         |        ^
      20 |   // Clear all timers
      21 |   jest.clearAllTimers();
      22 |   // Restore all mocks

      at FakeTimers._checkFakeTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:152:28)
      at FakeTimers.runOnlyPendingTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:59:14)
      at Object.<anonymous> (../jest.setup.ts:19:8)

  console.warn
    A function to advance timers was called but the timers APIs are not replaced with fake timers. Call `jest.useFakeTimers()` in this test file or enable fake timers for all tests by setting 'fakeTimers': {'enableGlobally': true} in Jest configuration file.
    Stack Trace:
    
          17 | afterEach(async () => {
          18 |   // Run all pending timers to avoid leaks
        > 19 |   jest.runOnlyPendingTimers();
             |        ^
          20 |   // Clear all timers
          21 |   jest.clearAllTimers();
          22 |   // Restore all mocks
    
          Error: 
          at FakeTimers._checkFakeTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:158:13)
          at FakeTimers.runOnlyPendingTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:59:14)
          at Object.<anonymous> (../jest.setup.ts:19:8)

      17 | afterEach(async () => {
      18 |   // Run all pending timers to avoid leaks
    > 19 |   jest.runOnlyPendingTimers();
         |        ^
      20 |   // Clear all timers
      21 |   jest.clearAllTimers();
      22 |   // Restore all mocks

      at FakeTimers._checkFakeTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:152:28)
      at FakeTimers.runOnlyPendingTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:59:14)
      at Object.<anonymous> (../jest.setup.ts:19:8)

  console.warn
    A function to advance timers was called but the timers APIs are not replaced with fake timers. Call `jest.useFakeTimers()` in this test file or enable fake timers for all tests by setting 'fakeTimers': {'enableGlobally': true} in Jest configuration file.
    Stack Trace:
    
          17 | afterEach(async () => {
          18 |   // Run all pending timers to avoid leaks
        > 19 |   jest.runOnlyPendingTimers();
             |        ^
          20 |   // Clear all timers
          21 |   jest.clearAllTimers();
          22 |   // Restore all mocks
    
          Error: 
          at FakeTimers._checkFakeTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:158:13)
          at FakeTimers.runOnlyPendingTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:59:14)
          at Object.<anonymous> (../jest.setup.ts:19:8)

      17 | afterEach(async () => {
      18 |   // Run all pending timers to avoid leaks
    > 19 |   jest.runOnlyPendingTimers();
         |        ^
      20 |   // Clear all timers
      21 |   jest.clearAllTimers();
      22 |   // Restore all mocks

      at FakeTimers._checkFakeTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:152:28)
      at FakeTimers.runOnlyPendingTimers (../../../node_modules/.pnpm/@jest+fake-timers@29.7.0/node_modules/@jest/fake-timers/build/modernFakeTimers.js:59:14)
      at Object.<anonymous> (../jest.setup.ts:19:8)

FAIL src/logging/http-logger.middleware.spec.ts
  ● HTTP Logger middleware › attaches and echoes X-Request-Id

    Nest can't resolve dependencies of the SseRateLimiterGuard (?). Please make sure that the argument MetricsService at index [0] is available in the KpisModule context.

    Potential solutions:
    - Is KpisModule a valid NestJS module?
    - If MetricsService is a provider, is it part of the current KpisModule?
    - If MetricsService is exported from a separate @Module, is that module imported within KpisModule?
      @Module({
        imports: [ /* the Module containing MetricsService */ ]
      })

      16 |     process.env.LOG_SILENCE_HEALTH = '1';
      17 |     process.env.LOG_SILENCE_METRICS = '1';
    > 18 |     const mod = await Test.createTestingModule({
         |                 ^
      19 |       imports: [AppModule],
      20 |     }).compile();
      21 |     app = mod.createNestApplication();

      at TestingInjector.lookupComponentInParentModules (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:262:19)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:215:33)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-injector.js:19:45)
      at resolveParam (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:129:38)
          at async Promise.all (index 0)
      at TestingInjector.resolveConstructorParams (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:144:27)
      at TestingInjector.loadInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:70:13)
      at TestingInjector.loadProvider (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:98:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:56:13
          at async Promise.all (index 5)
      at TestingInstanceLoader.createInstancesOfProviders (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:55:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:40:13
          at async Promise.all (index 20)
      at TestingInstanceLoader.createInstances (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:39:9)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:22:13)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-instance-loader.js:9:9)
      at TestingModuleBuilder.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-module.builder.js:118:9)
      at TestingModuleBuilder.compile (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-module.builder.js:74:9)
      at Object.<anonymous> (logging/http-logger.middleware.spec.ts:18:17)

  ● HTTP Logger middleware › generates a request id when missing

    Nest can't resolve dependencies of the SseRateLimiterGuard (?). Please make sure that the argument MetricsService at index [0] is available in the KpisModule context.

    Potential solutions:
    - Is KpisModule a valid NestJS module?
    - If MetricsService is a provider, is it part of the current KpisModule?
    - If MetricsService is exported from a separate @Module, is that module imported within KpisModule?
      @Module({
        imports: [ /* the Module containing MetricsService */ ]
      })

      16 |     process.env.LOG_SILENCE_HEALTH = '1';
      17 |     process.env.LOG_SILENCE_METRICS = '1';
    > 18 |     const mod = await Test.createTestingModule({
         |                 ^
      19 |       imports: [AppModule],
      20 |     }).compile();
      21 |     app = mod.createNestApplication();

      at TestingInjector.lookupComponentInParentModules (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:262:19)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:215:33)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-injector.js:19:45)
      at resolveParam (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:129:38)
          at async Promise.all (index 0)
      at TestingInjector.resolveConstructorParams (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:144:27)
      at TestingInjector.loadInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:70:13)
      at TestingInjector.loadProvider (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:98:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:56:13
          at async Promise.all (index 5)
      at TestingInstanceLoader.createInstancesOfProviders (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:55:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:40:13
          at async Promise.all (index 20)
      at TestingInstanceLoader.createInstances (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:39:9)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:22:13)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-instance-loader.js:9:9)
      at TestingModuleBuilder.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-module.builder.js:118:9)
      at TestingModuleBuilder.compile (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-module.builder.js:74:9)
      at Object.<anonymous> (logging/http-logger.middleware.spec.ts:18:17)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'close')

      27 |     process.env.LOG_SILENCE_HEALTH = prev.LHEALTH;
      28 |     process.env.LOG_SILENCE_METRICS = prev.LMET;
    > 29 |     await app.close();
         |               ^
      30 |   });
      31 |
      32 |   it('attaches and echoes X-Request-Id', async () => {

      at Object.<anonymous> (logging/http-logger.middleware.spec.ts:29:15)

FAIL src/logging/webhook.logging.spec.ts
  ● Webhook logging (body omitted) › handles webhook POST without throwing (body redaction path exercised)

    Nest can't resolve dependencies of the SseRateLimiterGuard (?). Please make sure that the argument MetricsService at index [0] is available in the KpisModule context.

    Potential solutions:
    - Is KpisModule a valid NestJS module?
    - If MetricsService is a provider, is it part of the current KpisModule?
    - If MetricsService is exported from a separate @Module, is that module imported within KpisModule?
      @Module({
        imports: [ /* the Module containing MetricsService */ ]
      })

       8 |
       9 |   beforeAll(async () => {
    > 10 |     const mod = await Test.createTestingModule({
         |                 ^
      11 |       imports: [AppModule],
      12 |     }).compile();
      13 |     app = mod.createNestApplication();

      at TestingInjector.lookupComponentInParentModules (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:262:19)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:215:33)
      at TestingInjector.resolveComponentInstance (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-injector.js:19:45)
      at resolveParam (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:129:38)
          at async Promise.all (index 0)
      at TestingInjector.resolveConstructorParams (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:144:27)
      at TestingInjector.loadInstance (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:70:13)
      at TestingInjector.loadProvider (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/injector.js:98:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:56:13
          at async Promise.all (index 5)
      at TestingInstanceLoader.createInstancesOfProviders (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:55:9)
      at ../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:40:13
          at async Promise.all (index 20)
      at TestingInstanceLoader.createInstances (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:39:9)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+core@10.4.20_@nestjs+common@10.4.20_@nestjs+platform-express@10.4.20_reflect-metadata@0.2.2_rxjs@7.8.2/node_modules/@nestjs/core/injector/instance-loader.js:22:13)
      at TestingInstanceLoader.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-instance-loader.js:9:9)
      at TestingModuleBuilder.createInstancesOfDependencies (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-module.builder.js:118:9)
      at TestingModuleBuilder.compile (../../../node_modules/.pnpm/@nestjs+testing@10.4.20_@nestjs+common@10.4.20_@nestjs+core@10.4.20_@nestjs+platform-express@10.4.20/node_modules/@nestjs/testing/testing-module.builder.js:74:9)
      at Object.<anonymous> (logging/webhook.logging.spec.ts:10:17)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'close')

      16 |
      17 |   afterAll(async () => {
    > 18 |     await app.close();
         |               ^
      19 |   });
      20 |
      21 |   it('handles webhook POST without throwing (body redaction path exercised)', async () => {

      at Object.<anonymous> (logging/webhook.logging.spec.ts:18:15)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Test Suites: 2 failed, 2 total
Tests:       3 failed, 3 total
Snapshots:   0 total
Time:        3.063 s
Ran all test suites matching /logging/i.
