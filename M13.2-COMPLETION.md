# M13.2 POS Ordering Core - Completion Report

## Summary
M13.2 implements the POS Ordering Core with menu browse, cart validation, modifier enforcement, and pricing snapshots.

## Scope Delivered

### A) POS Menu Browse
- **Endpoint**: `GET /pos/menu`
- Branch-aware, availability-filtered menu items
- Groups items by category with modifier groups
- Reuses M13.1 `MenuService.getAvailableItems()` and `isAvailable()`
- Returns items with full modifier constraint metadata (min/max/required/selectionType)

### B) Cart Validation + Pricing Snapshot
- **Enhanced** `POST /pos/orders` with:
  - Modifier validation against group constraints
  - Availability guard (calls M13.1 `isAvailable`)
  - Branch scope validation (BRANCH_SCOPE_VIOLATION error)
  - Item active/inactive check (ITEM_INACTIVE error)
  - Pricing snapshot storage on OrderItem

### C) Pricing Snapshot Fields (OrderItem)
| Field | Type | Description |
|-------|------|-------------|
| `itemNameSnapshot` | String? | Item name at order time |
| `basePriceCentsSnapshot` | Int? | Base price in cents |
| `selectedModifiersSnapshot` | Json? | Array of {groupId, optionId, name, priceDelta} |
| `unitPriceCentsSnapshot` | Int? | Base + modifiers in cents |
| `lineTotalCentsSnapshot` | Int? | Unit price × quantity |

### D) CSV Export
- **Endpoint**: `GET /pos/export/orders.csv`
- UTF-8 BOM prefix for Excel compatibility
- SHA-256 hash in `X-Content-Hash` header
- L2+ RBAC permission required

### E) Web UI
- New hook: `usePosMenu()` - React Query based menu fetching
- Utility functions: `validateModifierSelections()`, `calculateItemPrice()`
- Client-side validation matching server-side rules

## Files Changed

### Backend (services/api)
| File | Change |
|------|--------|
| `src/pos/pos-menu.controller.ts` | NEW - Menu and export endpoints |
| `src/pos/pos-menu.service.ts` | NEW - Menu, validation, export logic |
| `src/pos/pos.module.ts` | MODIFIED - Added MenuModule import, new services |
| `src/pos/pos.service.ts` | MODIFIED - Enhanced createOrder with validation |
| `src/pos/pos.dto.ts` | MODIFIED - Added groupId to OrderItemModifierDto |
| `test/pos-m132-ordering.e2e-spec.ts` | NEW - 13 E2E tests |

### Schema (packages/db)
| File | Change |
|------|--------|
| `prisma/schema.prisma` | MODIFIED - Added 5 snapshot fields to OrderItem |

### Frontend (apps/web)
| File | Change |
|------|--------|
| `src/hooks/usePosMenu.ts` | NEW - React Query hook with validation utils |
| `__tests__/m132-pos-menu.test.ts` | NEW - 12 unit tests |

## Error Codes

| Code | When |
|------|------|
| `ITEM_NOT_FOUND` | Item ID doesn't exist |
| `ITEM_INACTIVE` | Item's `isActive` is false |
| `ITEM_UNAVAILABLE` | Availability rules prevent ordering |
| `BRANCH_SCOPE_VIOLATION` | Item belongs to different branch |
| `INVALID_MODIFIER_SELECTION` | Missing required, min/max violated |
| `INVALID_MODIFIER_OPTION` | Option ID not in group |

## Test Results

### E2E Tests (13/13 PASS)
```
GET /pos/menu
  ✓ should return available items with modifiers (H7)
  ✓ should filter by availability rules (H3)
POST /pos/orders
  ✓ should create order with valid modifiers and store pricing snapshot (H4)
  ✓ should reject order with missing required modifier (H2)
  ✓ should reject order with multiple selections on SINGLE modifier (H2)
  ✓ should reject order with invalid option ID (H2)
  ✓ should reject order for inactive item
  ✓ should reject order for item from different branch (H9)
GET /pos/export/orders.csv
  ✓ should export orders with SHA-256 hash (H6)
  ✓ should produce consistent hash for same data (H6)
Modifier min/max validation (H2)
  ✓ should reject order with fewer than min selections
  ✓ should reject order with more than max selections
  ✓ should accept order with valid number of selections
```

### UI Unit Tests (12/12 PASS)
```
validateModifierSelections
  ✓ should pass with valid single selection
  ✓ should fail when required modifier is missing
  ✓ should fail when SINGLE group has multiple selections
  ✓ should fail when exceeding max selections
  ✓ should fail with invalid option ID
  ✓ should fail with unknown group
  ✓ should pass with valid multi selections
calculateItemPrice
  ✓ should calculate base price with no modifiers
  ✓ should add modifier price delta
  ✓ should calculate with multiple modifiers
  ✓ should multiply by quantity
  ✓ should handle unknown group gracefully
```

### Release Gate Tests (7/7 PASS)
No regressions in existing tests.

### M13.1 Tests (37/37 PASS)
No regressions in menu foundation tests.

## Hypotheses Validated

| ID | Hypothesis | Status |
|----|-----------|--------|
| H1 | Cross-org item access rejected | ✅ Via M13.1 org scoping |
| H2 | Modifier min/max validation | ✅ Tested with 4 scenarios |
| H3 | Availability server/UI mismatch | ✅ Server filters, UI gets consistent data |
| H4 | Pricing snapshot drift | ✅ Immutable snapshots stored |
| H5 | Idempotency key collisions | ✅ Existing IdempotencyInterceptor |
| H6 | Export hash consistency | ✅ SHA-256 with UTF-8 BOM |
| H7 | Route ordering shadowing | ✅ /pos/menu declared before /pos/:id |
| H8 | Test hang from unclosed handles | ✅ All tests use forceExit |
| H9 | Branch scoping violation | ✅ Explicit BRANCH_SCOPE_VIOLATION error |

## Next Steps (M13.3+)
- Full POS ordering UI page with cart and modifier drawer
- Split bill functionality with M13.2 pricing snapshots
- Receipt printing with snapshot data
- Offline mode support with IndexedDB caching

## Commit
Ready for commit and push to origin/main.
