// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====

enum RoleLevel {
  L1 // Waiter
  L2 // Cashier/Supervisor
  L3 // Chef/Stock
  L4 // Manager/Accountant
  L5 // Owner/Admin
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  CLEANING
}

enum ReservationStatus {
  HELD
  CONFIRMED
  SEATED
  CANCELLED
}

enum ItemType {
  FOOD
  DRINK
}

enum OrderStatus {
  NEW
  SENT
  IN_KITCHEN
  READY
  SERVED
  VOIDED
  CLOSED
}

enum SubscriptionStatus {
  ACTIVE
  GRACE
  PAST_DUE
  CANCELLED
}

enum SubscriptionEventType {
  RENEWAL_DUE
  RENEWED
  PAST_DUE
  CANCELLED
}

enum ServiceType {
  DINE_IN
  TAKEAWAY
}

enum StationTag {
  GRILL
  FRYER
  BAR
  OTHER
}

enum PaymentMethod {
  CASH
  CARD
  MOMO
}

enum BadgeState {
  ACTIVE
  REVOKED
  LOST
  RETURNED
}

enum ProcurementStrategy {
  SAFETY_STOCK
  FORECAST
}

enum ProcurementJobStatus {
  DRAFT
  APPROVED
  PLACED
}

enum PromotionEffectType {
  PERCENT_OFF
  FIXED_OFF
  HAPPY_HOUR
  BUNDLE
}

enum CashMovementType {
  PAID_IN
  PAID_OUT
  SAFE_DROP
  PICKUP
}

// ===== Organization & Multi-tenancy =====

model Org {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branches         Branch[]
  users            User[]
  settings         OrgSettings?
  devices          Device[]
  floorPlans       FloorPlan[]
  taxCategories    TaxCategory[]
  modifierGroups   ModifierGroup[]
  anomalyEvents    AnomalyEvent[]
  alertChannels    AlertChannel[]
  scheduledAlerts  ScheduledAlert[]
  reservations     Reservation[]
  supportSessions  SupportSession[]
  spoutDevices     SpoutDevice[]
  spoutEvents      SpoutEvent[]
  ownerDigests     OwnerDigest[]
  apiKeys          ApiKey[]
  subscription     OrgSubscription?
  branchBudgets    BranchBudget[]
  forecastProfiles ForecastProfile[]
  forecastPoints   ForecastPoint[]
  franchiseRanks   FranchiseRank[]
  badgeAssets      BadgeAsset[]

  @@map("orgs")
}

model OrgSettings {
  id                        String   @id @default(cuid())
  orgId                     String   @unique
  vatPercent                Decimal  @default(18.00) @db.Decimal(5, 2)
  currency                  String   @default("UGX")
  discountApprovalThreshold Decimal  @default(5000) @db.Decimal(10, 2)
  reservationHoldMinutes    Int      @default(30)
  receiptFooter             String?
  metadata                  Json?
  anomalyThresholds         Json?    // { lateVoidMin: 5, heavyDiscountUGX: 5000, noDrinksWarnRate: 0.25 }
  platformAccess            Json?    // { "ROLE_NAME": { "desktop": bool, "web": bool, "mobile": bool }, ... }
  franchiseWeights          Json?    // { revenue: 0.4, margin: 0.3, waste: -0.2, sla: 0.1 }
  showCostToChef            Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("org_settings")
}

model Branch {
  id        String   @id @default(cuid())
  orgId     String
  name      String
  address   String?
  timezone  String   @default("Africa/Kampala")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org            Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tables         Table[]
  orders         Order[]
  auditEvents    AuditEvent[]
  menuItems      MenuItem[]
  categories     Category[]
  users          User[]
  devices        Device[]
  shifts         Shift[]
  tillSessions   TillSession[]
  stockBatches   StockBatch[]
  purchaseOrders PurchaseOrder[]
  goodsReceipts  GoodsReceipt[]
  wastageRecords Wastage[]
  anomalyEvents  AnomalyEvent[]
  reservations   Reservation[]
  spoutDevices   SpoutDevice[]
  spoutEvents    SpoutEvent[]
  adjustments    Adjustment[]
  branchBudgets  BranchBudget[]
  forecastProfiles ForecastProfile[]
  forecastPoints ForecastPoint[]
  franchiseRanks FranchiseRank[]

  @@index([orgId, id])
  @@map("branches")
}

// ===== Users & Authentication =====

model User {
  id           String    @id @default(cuid())
  orgId        String
  branchId     String?
  email        String    @unique
  passwordHash String?
  pinHash      String?
  firstName    String
  lastName     String
  roleLevel    RoleLevel @default(L1)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  org                 Org                  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch              Branch?              @relation(fields: [branchId], references: [id], onDelete: SetNull)
  roles               Role[]
  orders              Order[]
  auditEvents         AuditEvent[]
  employeeProfile     EmployeeProfile?
  sessions            Session[]
  openedShifts        Shift[]              @relation("ShiftOpenedBy")
  closedShifts        Shift[]              @relation("ShiftClosedBy")
  openedTillSessions  TillSession[]        @relation("TillSessionOpenedBy")
  closedTillSessions  TillSession[]        @relation("TillSessionClosedBy")
  cashMovements       CashMovement[]       @relation("CashMovementCreatedBy")
  discounts           Discount[]           @relation("DiscountCreatedBy")
  approvedDiscounts   Discount[]           @relation("DiscountApprovedBy")
  createdRefunds      Refund[]             @relation("CreatedRefunds")
  approvedRefunds     Refund[]             @relation("ApprovedRefunds")
  webAuthnCredentials WebAuthnCredential[]
  anomalyEvents       AnomalyEvent[]
  supportSessions     SupportSession[]
  assignedBadges      BadgeAsset[]
  procurementJobs     ProcurementJob[]
  approvedPromotions  Promotion[]          @relation("PromotionApprovals")

  @@index([orgId, id])
  @@map("users")
}

model EmployeeProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  employeeCode String   @unique
  badgeId      String?  @unique
  badgeCode    String?  // Optional reference to BadgeAsset.code (soft link for legacy)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("employee_profiles")
}

model BadgeAsset {
  id             String     @id @default(cuid())
  orgId          String
  code           String     @unique
  state          BadgeState @default(ACTIVE)
  assignedUserId String?
  lastUsedAt     DateTime?
  custody        Json?      // Audit trail: [{ assignedTo, assignedAt, returnedAt }]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  org          Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedUser User? @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([assignedUserId])
  @@map("badge_assets")
}

model Device {
  id        String   @id @default(cuid())
  orgId     String
  branchId  String
  name      String
  deviceKey String   @unique
  isActive  Boolean  @default(true)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch   Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@index([orgId, id])
  @@map("devices")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  deviceId  String?
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  device Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model WebAuthnCredential {
  id           String   @id @default(cuid())
  userId       String
  credentialId String   @unique // base64url encoded
  publicKey    Bytes
  counter      Int      @default(0)
  deviceType   String // "singleDevice" or "multiDevice"
  backedUp     Boolean  @default(false)
  transports   String[] // ["usb", "nfc", "ble", "internal"]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("webauthn_credentials")
}

model FloorPlan {
  id        String   @id @default(cuid())
  orgId     String
  name      String
  data      Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org          Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tables       Table[]
  reservations Reservation[]

  @@index([orgId, id])
  @@map("floor_plans")
}

model Role {
  id          String   @id @default(cuid())
  name        String
  description String?
  level       Int      @default(1) // L1-L5
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  permissions Permission[]

  @@map("roles")
}

model Permission {
  id         String   @id @default(cuid())
  resource   String // e.g., "orders", "inventory", "reports"
  action     String // e.g., "read", "create", "update", "delete"
  conditions Json? // ABAC conditions
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  roles Role[]

  @@unique([resource, action])
  @@map("permissions")
}

// ===== Floor & Tables =====

model Table {
  id          String      @id @default(cuid())
  orgId       String
  branchId    String
  floorPlanId String?
  label       String
  capacity    Int         @default(4)
  status      TableStatus @default(AVAILABLE)
  isActive    Boolean     @default(true)
  metadata    Json? // floor plan position, shape, etc.
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  branch       Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  floorPlan    FloorPlan?    @relation(fields: [floorPlanId], references: [id], onDelete: SetNull)
  orders       Order[]
  reservations Reservation[]

  @@unique([branchId, label])
  @@index([orgId, id])
  @@map("tables")
}

model Reservation {
  id               String            @id @default(cuid())
  orgId            String
  branchId         String
  floorPlanId      String?
  tableId          String?
  name             String
  phone            String?
  partySize        Int
  startAt          DateTime
  endAt            DateTime
  status           ReservationStatus @default(HELD)
  deposit          Decimal           @default(0) @db.Decimal(10, 2)
  depositStatus    String            @default("NONE") // "NONE" | "HELD" | "CAPTURED" | "REFUNDED"
  paymentIntentId  String?
  reminderSentAt   DateTime?
  autoCancelAt     DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  org            Org                     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch         Branch                  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  floorPlan      FloorPlan?              @relation(fields: [floorPlanId], references: [id], onDelete: SetNull)
  table          Table?                  @relation(fields: [tableId], references: [id], onDelete: SetNull)
  paymentIntent  PaymentIntent?          @relation(fields: [paymentIntentId], references: [id], onDelete: SetNull)
  reminders      ReservationReminder[]

  @@index([orgId])
  @@index([branchId])
  @@index([tableId, startAt, endAt])
  @@index([autoCancelAt])
  @@map("reservations")
}

model ReservationReminder {
  id            String    @id @default(cuid())
  reservationId String
  channel       String // "SMS" | "EMAIL"
  target        String // phone number or email
  scheduledAt   DateTime
  sentAt        DateTime?
  createdAt     DateTime  @default(now())

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([scheduledAt, sentAt])
  @@map("reservation_reminders")
}

// ===== Menu =====

model Category {
  id        String   @id @default(cuid())
  branchId  String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  menuItems MenuItem[]

  @@index([branchId])
  @@map("categories")
}

model MenuItem {
  id            String     @id @default(cuid())
  branchId      String
  categoryId    String?
  name          String
  description   String?
  itemType      ItemType
  station       StationTag @default(OTHER)
  price         Decimal    @db.Decimal(10, 2)
  taxCategoryId String?
  isAvailable   Boolean    @default(true)
  metadata      Json? // variations, etc.
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  branch            Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  category          Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  taxCategory       TaxCategory?       @relation(fields: [taxCategoryId], references: [id], onDelete: SetNull)
  orderItems        OrderItem[]
  modifierGroups    MenuItemOnGroup[]
  recipeIngredients RecipeIngredient[]

  @@index([branchId])
  @@map("menu_items")
}

model TaxCategory {
  id            String   @id @default(cuid())
  orgId         String
  name          String
  rate          Decimal  @db.Decimal(5, 2)
  efirsTaxCode  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  org       Org        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  menuItems MenuItem[]

  @@map("tax_categories")
}

model ModifierGroup {
  id        String   @id @default(cuid())
  orgId     String
  name      String
  min       Int      @default(0)
  max       Int      @default(0)
  required  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org       Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  options   ModifierOption[]
  menuItems MenuItemOnGroup[]

  @@map("modifier_groups")
}

model ModifierOption {
  id         String   @id @default(cuid())
  groupId    String
  name       String
  priceDelta Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  group             ModifierGroup      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  recipeIngredients RecipeIngredient[]

  @@map("modifier_options")
}

model MenuItemOnGroup {
  id      String @id @default(cuid())
  itemId  String
  groupId String

  item  MenuItem      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  group ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([itemId, groupId])
  @@map("menu_item_on_group")
}

// ===== Orders =====

model Order {
  id           String      @id @default(cuid())
  branchId     String
  tableId      String?
  userId       String
  orderNumber  String
  status       OrderStatus @default(NEW)
  serviceType  ServiceType @default(DINE_IN)
  subtotal     Decimal     @default(0) @db.Decimal(12, 2)
  tax          Decimal     @default(0) @db.Decimal(12, 2)
  discount     Decimal     @default(0) @db.Decimal(10, 2)
  total        Decimal     @default(0) @db.Decimal(12, 2)
  anomalyFlags String[]
  metadata     Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  branch     Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  table      Table?      @relation(fields: [tableId], references: [id], onDelete: SetNull)
  user       User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  orderItems OrderItem[]
  payments   Payment[]
  refunds    Refund[]
  kdsTickets KdsTicket[]
  discounts  Discount[]

  @@unique([branchId, orderNumber])
  @@index([branchId])
  @@map("orders")
}

model KdsTicket {
  id        String     @id @default(cuid())
  orderId   String
  station   StationTag
  status    String     @default("QUEUED")
  createdAt DateTime   @default(now())
  readyAt   DateTime?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("kds_tickets")
}

model Shift {
  id           String    @id @default(cuid())
  orgId        String
  branchId     String
  openedById   String
  closedById   String?
  openedAt     DateTime  @default(now())
  closedAt     DateTime?
  openingFloat Decimal   @default(0) @db.Decimal(10, 2)
  declaredCash Decimal?  @db.Decimal(10, 2)
  overShort    Decimal?  @db.Decimal(10, 2)
  notes        String?
  metadata     Json?

  branch       Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  openedBy     User          @relation("ShiftOpenedBy", fields: [openedById], references: [id], onDelete: Restrict)
  closedBy     User?         @relation("ShiftClosedBy", fields: [closedById], references: [id], onDelete: Restrict)
  tillSessions TillSession[]

  @@index([branchId, openedAt])
  @@map("shifts")
}

model TillSession {
  id            String    @id @default(cuid())
  orgId         String
  branchId      String
  drawerId      String // Identifier for cash drawer (e.g., "DRAWER-1", "REGISTER-A")
  openedById    String
  closedById    String?
  openingFloat  Decimal   @db.Decimal(10, 2)
  closingCount  Decimal?  @db.Decimal(10, 2) // Total cash counted at close
  variance      Decimal?  @db.Decimal(10, 2) // Difference between expected and counted
  openedAt      DateTime  @default(now())
  closedAt      DateTime?
  shiftId       String? // Optional link to shift
  metadata      Json?

  branch        Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  openedBy      User           @relation("TillSessionOpenedBy", fields: [openedById], references: [id], onDelete: Restrict)
  closedBy      User?          @relation("TillSessionClosedBy", fields: [closedById], references: [id], onDelete: Restrict)
  shift         Shift?         @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  cashMovements CashMovement[]

  @@index([orgId, branchId])
  @@index([branchId, drawerId, closedAt])
  @@map("till_sessions")
}

model CashMovement {
  id            String           @id @default(cuid())
  orgId         String
  branchId      String
  tillSessionId String
  type          CashMovementType
  amount        Decimal          @db.Decimal(10, 2)
  reason        String?
  createdById   String
  createdAt     DateTime         @default(now())
  metadata      Json?

  tillSession TillSession @relation(fields: [tillSessionId], references: [id], onDelete: Cascade)
  createdBy   User        @relation("CashMovementCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  @@index([tillSessionId])
  @@index([orgId, branchId, createdAt])
  @@map("cash_movements")
}

model Discount {
  id           String   @id @default(cuid())
  orgId        String
  orderId      String
  createdById  String
  type         String // percentage, fixed
  value        Decimal  @db.Decimal(10, 2)
  approvedById String?
  createdAt    DateTime @default(now())
  metadata     Json?

  order      Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdBy  User  @relation("DiscountCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy User? @relation("DiscountApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@map("discounts")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  menuItemId  String
  quantity    Int      @default(1)
  price       Decimal  @db.Decimal(10, 2)
  subtotal    Decimal  @db.Decimal(10, 2)
  notes       String?
  metadata    Json? // modifiers, special instructions
  costUnit    Decimal? @db.Decimal(10, 2) // UGX cost per unit
  costTotal   Decimal? @db.Decimal(10, 2)
  marginTotal Decimal? @db.Decimal(10, 2)
  marginPct   Decimal? @db.Decimal(5, 2) // percentage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

// ===== Payments =====

model Payment {
  id            String        @id @default(cuid())
  orderId       String
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        String        @default("pending") // pending, completed, failed, refunded
  transactionId String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  order   Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  refunds Refund[]

  @@map("payments")
}

model Refund {
  id          String   @id @default(cuid())
  orderId     String
  paymentId   String
  provider    String // "MOMO" | "CASH" | "CARD" | "MANUAL"
  amount      Decimal  @db.Decimal(10, 2)
  reason      String
  status      String   @default("PENDING") // "PENDING" | "COMPLETED" | "FAILED"
  createdById String
  approvedById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order      Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payment    Payment @relation(fields: [paymentId], references: [id])
  createdBy  User  @relation("CreatedRefunds", fields: [createdById], references: [id])
  approvedBy User? @relation("ApprovedRefunds", fields: [approvedById], references: [id])

  @@index([orderId])
  @@index([status, createdAt])
  @@map("refunds")
}


model PaymentIntent {
  id           String        @id @default(cuid())
  orgId        String
  branchId     String
  orderId      String
  provider     String // "MTN" | "AIRTEL" | "MOMO"
  amount       Decimal       @db.Decimal(12, 2)
  currency     String        @default("UGX")
  status       String        @default("PENDING") // "PENDING" | "REQUIRES_ACTION" | "SUCCEEDED" | "FAILED" | "CANCELLED"
  providerRef  String?
  metadata     Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  reservations Reservation[]

  @@index([orgId, orderId])
  @@index([status, createdAt])
  @@map("payment_intents")
}

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String // "MTN" | "AIRTEL"
  eventType String
  raw       Json
  verified  Boolean  @default(false)
  receivedAt DateTime @default(now())

  @@index([provider, receivedAt])
  @@map("webhook_events")
}

model FiscalInvoice {
  id          String    @id @default(cuid())
  orgId       String
  branchId    String
  orderId     String    @unique
  status      String    @default("PENDING") // PENDING | SENT | FAILED
  efirsTin    String?
  deviceCode  String?
  response    Json?
  attempts    Int       @default(0)
  lastTriedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([orgId, status])
  @@index([status, lastTriedAt])
  @@map("fiscal_invoices")
}

// ===== Audit & Compliance =====

model AuditEvent {
  id         String   @id @default(cuid())
  branchId   String
  userId     String?
  action     String // e.g., "order.created", "order.voided", "payment.completed"
  resource   String // table name
  resourceId String? // record ID
  before     Json?
  after      Json?
  metadata   Json?
  createdAt  DateTime @default(now())

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([branchId, createdAt])
  @@index([userId])
  @@index([action])
  @@map("audit_events")
}

model AnomalyEvent {
  id         String   @id @default(cuid())
  orgId      String
  branchId   String?
  userId     String?
  orderId    String?
  type       String // NO_DRINKS | LATE_VOID | HEAVY_DISCOUNT | VOID_SPIKE
  severity   String   @default("INFO") // INFO | WARN | CRITICAL
  details    Json?
  occurredAt DateTime @default(now())

  org    Org     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch? @relation(fields: [branchId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([orgId, occurredAt])
  @@index([branchId, type])
  @@index([userId])
  @@map("anomaly_events")
}

model AlertChannel {
  id      String  @id @default(cuid())
  orgId   String
  type    String // EMAIL | SLACK
  target  String // email address or webhook URL
  enabled Boolean @default(true)

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("alert_channels")
}

model ScheduledAlert {
  id        String    @id @default(cuid())
  orgId     String
  name      String
  cron      String
  rule      String // VOID_SPIKE | LATE_VOID | HEAVY_DISCOUNT | NO_DRINKS_RATE
  enabled   Boolean   @default(true)
  lastRunAt DateTime?

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("scheduled_alerts")
}

model SupportSession {
  id          String   @id @default(cuid())
  orgId       String
  createdById String
  token       String   @unique
  expiresAt   DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  org       Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([token])
  @@index([expiresAt])
  @@map("support_sessions")
}

model ApiKey {
  id         String    @id @default(cuid())
  orgId      String
  name       String
  keyHash    String    @unique
  scopes     String[]
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("api_keys")
}

// ===== Hardware Integrations =====

model SpoutDevice {
  id        String   @id @default(cuid())
  orgId     String
  branchId  String
  name      String
  vendor    String // POURSENSE | FLOWX | SANDBOX
  secret    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org           Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch        Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  calibrations  SpoutCalibration[]
  events        SpoutEvent[]

  @@index([orgId])
  @@index([branchId])
  @@map("spout_devices")
}

model SpoutCalibration {
  id              String   @id @default(cuid())
  deviceId        String
  inventoryItemId String
  mlPerPulse      Decimal  @db.Decimal(8, 4)
  createdAt       DateTime @default(now())

  device        SpoutDevice   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@unique([deviceId, inventoryItemId])
  @@index([deviceId])
  @@map("spout_calibrations")
}

model SpoutEvent {
  id         String   @id @default(cuid())
  orgId      String
  branchId   String
  deviceId   String
  itemId     String?
  pulses     Int
  ml         Decimal  @db.Decimal(10, 3)
  raw        Json?
  occurredAt DateTime
  ingestedAt DateTime @default(now())

  org    Org         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  device SpoutDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([occurredAt])
  @@index([deviceId])
  @@index([orgId, branchId])
  @@map("spout_events")
}

model OwnerDigest {
  id                 String    @id @default(cuid())
  orgId              String
  name               String
  cron               String // e.g., "0 8 * * *" for daily at 8am
  lastRunAt          DateTime?
  recipients         String[] // Array of email addresses
  sendOnShiftClose   Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  org Org @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("owner_digests")
}

// ===== Inventory & Purchasing =====

model Supplier {
  id           String   @id @default(cuid())
  orgId        String
  name         String
  contact      String?
  email        String?
  phone        String?
  leadTimeDays Int      @default(2)
  minOrderQty  Decimal? @db.Decimal(10, 3)
  packSize     Decimal? @db.Decimal(10, 3)
  isActive     Boolean  @default(true)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  purchaseOrders PurchaseOrder[]

  @@index([orgId])
  @@map("suppliers")
}

model InventoryItem {
  id           String   @id @default(cuid())
  orgId        String
  sku          String?
  name         String
  unit         String // kg, ltr, pcs, etc.
  category     String?
  reorderLevel Decimal  @default(0) @db.Decimal(10, 3)
  reorderQty   Decimal  @default(0) @db.Decimal(10, 3)
  isActive     Boolean  @default(true)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stockBatches      StockBatch[]
  recipeIngredients RecipeIngredient[]
  wastageRecords    Wastage[]
  adjustments       Adjustment[]
  poItems           PurchaseOrderItem[]
  receiptLines      GoodsReceiptLine[]
  spoutCalibrations SpoutCalibration[]
  forecastProfiles  ForecastProfile[]
  forecastPoints    ForecastPoint[]

  @@unique([orgId, sku])
  @@index([orgId])
  @@map("inventory_items")
}

model StockBatch {
  id             String    @id @default(cuid())
  orgId          String
  branchId       String
  itemId         String
  batchNumber    String?
  receivedQty    Decimal   @db.Decimal(10, 3)
  remainingQty   Decimal   @db.Decimal(10, 3)
  unitCost       Decimal   @db.Decimal(10, 2)
  expiryDate     DateTime?
  receivedAt     DateTime  @default(now())
  goodsReceiptId String?
  metadata       Json?

  branch       Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  item         InventoryItem @relation(fields: [itemId], references: [id], onDelete: Restrict)
  goodsReceipt GoodsReceipt? @relation(fields: [goodsReceiptId], references: [id], onDelete: SetNull)

  @@index([orgId, itemId])
  @@index([branchId, receivedAt])
  @@map("stock_batches")
}

model PurchaseOrder {
  id          String    @id @default(cuid())
  orgId       String
  branchId    String
  supplierId  String
  poNumber    String
  status      String    @default("draft") // draft, placed, received, cancelled
  totalAmount Decimal   @default(0) @db.Decimal(12, 2)
  placedAt    DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  branch        Branch              @relation(fields: [branchId], references: [id], onDelete: Cascade)
  supplier      Supplier            @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  items         PurchaseOrderItem[]
  goodsReceipts GoodsReceipt[]

  @@unique([orgId, poNumber])
  @@index([orgId, branchId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id        String   @id @default(cuid())
  poId      String
  itemId    String
  qty       Decimal  @db.Decimal(10, 3)
  unitCost  Decimal  @db.Decimal(10, 2)
  subtotal  Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())

  po   PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@map("purchase_order_items")
}

model ProcurementJob {
  id           String                 @id @default(cuid())
  orgId        String
  createdById  String
  period       String?                @db.VarChar(7) // YYYY-MM
  strategy     ProcurementStrategy
  draftPoCount Int                    @default(0)
  status       ProcurementJobStatus   @default(DRAFT)
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Restrict)

  @@index([orgId])
  @@index([orgId, status])
  @@map("procurement_jobs")
}

model Promotion {
  id               String    @id @default(cuid())
  orgId            String
  name             String
  code             String?   // Optional coupon code
  active           Boolean   @default(false)
  startsAt         DateTime?
  endsAt           DateTime?
  scope            Json?     // {branches: [...], categories: [...], items: [...]}
  daypart          Json?     // {days: [1..7], start: "HH:mm", end: "HH:mm"}
  priority         Int       @default(100)
  exclusive        Boolean   @default(false)
  requiresApproval Boolean   @default(true)
  approvedById     String?
  approvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  approvedBy User?             @relation("PromotionApprovals", fields: [approvedById], references: [id], onDelete: SetNull)
  effects    PromotionEffect[]

  @@index([orgId])
  @@index([orgId, active])
  @@index([code])
  @@map("promotions")
}

model PromotionEffect {
  id          String              @id @default(cuid())
  promotionId String
  type        PromotionEffectType
  value       Decimal?            @db.Decimal(10, 2) // Percentage or fixed amount
  meta        Json?               // Additional config (bundle items, etc.)
  createdAt   DateTime            @default(now())

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@map("promotion_effects")
}

model GoodsReceipt {
  id         String   @id @default(cuid())
  orgId      String
  branchId   String
  poId       String?
  grNumber   String
  receivedAt DateTime @default(now())
  receivedBy String?
  metadata   Json?
  createdAt  DateTime @default(now())

  branch       Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  po           PurchaseOrder?     @relation(fields: [poId], references: [id], onDelete: SetNull)
  lines        GoodsReceiptLine[]
  stockBatches StockBatch[]

  @@unique([orgId, grNumber])
  @@index([orgId, branchId])
  @@map("goods_receipts")
}

model GoodsReceiptLine {
  id          String    @id @default(cuid())
  grId        String
  itemId      String
  qtyReceived Decimal   @db.Decimal(10, 3)
  unitCost    Decimal   @db.Decimal(10, 2)
  batchNumber String?
  expiryDate  DateTime?
  createdAt   DateTime  @default(now())

  gr   GoodsReceipt  @relation(fields: [grId], references: [id], onDelete: Cascade)
  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@map("goods_receipt_lines")
}

model RecipeIngredient {
  id               String   @id @default(cuid())
  menuItemId       String
  itemId           String
  qtyPerUnit       Decimal  @db.Decimal(10, 3) // qty of ingredient per menu item
  wastePct         Decimal  @default(0) @db.Decimal(5, 2)
  modifierOptionId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  menuItem       MenuItem        @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  item           InventoryItem   @relation(fields: [itemId], references: [id], onDelete: Restrict)
  modifierOption ModifierOption? @relation(fields: [modifierOptionId], references: [id], onDelete: SetNull)

  @@index([menuItemId])
  @@index([itemId])
  @@map("recipe_ingredients")
}

model Wastage {
  id         String   @id @default(cuid())
  orgId      String
  branchId   String
  itemId     String
  qty        Decimal  @db.Decimal(10, 3)
  reason     String?
  reportedBy String?
  metadata   Json?
  createdAt  DateTime @default(now())

  branch Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([orgId, branchId])
  @@index([itemId])
  @@map("wastage")
}

model Adjustment {
  id         String   @id @default(cuid())
  orgId      String
  branchId   String
  itemId     String
  deltaQty   Decimal  @db.Decimal(10, 3) // Positive = add, Negative = remove
  reason     String
  adjustedBy String
  metadata   Json?
  createdAt  DateTime @default(now())

  branch Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([orgId, branchId])
  @@index([itemId])
  @@map("adjustments")
}

// ===== E24: Subscriptions & Dev Portal =====

model DevAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  isSuper   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("dev_admins")
}

model SubscriptionPlan {
  id       String  @id @default(cuid())
  code     String  @unique
  name     String
  priceUGX Decimal @db.Decimal(10, 2)
  features Json
  isActive Boolean @default(true)

  subscriptions OrgSubscription[]

  @@map("subscription_plans")
}

model OrgSubscription {
  id            String             @id @default(cuid())
  orgId         String
  planId        String
  status        SubscriptionStatus @default(ACTIVE)
  nextRenewalAt DateTime
  graceUntil    DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  org  Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@unique([orgId])
  @@index([status, nextRenewalAt])
  @@map("org_subscriptions")
}

model SubscriptionEvent {
  id    String                  @id @default(cuid())
  orgId String
  type  SubscriptionEventType
  meta  Json
  at    DateTime                @default(now())

  @@index([orgId, at])
  @@map("subscription_events")
}

// ===== E22: Franchise Models =====

enum ForecastMethod {
  MA7
  MA14
  MA30
}

model BranchBudget {
  id            String   @id @default(cuid())
  orgId         String
  branchId      String
  period        String   @db.VarChar(7) // YYYY-MM
  revenueTarget Decimal  @db.Decimal(12, 2)
  cogsTarget    Decimal  @db.Decimal(12, 2)
  expenseTarget Decimal  @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  org    Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([orgId, branchId, period])
  @@index([orgId, period])
  @@map("branch_budgets")
}

model ForecastProfile {
  id                String         @id @default(cuid())
  orgId             String
  branchId          String?
  itemId            String?
  method            ForecastMethod @default(MA14)
  weekendUpliftPct  Decimal        @db.Decimal(5, 2) @default(0)
  monthEndUpliftPct Decimal        @db.Decimal(5, 2) @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  org    Org            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch?        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  item   InventoryItem? @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([orgId, branchId])
  @@index([orgId, itemId])
  @@map("forecast_profiles")
}

model ForecastPoint {
  id           String   @id @default(cuid())
  orgId        String
  branchId     String
  itemId       String
  date         DateTime @db.Date
  predictedQty Decimal  @db.Decimal(10, 2)
  createdAt    DateTime @default(now())

  org    Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([orgId, branchId, itemId, date])
  @@index([orgId, date])
  @@map("forecast_points")
}

model FranchiseRank {
  id       String   @id @default(cuid())
  orgId    String
  period   String   @db.VarChar(7) // YYYY-MM
  branchId String
  score    Decimal  @db.Decimal(10, 2)
  rank     Int
  meta     Json
  createdAt DateTime @default(now())

  org    Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([orgId, period, branchId])
  @@index([orgId, period, rank])
  @@map("franchise_ranks")
}
