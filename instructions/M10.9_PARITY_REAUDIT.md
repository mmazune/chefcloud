# M10.9 Parity Re-Audit

> **Created:** 2026-01-04  
> **Milestone:** M10.9 Liability Remittances  

---

## 1. Reference Systems Evaluated

### 1.1 Kill Bill (Apache 2.0)
- **Repository:** github.com/killbill/killbill
- **Relevance:** Payment lifecycle, idempotency patterns, batch processing
- **License:** Apache 2.0 - ADAPT permitted

### 1.2 OpenPayd API Documentation  
- **Source:** Public API documentation
- **Relevance:** Remittance state machine, beneficiary handling
- **License:** Study-only (proprietary API)

### 1.3 Apache OFBiz Accounting
- **Repository:** github.com/apache/ofbiz-framework
- **Relevance:** GL settlement patterns, accounts payable workflows
- **License:** Apache 2.0 - ADAPT permitted

---

## 2. Feature-by-Feature Parity Matrix

| Feature | Kill Bill | OpenPayd | OFBiz | Nimbus M10.9 |
|---------|-----------|----------|-------|--------------|
| **State Machine** | PENDING→PROCESSED→SUCCESS/ERROR | CREATED→PROCESSING→COMPLETED | N/A | DRAFT→APPROVED→POSTED→PAID |
| **Void/Cancel** | Refund entity | Cancellation request | GL reversal | VOID status + journal reversal |
| **Idempotency** | Plugin-based | Request header key | Transaction-based | idempotencyKey field (unique/org) |
| **Batch Processing** | Payment bundle | Bulk transfer | Payment batch | RemittanceBatch entity |
| **Line Items** | PaymentItem | Beneficiary list | PaymentApplication | RemittanceLine |
| **Audit Trail** | AuditLog | N/A | PaymentHistory | RemittanceJournalLink |
| **Multi-Tenant** | Per tenant | Per client | Per org | Per org + branch |
| **Period Lock** | N/A | N/A | Fiscal period | FiscalPeriod.locked check |
| **GL Integration** | External | N/A | Native | JournalEntry via M8.2b |

---

## 3. Detailed Behavior Comparison

### 3.1 State Machine

**Kill Bill Payment States:**
```
PENDING → PROCESSED → SUCCESS
                   ↘ ERROR
                   ↘ PLUGIN_FAILURE
```

**OpenPayd Remittance States:**
```
CREATED → PROCESSING → COMPLETED
                    ↘ FAILED
                    ↘ CANCELLED
```

**Nimbus M10.9 Remittance States:**
```
DRAFT → APPROVED → POSTED → PAID
  ↓         ↓         ↓       ↓
VOID      VOID      VOID    VOID (+ reversal)
```

**Parity Verdict:** Nimbus adds DRAFT stage for editing + explicit POSTED/PAID separation. VOID from any state is enterprise-grade.

### 3.2 Idempotency

| Aspect | Kill Bill | Nimbus |
|--------|-----------|--------|
| Key generation | Client-provided + plugin | Client-provided idempotencyKey |
| Scope | Global | Per organization |
| Enforcement | Plugin intercept | Unique constraint + service check |
| Duplicate handling | Return existing | 409 Conflict + return existing ID |

**Parity Verdict:** Equivalent with simpler implementation.

### 3.3 Journal Creation

| Aspect | OFBiz | Nimbus |
|--------|-------|--------|
| Trigger | On payment confirmation | On PAID transition |
| Pattern | Dr AP / Cr Cash | Dr Liability / Cr Cash |
| Reversal | Manual correction | Automatic via VOID |
| Link table | PaymentApplication | RemittanceJournalLink |

**Parity Verdict:** Equivalent with explicit reversal automation.

### 3.4 Period Lock

**Nimbus-Specific:** No reference system has fiscal period lock at payment level. This is an enterprise enhancement unique to Nimbus, preventing liability settlements in locked accounting periods.

---

## 4. Gap Analysis

| Gap | Reference Behavior | Nimbus Status | Resolution |
|-----|-------------------|---------------|------------|
| External payment integration | OpenPayd has bank APIs | Not in scope | Future milestone |
| Multi-currency | Supported in references | Single currency | Currency field present for future |
| Scheduled remittances | OpenPayd supports | Not in scope | Future milestone |
| Component-level grouping | Kill Bill has categories | Minimal (componentId optional) | Sufficient for MVP |

---

## 5. Adapted Patterns

### 5.1 From Kill Bill (Apache 2.0)
- Idempotency key pattern with unique constraint
- Payment batch concept with line items
- State machine with explicit transitions

### 5.2 From OFBiz (Apache 2.0)
- GL settlement pattern (Dr Liability / Cr Cash)
- Audit trail via link table
- Period-based constraints

---

## 6. Compliance Checklist

- [x] All ADAPT patterns from Apache-licensed repos only
- [x] No proprietary code copied
- [x] Study-only patterns documented as inspiration, not implementation
- [x] Unique Nimbus enhancements documented (period lock, branch scoping)
