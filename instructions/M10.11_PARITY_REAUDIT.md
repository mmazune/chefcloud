# M10.11 Parity Re-Audit

> **Created:** 2026-01-04  
> **Milestone:** M10.11 Workforce Availability, Swaps, Open Shifts  

---

## 1. Reference Systems Evaluated

### 1.1 Kimai (AGPL-3.0) - STUDY ONLY
- **Repository:** github.com/kevinpapst/kimai
- **Relevance:** Timesheet approval workflows, activity tracking patterns
- **License:** AGPL-3.0 - STUDY ONLY, no code adaptation
- **Patterns Studied:** Approval state machines, audit logging, user/activity relationships

### 1.2 Cal.com (MIT License)
- **Repository:** github.com/calcom/cal.com
- **Relevance:** Availability modeling, timezone handling, scheduling conflicts
- **License:** MIT - ADAPT permitted
- **Patterns Adapted:** Weekly availability schema, exception windows, conflict detection

### 1.3 Calendso Patterns (MIT License)
- **Repository:** Early cal.com patterns
- **Relevance:** Booking availability, time slot modeling
- **License:** MIT - ADAPT permitted

---

## 2. Feature-by-Feature Parity Matrix

### 2.1 Employee Availability

| Aspect | Cal.com (MIT) | Kimai (AGPL) | Nimbus M10.11 |
|--------|---------------|--------------|---------------|
| **Weekly Model** | Availability schedules per day | N/A (timesheets) | WorkforceAvailability (dayOfWeek, start/end) |
| **Exceptions** | Date-specific overrides | N/A | WorkforceAvailabilityException |
| **Timezone** | User timezone stored | N/A | Branch timezone + user preference |
| **Validation** | Overlap checks | N/A | start < end, no overlaps, max 24h |
| **RBAC** | Owner access | Manager approval | L1+ self, L4+ override |

**Parity Verdict:** MEETS - Adapted cal.com availability modeling with enterprise RBAC.

### 2.2 Shift Swap Workflow

| Aspect | Kimai (AGPL) | Industry Best Practice | Nimbus M10.11 |
|--------|--------------|------------------------|---------------|
| **Request Types** | N/A | Direct + Open Pool | DIRECT_SWAP, OFFER_SHIFT |
| **Lifecycle** | Simple approve/reject | Multi-step with acceptance | DRAFT→REQUESTED→ACCEPTED→APPROVED→APPLIED |
| **Target Acceptance** | N/A | Yes | toUserId accept/decline before manager |
| **Approval Gate** | Manager required | Manager required | L4+ approve, then atomic apply |
| **Audit Trail** | Basic logging | Full lifecycle | SWAP_REQUESTED/ACCEPTED/APPROVED/APPLIED/CANCELLED/DECLINED |
| **Conflict Check** | N/A | Pre-apply validation | Overlap + max hours + availability + period lock |

**Parity Verdict:** EXCEEDS - More comprehensive than Kimai patterns, includes target acceptance and atomic apply.

### 2.3 Open Shifts + Claiming

| Aspect | Industry Pattern | Nimbus M10.11 |
|--------|------------------|---------------|
| **Open Shift Flag** | Shift without assignee | ScheduledShift.isOpen = true, userId nullable |
| **Claim Process** | First-come or approval | Claim endpoint + optional manager approval |
| **Approval Toggle** | Policy-based | WorkforcePolicy.openShiftRequiresApproval |
| **Conflict Check** | Pre-claim validation | Overlap + availability + max hours |
| **Idempotency** | Unique constraint | OpenShiftClaim unique on [shiftId, userId] |

**Parity Verdict:** MEETS - Standard open shift patterns with policy-driven approval.

### 2.4 Conflict Enforcement

| Aspect | Cal.com (MIT) | Kimai (AGPL) | Nimbus M10.11 |
|--------|---------------|--------------|---------------|
| **Overlap Detection** | Time slot collision | N/A | Centralized checkConflicts() |
| **Max Hours** | N/A | Timesheet validation | Daily/weekly OT from WorkforcePolicy |
| **Availability Windows** | Booking availability | N/A | Check against user availability |
| **Period Lock** | N/A | Timesheet lock | PayPeriod CLOSED/EXPORTED blocks changes |
| **Centralization** | Per-service | Per-service | Dedicated WorkforceConflictsService |

**Parity Verdict:** EXCEEDS - Centralized enforcement with policy-driven thresholds.

### 2.5 Notifications

| Aspect | Industry Pattern | Nimbus M10.11 |
|--------|------------------|---------------|
| **Event Log** | Audit + notification table | WorkforceNotificationLog |
| **Event Types** | Workflow transitions | SWAP_*, SHIFT_*, CLAIM_* |
| **Delivery** | Email/Push/In-app | Log-only (delivery DEFERRED) |
| **Recipient** | Event-specific | targetUserId, performedById |

**Parity Verdict:** MEETS with DEFERRED - Log infrastructure ready, delivery deferred.

### 2.6 Web UI

| Aspect | Industry Pattern | Nimbus M10.11 |
|--------|------------------|---------------|
| **Self-Service** | Employee portal | /my-availability, /my-swaps, /open-shifts |
| **Manager Tools** | Approval queue | /workforce/swaps |
| **Conflict Display** | Visual indicators | Availability badges on schedule |
| **Responsive** | Mobile-friendly | Consistent with existing Nimbus patterns |

**Parity Verdict:** MEETS - Standard self-service + manager patterns.

---

## 3. Adapted Patterns

### 3.1 From Cal.com (MIT)
- Weekly availability schema (dayOfWeek, startTime, endTime)
- Date exception override pattern
- Timezone-aware scheduling logic

### 3.2 From Industry Best Practices
- Multi-step swap lifecycle (request → accept → approve → apply)
- Atomic shift updates on approval
- Policy-driven approval gates
- Centralized conflict enforcement

---

## 4. Compliance Checklist

- [x] All ADAPT patterns from MIT-licensed repos only
- [x] AGPL repos (Kimai) used for study-only, no code copied
- [x] Swap lifecycle exceeds basic patterns
- [x] Conflict enforcement centralized and policy-driven
- [x] Notification delivery explicitly marked DEFERRED
- [x] Full audit trail for all state transitions

---

## 5. Evidence Links (Post-Implementation)

| Feature | File | Key Function |
|---------|------|--------------|
| Availability CRUD | availability.service.ts | getMyAvailability, updateMyAvailability |
| Swap Lifecycle | swaps.service.ts | createSwapRequest, acceptSwap, approveSwap, applySwap |
| Open Shift Claim | open-shifts.service.ts | claimOpenShift |
| Conflict Check | workforce-conflicts.service.ts | checkConflicts |
| Notifications | workforce-notifications.service.ts | logEvent |
