# M10.10 Parity Re-Audit

> **Created:** 2026-01-04  
> **Milestone:** M10.10 Remittance Automation + Provider Directory  

---

## 1. Reference Systems Evaluated

### 1.1 Kill Bill (Apache 2.0)
- **Repository:** github.com/killbill/killbill
- **Relevance:** Payment idempotency, lifecycle management, retry patterns
- **License:** Apache 2.0 - ADAPT permitted

### 1.2 Apache OFBiz (Apache 2.0)
- **Repository:** github.com/apache/ofbiz-framework
- **Relevance:** Vendor/party management, accounts payable automation
- **License:** Apache 2.0 - ADAPT permitted

---

## 2. Feature-by-Feature Parity Matrix

### 2.1 Provider Directory

| Aspect | Kill Bill | OFBiz | Nimbus M10.10 |
|--------|-----------|-------|---------------|
| Model | PartyContactMechanism | Party + PartyRole | RemittanceProvider |
| Types | Generic | Vendor, Customer, etc. | TAX_AUTHORITY, BENEFITS, PENSION, OTHER |
| Scope | Per tenant | Per company | Per org + optional branch |
| Defaults | Payment plugin | Default accounts | defaultCashAccountId, defaultLiabilityAccountId |

**Parity Verdict:** Nimbus adds branch-scoping and type-specific categorization.

### 2.2 Component Mapping

| Aspect | Kill Bill | OFBiz | Nimbus M10.10 |
|--------|-----------|-------|---------------|
| Model | Subscription→Product | InvoiceItem→Party | CompensationRemittanceMapping |
| Granularity | Per subscription | Per invoice item | Per compensation component |
| Flexibility | Plugin-based | Configuration | Direct FK relationship |

**Parity Verdict:** Nimbus uses direct component→provider mapping for simplicity.

### 2.3 Idempotent Generation

| Aspect | Kill Bill | Nimbus M10.10 |
|--------|-----------|---------------|
| Key Source | Client-provided | Deterministic from inputs |
| Key Format | UUID | Hash of (orgId, branchId, runIds, type) |
| Collision Handling | Return existing | Return existing with idempotentHit flag |
| Duplicate Prevention | Transaction history | RemittanceSourceLink table |

**Parity Verdict:** Nimbus uses deterministic keys for automatic idempotency.

### 2.4 Reconciliation Metadata

| Aspect | OFBiz | Nimbus M10.10 |
|--------|-------|---------------|
| Model | PaymentApplication | RemittanceBatch fields |
| Fields | partyIdTo, paymentRefNum | externalReference, settledAt, settlementMethod |
| Method Enum | N/A | CASH, BANK_TRANSFER, MOBILE_MONEY, OTHER |
| Audit | PaymentHistory | Standard audit columns |

**Parity Verdict:** Nimbus adds explicit settlement method and timing.

### 2.5 Exports

| Aspect | OFBiz | Nimbus M10.10 |
|--------|-------|---------------|
| Batch Export | Custom report | GET /reports/export/remittances |
| Line Export | Custom report | GET /reports/export/remittance-lines |
| Bank Upload | N/A | GET /reports/export/remittances-bank-upload (stub) |
| Format | PDF/CSV | CSV |

**Parity Verdict:** Nimbus adds bank upload stub for future integrations.

---

## 3. Detailed Behavior Comparison

### 3.1 Kill Bill Idempotency Pattern

```
// Kill Bill approach (simplified)
PaymentTransaction {
  externalKey: string  // Client-provided
  transactionStatus: PENDING → SUCCESS/FAILURE
}

// On duplicate key:
- Return existing transaction
- No new record created
```

### 3.2 Nimbus M10.10 Idempotency Pattern

```
// Nimbus approach
RemittanceBatch {
  idempotencyKey: string  // Deterministic hash
  // Hash = SHA256(orgId + branchId + sortedRunIds.join(',') + type)
}

RemittanceSourceLink {
  batchId: string
  payrollRunId: string
  // Unique constraint: [batchId, payrollRunId]
}

// On generate:
1. Compute deterministic idempotencyKey
2. Check existing batch with key
3. If exists: return { batch, idempotentHit: true }
4. If not: create batch, create source links
5. Return { batch, created: true }
```

**Parity Verdict:** Nimbus adds source link tracking for explicit duplicate prevention.

---

## 4. Adapted Patterns

### 4.1 From Kill Bill (Apache 2.0)
- Idempotency key concept with unique constraint
- Return existing entity on duplicate (200, not 409)
- Transaction-based state machine

### 4.2 From OFBiz (Apache 2.0)
- Party/vendor directory structure
- Payment application reference pattern
- Accounts payable workflow

---

## 5. Compliance Checklist

- [x] All ADAPT patterns from Apache-licensed repos only
- [x] No proprietary code copied
- [x] Deterministic idempotency keys (Nimbus enhancement)
- [x] Branch-scoped providers (Nimbus enhancement)
- [x] Bank upload stub format documented as future integration point
