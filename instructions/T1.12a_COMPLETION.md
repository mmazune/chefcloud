# T1.12a: Fix E2E Seed/Setup - COMPLETION REPORT

**Task:** Fix E2E setup/seed so it is schema-aligned and deterministic, and make tests/runners FAIL FAST when seed/setup fails

**Date:** 2024-12-29  
**Status:** ‚úÖ COMPLETED

---

## Executive Summary

Fixed **schema drift** causing 12+ E2E test files to timeout with "users.jobRole does not exist" error. Root cause was a `jobRole` column added to `schema.prisma` without creating a migration. Additionally improved E2E robustness with seed verification and fail-fast gates.

**Key Results:**
- ‚úÖ Created migration for missing `users.jobRole` column
- ‚úÖ Fixed FK cleanup order (stock_movements before inventoryItem)
- ‚úÖ Added seed verification script with dataset integrity checks
- ‚úÖ Integrated verification into E2E setup (fail-fast on missing data)
- ‚úÖ Updated matrix/CI runners to run setup before tests
- ‚úÖ Verified DEMO_TAPAS dataset is seeded with 178 menu items, 11 users, 158 inventory items, 305 orders

---

## Hypotheses (From T1.12a_HYPOTHESES.md)

### H1: Schema Drift - Prisma Schema vs Database Schema Mismatch (95% confidence)
**STATUS: ‚úÖ CONFIRMED**

**Evidence:**
- `users.jobRole` exists in `packages/db/prisma/schema.prisma` (line 375)
- No migration file exists for `jobRole` column
- Prisma generates TypeScript types including `jobRole` but DB column doesn't exist

**Solution Implemented:**
- Created migration: `20251229114833_add_missing_jobrole_column/migration.sql`
- Migration adds `JobRole` enum and `users.jobRole` column
- Applied to both dev (`chefcloud`) and test (`chefcloud_test`) databases
- **Files changed:**
  - `/workspaces/chefcloud/packages/db/prisma/migrations/20251229114833_add_missing_jobrole_column/migration.sql` (NEW)

### H2: Migrations Not Deployed to Test DB (20% confidence)
**STATUS: ‚ùå NOT THE ISSUE**

Test DB migration deployment was working correctly. The issue was that the migration didn't exist at all.

### H3: Implicit Prisma Client Types (30% confidence)
**STATUS: ‚úÖ PARTIALLY CONFIRMED**

Prisma Client includes types for `jobRole` even when database column doesn't exist. This masked the issue until runtime. Seed script didn't explicitly reference `jobRole`, but underlying schema validation failed.

### H4: Missing Fail-Fast Gate in E2E Setup (50% confidence)
**STATUS: ‚úÖ CONFIRMED & FIXED**

**Evidence:**
- Seed could complete with warnings but leave database in incomplete state
- Tests would timeout waiting for data that never existed
- No verification step after seed

**Solution Implemented:**
- Created `scripts/verify-e2e-seed.mjs` to check dataset integrity
- Integrated verification into `test/setup-test-db.sh`
- Verification exits non-zero if datasets incomplete (fail-fast)
- **Files changed:**
  - `/workspaces/chefcloud/services/api/scripts/verify-e2e-seed.mjs` (NEW)
  - `/workspaces/chefcloud/services/api/test/setup-test-db.sh` (MODIFIED)

---

## Files Changed

### 1. Migration: Add Missing jobRole Column
**File:** `/workspaces/chefcloud/packages/db/prisma/migrations/20251229114833_add_missing_jobrole_column/migration.sql` (NEW)

**Changes:**
```sql
-- Create JobRole enum
CREATE TYPE "JobRole" AS ENUM (...17 roles...);

-- Add jobRole column to users table
ALTER TABLE "users" ADD COLUMN "jobRole" "JobRole";

-- Drop deprecated isDemo column from orgs table
ALTER TABLE "orgs" DROP COLUMN "isDemo";
```

**Rationale:** 
- Aligns database schema with `schema.prisma`
- Fixes root cause of "column does not exist" error
- Also removes deprecated `isDemo` column (secondary drift)

### 2. Seed Script: Fix FK Cleanup Order
**File:** `/workspaces/chefcloud/services/api/prisma/seed.ts` (line 328)

**Changes:**
```typescript
// Before cleanup sequence:
await prisma.inventoryItem.deleteMany({}); // ‚ùå FAILED - FK constraint violation
await prisma.stockMovement.deleteMany({});

// After cleanup sequence:
await prisma.stockMovement.deleteMany({}); // ‚úÖ Delete children first
await prisma.inventoryItem.deleteMany({});
```

**Rationale:**
- `stock_movements` has FK `stock_movements_itemId_fkey` referencing `inventoryItem`
- Must delete child records before parent
- Prevents "violates foreign key constraint" error during cleanup

### 3. Seed Verification Script
**File:** `/workspaces/chefcloud/services/api/scripts/verify-e2e-seed.mjs` (NEW - 208 lines)

**Purpose:** Verify dataset integrity after seed, fail-fast if incomplete

**Features:**
- Verifies DEMO_TAPAS: checks org (slug: `tapas-demo`), >=1 branch, >0 menu items, >=5 users
- Verifies DEMO_CAFESSERIE_FRANCHISE: checks org (slug: `cafesserie-demo`), >=2 branches, cross-branch data
- Exits with code 1 if verification fails (blocks tests from running)
- Supports `ALL` mode to verify all datasets

**Usage:**
```bash
export $(cat .env.e2e | xargs) && node scripts/verify-e2e-seed.mjs DEMO_TAPAS
export $(cat .env.e2e | xargs) && node scripts/verify-e2e-seed.mjs ALL
```

**Important Note:** 
- Script uses `@chefcloud/db` package which defaults to `packages/db/.env` (dev database)
- **MUST** export `DATABASE_URL` from `.env.e2e` to connect to test database
- Verification correctly uses branchId (not orgId) for menuItem queries

### 4. E2E Setup Script: Integrate Verification
**File:** `/workspaces/chefcloud/services/api/test/setup-test-db.sh` (MODIFIED)

**Changes:**
```bash
# After seed completes:
npx tsx "$SEED_SCRIPT" || { echo "‚ùå Seed failed"; exit 1; }

# NEW: Verify seed data integrity
node "$VERIFY_SCRIPT" ALL || {
  echo "‚ùå Seed verification failed - dataset is incomplete"
  exit 1
}
```

**Rationale:**
- Fail-fast if seed creates incomplete dataset
- Prevents tests from running against empty/partial database
- Provides clear error message about what's missing

### 5. Matrix Runner: Run Setup First
**File:** `/workspaces/chefcloud/services/api/scripts/e2e-runtime-matrix.mjs` (MODIFIED)

**Changes:**
```javascript
async function main() {
  // NEW: Run setup once before all tests
  console.log('üîß Running E2E database setup...');
  const setupResult = await new Promise((resolve) => {
    const child = spawn('pnpm', ['test:e2e:setup'], {
      cwd: process.cwd(),
      stdio: 'inherit',
    });
    child.on('close', (code) => resolve(code));
  });

  if (setupResult !== 0) {
    console.error('‚ùå E2E setup failed - cannot proceed');
    process.exit(1);
  }

  // Then run tests...
}
```

**Rationale:**
- Ensures database is seeded before running matrix
- Prevents redundant setup calls per test file
- Fail-fast if setup fails

### 6. Deadline Runner: Run Setup First
**File:** `/workspaces/chefcloud/services/api/scripts/run-e2e-with-deadline.mjs` (MODIFIED)

**Changes:**
```javascript
(async () => {
  // NEW: Run setup before spawning Jest
  console.log('üîß Running E2E database setup...');
  const setupChild = spawn('pnpm', ['test:e2e:setup'], {
    cwd: process.cwd(),
    stdio: 'inherit',
  });

  await new Promise((resolve) => {
    setupChild.on('close', (code) => {
      if (code !== 0) {
        console.error('‚ùå Setup failed');
        process.exit(1);
      }
      resolve();
    });
  });

  // Then spawn Jest...
})();
```

**Rationale:**
- CI deadline runner now runs setup first
- Wrapped in async IIFE for await support
- Fail-fast if setup fails

---

## Commands Run (With Timeouts)

### 1. Create Migration (Dev Database)
```bash
cd /workspaces/chefcloud/packages/db
npx prisma migrate dev --name add_missing_jobrole_column --create-only
```
**Result:** ‚úÖ Migration created

### 2. Apply Migration (Dev Database)
```bash
cd /workspaces/chefcloud/packages/db
npx prisma migrate dev
```
**Result:** ‚úÖ "Your database is now in sync with your schema"

### 3. Apply Migration + Seed (Test Database)
```bash
cd /workspaces/chefcloud/services/api
timeout 10m pnpm test:e2e:setup
```
**Result:** ‚úÖ Seed completed successfully
**Output:**
- Created org: Demo Restaurant
- Created 11 users
- Created 3 menu items
- Seeded DEMO_TAPAS (Tapas Bar & Restaurant)
- Seeded DEMO_CAFESSERIE (Cafesserie)
- **NEW:** Verification passed for all datasets

**Duration:** ~2 minutes

### 4. Verify DEMO_TAPAS Dataset
```bash
cd /workspaces/chefcloud/services/api
export $(cat .env.e2e | xargs) && node scripts/verify-e2e-seed.mjs DEMO_TAPAS
```
**Result:** ‚úÖ Verification passed
**Output:**
```
‚úÖ Org found: Tapas Bar & Restaurant (00000000-0000-4000-8000-000000000001)
‚úÖ Found 1 branch(es)
‚úÖ Found 178 menu items
‚úÖ Found 11 users
‚úÖ Found 158 inventory items
‚úÖ Found 305 orders
‚úÖ DEMO_TAPAS verification passed
```

### 5. Verify DEMO_CAFESSERIE_FRANCHISE Dataset
```bash
export $(cat .env.e2e | xargs) && node scripts/verify-e2e-seed.mjs DEMO_CAFESSERIE_FRANCHISE
```
**Result:** ‚úÖ Verification passed
**Output:**
```
‚úÖ Org found: Cafesserie (00000000-0000-4000-8000-000000000002)
‚úÖ Found 4 branches (franchise)
‚úÖ Found 320 menu items
‚úÖ Found 8 users
‚úÖ Found orders across 4 branch(es)
‚úÖ DEMO_CAFESSERIE_FRANCHISE verification passed
```

### 6. Verify All Datasets
```bash
export $(cat .env.e2e | xargs) && node scripts/verify-e2e-seed.mjs ALL
```
**Result:** ‚úÖ All verifications passed

### 7. Run Single E2E Test
```bash
timeout 5m pnpm test:e2e -- --runTestsByPath test/e2e/minimal-harness.e2e-spec.ts --runInBand
```
**Result:** ‚úÖ PASS (0.893s)

---

## Verification Output (After Fix)

### DEMO_TAPAS Verification
```
üìä Checking DEMO_TAPAS dataset...
‚úÖ Org found: Tapas Bar & Restaurant (00000000-0000-4000-8000-000000000001)
‚úÖ Found 1 branch(es)
‚úÖ Found 178 menu items
‚úÖ Found 11 users
‚úÖ Found 158 inventory items
‚úÖ Found 305 orders
‚úÖ DEMO_TAPAS verification passed
```

### DEMO_CAFESSERIE_FRANCHISE Verification
```
üìä Checking DEMO_CAFESSERIE_FRANCHISE dataset...
‚úÖ Org found: Cafesserie (00000000-0000-4000-8000-000000000002)
‚úÖ Found 4 branches (franchise)
‚úÖ Found 320 menu items
‚úÖ Found 8 users
‚úÖ Found orders across 4 branch(es)
‚úÖ DEMO_CAFESSERIE_FRANCHISE verification passed
```

---

## Dataset Confirmation

### DEMO_TAPAS is Default ‚úÖ
Per `DEMO_TENANTS_AND_DATASETS.md`:
- **Rule:** All E2E tests default to DEMO_TAPAS unless explicitly testing empty-state or multi-branch behavior
- **Implementation:** 
  - `E2E_DEMO_DATASET` defaults to `DEMO_TAPAS` in matrix and deadline runners
  - Seed creates DEMO_TAPAS with comprehensive data (menu, recipes, inventory, orders, users)

### Actual Slugs (Corrected in Verification Script)
- ‚ùå Old assumption: `tapas-bar`, `demo-empty`, `cafesserie`
- ‚úÖ Actual slugs: `tapas-demo`, `cafesserie-demo`
- **DEMO_EMPTY does not exist yet** - only `demo-restaurant` (legacy seed)

---

## Runtime Matrix Before vs After

**BEFORE:**
- 12+ files timing out at 120s
- Error: "column users.jobRole does not exist in the current database"
- No verification gate - tests run against empty database

**AFTER:**
- Setup completes in ~2 minutes
- Verification confirms datasets are complete
- Tests fail-fast if seed incomplete
- Single test file (minimal-harness) passes in 0.893s

**Note:** Full matrix run not executed yet (time budget). Single test confirms setup works correctly.

---

## Lessons Learned

### 1. Schema Drift Detection
**Problem:** `schema.prisma` can diverge from actual database schema if migrations not created

**Solution:**
- Always run `npx prisma migrate dev` after editing schema
- CI should fail if `prisma migrate status` shows drift
- Add pre-commit hook to check for pending migrations

### 2. Prisma Client Type Generation
**Issue:** Prisma generates types for ALL schema fields, even if DB column doesn't exist yet

**Implication:**
- TypeScript won't catch missing columns at compile-time
- Errors only surface at runtime during DB operations
- Seed scripts can "look correct" but fail on actual execution

**Mitigation:**
- Run `prisma migrate status` before seeding
- Use verification script to catch schema/data mismatches

### 3. Foreign Key Cleanup Order
**Rule:** Always delete child records before parent records

**Example:**
```typescript
// ‚ùå WRONG - parent first
await prisma.inventoryItem.deleteMany({});
await prisma.stockMovement.deleteMany({});

// ‚úÖ CORRECT - children first
await prisma.stockMovement.deleteMany({});
await prisma.inventoryItem.deleteMany({});
```

### 4. Database Connection Defaults
**Gotcha:** `@chefcloud/db` package uses `packages/db/.env` by default (dev database)

**Solution:**
- Always export `DATABASE_URL` from `.env.e2e` when verifying test database
- Use `export $(cat .env.e2e | xargs)` to override package defaults

### 5. Fail-Fast Gates
**Best Practice:** Verify assumptions before running expensive operations

**Implementation:**
- Seed verification prevents tests from running against incomplete data
- Setup scripts exit non-zero immediately on failure
- CI runners check setup status before spawning Jest

---

## Remaining Work (Future)

### 1. Replace demo-restaurant with DEMO_EMPTY
Current state:
- ‚úÖ DEMO_TAPAS exists (slug: `tapas-demo`)
- ‚úÖ DEMO_CAFESSERIE_FRANCHISE exists (slug: `cafesserie-demo`)
- ‚ùå DEMO_EMPTY doesn't exist - only legacy `demo-restaurant` (11 users, 3 menu items)

**Action:** Create DEMO_EMPTY dataset with minimal org + branch + owner (per spec)

### 2. Pre-Commit Schema Drift Check
**Action:** Add git hook to run `prisma migrate status` and fail if drift detected

### 3. Full Matrix Run
**Action:** Run `node scripts/e2e-runtime-matrix.mjs` to confirm timed-out files drop from 12 to 0

### 4. Canonical Demo Fixtures File
Per `DEMO_TENANTS_AND_DATASETS.md`:
- **Missing:** `services/api/test/helpers/demo-fixtures.ts`
- **Purpose:** Single source of truth for orgSlugs, branchIds, demo user credentials
- **Action:** Create file exporting `DEMO_TAPAS`, `DEMO_EMPTY`, `DEMO_CAFESSERIE_FRANCHISE` constants

---

## Summary

‚úÖ **Fixed schema drift** - Created migration for missing `jobRole` column  
‚úÖ **Fixed FK cleanup** - Reordered stock_movements deletion before inventoryItem  
‚úÖ **Added verification** - Seed integrity checks with fail-fast on incomplete data  
‚úÖ **Updated runners** - Matrix and CI now run setup before tests  
‚úÖ **Verified datasets** - DEMO_TAPAS and DEMO_CAFESSERIE_FRANCHISE fully seeded  

**Impact:** E2E tests now have schema-aligned, deterministic seed data with fail-fast gates preventing 120s timeouts when data is missing.

**Next Steps:**
1. Run full matrix to confirm timeout reduction
2. Create DEMO_EMPTY dataset to replace legacy demo-restaurant
3. Add pre-commit hook for schema drift detection
