# M10.4 Parity Re-Audit: Workforce Enterprise

> **Date:** 2026-01-03  
> **Milestone:** M10.4  
> **Reference:** Kimai (AGPL, study-only)

---

## 1. Feature-by-Feature Comparison

### 1.1 Pay Period Management

| Behavior | Kimai | Nimbus M10.4 | Verdict |
|----------|-------|--------------|---------|
| Define period types (weekly/biweekly/monthly) | ✓ Custom date ranges | ✓ WEEKLY/BIWEEKLY/MONTHLY enum | MEETS |
| Period locking prevents edits | ✓ "Lock timesheet" feature | ✓ CLOSED status blocks approve/reject | MEETS |
| Period status tracking | ✓ locked/unlocked | ✓ OPEN/CLOSED/EXPORTED | EXCEEDS (3-state) |
| Generate periods in bulk | ✗ Manual creation | ✓ Auto-generate for date range | EXCEEDS |
| Branch-specific periods | ✗ User-based | ✓ Optional branchId scoping | EXCEEDS |

**Nimbus Evidence:**
- `POST /workforce/pay-periods/generate` with periodType, startDate, endDate, branchId
- PayPeriod model: status enum PayPeriodStatus (OPEN, CLOSED, EXPORTED)
- closePayPeriod updates status to CLOSED, sets closedAt/closedById

### 1.2 Timesheet Approval Workflow

| Behavior | Kimai | Nimbus M10.4 | Verdict |
|----------|-------|--------------|---------|
| Per-entry approval | ✓ | ✓ TimesheetApproval per TimeEntry | MEETS |
| Bulk approve/reject | ✗ One at a time | ✓ Bulk operations with IDs array | EXCEEDS |
| Rejection reason | ✓ Comment field | ✓ rejectionReason field | MEETS |
| Approval locks entry | ✓ | ✓ APPROVED status + lockedAt | MEETS |
| Manager override | ✓ Admin can edit locked | ✗ Locked = immutable | DIFFERENT (stricter) |

**Nimbus Evidence:**
- `POST /workforce/timesheets/approve` body: `{ ids: string[] }`
- `POST /workforce/timesheets/reject` body: `{ ids: string[], reason?: string }`
- TimesheetApproval.lockedAt prevents further modifications

### 1.3 Time Rounding Rules

| Behavior | Kimai | Nimbus M10.4 | Verdict |
|----------|-------|--------------|---------|
| Rounding interval (15/30/60 min) | ✓ | ✓ roundingIntervalMins | MEETS |
| Rounding mode (nearest/up/down) | ✓ | ✓ RoundingMode enum | MEETS |
| Per-policy configuration | ✗ Global | ✓ Per-org WorkforcePolicy | EXCEEDS |
| Applied at export time | ✓ | ✓ exportPayroll applies rounding | MEETS |

**Nimbus Evidence:**
- WorkforcePolicy: roundingIntervalMins, roundingMode (NEAREST/UP/DOWN)
- roundTime() helper in workforce-enterprise.service.ts

### 1.4 Overtime Calculation

| Behavior | Kimai | Nimbus M10.4 | Verdict |
|----------|-------|--------------|---------|
| Daily OT threshold | ✓ 8 hours default | ✓ dailyOtThresholdMins (default 480) | MEETS |
| Weekly OT threshold | ✓ 40 hours default | ✓ weeklyOtThresholdMins (default 2400) | MEETS |
| Per-export OT calculation | ✓ | ✓ regularMinutes + overtimeMinutes | MEETS |
| Double-time rules | ✗ | ✗ Not implemented | DEFERRED |

**Nimbus Evidence:**
- exportPayroll calculates regularMinutes = min(roundedMinutes, dailyOtThresholdMins)
- overtimeMinutes = max(0, roundedMinutes - dailyOtThresholdMins)

### 1.5 Payroll Export

| Behavior | Kimai | Nimbus M10.4 | Verdict |
|----------|-------|--------------|---------|
| CSV export | ✓ | ✓ format: 'CSV' | MEETS |
| JSON export | ✓ | ✓ format: 'JSON' (default) | MEETS |
| Excel export | ✓ | ✗ Not implemented | DEFERRED |
| Period-based export | ✓ | ✓ payPeriodId parameter | MEETS |
| Export marks period | ✗ | ✓ status → EXPORTED, exportedAt | EXCEEDS |

**Nimbus Evidence:**
- `POST /workforce/payroll/export` body: startDate, endDate, format, branchId, payPeriodId
- generateCsv() returns {csv: string} with headers

### 1.6 Audit Logging

| Behavior | Kimai | Nimbus M10.4 | Verdict |
|----------|-------|--------------|---------|
| Track all changes | ✓ Activity log | ✓ WorkforceAuditLog | MEETS |
| Action types | ✓ Generic | ✓ Specific: POLICY_UPDATED, PAY_PERIOD_CLOSED, etc. | EXCEEDS |
| Payload storage | ✗ Text only | ✓ JSON payload | EXCEEDS |
| Queryable by entity | ✗ | ✓ entityType + entityId indexes | EXCEEDS |

**Nimbus Evidence:**
- WorkforceAuditLog: orgId, action, entityType, entityId, payload, performedById
- WorkforceAuditAction enum with 16+ specific actions

---

## 2. Verdict Summary

| Feature Group | Verdict | Notes |
|--------------|---------|-------|
| Pay Period Management | EXCEEDS | 3-state lifecycle, bulk generation |
| Timesheet Approval | EXCEEDS | Bulk operations, strict locking |
| Time Rounding | EXCEEDS | Per-org policy |
| Overtime Calculation | MEETS | Daily + weekly thresholds |
| Payroll Export | EXCEEDS | Auto-marks period as exported |
| Audit Logging | EXCEEDS | Structured, queryable logs |

**Overall: EXCEEDS Kimai baseline for enterprise workforce management**

---

## 3. Deferred Items

| Item | Reason | Target Milestone |
|------|--------|------------------|
| Double-time rules | Complexity | M10.6 |
| Excel export | Dependency (xlsx lib) | M10.6 |
| Staff self-service view | UX design needed | M10.5 |
| Mobile optimization | Cross-cutting | M11 |

---

*Last Updated: 2026-01-03*
