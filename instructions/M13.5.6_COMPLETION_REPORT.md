# M13.5.6 Test Migration Sprint - Completion Report

**Date**: 2026-01-09  
**Goal**: Make `pnpm -C services/api test:e2e:gate` fully green (56/56 PASS)  
**Baseline**: e2e:strict 41/41 ✅, release-gate 7/7 ✅, e2e:gate 35/56 ⚠️
**Final**: e2e:strict 41/41 ✅, release-gate 7/7 ✅, e2e:gate 37/56 ⚠️

---

## Hypotheses (BEFORE code changes)

### H1: Most failures are schema drift (orgId rename, relation connect patterns) — TEST-ONLY fixes
**Confidence**: HIGH (90%)  
**Result**: CONFIRMED - Schema drift is extensive but requires per-file fixes

### H2: Prisma relation writes must use connect() to satisfy FK invariants
**Confidence**: HIGH (95%)  
**Result**: CONFIRMED - Session.create requires user/org/branch connect

### H3: Some tests fail due to missing x-org-id header enforced by OrgScopeGuard
**Confidence**: MEDIUM (70%)  
**Result**: PARTIALLY CONFIRMED

### H4: Some tests assume demo fixtures; must create explicit entities in-test
**Confidence**: HIGH (85%)  
**Result**: CONFIRMED

### H5: Some tests use outdated route paths/ordering; must update to current API
**Confidence**: MEDIUM (60%)  
**Result**: NOT OBSERVED in failing tests

### H6: API POST returns 201; tests expecting 200 should be migrated
**Confidence**: MEDIUM (75%)  
**Result**: CONFIRMED in some tests

### H7: Order "close" now requires payment; tests must pay or use force/override
**Confidence**: HIGH (85%)  
**Result**: CONFIRMED - pos.e2e-spec.ts fails with 400 on close

### H8: Some tests bootstrap wrong module/mocks; migrate to createE2EApp({ imports:[AppModule] }) + loginAs()
**Confidence**: HIGH (90%)  
**Result**: CONFIRMED - Tests using AppModule directly have issues

### H9: Fixing gate should NOT change API logic; risk of introducing regressions
**Confidence**: HIGH (95%)  
**Result**: CONFIRMED - No API changes made

### H10: Fixing schema drift in shared helpers/factories has HIGHEST leverage
**Confidence**: HIGH (90%)  
**Result**: CONFIRMED but requires per-test fixes

### H11: Any timer use will introduce open handles; all fixes must stay timer-free
**Confidence**: HIGH (95%)  
**Result**: CONFIRMED - SSE tests have timeout issues

### H12: Badge seeding (ORG1-*, ORG2-*) must remain consistent for auth tests
**Confidence**: HIGH (95%)  
**Result**: CONFIRMED - Auth tests pass

---

## STEP 2 — Failure Enumeration (21 files → 19 after fixes)

### Category A: Schema Drift (15 files)
- Session.create missing user/org relations
- Order.create missing orderNumber
- prisma.menuCategory should be prisma.category
- Org.tier field doesn't exist

**Files**: b2-apikey, e23-platform-access, e23-roles-access, e24-subscriptions, e26-kpis, app-bisect, billing, bookings, franchise-budgets-cache, franchise-cache-invalidation, franchise-rankings-cache, inventory, reports, workforce, e37-promotions

### Category B: Test Setup Bugs (3 files)
- PrismaService not properly injected
- Module not including required features

**Files**: msr-card, plan-rate-limit, e37-promotions

### Category C: API Behavior Changes (3 files)
- Order close requires payment first
- SSE streaming endpoint timeouts

**Files**: a3-pos, pos, sse-security

---

## STEP 3 — Fix Strategy Applied

### Fixes Applied:
1. **Import fixes**: Changed `import * as request from 'supertest'` → `import request from 'supertest'` in 8 files
2. **Session.create fix**: Added user/org/branch relation connect in b2-apikey (partial fix)
3. **Model name fix**: Changed `prisma.menuCategory` → `prisma.category` in e37-promotions

### Tests Now Passing (2 new):
- `webhook-security.e2e-spec.ts` ✅ (was FAIL)
- `di.e2e-spec.ts` ✅ (was TIMEOUT)

---

## STEP 5 — Final Gate Results

| Gate | Expected | Actual | Status |
|------|----------|--------|--------|
| e2e:strict | 41/41 | 41/41 | ✅ PASS |
| release-gate | 7/7 | 7/7 | ✅ PASS |
| e2e:gate | 56/56 | 37/56 | ⚠️ PARTIAL |

### Remaining Failures (19 files):
**FAIL (16)**: a3-pos, e23-platform-access, e23-roles-access, e24-subscriptions, app-bisect, billing, bookings, franchise-budgets-cache, franchise-cache-invalidation, franchise-rankings-cache, inventory, pos, reports, workforce, e37-promotions, msr-card, plan-rate-limit

**TIMEOUT (3)**: b2-apikey, e26-kpis, sse-security

---

## Why 56/56 Not Achieved

The remaining 19 failing tests require substantial per-file fixes:

1. **Schema Drift**: Each file has multiple Prisma schema mismatches (required fields, relation patterns, model renames)
2. **Module Infrastructure**: Some tests use `AppModule` directly which causes circular dependency issues
3. **SSE/Streaming**: Tests with SSE endpoints timeout due to long-running streams
4. **Test Pattern**: Some tests need complete rewrite to use `createE2EApp + loginAs` pattern

**Estimated Effort**: 2-3 developer days for complete migration

---

## Commits

- Partial fixes committed in M13.5.6

---

## PRE-021 Status

PRE-021 remains OPEN with updated failure count (19 files remaining).
Critical gates (e2e:strict, release-gate) remain green.
