# M12.1 Parity Re-Audit: Inventory Period Close Patterns

## Overview
Study-only comparison of period close, valuation snapshotting, and reconciliation patterns in InvenTree and Odoo.

## InvenTree Patterns

### Stock History + Valuation

**Source:** InvenTree v0.14+ stock module

| Feature | InvenTree Behavior | Evidence |
|---------|-------------------|----------|
| Stock tracking | StockItem + StockItemHistory | Per-item FIFO history with timestamps |
| Valuation | Computed at query time | No persistent snapshots; SUM over history |
| Period close | None | No formal period concept |
| Lock mechanism | None | All adjustments always allowed |
| GL integration | None | Standalone inventory system |

**Key Observations:**
- InvenTree uses append-only StockItemHistory for movements
- Valuation is calculated on-demand, not persisted
- No period lock concept - adjustments can modify any date
- Suitable for smaller operations without audit requirements

### Nimbus Equivalent
- InventoryLedgerEntry provides append-only history (✓ parity)
- M12.1 adds persistent valuation snapshots (enhancement)
- M12.1 adds period locks (enhancement)

## Odoo Patterns (Study-Only)

### Stock Valuation Layers

**Source:** Odoo 16+ stock_account module

| Feature | Odoo Behavior | Evidence |
|---------|--------------|----------|
| Valuation layers | stock.valuation.layer model | Perpetual inventory with FIFO/AVCO layers |
| Period close | account.period + lock dates | Fiscal year close with lock date mechanism |
| Lock mechanism | company.period_lock_date | Global lock; specific user groups can bypass |
| Override | res.groups accounting manager | Group-based bypass for corrections |
| Reconciliation | stock.landed.cost + account.move | Automatic revaluation journal entries |

**Key Observations:**
- Odoo uses perpetual inventory with real-time GL posting
- Lock dates are company-level, not branch-level
- Override is group-based (less granular than action-based)
- Reconciliation is automatic via account.move relation

### Nimbus Equivalent
- M11.5 InventoryCostLayer provides WAC layers (✓ parity with AVCO)
- M12.1 adds branch-level period locks (enhancement - more granular)
- M12.1 L5 override with audit (enhancement - more auditable)
- M12.1 explicit reconciliation endpoint (more transparent)

## Concrete Behavior Comparison

### Period Boundary Handling

| Aspect | InvenTree | Odoo | Nimbus M12.1 |
|--------|-----------|------|--------------|
| End date meaning | N/A | Inclusive (≤ lock_date) | Inclusive (≤ endDate 23:59:59.999) |
| Timezone | N/A | Company timezone | UTC (stored) with branch display |
| Edge case | N/A | Transactions on lock date blocked | Transactions on endDate OK if before 24:00 |

### Blocking States Before Close

| Aspect | InvenTree | Odoo | Nimbus M12.1 |
|--------|-----------|------|--------------|
| Draft documents | N/A | Draft invoices block | Draft stocktakes, production, adjustments |
| In-transit | N/A | Draft pickings block | IN_TRANSIT transfers older than endDate |
| Pending posts | N/A | Unposted journals block | PENDING adjustments within range |

### Valuation Snapshot Contents

| Field | InvenTree | Odoo | Nimbus M12.1 |
|-------|-----------|------|--------------|
| Qty on hand | Computed | stock.valuation.layer.quantity | qtyOnHand (Decimal 12,4) |
| Unit cost | Last purchase | layer.unit_cost (FIFO/AVCO) | wac (Decimal 12,4) |
| Total value | Computed | layer.value | value (qty × wac, Decimal 12,2) |
| Per location | Yes | By warehouse | Yes (per item+location) |
| Timestamp | N/A | layer.create_date | asOf (endDate boundary) |

### Movement Summary Categories

| Category | InvenTree | Odoo | Nimbus M12.1 |
|----------|-----------|------|--------------|
| Receives | stock.move IN | stock.move purchase | receiveQty/Value |
| Sales | stock.move OUT | stock.move sale | depletionQty/Value |
| Waste | stock.move scrap | stock.scrap | wasteQty/Value |
| Transfers | stock.move internal | stock.move internal | transferIn/OutQty |
| Adjustments | stock.move adjustment | stock.inventory.adjustment | adjustmentQty/Value |
| Count variance | N/A | stock.inventory line | countVarianceQty/Value |
| Production | N/A | mrp.production | productionConsume/ProduceQty |

### GL Reconciliation

| Aspect | InvenTree | Odoo | Nimbus M12.1 |
|--------|-----------|------|--------------|
| Method | N/A | Automatic via account.move | Explicit comparison endpoint |
| Categories | N/A | Receipt, COGS, valuation | Receipt, COGS, Waste, Variance |
| Delta handling | N/A | Revaluation entries | MATCH/WARN/FAIL status |
| Audit trail | N/A | Journal links | journalEntryIds list + count |

## Parity Verdict

| Feature | InvenTree Parity | Odoo Parity | Notes |
|---------|------------------|-------------|-------|
| A) Period Model | Enhancement | ≈ Equivalent | Branch-scoped vs company-scoped |
| B) Lock Enforcement | Enhancement | ≈ Equivalent | L5 override vs group override |
| C) Close Operation | Enhancement | ≈ Equivalent | Explicit blocking states |
| D) GL Reconciliation | Enhancement | ≈ Equivalent | More transparent; no auto-revalue |
| E) Exports | Enhancement | ≈ Equivalent | SHA-256 hash header added |
| F) Web UI | Enhancement | ≈ Equivalent | Simpler operational UI |

## Conclusion

M12.1 provides:
1. **InvenTree enhancement**: Adds formal period close that InvenTree lacks
2. **Odoo equivalence**: Similar lock mechanism with branch-level granularity
3. **Nimbus differentiation**: Explicit reconciliation (vs auto-revalue), action-based audit (vs group-based)

The implementation maintains accounting fidelity while being more transparent about reconciliation status.
