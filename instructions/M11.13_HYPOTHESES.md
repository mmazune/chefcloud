# M11.13 Hypotheses: Inventory → Accounting GL Integration

## Overview

These hypotheses must be validated through tests BEFORE considering M11.13 complete.
Each hypothesis addresses a specific failure mode or edge case.

---

## H1: Branch Override Not Applied

**Hypothesis:** If a branch-specific InventoryPostingMapping exists but the system uses the org default instead, journal entries will post to wrong accounts.

**Test Scenario:**
1. Create org default mapping with Account A (Inventory Asset)
2. Create branch override mapping with Account B (Inventory Asset)
3. Post a goods receipt for that specific branch
4. Assert journal entry uses Account B, not Account A

**Expected Result:** Branch-specific mapping takes precedence over org default.

**Risk:** Medium - Could cause incorrect financial reporting per branch.

---

## H2: Duplicate Journals Created

**Hypothesis:** If the idempotency check fails (e.g., unique constraint not enforced on source+sourceId), posting the same document twice creates duplicate journal entries.

**Test Scenario:**
1. Post a goods receipt → journal entry created
2. Call `post()` again on the same receipt
3. Query journal entries for that sourceId

**Expected Result:** Only one journal entry exists; second call returns idempotent response.

**Validation Approach:**
- Assert `isAlreadyPosted: true` on second call
- Assert journal entry count = 1 for that sourceId
- Verify no `prisma.journalEntry.create()` called on second invocation

**Risk:** High - Duplicate journals corrupt trial balance.

---

## H3: Period Lock Not Enforced

**Hypothesis:** If fiscal period lock check is skipped or incorrectly implemented, users can post inventory GL entries to locked periods.

**Test Scenario:**
1. Create fiscal period for current date, set status = 'LOCKED'
2. Attempt to post a goods receipt with journalDate in that period
3. Expect ForbiddenException

**Expected Result:** Posting fails with "Cannot post in locked fiscal period" error.

**Validation Approach:**
- Assert ForbiddenException thrown
- Assert no journal entry created
- Assert receipt remains in DRAFT status (or status before GL posting)

**Risk:** Critical - Violates accounting controls.

---

## H4: Depletion Cost Missing Causes Incorrect COGS Posting

**Hypothesis:** If an order depletion has no COGS breakdown (e.g., costingService.recordCogsBreakdown returns 0), the GL posting will create a journal with 0 amount or skip posting entirely.

**Test Scenario:**
1. Create order depletion where items have no cost layers (cogsTotal = 0)
2. Call depleteForOrder()
3. Verify GL posting behavior

**Expected Result:** 
- If cogsTotal = 0, skip GL posting (status = SKIPPED, reason: "No COGS to post")
- No journal entry created for zero-amount transactions

**Validation Approach:**
- Assert glPostingStatus = 'SKIPPED'
- Assert no journal entry linked
- Assert glPostingError explains "Zero COGS amount"

**Risk:** Medium - Zero-amount journals pollute GL.

---

## H5: CSV Hash Mismatch (BOM/Newlines)

**Hypothesis:** If CSV export includes BOM character or inconsistent newlines, the SHA-256 hash in `X-Content-Hash` header won't match client-computed hash.

**Test Scenario:**
1. Call `/inventory/gl-postings/export`
2. Capture response body and `X-Content-Hash` header
3. Compute SHA-256 of response body
4. Compare hashes

**Expected Result:** Hashes match exactly.

**Validation Approach:**
- No UTF-8 BOM (EF BB BF) at start
- Consistent CRLF or LF (not mixed)
- Hash computed on exact byte content returned

**Risk:** Low - Affects audit verification.

---

## H6: Cross-Tenant Leakage in GL Postings

**Hypothesis:** If orgId filter is missing in GL posting queries, postings from other organizations could be visible.

**Test Scenario:**
1. Create postings in Org A
2. Query `/inventory/gl-postings` as user in Org B
3. Assert Org A postings not visible

**Expected Result:** Only current org's postings returned.

**Validation Approach:**
- Assert all returned records have orgId matching authenticated user's org
- Attempt to access Org A posting by ID from Org B → 404

**Risk:** Critical - Security violation.

---

## H7: RBAC Allows L3 to Modify Mappings

**Hypothesis:** If RBAC check uses L3 instead of L4, managers could modify account mappings (should be owner-only).

**Test Scenario:**
1. Authenticate as L3 MANAGER user
2. Attempt POST /inventory/gl-mappings
3. Expect 403 Forbidden

**Expected Result:** L3 cannot create/update/delete mappings; only L4+ can.

**Validation Approach:**
- Assert 403 response for L3 on mutation endpoints
- Assert L4 succeeds
- Assert L3 can READ mappings (GET)

**Risk:** Medium - Unauthorized access to accounting configuration.

---

## H8: Reversal Creates Imbalanced Journal

**Hypothesis:** If void operation swaps debit/credit incorrectly (e.g., negatives not handled), reversal journal may be imbalanced.

**Test Scenario:**
1. Post goods receipt → journal with Dr 1000, Cr 1000
2. Void the receipt
3. Verify reversal journal has Dr 1000, Cr 1000 (exact opposite)
4. Assert total debits = total credits

**Expected Result:** Reversal journal is perfectly balanced.

**Validation Approach:**
```typescript
const reversal = await findReversalJournal(originalId);
const totalDebit = reversal.lines.reduce((sum, l) => sum + l.debit, 0);
const totalCredit = reversal.lines.reduce((sum, l) => sum + l.credit, 0);
expect(totalDebit).toBe(totalCredit);
```

**Risk:** High - Imbalanced journals break trial balance.

---

## H9: Missing Mapping Fails Gracefully

**Hypothesis:** If no InventoryPostingMapping exists for the org/branch, the posting should fail with a clear error (not crash).

**Test Scenario:**
1. Ensure no mapping exists for Org X
2. Attempt to post goods receipt in Org X
3. Expect BadRequestException with helpful message

**Expected Result:** Error message: "GL integration not configured. Please set up inventory posting mappings."

**Validation Approach:**
- Assert BadRequestException (not 500 error)
- Assert receipt remains in previous status
- Assert no partial journal entry created

**Risk:** Medium - Poor UX without clear error.

---

## H10: Account Type Validation

**Hypothesis:** If user assigns wrong account type (e.g., Revenue account as Inventory Asset), postings will be technically valid but financially incorrect.

**Test Scenario:**
1. Create mapping with Revenue account as inventoryAssetAccountId
2. Attempt to save mapping
3. Expect validation error

**Expected Result:** Mapping creation fails with "Inventory Asset account must be ASSET type".

**Validation Approach:**
- inventoryAssetAccountId → must be ASSET type
- cogsAccountId → must be EXPENSE type
- wasteExpenseAccountId → must be EXPENSE type
- shrinkExpenseAccountId → must be EXPENSE type
- grniAccountId → must be LIABILITY type

**Risk:** Medium - Incorrect financial classification.

---

## Summary

| ID | Hypothesis | Risk | Priority |
|----|------------|------|----------|
| H1 | Branch Override Not Applied | Medium | P2 |
| H2 | Duplicate Journals Created | High | P1 |
| H3 | Period Lock Not Enforced | Critical | P0 |
| H4 | Depletion Cost Missing | Medium | P2 |
| H5 | CSV Hash Mismatch | Low | P3 |
| H6 | Cross-Tenant Leakage | Critical | P0 |
| H7 | RBAC Allows L3 Mutations | Medium | P2 |
| H8 | Reversal Creates Imbalance | High | P1 |
| H9 | Missing Mapping Fails Gracefully | Medium | P2 |
| H10 | Account Type Validation | Medium | P2 |

---

## Version

- **Hypotheses Version:** 1.0
- **Created:** 2025-01-18
- **Milestone:** M11.13
