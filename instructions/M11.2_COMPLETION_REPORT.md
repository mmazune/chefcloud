# M11.2 Completion Report

> **Milestone:** M11.2 Purchasing & Receiving Core  
> **Created:** 2026-01-05  
> **Status:** BACKEND_COMPLETE

---

## 1. Hypotheses

| ID | Hypothesis | Confidence | Failure Mode | Outcome |
|----|------------|------------|--------------|---------|
| H1 | Receiving posts ledger entries in input UOM (breaks on-hand) unless forced base conversion | HIGH | On-hand calculations incorrect, multi-UOM math fails | **MITIGATED** - All receiving converts to base UOM before ledger entry |
| H2 | PO receiving over-receipt allows inventory inflation unless capped/line policy enforced | HIGH | Stock over-stated, valuation incorrect | **MITIGATED** - `allowOverReceipt` per line with `validateOverReceipt()` check |
| H3 | Posting receipt twice duplicates ledger entries without idempotency guard | HIGH | Double inventory, financial discrepancies | **MITIGATED** - Status check + idempotencyKey on receipts |
| H4 | Org/branch scoping missing on PO/receipt queries causing cross-tenant leakage | CRITICAL | Security breach, data exposure | **MITIGATED** - All queries include orgId+branchId in where clause |
| H5 | Export hash mismatch on Windows due to BOM/newlines ordering | MEDIUM | Cross-platform verification fails | **MITIGATED** - UTF-8 BOM + LF-normalized hash computation |
| H6 | Tests hang due to unclosed app/server or open handles | HIGH | CI pipeline failures, --forceExit required | PENDING - E2E tests not yet written |
| H7 | RBAC regression lets L2 approve/cancel POs | HIGH | Unauthorized approvals, audit failure | **MITIGATED** - RBAC guards on controller endpoints |
| H8 | Vendor reuse mismatch (inventory creates duplicate supplier instead of reusing Vendor) | MEDIUM | Data duplication, accounting mismatch | **MITIGATED** - PurchaseOrderV2 uses FK to accounting Vendor model |

---

## 2. Implementation Summary

### 2.1 Files Created

| File | Purpose |
|------|---------|
| `services/api/src/audit/audit-log.service.ts` | Centralized audit logging service |
| `services/api/src/audit/audit.module.ts` | AuditModule for DI |
| `services/api/src/audit/index.ts` | Module exports |
| `services/api/src/inventory/purchase-orders.service.ts` | PO CRUD, state machine, UOM conversion |
| `services/api/src/inventory/receipts.service.ts` | Receipt creation, idempotent posting, ledger integration |
| `services/api/src/inventory/procurement-reporting.service.ts` | KPIs, CSV/JSON exports |
| `services/api/src/inventory/procurement.controller.ts` | REST API endpoints |

### 2.2 Files Modified

| File | Changes |
|------|---------|
| `packages/db/prisma/schema.prisma` | Added PurchaseOrderStatus, GoodsReceiptStatus enums; PurchaseOrderV2, PurchaseOrderLineV2, GoodsReceiptV2, GoodsReceiptLineV2 models |
| `services/api/src/inventory/inventory.module.ts` | Registered new services, controller, AuditModule import |

---

## 3. Test Results

### 3.1 E2E Tests

| Test File | Assertions | Status | Runtime |
|-----------|------------|--------|---------|
| TBD - M11.2 E2E | TBD | PENDING | TBD |

### 3.2 UI Tests

| Test File | Assertions | Status | Runtime |
|-----------|------------|--------|---------|
| TBD - M11.2 UI | TBD | PENDING | TBD |

---

## 4. Verification Gates

| Gate | Command | Status | Runtime |
|------|---------|--------|---------|
| API Lint | pnpm -C services/api lint | ✅ PASS (191 warnings, 0 errors) | ~10s |
| Web Lint | pnpm -C apps/web lint | ✅ PASS (warnings only) | ~15s |
| API Build | pnpm -C services/api build | ✅ PASS | ~8s |
| Web Build | pnpm -C apps/web build | ✅ PASS | ~45s |
| Prisma Generate | pnpm -C packages/db db:generate | ✅ PASS | ~3s |
| Teardown Check | test:e2e:teardown-check | PENDING | TBD |
| Coverage Check | test:e2e:coverage-check | PENDING | TBD |
| E2E M11.2 | test:e2e (detectOpenHandles) | PENDING | TBD |
| E2E Strict | test:e2e:strict | PENDING | TBD |
| E2E Gate | test:e2e:gate | PENDING | TBD |

---

## 5. Parity Verdicts

| Scope | Verdict | Evidence |
|-------|---------|----------|
| A) Purchase Orders | ✅ IMPLEMENTED | PurchaseOrderV2 with state machine, vendor FK, notes, expectedAt |
| B) PO Lines | ✅ IMPLEMENTED | PurchaseOrderLineV2 with qtyOrderedInput/Base, UOM conversion, unitCost, allowOverReceipt |
| C) Receiving | ✅ IMPLEMENTED | GoodsReceiptV2/Lines with partial receiving, location tracking |
| D) Ledger Integration | ✅ IMPLEMENTED | recordEntry() with PURCHASE reason, BASE UOM, idempotent posting |
| E) Exports | ✅ IMPLEMENTED | CSV/JSON exports with UTF-8 BOM, LF-normalized hash |
| F) Audit/Security | ✅ IMPLEMENTED | RBAC guards, AuditLogService, org/branch scoping |

---

## 6. PRE-Existing Issues

- 191 lint warnings in API (pre-existing, all are unused vars/imports)
- TypeScript version warning (5.9.3 vs supported <5.4.0)

---

## 7. Remaining Work

- [ ] Web UI pages for PO and Receipt management
- [ ] E2E tests (inventory-m112-procurement.e2e-spec.ts)
- [ ] UI smoke tests (m112-procurement-pages.test.tsx)
- [ ] Run full verification gate suite

---

## 8. Commit

Backend implementation complete. Ready for UI + tests.
