# M7.4D NPS Fail Request Analysis

## Failing Request Details

**Extracted from:** `instructions/M7.4_ROLE_VERIFY_OUTPUT.txt`

### Request Info
| Field | Value |
|-------|-------|
| Method | `GET` |
| Path | `/feedback/analytics/nps-summary` |
| Query Params | **NONE** (missing required `from` and `to`) |
| Headers | `Authorization: Bearer <jwt>` |
| Expected RBAC | L4+ (Manager, Owner, HR, Accountant) |

### Roles Failing
All L4+ roles across both orgs are affected:

**Tapas Bar & Restaurant:**
- `owner@tapas.demo.local` (L5) - ⚠️ 400
- `manager@tapas.demo.local` (L4) - ⚠️ 400
- `accountant@tapas.demo.local` (L4) - ⚠️ 400

**Cafesserie (Franchise):**
- `owner@cafesserie.demo.local` (L5) - ⚠️ 400
- `manager@cafesserie.demo.local` (L4) - ⚠️ 400
- `accountant@cafesserie.demo.local` (L4) - ⚠️ 400

### Error Message
```
Status: ERROR, Message: 400: Request failed
```

## Root Cause Identified

**Issue:** The verifier script at `scripts/verify-role-coverage.ts` line 146 defines:
```typescript
{ endpoint: '/feedback/analytics/nps-summary', method: 'GET', minLevel: 'L4', description: 'NPS summary' },
```

**Problem:** No `params` object is provided, but the endpoint requires:
- `from` - ISO date string (required by `@IsDateString()`)
- `to` - ISO date string (required by `@IsDateString()`)

**DTO Definition** (`src/feedback/dto/feedback.dto.ts`):
```typescript
export class NpsSummaryQueryDto {
  @IsOptional()
  @IsString()
  branchId?: string;

  @IsDateString()
  from!: string;  // REQUIRED

  @IsDateString()
  to!: string;    // REQUIRED

  @IsOptional()
  @IsEnum(FeedbackChannel)
  channel?: FeedbackChannel;
}
```

## Fix Required

1. **Verifier Script**: Add `params: { from, to }` to the NPS endpoint test
2. **Optional API Enhancement**: Make `from`/`to` default to last 30 days if omitted (defensive)
