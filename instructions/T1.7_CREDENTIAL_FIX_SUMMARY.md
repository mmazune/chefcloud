# T1.7: E2E Auth/Seed Credential Fix Summary

**Date:** 2025-12-27  
**Task:** Eliminate systemic E2E auth/seed mismatches causing widespread 401s  
**Status:** ‚úÖ Core Credential Fix COMPLETE

---

## Problem Statement

### Baseline (T1.6 Results)
- **14 test suites** (31.8% of failures) failing with `401 Unauthorized` errors
- Root cause: **Credential mismatch** between E2E tests and demo seed data

### Investigation Findings

**Wrong Credentials in Tests:**
```typescript
// ‚ùå OLD (WRONG)
email: 'owner@demo.local'
password: 'Owner#123'

// ‚ùå Also found:
email: 'demo@chefcloud.dev'
password: 'demo123'
```

**Correct Seed Data:**
```typescript
// ‚úÖ CORRECT (from prisma/demo/constants.ts)
email: 'owner@tapas.demo.local'
password: 'Demo#123'  // ALL users share this password
```

**Pattern:**
- Seed creates users with `{role}@{org}.demo.local` emails (e.g., `owner@tapas.demo.local`)
- ALL demo users share password: `Demo#123`
- Two orgs: Tapas Bar (`tapas-bar`) and Cafesserie (`cafesserie`)

---

## Solution Implemented

### 1. Created Canonical Credential Source
**File:** `test/helpers/e2e-credentials.ts`

```typescript
export const E2E_DEMO_PASSWORD = 'Demo#123';

export const TAPAS_CREDENTIALS = {
  owner: {
    email: 'owner@tapas.demo.local',
    password: E2E_DEMO_PASSWORD,
    roleLevel: 'L5',
    firstName: 'Alice',
    lastName: 'Owner',
  },
  manager: { ... },
  waiter: { ... },
  // ... all seed roles
};

export const E2E_USERS = TAPAS_CREDENTIALS;  // Default
```

### 2. Updated Shared Login Helper
**File:** `test/helpers/e2e-login.ts`

```typescript
import { E2E_USERS } from './e2e-credentials';

export async function loginAs(app, role, org='tapas') {
  const credentials = E2E_USERS[role];
  const response = await request(app.getHttpServer())
    .post('/auth/login')
    .send({
      email: credentials.email,
      password: credentials.password,
    });
  
  return {
    token: response.body.access_token,
    user: response.body.user,
  };
}
```

### 3. Updated Test Files to Use Helpers

**Files Fixed:**
1. ‚úÖ `test/auth.e2e-spec.ts` - All login tests
2. ‚úÖ `test/a3-pos.e2e-spec.ts` - Waiter login
3. ‚úÖ `test/m1-kds-enterprise.e2e-spec.ts` - Waiter + manager logins
4. ‚úÖ `test/e23-roles-access.e2e-spec.ts` - Multi-role login tests
5. ‚úÖ `test/e24-subscriptions.e2e-spec.ts` - Owner + waiter logins
6. ‚úÖ `test/msr-card.e2e-spec.ts` - Owner login

**Changes Applied:**
```typescript
// ‚úÖ BEFORE (wrong credentials)
const loginResponse = await request(app.getHttpServer())
  .post('/auth/login')
  .send({
    email: 'owner@demo.local',
    password: 'Owner#123',
  });
const token = loginResponse.body.access_token;

// ‚úÖ AFTER (correct credentials)
import { E2E_USERS } from './helpers/e2e-credentials';

const loginResponse = await request(app.getHttpServer())
  .post('/auth/login')
  .send({
    email: E2E_USERS.owner.email,
    password: E2E_USERS.owner.password,
  });
const token = loginResponse.body.access_token;  // Note: API returns access_token (snake_case)
```

### 4. Fixed Non-Existent User References

**Problem:** `test/e23-roles-access.e2e-spec.ts` tried to login as users that don't exist in seed:
- `ticketmaster@demo.local` ‚ùå ‚Üí `supervisor@tapas.demo.local` ‚úÖ
- `assistantmgr@demo.local` ‚ùå ‚Üí `stock@tapas.demo.local` ‚úÖ  
- `assistantchef@demo.local` ‚ùå ‚Üí `chef@tapas.demo.local` ‚úÖ
- `headbarista@demo.local` ‚ùå ‚Üí `bartender@tapas.demo.local` ‚úÖ

**Solution:** Mapped to equivalent role levels from actual seed data.

---

## Validation Results

### Incremental Test Results

**test/auth.e2e-spec.ts:**
```
‚úÖ 12/16 tests PASSING (75%)
‚úÖ All email/password login tests PASS
‚ùå 4 PIN/MSR tests fail (unrelated to credential fix)
```

**test/a3-pos.e2e-spec.ts:**
```
‚úÖ Login succeeds (200 OK)
‚ùå Test fails later due to menu data issues (not auth)
```

**Key Improvement:**
- **BEFORE:** Login fails with 401 Unauthorized
- **AFTER:** Login succeeds with 200 OK ‚úÖ

### API Response Field Note

**Important Discovery:**
- API returns `access_token` (snake_case), not `accessToken` (camelCase)
- All tests must use `response.body.access_token`
- This is correct per `src/auth/dto/auth.dto.ts`:
  ```typescript
  export interface AuthResponse {
    access_token: string;  // ‚úÖ CORRECT
    user: { ... };
  }
  ```

---

## Files Modified

### Core Helper Files (Created/Updated)
- `test/helpers/e2e-credentials.ts` - Canonical credential source
- `test/helpers/e2e-login.ts` - Shared login helper

### Test Files Fixed (6 files)
1. `test/auth.e2e-spec.ts`
2. `test/a3-pos.e2e-spec.ts`
3. `test/m1-kds-enterprise.e2e-spec.ts`
4. `test/e23-roles-access.e2e-spec.ts`
5. `test/e24-subscriptions.e2e-spec.ts`
6. `test/msr-card.e2e-spec.ts`

### Remaining Slice Tests (Skipped)
- `test/e2e/auth.slice.e2e-spec.ts` - Uses MockAuthService, not real seed data

---

## Expected Impact

### Before Fix (Baseline)
- **14 test suites** failing with auth/seed issues
- Total: **129 failed tests** across these suites
- Error pattern: `expected 200 OK, got 401 Unauthorized`

### After Fix (Predicted)
- Auth/seed failures: **14 ‚Üí <5 suites** (65%+ reduction)
- Tests now using correct credentials from seed
- Systematic fix prevents future credential drift

### Additional Benefits
1. **Single Source of Truth:** All tests import from `e2e-credentials.ts`
2. **Seed Alignment:** Credentials match `prisma/demo/constants.ts` exactly
3. **Maintainability:** Future seed changes only require updating one file
4. **Type Safety:** Helper functions provide better IDE support

---

## Remaining Work

### Not Fixed in This Task
1. **Slice tests** using MockAuthService (intentionally different credentials)
2. **PIN login tests** - Seed data may not have PINs configured
3. **MSR badge tests** - Seed data may not have MSR cards
4. **Menu data issues** in POS tests (separate from auth)

### Recommended Follow-Up Tasks
1. Run full E2E suite to measure actual impact
2. Verify seed data exists in database (run `pnpm prisma db seed` if needed)
3. Fix PIN/MSR tests if seed supports these features
4. Update any remaining test files with credential mismatches

---

## Lessons Learned

1. **Credential Drift:** Tests hardcoded credentials that diverged from seed over time
2. **Response Fields:** API uses snake_case (`access_token`) not camelCase
3. **User Mapping:** Tests referenced non-existent users, needed mapping to real roles
4. **Systematic Approach:** Helper files + imports prevent future divergence

---

## Success Metrics

**Baseline ‚Üí After:**
- ‚úÖ Login tests: 401 errors ‚Üí 200 OK
- ‚úÖ Central credential management established
- ‚úÖ 6 critical test files updated
- üîÑ Full suite results pending (running in background)

**Target:**
- Auth/seed failure reduction: **65%+** (14 ‚Üí <5 suites)
- Zero hardcoded credentials in updated test files
