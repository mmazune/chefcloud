# M7.3A Testing & Verification Guide

**Quick Start:** How to run and verify the seed completeness fix

---

## âš¡ Quick Test (5 minutes)

### Step 1: Build and Start API
```powershell
cd services/api
pnpm build
pnpm start
```

**Wait for:** "Application is running on: http://[::1]:3001"

### Step 2: Run Seed Script (Terminal 2)
```powershell
cd services/api
npx tsx prisma/demo/seedComprehensive.ts
```

**Expected Output:**
```
ğŸ“Š Seeding Comprehensive Demo Data...

ğŸª‘ Seeding Tables...
  âœ… Created 10 Tapas tables
  âœ… Created 5 Cafesserie Village Mall tables
  âœ… Created 5 Cafesserie Acacia Mall tables
  âœ… Created 5 Cafesserie Arena Mall tables
  âœ… Created 5 Cafesserie Mombasa tables

ğŸ’° Seeding Completed Orders with Payments...
  âœ… Tapas: Created 248 completed orders
  âœ… Village Mall: Created 248 completed orders
  âœ… Acacia Mall: Created 248 completed orders
  âœ… Arena Mall: Created 248 completed orders
  âœ… Mombasa: Created 248 completed orders
  âœ… Total completed orders: 1240

ğŸ“± Seeding OPEN Orders for POS...
  âœ… Tapas: Created 12 open orders
  âœ… Village Mall: Created 12 open orders
  âœ… Acacia Mall: Created 12 open orders
  âœ… Arena Mall: Created 12 open orders
  âœ… Mombasa: Created 12 open orders
  âœ… Total open orders: 60
```

### Step 3: Quick Verification
```powershell
# Check if API is healthy
Invoke-WebRequest -Uri "http://localhost:3001/health"

# Check Tapas orders (should show ~248 closed + 12 open)
Invoke-WebRequest -Uri "http://localhost:3001/api/debug/demo-health" | Select-Object -ExpandProperty Content | ConvertFrom-Json | Select-Object -ExpandProperty tapas

# Check Village Mall orders (should show ~248 closed + 12 open)
Invoke-WebRequest -Uri "http://localhost:3001/api/debug/demo-health" | Select-Object -ExpandProperty Content | ConvertFrom-Json | Select-Object -ExpandProperty cafesserie
```

**Success Criteria:**
- âœ… All 5 branches show > 200 orders
- âœ… Each branch shows ~12 OPEN orders
- âœ… No "0 orders" for any branch

---

## ğŸ” Detailed Verification

### 1. Database Direct Check
```powershell
cd services/api
npx prisma studio
```

Then navigate to:
- **Order** table: Should show ~1300 orders
- Filter by `branchId`: Each branch should have ~260 orders
- Filter by `status = 'CLOSED'`: Should show ~1240 orders
- Filter by `status IN ('NEW','SENT','SERVED')`: Should show ~60 orders

### 2. Test All Branches

#### Tapas (Main Branch)
```powershell
# Analytics
$tapasAnalytics = Invoke-WebRequest -Uri "http://localhost:3001/api/analytics?branchId=00000000-0000-4000-8000-000000000002&startDate=2024-01-01&endDate=2024-12-31" | ConvertFrom-Json
$tapasAnalytics.revenue
$tapasAnalytics.orders.Length

# POS Active Orders
$tapasPOS = Invoke-WebRequest -Uri "http://localhost:3001/api/orders?branchId=00000000-0000-4000-8000-000000000002" | ConvertFrom-Json
$tapasPOS.Count
```

#### Village Mall
```powershell
# Analytics
$villageAnalytics = Invoke-WebRequest -Uri "http://localhost:3001/api/analytics?branchId=00000000-0000-4000-8000-000000000006&startDate=2024-01-01&endDate=2024-12-31" | ConvertFrom-Json
$villageAnalytics.revenue
$villageAnalytics.orders.Length

# POS Active Orders
$villagePOS = Invoke-WebRequest -Uri "http://localhost:3001/api/orders?branchId=00000000-0000-4000-8000-000000000006" | ConvertFrom-Json
$villagePOS.Count
```

#### Acacia Mall
```powershell
# Analytics
$acaciaAnalytics = Invoke-WebRequest -Uri "http://localhost:3001/api/analytics?branchId=00000000-0000-4000-8000-000000000007&startDate=2024-01-01&endDate=2024-12-31" | ConvertFrom-Json
$acaciaAnalytics.revenue
$acaciaAnalytics.orders.Length
```

#### Arena Mall
```powershell
# Analytics
$arenaAnalytics = Invoke-WebRequest -Uri "http://localhost:3001/api/analytics?branchId=00000000-0000-4000-8000-000000000008&startDate=2024-01-01&endDate=2024-12-31" | ConvertFrom-Json
$arenaAnalytics.revenue
$arenaAnalytics.orders.Length
```

#### Mombasa
```powershell
# Analytics
$mombasaAnalytics = Invoke-WebRequest -Uri "http://localhost:3001/api/analytics?branchId=00000000-0000-4000-8000-000000000009&startDate=2024-01-01&endDate=2024-12-31" | ConvertFrom-Json
$mombasaAnalytics.revenue
$mombasaAnalytics.orders.Length
```

**Expected Results for Each Branch:**
- `revenue` > 0 (should be millions in UGX)
- `orders.Length` >= 200 (should be ~248)
- POS active orders: ~12

### 3. Run Automated Health Check
```powershell
cd services/api
npx tsx scripts/verify-demo-health.ts
```

**Expected Output:**
```
ğŸ” ChefCloud Demo Data Health Check
====================================

Testing Tapas Restaurant...
  âœ… Debug endpoint: PASS (248 orders)
  âœ… Analytics: PASS (revenue > 0, top items: 15)
  âœ… POS Orders: PASS (12 active orders)

Testing Cafesserie...
  âœ… Village Mall: PASS (248 orders)
  âœ… Acacia Mall: PASS (248 orders)
  âœ… Arena Mall: PASS (248 orders)
  âœ… Mombasa: PASS (248 orders)

Overall Status: âœ… ALL TESTS PASSED
```

---

## ğŸš¨ Troubleshooting

### Issue: Seed script shows "0 menu items found"

**Cause:** Menu items not seeded yet

**Fix:**
```powershell
cd services/api
pnpm db:seed:menu  # Or run full seed script first
npx tsx prisma/demo/seedComprehensive.ts
```

### Issue: API not running

**Symptoms:** Connection refused errors

**Fix:**
```powershell
cd services/api
pnpm build  # If dist/ folder missing
pnpm start  # Keep this terminal open
```

### Issue: Orders already exist (second run)

**Expected Behavior:** Upsert should succeed silently

**Verification:**
```powershell
# First run: Creates 1300 orders
npx tsx prisma/demo/seedComprehensive.ts

# Second run: Updates 0 orders (all exist)
npx tsx prisma/demo/seedComprehensive.ts
```

Both runs should show same counts (idempotent).

### Issue: Analytics shows "No data"

**Possible Causes:**
1. Wrong branchId in query
2. Date range doesn't overlap with seeded data (last 30 days)
3. Orders exist but missing orderItems or payments

**Debug:**
```powershell
# Check if orders have orderItems
npx prisma studio
# Navigate to OrderItem table, should show ~3000-6000 items
# Check if items reference valid orderId

# Check if CLOSED orders have payments
# Navigate to Payment table, should show ~1240 payments
# Check if payments reference valid orderId
```

### Issue: POS shows no active orders

**Possible Causes:**
1. All orders are CLOSED
2. seedLiveOrders() not called
3. Orders older than 24 hours

**Debug:**
```powershell
# Check order statuses
cd services/api
npx prisma studio
# Navigate to Order table
# Filter by: status NOT IN ('CLOSED', 'CANCELLED')
# Should see ~60 orders with NEW/SENT/SERVED
```

---

## âœ… Success Checklist

After running seed script, verify:

- [ ] Console shows "Created X completed orders" for all 5 branches
- [ ] Console shows "Created X open orders" for all 5 branches
- [ ] Total completed orders: ~1240
- [ ] Total open orders: ~60
- [ ] `/api/debug/demo-health` shows data for all branches
- [ ] Analytics endpoint returns revenue > 0 for each branch
- [ ] POS endpoint returns ~12 active orders per branch
- [ ] Prisma Studio shows ~1300 orders in Order table
- [ ] Prisma Studio shows ~3000-6500 orderItems in OrderItem table
- [ ] Prisma Studio shows ~1240 payments in Payment table

---

## ğŸ¯ Before/After Comparison

### Before M7.3A
```
Tapas:        248 orders (only CLOSED)
Village Mall: 0 orders âŒ
Acacia Mall:  0 orders âŒ
Arena Mall:   0 orders âŒ
Mombasa:      0 orders âŒ
OPEN Orders:  0 across all branches âŒ

Total: 248 orders
```

### After M7.3A
```
Tapas:        248 CLOSED + 12 OPEN = 260 orders âœ…
Village Mall: 248 CLOSED + 12 OPEN = 260 orders âœ…
Acacia Mall:  248 CLOSED + 12 OPEN = 260 orders âœ…
Arena Mall:   248 CLOSED + 12 OPEN = 260 orders âœ…
Mombasa:      248 CLOSED + 12 OPEN = 260 orders âœ…

Total: 1240 CLOSED + 60 OPEN = 1300 orders âœ…
```

---

## ğŸ“Š Expected Database State

```
Table         | Count    | Notes
--------------|---------|-----------------------------------------
Order         | ~1300   | 1240 CLOSED + 60 OPEN
OrderItem     | ~3900   | Avg 3 items per order
Payment       | ~1240   | Only for CLOSED orders
Table         | 30      | 10 Tapas + 20 Cafesserie
Branch        | 5       | 1 Tapas + 4 Cafesserie
```

---

**Last Updated:** 2024-01-XX  
**Related Docs:** M7.3A_COMPLETION_SUMMARY.md, M7.3A_GAP_ANALYSIS.md
