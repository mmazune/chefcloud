# M7.4D Root Cause Analysis

## Issue
NPS summary endpoint returns 400 for all L4+ roles during verification.

## Root Cause Type
**B) Missing required query params in verifier script** (not an API bug)

## Analysis

### 1. Endpoint Definition
- **Path:** `GET /feedback/analytics/nps-summary`
- **Controller:** `services/api/src/feedback/feedback.controller.ts` line 141
- **DTO:** `NpsSummaryQueryDto` at `services/api/src/feedback/dto/feedback.dto.ts` lines 167-182

### 2. DTO Validation Requirements
```typescript
export class NpsSummaryQueryDto {
  @IsOptional()
  @IsString()
  branchId?: string;

  @IsDateString()     // ← REQUIRED (no @IsOptional)
  from!: string;

  @IsDateString()     // ← REQUIRED (no @IsOptional)
  to!: string;

  @IsOptional()
  @IsEnum(FeedbackChannel)
  channel?: FeedbackChannel;
}
```

### 3. Verifier Script Defect
**File:** `scripts/verify-role-coverage.ts` line 146

**Before (broken):**
```typescript
{ endpoint: '/feedback/analytics/nps-summary', method: 'GET', minLevel: 'L4', description: 'NPS summary' },
```

**After (fixed):**
```typescript
{ endpoint: '/feedback/analytics/nps-summary', method: 'GET', params: { from: getDateDaysAgo(30), to: getTodayISO() }, minLevel: 'L4', description: 'NPS summary' },
```

### 4. Why Other Analytics Endpoints Work
Looking at similar L4 endpoints in the same file:

```typescript
// Line 131 - Has params ✓
{ endpoint: '/analytics/daily-metrics', method: 'GET', params: { from: getDateDaysAgo(30), to: getTodayISO() }, minLevel: 'L4', description: 'Daily metrics' },

// Line 132 - Has params ✓
{ endpoint: '/analytics/category-sales', method: 'GET', params: { from: getDateDaysAgo(30), to: getTodayISO() }, minLevel: 'L4', description: 'Category sales' },

// Line 146 - MISSING params ✗
{ endpoint: '/feedback/analytics/nps-summary', method: 'GET', minLevel: 'L4', description: 'NPS summary' },
```

## Fix Applied
Add `params: { from: getDateDaysAgo(30), to: getTodayISO() }` to NPS endpoint entry.

## Verification
After fix:
- All L4+ roles (Owner, Manager, HR, Accountant) should return 200
- NPS data with valid statistics should be returned
- Verifier should show PASS instead of ERROR

## Related Endpoints
The same `from`/`to` params pattern is used by:
- `/analytics/daily-metrics`
- `/analytics/category-sales`
- `/analytics/revenue-trends`
- `/analytics/order-volume`
- `/analytics/table-utilization`
- `/analytics/peak-hours`
