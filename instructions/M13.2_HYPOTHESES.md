# M13.2 POS Ordering Core - Hypotheses

**Date:** 2026-01-08  
**Baseline:** M13.1 complete at commit f0d0c92

## Hypotheses (BEFORE Implementation)

| # | Hypothesis | Confidence | Failure Mode | Verification Method |
|---|------------|------------|--------------|---------------------|
| H1 | Cross-org item access if queries miss orgId filters | HIGH | User in OrgA can add items from OrgB to cart if menuItem lookup doesn't filter by orgId | E2E test: attempt order with item from different org → 404 |
| H2 | Modifier selection validation allows invalid cart states | HIGH | Client submits SINGLE group with 2 selections, or MULTI with count > maxSelect → order created with invalid modifiers | E2E test: exceed max, miss required → 400 INVALID_MODIFIER_SELECTION |
| H3 | Availability evaluation differs between UI and server | MEDIUM | UI shows item available but server rejects (timezone mismatch, stale client cache) | E2E test: item with rule outside current time → 403 ITEM_UNAVAILABLE |
| H4 | Pricing snapshot drift if recomputing from mutable menu data | HIGH | Menu price changed after order creation, order.total recalculated differently in reports | E2E test: verify snapshotPriceCents stored on OrderItem, not recomputed |
| H5 | Idempotency key collisions create duplicates or wrong replays | MEDIUM | Same X-Idempotency-Key with different payload returns wrong order or creates duplicate | E2E test: same key twice → same order ID returned, no duplicate lines |
| H6 | Export hash mismatch due to BOM/newline/ordering differences (Windows) | MEDIUM | CSV export on Windows has CRLF, hash computed with LF → mismatch | E2E test: verify X-Nimbus-Export-Hash = SHA-256 of response body |
| H7 | Route ordering shadows /pos/menu with /pos/:id | HIGH | GET /pos/menu returns 404 because :id param captures "menu" | Declare /pos/menu BEFORE /pos/:id in controller |
| H8 | Tests hang due to unclosed app/server or lingering timers | HIGH | E2E test suite doesn't exit, --forceExit required | Use cleanup(), no setInterval/setTimeout without cleanup |
| H9 | Branch scoping violation allows ordering for wrong branch | MEDIUM | User authenticated for Branch A can submit order for Branch B items | E2E test: item from different branch → 400 BRANCH_SCOPE_VIOLATION |

## Critical Implementation Guards

1. **Modifier enforcement**: Check min/max/required on server BEFORE order creation
2. **Snapshot storage**: Store itemNameSnapshot, basePriceCentsSnapshot, selectedModifiersSnapshot on OrderItem
3. **Org/Branch scoping**: All item lookups MUST include orgId AND branchId filters
4. **Idempotency**: Use existing IdempotencyInterceptor + check for existing order by idempotency key
5. **Route ordering**: Static routes (/pos/menu) before parameterized (/pos/:id)
