# M10.12 Parity Re-Audit

> **Status:** `PRE-IMPLEMENTATION`
> **Created:** 2026-01-04
> **Milestone:** M10.12

---

## Pre-Implementation Assessment

This document will be updated AFTER implementation to provide evidence-based parity verdicts.

---

## Feature Groups

### 1. Labor Targets CRUD

**Reference Patterns:**
- Nimbus: CompensationComponent CRUD pattern (compensation.service.ts)
- Kimai: Activity configuration (STUDY-ONLY)

**Target Behavior:**
- Org-level defaults with branch override
- RBAC: L4+ write, L3+ read
- Unique constraint: (orgId, branchId, roleKey, dayOfWeek, hourStart)

**Status:** PENDING

---

### 2. Forecast Generation

**Reference Patterns:**
- Nimbus: remittance.service.ts inputsHash pattern
- Kimai: Report snapshotting (STUDY-ONLY)

**Target Behavior:**
- Deterministic: same inputs â†’ same inputsHash
- Idempotent: returns existing if inputsHash matches
- Data sources: reservations covers + historical orders

**Status:** PENDING

---

### 3. Staffing Plan Generation

**Reference Patterns:**
- Nimbus: PayrollRun generation (payroll-run.service.ts)

**Target Behavior:**
- Requires forecast snapshot (FK)
- Produces StaffingPlanLine per hour per role
- Idempotent: one plan per (branchId, date, forecastSnapshotId)

**Status:** PENDING

---

### 4. Variance Report

**Reference Patterns:**
- Nimbus: WorkforceReportingService scheduled vs actual

**Target Behavior:**
- Compare ScheduledShift counts vs StaffingPlanLine suggested
- Filter shifts by status (exclude CANCELLED/VOID)
- Output per hour per role

**Status:** PENDING

---

### 5. Alerts Generation

**Reference Patterns:**
- Nimbus: Notification logging pattern

**Target Behavior:**
- Compute from variance delta
- Severity thresholds: LOW (10-20%), MED (20-40%), HIGH (>40%)
- Unique constraint prevents duplicates
- Resolve action sets resolvedAt

**Status:** PENDING

---

### 6. CSV Exports

**Reference Patterns:**
- Nimbus: payroll-export.service.ts UTF8_BOM + escapeCsvValue

**Target Behavior:**
- Headers as first row
- Proper escaping for commas/quotes/newlines
- Content-Type: text/csv
- Content-Disposition: attachment

**Status:** PENDING

---

### 7. UI Pages

**Reference Patterns:**
- Nimbus: existing workforce pages (my-schedule, payroll-runs)

**Target Behavior:**
- LaborTargetsPage: CRUD with branch selector
- StaffingPlannerPage: date picker, generate buttons, plan table
- StaffingAlertsPage: list with filters, resolve action

**Status:** PENDING

---

### 8. RBAC Enforcement

**Reference Patterns:**
- Nimbus: @Roles decorator pattern (scheduling.controller.ts)

**Target Behavior:**
- L4+ for write operations
- L3+ for read operations
- L1/L2 get 403 on all endpoints

**Status:** PENDING

---

### 9. Idempotency

**Reference Patterns:**
- Nimbus: unique constraints + findFirst pattern

**Target Behavior:**
- ForecastSnapshot: unique (orgId, branchId, date, inputsHash)
- StaffingPlan: unique (orgId, branchId, date, forecastSnapshotId)
- StaffingAlert: unique (orgId, branchId, date, hour, type)

**Status:** PENDING

---

## Post-Implementation Parity Matrix

| Feature Group | Verdict | Evidence |
|---------------|---------|----------|
| Labor Targets | TBD | |
| Forecast | TBD | |
| Staffing Plan | TBD | |
| Variance | TBD | |
| Alerts | TBD | |
| CSV Exports | TBD | |
| UI Pages | TBD | |
| RBAC | TBD | |
| Idempotency | TBD | |

---

## Post-Implementation Notes

*(To be filled after implementation)*
