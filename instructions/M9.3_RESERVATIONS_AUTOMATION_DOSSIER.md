# M9.3 Reservations Automation + Host Ops – Dossier

## Module Overview

**Version:** M9.3  
**Status:** Complete  
**Date:** 2025-01-24  

### Purpose

M9.3 extends the Reservations module with:
1. **Automation Runner** – Scheduled tasks for hold expiry, waitlist promotion, and reminders
2. **Host Operations** – "Today Board" view with real-time status tracking
3. **Capacity Management** – Per-slot capacity limits with availability checking
4. **No-Show Grace Period** – Configurable grace window with conditional deposit forfeiture

---

## Features Implemented

### AC-01: Hold Expiry Automation
- Policy field: `autoExpireHeldEnabled: Boolean`
- Cron-based runner expires HELD reservations older than `holdExpiryMinutes`
- Creates AutomationLog entries for audit trail

### AC-02: Waitlist Auto-Promotion
- Policy field: `waitlistAutoPromote: Boolean`
- When cancellation/expiry occurs, eligible waitlist entry is auto-promoted
- Links via `WaitlistEntry.promotedToResId`
- Manual trigger endpoint: `POST /reservations/trigger-waitlist-promotion`

### AC-03: Reminder Scheduling
- Policy fields: `reminderEnabled: Boolean`, `reminderLeadMinutes: Int`
- Automation runner sends reminders at configured lead time
- Respects notification channel preferences (SMS/Email/Push)

### AC-04: Slot Availability
- Existing endpoint: `GET /reservations/slots`
- Returns available time slots considering existing reservations

### AC-05: Capacity Checking
- Policy field: `maxCapacityPerSlot: Int`
- Endpoint: `POST /reservations/check-capacity`
- Response includes `{ available, currentCount, maxCapacity, remainingSeats }`

### AC-06: No-Show Grace Period + Deposit Forfeiture
- Policy field: `noShowGraceMinutes: Int`
- Endpoint: `POST /reservations/:id/no-show-with-grace`
- Within grace: marks as NO_SHOW, no forfeiture
- Past grace: marks as NO_SHOW + forfeits deposit (if PAID)

### AC-07: Today Board (Host View)
- Endpoint: `GET /reservations/today-board`
- Returns: date, reservations (filterable by status), waitlist, stats
- Stats include counts by status (held, confirmed, seated, etc.)

### AC-08: Host Actions
- Confirm: `POST /reservations/:id/confirm`
- Seat: `POST /reservations/:id/seat`
- Complete: `POST /reservations/:id/complete`
- No-Show: `POST /reservations/:id/no-show-with-grace`
- Cancel: `POST /reservations/:id/cancel`
- All actions create audit entries

### AC-09: Calendar Refresh Key
- Endpoint: `GET /reservations/calendar-refresh-key`
- Returns ETag/timestamp for cache invalidation
- UI polls to detect changes without full data refresh

### AC-10: Unified Status Taxonomy
- Reservation: `HELD → CONFIRMED → SEATED → COMPLETED` or `NO_SHOW` or `CANCELLED`
- Waitlist: `WAITING → NOTIFIED → SEATED` or `LEFT` or `CANCELLED`
- All transitions logged

### AC-11: RBAC Enforcement
- Host operations require L2+ (Cashier/Supervisor or above)
- Automation triggers require L3+ (Manager or above)
- Frontend redirects unauthorized users

### AC-12: Audit Logging (AutomationLog)
- New model: `AutomationLog { id, branchId, actionType, reservationId, waitlistEntryId, details, createdAt }`
- Endpoint: `GET /reservations/automation-logs`
- Filterable by actionType, date range

---

## Schema Changes

```prisma
model ReservationPolicy {
  // ... existing fields ...
  
  // M9.3 additions
  autoExpireHeldEnabled Boolean @default(false)
  waitlistAutoPromote   Boolean @default(false)
  reminderEnabled       Boolean @default(false)
  reminderLeadMinutes   Int     @default(60)
  maxCapacityPerSlot    Int?
  noShowGraceMinutes    Int     @default(15)
}

model WaitlistEntry {
  // ... existing fields ...
  promotedToResId String? // M9.3: Link to promoted reservation
}

model AutomationLog {
  id              String    @id @default(cuid())
  branchId        String
  actionType      String    // EXPIRE_HELD, PROMOTE_WAITLIST, SEND_REMINDER, etc.
  reservationId   String?
  waitlistEntryId String?
  details         Json?
  createdAt       DateTime  @default(now())
  
  @@index([branchId, actionType, createdAt])
}
```

---

## New Services

### AutomationService (`automation.service.ts`)
- `processExpiredHolds(branchId)` – Finds and cancels expired HELD reservations
- `processReminders(branchId)` – Sends reminders for upcoming confirmed reservations
- `tryAutoPromoteWaitlist(branchId)` – Promotes next eligible waitlist entry
- `handleNoShowWithGrace(reservationId)` – Applies grace period logic
- `checkCapacity(branchId, dateTime, partySize)` – Validates slot availability
- `getAutomationLogs(branchId, filters)` – Returns filtered audit logs

### HostOpsService (`host-ops.service.ts`)
- `getTodayBoard(branchId, filters)` – Returns today's reservations + stats
- `getUpcoming(branchId, days)` – Returns future reservations
- `getTableStatuses(branchId)` – Returns table availability map
- `getCalendarRefreshKey(branchId)` – Returns cache invalidation key

---

## API Endpoints Added

| Method | Path | Description |
|--------|------|-------------|
| GET | `/reservations/today-board` | Host today view |
| GET | `/reservations/upcoming` | Future reservations |
| GET | `/reservations/table-statuses` | Table availability |
| GET | `/reservations/calendar-refresh-key` | Cache key for polling |
| POST | `/reservations/check-capacity` | Validate slot capacity |
| GET | `/reservations/automation-logs` | Audit log entries |
| POST | `/reservations/trigger-waitlist-promotion` | Manual promotion trigger |
| POST | `/reservations/:id/no-show-with-grace` | No-show with grace logic |

---

## Frontend Components

### TodayBoardPage (`/reservations/today-board`)
- Real-time reservation list with status badges
- Waitlist section with wait times
- Stats dashboard (by status)
- Host action buttons with confirmation dialogs
- Auto-refresh every 30 seconds
- RBAC-enforced (redirects L1 users)

---

## Testing

E2E test file: `services/api/test/e2e/reservations-m93-automation.e2e-spec.ts`

- **32+ test cases** covering all 12 acceptance criteria
- Tests grouped by AC for traceability
- No unbounded waits (uses `.ok(() => true)` pattern)

---

## Migration Notes

1. Run `prisma migrate dev` to apply schema changes
2. Update cron jobs to include M9.3 automation runners
3. Configure reminder channels in notification settings

---

## Related Milestones

- M9.1: Core reservations CRUD
- M9.2: Enterprise ops (deposits, policies, notifications)
- M10: Waitlist Management
