# M10.1 Parity Re-Audit: Workforce Core

> **Created:** 2026-01-03  
> **Milestone:** M10.1  
> **Reference System:** Kimai (AGPL-3.0, STUDY-only)

---

## 1. Feature-by-Feature Comparison

### A) Shift Scheduling

| Behavior | Kimai Pattern | Nimbus Current | Nimbus M10.1 Target | Evidence |
|----------|---------------|----------------|---------------------|----------|
| **Shift Templates** | N/A (activity templates) | None | ShiftTemplate model with name, role, times, breakPolicy | New model |
| **Shift Status Lifecycle** | N/A (timesheets have status) | DutyShift has no status | DRAFT→PUBLISHED→IN_PROGRESS→COMPLETED→APPROVED + CANCELLED | ShiftStatus enum |
| **Conflict Detection** | Allows overlap (different projects) | No validation | Rejects same-user overlap | `checkShiftConflicts()` |
| **Duration Bounds** | No limit | No validation | Configurable 1-16 hour default | Validation in DTO |
| **Batch Publish** | N/A | N/A | Publish all DRAFT in date range | `/shifts/publish` endpoint |
| **Role Assignment** | Activity-based | roleSlug on DutyShift | role/jobRole on Shift | Schema field |

**Verdict: EXCEEDS** - Kimai doesn't have shift scheduling; we add full lifecycle.

### B) Timeclock Operations

| Behavior | Kimai Pattern | Nimbus Current | Nimbus M10.1 Target | Evidence |
|----------|---------------|----------------|---------------------|----------|
| **Start/Stop Model** | Click to start timer | clockIn/clockOut methods | Same pattern with shift attachment | `clockIn()`, `clockOut()` |
| **Shift Attachment** | Project/activity link | Not linked to DutyShift | TimeEntry.shiftId required | Schema FK |
| **Single Active Entry** | One running timer | Checks for open entry | Same | Existing validation |
| **Grace Window** | N/A | N/A | 15-min early clock-in | Policy config |
| **Self-Service Only** | User creates own entries | userId from auth | Same + L4+ override | RBAC check |
| **Unscheduled Clock-In** | Allowed (freestyle) | Allowed | Denied by default (policy) | Validation |

**Verdict: MEETS** - Kimai patterns adapted with shift-attachment requirement.

### C) Break Tracking

| Behavior | Kimai Pattern | Nimbus Current | Nimbus M10.1 Target | Evidence |
|----------|---------------|----------------|---------------------|----------|
| **Break Deduction** | Auto-deduct config | Not tracked | Manual break start/end | BreakEntry model |
| **Break Duration** | Computed from config | N/A | Sum of BreakEntry durations | `breakMinutes` field |
| **Multiple Breaks** | Single deduction | N/A | Multiple BreakEntry per TimeEntry | 1:N relation |

**Verdict: MEETS** - Manual tracking aligns with enterprise audit needs.

### D) Approvals Workflow

| Behavior | Kimai Pattern | Nimbus Current | Nimbus M10.1 Target | Evidence |
|----------|---------------|----------------|---------------------|----------|
| **Approval Scope** | Timesheet entry level | TimeEntry.approved flag | Shift-level approval | Shift.status = APPROVED |
| **Freeze on Approval** | Locks timesheet | Just sets flag | Freezes actualMinutes, etc. | Business logic |
| **Approval RBAC** | Team lead / Admin | L3+ | L4 Manager / L5 Owner | Guard check |
| **Batch Approval** | Multi-select | N/A | Deferred to M10.2 | Out of scope |

**Verdict: MEETS** - Shift-level approval with freeze behavior.

### E) Labor Reporting

| Behavior | Kimai Pattern | Nimbus Current | Nimbus M10.1 Target | Evidence |
|----------|---------------|----------------|---------------------|----------|
| **Aggregation** | Duration per project | Hours per employee | Planned vs actual, per-role, per-user | `/reports/labor` |
| **Overtime Calc** | Based on daily limit | Basic overtimeMinutes | Same + aggregation | Report service |
| **Date Range Filter** | Required | Required | Required | Query params |
| **Branch Filter** | N/A (team-based) | branchId optional | branchId required | Query params |

**Verdict: EXCEEDS** - Planned vs actual comparison not in Kimai.

### F) CSV Exports

| Behavior | Kimai Pattern | Nimbus Current | Nimbus M10.1 Target | Evidence |
|----------|---------------|----------------|---------------------|----------|
| **Export Format** | CSV/Excel/PDF | CSV only | CSV | Response type |
| **Shift Export Headers** | N/A | N/A | id, branchId, userId, userName, role, startAt, endAt, plannedMinutes, actualMinutes, status, approvedAt | `/export/shifts` |
| **Timeclock Export Headers** | user, date, project, duration | Basic | id, userId, userName, shiftId, clockInAt, clockOutAt, totalMinutes, breakMinutes, overtimeMinutes, approved | `/export/timeclock` |
| **Status Filter** | approved/pending | N/A | Include COMPLETED + APPROVED only | Query validation |

**Verdict: MEETS** - Industry-standard CSV with relevant headers.

### G) Audit Logging

| Behavior | Kimai Pattern | Nimbus Current | Nimbus M10.1 Target | Evidence |
|----------|---------------|----------------|---------------------|----------|
| **Activity Log** | Tracks changes | None for workforce | WorkforceAuditLog model | New model |
| **Actions Logged** | Create/update/delete | N/A | CREATED, UPDATED, PUBLISHED, CANCELLED, APPROVED, CLOCK_IN, CLOCK_OUT, BREAK_START, BREAK_END | Enum values |
| **Actor Tracking** | userId | N/A | performedById | Schema field |
| **Metadata** | Change details | N/A | JSON payload field | Schema field |

**Verdict: MEETS** - Comprehensive audit trail for scheduling operations.

---

## 2. Permission Model Comparison

| Kimai Role | Nimbus Equivalent | Scheduling | Timeclock | Approvals | Reports |
|------------|-------------------|------------|-----------|-----------|---------|
| Admin | L5 Owner | Full | Full + override | Full | Full |
| Team Lead | L4 Manager | Full | Full + override | Full | Full |
| User | Staff (L1-L2) | Own view | Self only | None | None |
| N/A | L3 Supervisor | Limited | Self only | None (deferred) | None |
| N/A | Accountant | None | None | None | Read-only |

---

## 3. Database Model Evidence

### New Models

```prisma
enum ShiftStatus {
  DRAFT
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  APPROVED
  CANCELLED
}

model ShiftTemplate {
  id               String   @id @default(cuid())
  orgId            String
  branchId         String?  // null = org-wide
  name             String
  role             String   // jobRole slug
  defaultStartTime String   // HH:mm format
  defaultEndTime   String   // HH:mm format
  breakPolicy      Json?    // { breakMinutes: 30, unpaid: true }
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Shift {
  id              String      @id @default(cuid())
  orgId           String
  branchId        String
  userId          String
  role            String
  startAt         DateTime
  endAt           DateTime
  plannedMinutes  Int
  actualMinutes   Int?
  breakMinutes    Int?
  overtimeMinutes Int?
  notes           String?
  status          ShiftStatus @default(DRAFT)
  publishedAt     DateTime?
  approvedAt      DateTime?
  approvedById    String?
  cancelledAt     DateTime?
  cancelledById   String?
  cancelReason    String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model BreakEntry {
  id          String    @id @default(cuid())
  timeEntryId String
  startedAt   DateTime
  endedAt     DateTime?
  minutes     Int?
  createdAt   DateTime  @default(now())
}

model WorkforceAuditLog {
  id            String   @id @default(cuid())
  orgId         String
  action        String   // SHIFT_CREATED, CLOCK_IN, etc.
  entityType    String   // Shift, TimeEntry, etc.
  entityId      String
  performedById String
  payload       Json?
  createdAt     DateTime @default(now())
}
```

### Modified Models

```prisma
model TimeEntry {
  // Existing fields...
  shiftId String?  // NEW: Link to scheduled shift
  
  shift Shift? @relation(fields: [shiftId], references: [id])
}
```

---

## 4. Endpoint Evidence

| Endpoint | Method | RBAC | Request | Response |
|----------|--------|------|---------|----------|
| `/workforce/templates` | GET | L4+ | `?branchId=` | ShiftTemplate[] |
| `/workforce/templates` | POST | L4+ | CreateTemplateDto | ShiftTemplate |
| `/workforce/templates/:id` | PUT | L4+ | UpdateTemplateDto | ShiftTemplate |
| `/workforce/templates/:id` | DELETE | L4+ | - | void |
| `/workforce/shifts` | GET | L3+ (filtered) | `?branchId=&from=&to=&status=` | Shift[] |
| `/workforce/shifts` | POST | L4+ | CreateShiftDto | Shift |
| `/workforce/shifts/:id` | PUT | L4+ | UpdateShiftDto | Shift |
| `/workforce/shifts/:id` | DELETE | L4+ (DRAFT only) | - | void |
| `/workforce/shifts/publish` | POST | L4+ | `{ branchId, from, to }` | Shift[] |
| `/workforce/timeclock/clock-in` | POST | Auth | `{ shiftId }` | TimeEntry |
| `/workforce/timeclock/clock-out` | POST | Auth | - | TimeEntry |
| `/workforce/timeclock/break-start` | POST | Auth | - | BreakEntry |
| `/workforce/timeclock/break-end` | POST | Auth | - | BreakEntry |
| `/workforce/timeclock/status` | GET | Auth | - | { active: TimeEntry?, todayShift: Shift? } |
| `/workforce/approvals` | GET | L4+ | `?branchId=` | Shift[] (COMPLETED) |
| `/workforce/approvals/:id/approve` | POST | L4+ | - | Shift |
| `/workforce/reports/labor` | GET | L4+ or Accountant | `?branchId=&from=&to=` | LaborReport |
| `/workforce/reports/export/shifts` | GET | L4+ or Accountant | `?branchId=&from=&to=` | CSV |
| `/workforce/reports/export/timeclock` | GET | L4+ or Accountant | `?branchId=&from=&to=` | CSV |

---

## 5. Final Parity Verdict

| Feature Group | Verdict | Rationale |
|---------------|---------|-----------|
| A) Shift Scheduling | **EXCEEDS** | Full status lifecycle not in Kimai |
| B) Timeclock | **MEETS** | Start/stop with shift attachment |
| C) Break Tracking | **MEETS** | Manual tracking, enterprise audit |
| D) Approvals | **MEETS** | Shift-level with freeze behavior |
| E) Reporting | **EXCEEDS** | Planned vs actual comparison |
| F) Exports | **MEETS** | Standard CSV with relevant headers |
| G) Audit | **MEETS** | Comprehensive action logging |

**Overall: MEETS/EXCEEDS** - Nimbus M10.1 implementation meets or exceeds Kimai patterns where applicable, with enterprise-grade additions for shift scheduling lifecycle and planned-vs-actual reporting.
