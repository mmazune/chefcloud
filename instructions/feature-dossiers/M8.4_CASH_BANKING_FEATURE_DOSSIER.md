# Feature Dossier: M8.4 Cash/Banking + Partial Payments + Payment Ledger

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-02  
> **Author:** Claude (Claude Opus 4.5)  
> **Milestone:** M8.4  

---

## 1. Scope

### 1.1 Feature Summary

M8.4 delivers enterprise-grade cash/bank account management, payment method → GL account mapping, and partial payment support for both AP (Vendor Bills) and AR (Customer Invoices). This enables realistic payment tracking where bills/invoices can be paid in installments, with each payment properly posted to the GL using the correct cash/bank account based on payment method.

### 1.2 In Scope

- **PaymentMethodMapping model**: Org-scoped mapping of PaymentMethod → GL Account
- **PARTIALLY_PAID status**: Add to BillStatus and InvoiceStatus enums
- **Partial payment for AP**: VendorPayment supports partial amounts, auto-updates bill status
- **Partial payment for AR**: CustomerReceipt supports partial amounts, auto-updates invoice status
- **Outstanding amount tracking**: Compute remaining balance per bill/invoice
- **Payment method → account resolution**: Payments post to correct Cash/Bank/Clearing account
- **Period lock enforcement**: On payment/receipt postings
- **Overpayment prevention**: Validation at API layer
- **Seed upgrades**: Add PARTIALLY_PAID examples to DEMO_TAPAS and DEMO_CAFESSERIE
- **E2E tests**: Minimum 8 tests covering all acceptance criteria

### 1.3 Out of Scope

- Multi-currency payments (deferred to future milestone)
- Credit notes / refunds (deferred)
- Payment reconciliation workflows
- UI pages (backend-only milestone)
- Payment batching / bulk payments
- Payment approval workflows

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| schema.prisma | DB | Add PaymentMethodMapping, update enums |
| accounting.service.ts | API | Partial payment logic, method mapping |
| accounting.controller.ts | API | New endpoints for mappings |
| seedDemo.ts | Seed | Add PARTIALLY_PAID examples |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| payment_method_mappings | CREATE | PaymentMethod → Account mapping |
| vendor_bills | ALTER | Add paidAmount field for tracking |
| customer_invoices | ALTER | Add paidAmount field for tracking |
| (enums) BillStatus | ALTER | Add PARTIALLY_PAID |
| (enums) InvoiceStatus | ALTER | Add PARTIALLY_PAID |
| (enums) PaymentMethod | ALTER | Add BANK_TRANSFER, MOBILE_MONEY |

### 1.6 API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /accounting/payment-methods | List payment method mappings for org |
| POST | /accounting/payment-methods | Create/update payment method mapping |
| GET | /accounting/vendor-bills/:id/outstanding | Get outstanding amount |
| GET | /accounting/customer-invoices/:id/outstanding | Get outstanding amount |
| POST | /accounting/vendor-payments | Enhanced: supports partial, validates mapping |
| POST | /accounting/customer-receipts | Enhanced: supports partial, validates mapping |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| (Backend only) | N/A | M8.4 is backend-focused; UI in future milestone |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

- VendorBill with DRAFT, OPEN, PAID, VOID statuses (no PARTIALLY_PAID)
- CustomerInvoice with DRAFT, OPEN, PAID, VOID statuses (no PARTIALLY_PAID)
- VendorPayment creates GL entries but doesn't track partial payments
- CustomerReceipt creates GL entries but doesn't track partial payments
- PaymentMethod enum: CASH, CARD, MOMO (no mapping to GL accounts)
- No explicit Cash/Bank account designation in seed
- Payments use account name search ("Cash", "Bank") which is fragile

### 2.2 Gaps and Limitations

- No PARTIALLY_PAID status - bills/invoices jump from OPEN to PAID
- No paidAmount tracking on bills/invoices
- No PaymentMethod → Account mapping table
- Payment GL posting searches by name, not explicit mapping
- No validation for overpayment
- Seed lacks PARTIALLY_PAID examples

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| M8.3 AP/AR GL Posting | Complete | Uses: Journal creation patterns |
| M8.2b Period Lock | Complete | Uses: Period lock check |
| GL Accounts | Complete | Uses: Account table |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| bigcapital | AP/AR | AGPL-3.0 | STUDY-ONLY | Partial payment patterns |
| killbill | Billing | Apache-2.0 | ADAPT-OK | Payment allocation logic |
| hledger | Accounting | GPL-3.0 | STUDY-ONLY | Account mapping concepts |

### 3.2 Clean Room Protocol Applied

- ✅ STUDY-ONLY for AGPL repos (bigcapital)
- ✅ No code copied from copyleft repos
- ✅ Patterns extracted conceptually only
- ✅ Implementation written from scratch

### 3.3 Patterns Studied

#### bigcapital: Partial Payment Tracking
- Bills have `amountPaid` field
- Status computed: if `amountPaid == 0` → OPEN, if `amountPaid < total` → PARTIAL, if `amountPaid >= total` → PAID
- Each payment records against specific bill

#### killbill: Payment Allocation
- Invoice has balance tracking
- Payments allocated to invoices
- InvoiceItem level tracking for complex scenarios
- State machine: DRAFT → COMMITTED → PAID

#### hledger: Account Mapping
- Accounts have types (Asset, Liability, etc.)
- Cash accounts are explicit
- Transactions post to specific accounts, not search-by-name

---

## 4. Domain Invariants

### 4.1 Business Rules

| ID | Rule | Enforcement |
|----|------|-------------|
| BR-01 | paidAmount cannot exceed total | API validation |
| BR-02 | Payment amount must be positive | API validation |
| BR-03 | OPEN bill → PARTIALLY_PAID when 0 < paidAmount < total | Service logic |
| BR-04 | PARTIALLY_PAID bill → PAID when paidAmount >= total | Service logic |
| BR-05 | PaymentMethod must have mapping to create payment GL | Service validation |
| BR-06 | Period lock blocks payment/receipt creation | API check with 403 |
| BR-07 | Only OPEN or PARTIALLY_PAID docs can receive payments | API validation |

### 4.2 Data Invariants

| ID | Invariant | How Enforced |
|----|-----------|--------------|
| DI-01 | paidAmount >= 0 | DB constraint + API |
| DI-02 | paidAmount <= total | API validation |
| DI-03 | PaymentMethodMapping unique per (orgId, method) | DB unique constraint |
| DI-04 | Every payment/receipt has journalEntryId | Service sets on create |

### 4.3 State Machine

```
VendorBill / CustomerInvoice State Machine (M8.4):

                                    payment
  DRAFT ─────► OPEN ────────────────────────────► PAID
                │                                   ▲
                │                                   │
                │      partial payment              │ final payment
                └───────────────────► PARTIALLY_PAID ┘
                                           │
                                           │ void
                                           ▼
                                         VOID

State Transitions:
- DRAFT → OPEN: Creates GL entry (existing M8.3)
- OPEN → PARTIALLY_PAID: When payment received but paidAmount < total
- OPEN → PAID: When single payment covers full amount
- PARTIALLY_PAID → PAID: When subsequent payment makes paidAmount >= total
- OPEN/PARTIALLY_PAID/PAID → VOID: Creates reversal entry
```

---

## 5. Data Model

### 5.1 Entity Definitions

```prisma
// M8.4: Payment Method Mapping
model PaymentMethodMapping {
  id        String        @id @default(cuid())
  orgId     String
  method    PaymentMethod // CASH, CARD, MOMO, BANK_TRANSFER, MOBILE_MONEY
  accountId String        // GL account for this payment method
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  account   Account       @relation(fields: [accountId], references: [id])
  
  @@unique([orgId, method])
  @@index([orgId])
  @@map("payment_method_mappings")
}

// Updates to VendorBill
model VendorBill {
  // ... existing fields ...
  paidAmount Decimal @default(0) @db.Decimal(12, 2) // M8.4: Track payments
}

// Updates to CustomerInvoice  
model CustomerInvoice {
  // ... existing fields ...
  paidAmount Decimal @default(0) @db.Decimal(12, 2) // M8.4: Track payments
}

// Updates to enums
enum BillStatus {
  DRAFT
  OPEN
  PARTIALLY_PAID // M8.4: New
  PAID
  VOID
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PARTIALLY_PAID // M8.4: New
  PAID
  VOID
}

enum PaymentMethod {
  CASH
  CARD
  MOMO
  BANK_TRANSFER    // M8.4: New
  MOBILE_MONEY     // M8.4: New (alias for MOMO in some contexts)
}
```

### 5.2 Entity Relationships

```
PaymentMethodMapping ────────► Account (GL Account)
        │
        │ (org-scoped)
        │
VendorPayment.method ◄────────┘
CustomerReceipt.method ◄──────┘
```

### 5.3 Indexes

| Table | Index | Type | Rationale |
|-------|-------|------|-----------|
| payment_method_mappings | orgId, method | unique | One mapping per method per org |

### 5.4 Migration Strategy

- [x] New migration file needed
- [ ] Data migration required (paidAmount defaults to 0)
- [x] Backward compatible: YES

---

## 6. UX Requirements

### 6.1 User Stories

| ID | As a... | I want to... | So that... |
|----|---------|--------------|------------|
| US-01 | Accountant | Record partial vendor payments | I can track installment payments |
| US-02 | Accountant | See outstanding balance on bills | I know how much is still owed |
| US-03 | Accountant | Have payments post to correct cash account | My cash accounts are accurate |
| US-04 | Accountant | Record partial customer receipts | I can track customer payment plans |
| US-05 | Accountant | Be blocked from overpayment | I can't create invalid data |

### 6.2 Validation Messages

| Field | Validation | Message |
|-------|------------|---------|
| payment.amount | Must not exceed outstanding | "Payment amount $X exceeds outstanding balance $Y" |
| payment.amount | Must be positive | "Payment amount must be greater than zero" |
| payment.method | Must have mapping | "No GL account mapped for payment method: X" |
| bill.status | Must be OPEN or PARTIALLY_PAID | "Bill must be in OPEN or PARTIALLY_PAID status to accept payment" |

---

## 7. Failure Modes

### 7.1 Error Scenarios

| ID | Scenario | Expected Behavior | HTTP Code |
|----|----------|-------------------|-----------|
| ERR-01 | Payment exceeds outstanding | BadRequestException with amounts | 400 |
| ERR-02 | Payment method not mapped | BadRequestException | 400 |
| ERR-03 | Bill not in payable state | BadRequestException | 400 |
| ERR-04 | Period locked | ForbiddenException | 403 |
| ERR-05 | Negative payment amount | BadRequestException | 400 |
| ERR-06 | Bill/Invoice not found | NotFoundException | 404 |

### 7.2 Rollback Scenarios

| Scenario | Rollback Action |
|----------|-----------------|
| Journal creation fails | Transaction rollback, no payment recorded |
| Status update fails | Transaction rollback, revert paidAmount |

---

## 8. Security Considerations

### 8.1 Authorization

| Action | Required Role(s) | Tenant Isolation |
|--------|------------------|------------------|
| Create payment | accountant, manager, owner | YES (orgId check) |
| View mappings | any authenticated | YES |
| Create/update mappings | accountant, manager, owner | YES |

### 8.2 Input Validation

| Input | Validation Rules |
|-------|-----------------|
| amount | Positive decimal, ≤ 2 decimal places |
| method | Must be valid PaymentMethod enum |
| billId | Must exist and belong to org |

---

## 9. Acceptance Criteria

### 9.1 Functional Criteria

| ID | Criterion | Verification Method |
|----|-----------|---------------------|
| AC-01 | PaymentMethodMapping created for org with seeded accounts | E2E |
| AC-02 | Vendor payment posts to mapped account (not name search) | E2E |
| AC-03 | Partial payment transitions bill to PARTIALLY_PAID | E2E |
| AC-04 | Final payment transitions bill to PAID | E2E |
| AC-05 | Overpayment rejected with 400 | E2E |
| AC-06 | Customer receipt posts to mapped account | E2E |
| AC-07 | Partial receipt transitions invoice to PARTIALLY_PAID | E2E |
| AC-08 | Period lock blocks payment posting with 403 | E2E |

### 9.2 Non-Functional Criteria

| ID | Criterion | Target | Verification |
|----|-----------|--------|--------------|
| NF-01 | Payment creation response time | < 500ms | Manual |
| NF-02 | Seed includes 2+ PARTIALLY_PAID per dataset | Count | Seed verify |

---

## 10. E2E Expansions

### 10.1 Required Test Coverage

| Acceptance Criterion | Test Count | Dataset |
|---------------------|------------|---------|
| AC-01 | 1 | DEMO_TAPAS |
| AC-02 | 1 | DEMO_TAPAS |
| AC-03 | 1 | DEMO_TAPAS |
| AC-04 | 1 | DEMO_TAPAS |
| AC-05 | 1 | DEMO_TAPAS |
| AC-06 | 1 | DEMO_TAPAS |
| AC-07 | 1 | DEMO_TAPAS |
| AC-08 | 1 | DEMO_TAPAS |

### 10.2 E2E File Location

```
services/api/test/e2e/accounting-m84-partial-payments.e2e-spec.ts
```

---

## 11. Verification Gates

### 11.1 Pre-Implementation

- [x] Feature dossier created
- [x] Reference repos studied
- [x] Schema changes planned

### 11.2 Post-Implementation

```bash
# Gate 1: Linting
timeout 120s pnpm lint

# Gate 2: E2E teardown check
timeout 30s pnpm -C services/api test:e2e:teardown-check

# Gate 3: M8.4 E2E tests
timeout 600s pnpm -C services/api test:e2e -- --runInBand --runTestsByPath test/e2e/accounting-m84-partial-payments.e2e-spec.ts
```

### 11.3 Verification Timestamp

- **Completed:** [PENDING]
- **Lint:** [PENDING]
- **E2E tests:** [PENDING]

---

## Appendix: GL Account Mapping

For M8.4, the following standard mappings are seeded:

| PaymentMethod | Default Account | Account Type |
|---------------|-----------------|--------------|
| CASH | Cash on Hand (1000) | ASSET |
| CARD | Card Clearing (1020) | ASSET |
| MOMO | Mobile Money Clearing (1030) | ASSET |
| BANK_TRANSFER | Bank Account (1010) | ASSET |
| MOBILE_MONEY | Mobile Money Clearing (1030) | ASSET |
