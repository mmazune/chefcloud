# Feature Dossier: Role UX Foundation (M8.1)

> **Status:** `COMPLETE`  
> **Created:** 2026-01-02  
> **Author:** ChefCloud Team  
> **Milestone:** M8.1  

---

## 1. Scope

### 1.1 Feature Summary

M8.1 establishes a role-optimized user experience foundation for ChefCloud. It introduces persistent `jobRole` assignment for all demo users, role-based post-login routing, and a centralized role capability configuration that drives navigation and landing pages. Previously, all roles (Owner, Manager, Accountant, etc.) saw identical UI after login. Now each role lands on a specialized workspace with role-appropriate navigation.

### 1.2 In Scope

- Populate `jobRole` for all demo seed users (11 Tapas + 8 Cafesserie)
- Return `jobRole` in JWT payload and `/me` endpoint response
- Create `roleCapabilities.ts` as single source of truth for role UX
- Implement role-based post-login routing (different landing pages per role)
- Replace scattered minRole navigation logic with config-driven navGroups
- Create placeholder workspace pages for each role (8 workspaces)
- Update verification scripts to assert jobRole presence

### 1.3 Out of Scope

- Role-specific dashboard widgets (M8.2)
- Deep link protection based on roleCapabilities (M8.3)
- Role-specific quick actions (M8.4)
- Mobile-optimized role workspaces (M8.5)
- Actual workspace functionality (placeholder only)

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| services/api | API | JWT payload, /me endpoint, auth DTOs |
| apps/web | UI | AuthContext, Sidebar, role workspaces |
| prisma/demo | Shared | Demo seed data with jobRole |
| scripts | Tooling | Verification scripts |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| users | READ | Uses existing jobRole column (migration 20251229114833) |

### 1.6 API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /auth/login | Now returns user.jobRole in response |
| GET | /me | Now returns jobRole field |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| WorkspacePlaceholder | - | Reusable component for role workspace pages |
| OwnerWorkspace | /workspaces/owner | Owner landing page |
| ManagerWorkspace | /workspaces/manager | Manager landing page |
| AccountantWorkspace | /workspaces/accountant | Accountant landing page |
| ProcurementWorkspace | /workspaces/procurement | Procurement landing page |
| StockManagerWorkspace | /workspaces/stock-manager | Stock Manager landing page |
| SupervisorWorkspace | /workspaces/supervisor | Supervisor landing page |
| ChefWorkspace | /workspaces/chef | Chef/Kitchen landing page |
| EventManagerWorkspace | /workspaces/event-manager | Event Manager landing page |
| Sidebar | - | Updated to use roleCapabilities navGroups |

---

## 2. Current Nimbus State

### 2.1 What Existed Before M8.1

- `jobRole` column existed in users table (migration 20251229114833)
- Demo users were created WITHOUT jobRole populated (all NULL)
- `/me` endpoint did NOT return jobRole
- All users landed on `/dashboard` after login regardless of role
- Sidebar navigation used scattered `minRole` checks instead of central config

### 2.2 Gaps and Limitations Addressed

- Demo users now have jobRole populated matching their functional role
- jobRole is included in auth responses for frontend consumption
- Each role has a dedicated landing workspace
- Navigation is tailored per role via roleCapabilities.ts

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| T1.12a (JobRole schema) | Complete | Uses |
| M7.4 (Demo seeding) | Complete | Uses |
| M8.2 (Role dashboard widgets) | Planned | Depends on M8.1 |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| N/A | - | - | - | Internal design based on ChefCloud architecture |

---

## 4. Technical Design

### 4.1 roleCapabilities.ts Structure

```typescript
interface RoleCapability {
  defaultRoute: string;           // Post-login landing page
  dashboardVariant: DashboardVariant; // Dashboard style
  navGroups: NavGroup[];          // Sidebar navigation groups
  workspaceTitle: string;         // Workspace page title
  workspaceDescription: string;   // Workspace page description
}

const ROLE_CAPABILITIES: Record<JobRole, RoleCapability> = {
  OWNER: { ... },
  MANAGER: { ... },
  // ... all 11 roles
};
```

### 4.2 Helper Functions

- `getRoleCapabilities(jobRole)` - Get config for role (with fallback to CASHIER)
- `getDefaultRoute(jobRole)` - Get landing route for post-login redirect
- `getAllNavItems(jobRole)` - Flatten all nav items for route checking
- `isRouteAccessible(jobRole, route)` - Check if role can access a route

### 4.3 Post-Login Flow

1. User submits login credentials
2. Backend validates and returns `{ accessToken, user: { jobRole, ... } }`
3. Frontend stores user in AuthContext
4. AuthContext calls `getDefaultRoute(user.jobRole)`
5. Router navigates to role-specific workspace (e.g., `/workspaces/manager`)
6. Sidebar renders navGroups from `getRoleCapabilities(user.jobRole)`

---

## 5. Role Configuration Matrix

| JobRole | Default Route | Dashboard | Workspace Title |
|---------|---------------|-----------|-----------------|
| OWNER | /workspaces/owner | full | Owner Headquarters |
| MANAGER | /workspaces/manager | operational | Manager Hub |
| ACCOUNTANT | /workspaces/accountant | finance | Finance Center |
| PROCUREMENT | /workspaces/procurement | inventory | Procurement Center |
| STOCK_MANAGER | /workspaces/stock-manager | inventory | Inventory Hub |
| SUPERVISOR | /workspaces/supervisor | operational | Shift Command |
| CASHIER | /pos | pos | Point of Sale |
| CHEF | /workspaces/chef | kds | Kitchen Hub |
| WAITER | /pos | pos | Table Service |
| BARTENDER | /pos | pos | Bar Station |
| EVENT_MANAGER | /workspaces/event-manager | events | Events Center |

---

## 6. Testing

### 6.1 Verification Scripts

| Script | Purpose | Output |
|--------|---------|--------|
| verify-role-nav.ts | Output role configs | M8.1_ROLE_NAV_VERIFY_OUTPUT.txt |
| verify-role-coverage.ts | Assert jobRole in /me | M7.4_ROLE_VERIFY_OUTPUT.txt |

### 6.2 Manual Testing

```bash
# 1. Seed database
E2E_DATASET=ALL pnpm -C services/api test:e2e:setup

# 2. Start services
pnpm -C services/api start:dev
pnpm -C apps/web dev

# 3. Login as different roles and verify landing page
- owner@tapas.demo.local → /workspaces/owner
- accountant@tapas.demo.local → /workspaces/accountant
- cashier@tapas.demo.local → /pos
```

---

## 7. Files Changed

### Backend

- `services/api/prisma/demo/constants.ts` - Added jobRole to demo users
- `services/api/prisma/demo/seedDemo.ts` - Added jobRole to upsert
- `services/api/src/auth/jwt.strategy.ts` - Added jobRole to JwtPayload
- `services/api/src/auth/auth.service.ts` - Added jobRole to response
- `services/api/src/auth/dto/auth.dto.ts` - Added jobRole to AuthResponse
- `services/api/src/me/me.controller.ts` - Added jobRole to /me response

### Frontend

- `apps/web/src/config/roleCapabilities.ts` - **NEW** Central config
- `apps/web/src/lib/auth.ts` - Added jobRole to types
- `apps/web/src/contexts/AuthContext.tsx` - Role-based routing
- `apps/web/src/pages/index.tsx` - Role-based redirect
- `apps/web/src/components/layout/Sidebar.tsx` - Config-driven nav
- `apps/web/src/components/workspace/WorkspacePlaceholder.tsx` - **NEW**
- `apps/web/src/pages/workspaces/*.tsx` - **NEW** 8 workspace pages

### Scripts

- `scripts/verify-role-coverage.ts` - Added jobRole verification
- `scripts/verify-role-nav.ts` - **NEW** Role nav verification

---

## 8. Acceptance Criteria

| Criteria | Status |
|----------|--------|
| All demo users have jobRole populated | ✅ |
| /me returns jobRole | ✅ |
| Login response includes user.jobRole | ✅ |
| Post-login routes to role-specific workspace | ✅ |
| Sidebar shows role-appropriate navigation | ✅ |
| Verification scripts pass | ✅ |
| Lint passes (0 errors) | ✅ |
| E2E core tests pass | ✅ |

---

## 9. Rollback Plan

If issues arise:
1. Revert roleCapabilities.ts changes
2. Restore original Sidebar.tsx with minRole logic
3. Restore original AuthContext.tsx with hardcoded /dashboard route
4. jobRole in database is additive and safe to leave

---

## 10. Future Enhancements

- M8.2: Role-specific dashboard widgets
- M8.3: Deep link protection using isRouteAccessible()
- M8.4: Role-specific quick actions
- M8.5: Mobile-optimized role workspaces
- Role capability editor in admin panel
