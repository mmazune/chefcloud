# Feature Dossier: M8.3 AP/AR Document Lifecycle + GL Posting

> **Status:** `COMPLETE`  
> **Created:** 2026-01-07  
> **Completed:** 2026-01-02  
> **Author:** Claude (Claude Opus 4.5)  
> **Milestone:** M8.3  

---

## 1. Scope

### 1.1 Feature Summary

Implement enterprise-grade Accounts Payable (AP) and Accounts Receivable (AR) document lifecycles with automatic posting to the General Ledger. VendorBills and CustomerInvoices transition through a full lifecycle (DRAFT → OPEN → PAID/VOID) with each state change creating appropriate journal entries that are immediately POSTED. Payments also create journal entries (AP reduction vs Cash/Bank, AR reduction vs Cash/Bank). Period lock is enforced - documents dated in a locked period cannot transition to OPEN.

### 1.2 In Scope

- VendorBill lifecycle: DRAFT → OPEN (with GL posting) → PAID (with payment GL) + VOID (with reversal GL)
- CustomerInvoice lifecycle: DRAFT → OPEN (with GL posting) → PAID (with receipt GL) + VOID (with reversal GL)
- VendorPayment GL posting: Debit AP, Credit Cash/Bank
- CustomerReceipt creation and GL posting: Debit Cash/Bank, Credit AR
- Period lock enforcement on OPEN transition (403 if period locked)
- GL integration fields on VendorBill and CustomerInvoice
- Seed hardening: 10+ vendor bills and 10+ customer invoices per org
- E2E tests: ≥2 per acceptance criterion

### 1.3 Out of Scope

- Multi-currency AP/AR (deferred to M8.4)
- Partial payments with complex allocation (bills/invoices are paid in full or tracked via separate payment records)
- Purchase orders / Sales orders (separate feature)
- Vendor credits / Customer credits (separate feature)
- Payment reconciliation workflows

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| accounting.service.ts | API | Core business logic for AP/AR + GL posting |
| accounting.controller.ts | API | HTTP endpoints for lifecycle transitions |
| schema.prisma | DB | Add GL integration fields to VendorBill and CustomerInvoice |
| demo-seed.ts | Seed | Add 10+ bills/invoices per org |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| vendor_bills | ALTER | Add journalEntryId, openedAt, openedById |
| customer_invoices | ALTER | Add journalEntryId, openedAt, openedById, memo |
| journal_entries | READ | Create entries when bills/invoices open or payments made |

### 1.6 API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /accounting/vendors/bills | Create vendor bill (DRAFT) |
| POST | /accounting/vendors/bills/:id/open | Open bill → Creates GL entry |
| POST | /accounting/vendors/bills/:id/void | Void bill → Creates reversal entry |
| POST | /accounting/vendors/payments | Create payment → Creates payment GL |
| POST | /accounting/customers | Create customer |
| POST | /accounting/customers/invoices | Create invoice (DRAFT) |
| POST | /accounting/customers/invoices/:id/open | Open invoice → Creates GL entry |
| POST | /accounting/customers/invoices/:id/void | Void invoice → Creates reversal entry |
| POST | /accounting/customers/receipts | Create receipt → Creates receipt GL |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| (Backend only) | N/A | M8.3 is backend-focused; UI in future milestone |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

- VendorBill model with DRAFT, OPEN, PAID, VOID statuses
- CustomerInvoice model with DRAFT, OPEN, PAID, VOID statuses
- `openVendorBill()` - Transitions DRAFT → OPEN but does NOT create journal entry
- `createVendorPayment()` - Creates payment and marks bill PAID but does NOT create journal entry
- AP/AR aging reports (getAPAging, getARAging) - Work correctly for OPEN status
- JournalEntry lifecycle from M8.2b: DRAFT → POSTED → REVERSED with period lock

### 2.2 Gaps and Limitations

- VendorBill has no GL integration - opening a bill doesn't create an expense/liability entry
- CustomerInvoice has no GL integration - opening an invoice doesn't create AR/revenue entry
- VendorPayment doesn't create a payment journal (should debit AP, credit Cash)
- No CustomerReceipt entity for customer payments
- No period lock enforcement on bill/invoice opening
- Schema lacks journalEntryId foreign key on bills/invoices
- Aging reports don't filter by POSTED journal status (but this is OK - aging is about document status)

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| M8.2b Journal Lifecycle | Complete | Uses: JournalEntry with POSTED status |
| Chart of Accounts | Complete | Uses: Account for AP, AR, Expense, Revenue |
| Period Lock | Complete | Uses: FiscalPeriod.status for lock check |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| bigcapital | accounting | AGPL-3.0 | STUDY-ONLY | Full AP/AR lifecycle with GL integration |
| killbill | billing | Apache-2.0 | ADAPT | Invoice state machine patterns |

### 3.2 Key Files to Study

| Repo | File Path | Focus Area |
|------|-----------|------------|
| bigcapital | packages/server/src/modules/Bills/commands/BillsGLEntries.ts | How bills write to ledger |
| bigcapital | packages/server/src/modules/Bills/commands/OpenBill.service.ts | Bill opening pattern |
| bigcapital | packages/server/src/modules/Ledger/LedgerStorage.service.ts | Ledger storage abstraction |

### 3.3 Concepts Extracted

> **Note:** STUDY-ONLY - concepts documented in own words, no code copied.

#### From bigcapital:

1. **Bill GL Entry Pattern**: When a bill is "opened" (approved), create a journal entry:
   - DEBIT: Expense/Inventory account (per line item) or a general Expense account
   - CREDIT: Accounts Payable liability account
   - Total must balance

2. **Payment GL Entry Pattern**: When payment is made for a bill:
   - DEBIT: Accounts Payable (reduces liability)
   - CREDIT: Cash/Bank asset account

3. **Reference Linking**: Bills store a `transactionType` and `transactionId` on journal entries to link back to the source document.

4. **Ledger Storage Service**: Abstract layer that handles creating balanced journal entries with proper validation.

5. **Invoice GL Entry Pattern** (from SaleInvoices module):
   - DEBIT: Accounts Receivable asset account
   - CREDIT: Revenue account(s) + Tax Payable (if tax)

6. **Receipt GL Entry Pattern**:
   - DEBIT: Cash/Bank asset
   - CREDIT: Accounts Receivable (reduces asset)

---

## 4. Domain Invariants

### 4.1 Business Rules

| ID | Rule | Enforcement |
|----|------|-------------|
| BR-01 | Bills can only transition DRAFT → OPEN → PAID/VOID | API validation |
| BR-02 | Opening a bill in a locked period is forbidden (403) | API period lock check |
| BR-03 | Journal entries from bill/invoice opening are auto-POSTED (not DRAFT) | Service logic |
| BR-04 | Payment amount cannot exceed remaining bill balance | API validation |
| BR-05 | Voiding a bill creates a reversal journal entry | Service logic |
| BR-06 | Only OPEN bills can be paid or voided | API validation |
| BR-07 | Same rules apply to CustomerInvoice | API validation |

### 4.2 Data Invariants

| ID | Invariant | How Enforced |
|----|-----------|--------------|
| DI-01 | Every OPEN bill has a linked journalEntryId | Service sets on open |
| DI-02 | Every payment has a linked journalEntryId | Service sets on create |
| DI-03 | Journal entries created from bills have source='VENDOR_BILL' | Hardcoded value |
| DI-04 | Journal entries created from invoices have source='CUSTOMER_INVOICE' | Hardcoded value |

### 4.3 State Machine

```
VendorBill / CustomerInvoice State Machine:

  DRAFT ────────────────► OPEN ────────────────► PAID
                           │                       │
                           │                       │
                           └──────► VOID ◄─────────┘
                                     │
                                     └─ (creates reversal journal)

State Transitions:
- DRAFT → OPEN: createJournalEntry (auto-POSTED), set openedAt, openedById, journalEntryId
- OPEN → PAID: Triggered when payments >= total
- OPEN → VOID: createReversalJournalEntry (auto-POSTED), set status=VOID
- PAID → VOID: createReversalJournalEntry (auto-POSTED), set status=VOID
```

---

## 5. Data Model

### 5.1 Entity Definitions

```prisma
// Changes to VendorBill
model VendorBill {
  // ... existing fields ...
  
  // M8.3: GL Integration
  journalEntryId String?       // Links to GL entry when OPEN
  openedAt       DateTime?     // When bill was opened
  openedById     String?       // User who opened the bill
  
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])
}

// Changes to CustomerInvoice  
model CustomerInvoice {
  // ... existing fields ...
  
  // M8.3: GL Integration
  memo           String?       // Invoice memo
  journalEntryId String?       // Links to GL entry when OPEN
  openedAt       DateTime?     // When invoice was opened
  openedById     String?       // User who opened the invoice
  
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])
}

// New: CustomerReceipt (for AR payments)
model CustomerReceipt {
  id             String   @id @default(cuid())
  orgId          String
  customerId     String
  invoiceId      String?  // Optional link to specific invoice
  amount         Decimal  @db.Decimal(12, 2)
  receivedAt     DateTime @default(now())
  method         String   // CASH, CARD, MOMO, BANK
  ref            String?  // Payment reference
  journalEntryId String?  // Links to GL entry
  metadata       Json?
  createdAt      DateTime @default(now())
  
  customer       CustomerAccount   @relation(fields: [customerId], references: [id])
  invoice        CustomerInvoice?  @relation(fields: [invoiceId], references: [id])
  journalEntry   JournalEntry?     @relation(fields: [journalEntryId], references: [id])
  
  @@index([orgId])
  @@index([customerId])
  @@index([invoiceId])
  @@map("customer_receipts")
}

// Add to VendorPayment
model VendorPayment {
  // ... existing fields ...
  journalEntryId String?       // M8.3: Links to GL entry
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])
}
```

### 5.2 Entity Relationships

```
VendorBill 1──────* VendorPayment
     │                    │
     └───────────────────►│ (both link to)
                          ▼
                    JournalEntry

CustomerInvoice 1──────* CustomerReceipt
     │                        │
     └────────────────────────┘►
                          ▼
                    JournalEntry
```

### 5.3 Indexes

| Table | Index | Type | Rationale |
|-------|-------|------|-----------|
| vendor_bills | journalEntryId | btree | FK lookup |
| customer_invoices | journalEntryId | btree | FK lookup |
| customer_receipts | orgId, customerId | btree | Tenant + customer filtering |

### 5.4 Migration Strategy

- [x] New migration file needed
- [ ] Data migration required (no - new fields default null)
- [x] Backward compatible: YES (all new fields are optional)

---

## 6. UX Requirements

### 6.1 User Stories

| ID | As a... | I want to... | So that... |
|----|---------|--------------|------------|
| US-01 | Accountant | Open a vendor bill and see a journal entry created | My AP liability is properly recorded in the GL |
| US-02 | Accountant | Record a vendor payment and see AP reduced | My cash and liability accounts stay accurate |
| US-03 | Accountant | Open a customer invoice and see AR recorded | My receivables are tracked in the GL |
| US-04 | Accountant | Record a customer receipt and see AR reduced | Cash receipts are properly recorded |
| US-05 | Accountant | Be blocked from opening bills in locked periods | I can't accidentally post to closed periods |
| US-06 | Accountant | Void a bill and see the GL reversed | Mistakes can be corrected without orphaned entries |

### 6.2 Screen Mockups

N/A - M8.3 is backend-focused.

### 6.3 User Flows

```
AP Workflow:
1. Create vendor bill (DRAFT)
2. Review bill details
3. Call POST /bills/:id/open
4. System creates journal entry (POSTED), returns bill with journalEntryId
5. When ready to pay, call POST /vendors/payments
6. System creates payment journal entry, marks bill PAID if fully paid

AR Workflow:
1. Create customer invoice (DRAFT) 
2. Review invoice
3. Call POST /invoices/:id/open
4. System creates journal entry (POSTED)
5. When payment received, call POST /customers/receipts
6. System creates receipt journal entry, marks invoice PAID if fully paid
```

### 6.4 Validation Messages

| Field | Validation | Message |
|-------|------------|---------|
| bill.status | Must be DRAFT to open | "Bill must be in DRAFT status to open" |
| period | Must not be locked | "Cannot open bill in locked fiscal period: {name}" |
| payment.amount | Cannot exceed balance | "Payment amount exceeds remaining bill balance" |

---

## 7. Failure Modes

### 7.1 Error Scenarios

| ID | Scenario | Expected Behavior | HTTP Code |
|----|----------|-------------------|-----------|
| ERR-01 | Open bill in locked period | ForbiddenException with period name | 403 |
| ERR-02 | Open bill not in DRAFT | BadRequestException | 400 |
| ERR-03 | Pay bill not in OPEN | BadRequestException | 400 |
| ERR-04 | Bill not found | NotFoundException | 404 |
| ERR-05 | Payment exceeds balance | BadRequestException | 400 |
| ERR-06 | Account not found for GL posting | BadRequestException (log error) | 400 |

### 7.2 Rollback Scenarios

| Scenario | Rollback Action |
|----------|-----------------|
| Journal creation fails during open | Transaction rollback, bill stays DRAFT |
| Payment journal fails | Transaction rollback, no payment recorded |

### 7.3 Concurrency Handling

- All state transitions use Prisma transactions to ensure atomicity
- No optimistic locking currently (acceptable for single-org usage patterns)

---

## 8. Security Considerations

### 8.1 Authentication

- [x] Requires authenticated user
- [ ] Supports API key access
- [ ] Public endpoint

### 8.2 Authorization

| Action | Required Role(s) | Tenant Isolation |
|--------|------------------|------------------|
| Open bill | accountant, manager, owner | YES (orgId check) |
| Create payment | accountant, manager, owner | YES |
| Void bill | accountant, manager, owner | YES |

### 8.3 Input Validation

| Input | Validation Rules |
|-------|-----------------|
| billId | Must be valid cuid, must belong to org |
| paymentAmount | Must be positive number, must not exceed balance |
| userId | Must be authenticated user |

### 8.4 Audit Logging

| Event | Log Level | Data Captured |
|-------|-----------|---------------|
| Bill opened | INFO | billId, journalEntryId, userId |
| Payment created | INFO | paymentId, billId, amount, journalEntryId |
| Bill voided | INFO | billId, reversalEntryId, userId |

### 8.5 Security Checklist

- [x] OWASP input validation applied
- [x] SQL injection prevented (parameterized queries via Prisma)
- [x] XSS prevented (API-only, no HTML output)
- [ ] CSRF protection (handled by auth layer)
- [ ] Rate limiting (not needed for internal accounting)

---

## 9. Acceptance Criteria

### 9.1 Functional Criteria

| ID | Criterion | Verification Method |
|----|-----------|---------------------|
| AC-01 | Opening a VendorBill in DRAFT creates a POSTED journal entry (Debit Expense, Credit AP) | E2E |
| AC-02 | Opening a VendorBill in a locked period returns 403 | E2E |
| AC-03 | Creating a VendorPayment creates a POSTED journal entry (Debit AP, Credit Cash) | E2E |
| AC-04 | Voiding an OPEN VendorBill creates a reversal entry and sets status VOID | E2E |
| AC-05 | Opening a CustomerInvoice creates a POSTED journal entry (Debit AR, Credit Revenue) | E2E |
| AC-06 | Opening a CustomerInvoice in a locked period returns 403 | E2E |
| AC-07 | Creating a CustomerReceipt creates a POSTED journal entry (Debit Cash, Credit AR) | E2E |
| AC-08 | Voiding an OPEN CustomerInvoice creates a reversal entry | E2E |
| AC-09 | Trial balance includes GL entries from opened bills/invoices/payments | E2E |

### 9.2 Non-Functional Criteria

| ID | Criterion | Target | Verification |
|----|-----------|--------|--------------|
| NF-01 | Open bill response time | < 500ms | Manual test |
| NF-02 | Seed includes 10+ bills and 10+ invoices per org | Count check | Seed verification |

### 9.3 DATA_PERSISTENCE Compliance

Per DATA_PERSISTENCE_AND_CONSISTENCY_STANDARD.md:

- [x] No orphaned database columns (all new fields are used)
- [x] No stub endpoints returning 501 (all endpoints implemented)
- [x] No UI buttons that don't work (no UI in this milestone)
- [x] All layers complete (DB → API → Service → Seed → Reports → E2E)

---

## 10. E2E Expansions

### 10.1 Required Test Coverage

| Acceptance Criterion | Test Count | Dataset |
|---------------------|------------|---------|
| AC-01 | 2 | DEMO_TAPAS |
| AC-02 | 2 | DEMO_TAPAS |
| AC-03 | 2 | DEMO_TAPAS |
| AC-04 | 2 | DEMO_TAPAS |
| AC-05 | 2 | DEMO_TAPAS |
| AC-06 | 2 | DEMO_TAPAS |
| AC-07 | 2 | DEMO_TAPAS |
| AC-08 | 2 | DEMO_TAPAS |
| AC-09 | 2 | DEMO_TAPAS |

### 10.2 New E2E Tests

| Test Name | Description | Dataset | Timeout |
|-----------|-------------|---------|---------|
| ap-lifecycle-open-creates-gl | Open bill creates POSTED journal | DEMO_TAPAS | 30s |
| ap-lifecycle-locked-period-403 | Open bill in locked period returns 403 | DEMO_TAPAS | 30s |
| ap-payment-creates-gl | Vendor payment creates journal entry | DEMO_TAPAS | 30s |
| ap-void-creates-reversal | Void bill creates reversal entry | DEMO_TAPAS | 30s |
| ar-lifecycle-open-creates-gl | Open invoice creates POSTED journal | DEMO_TAPAS | 30s |
| ar-lifecycle-locked-period-403 | Open invoice in locked period returns 403 | DEMO_TAPAS | 30s |
| ar-receipt-creates-gl | Customer receipt creates journal entry | DEMO_TAPAS | 30s |
| ar-void-creates-reversal | Void invoice creates reversal entry | DEMO_TAPAS | 30s |
| trial-balance-includes-ap-ar | Trial balance shows AP/AR entries | DEMO_TAPAS | 30s |

### 10.3 E2E File Locations

```
services/api/test/e2e/
├── accounting/
│   ├── ap-lifecycle.e2e-spec.ts   (new)
│   ├── ar-lifecycle.e2e-spec.ts   (new)
```

---

## 11. Verification Gates

### 11.1 Pre-Implementation

- [x] Feature dossier reviewed
- [x] Reference repos studied (STUDY-ONLY pattern applied)
- [x] Schema changes planned

### 11.2 Post-Implementation

```bash
# Gate 1: Linting
timeout 120s pnpm lint

# Gate 2: Unit tests  
timeout 300s pnpm test

# Gate 3: E2E tests (includes new tests)
timeout 600s pnpm test:e2e:gate

# Gate 4: Teardown test (no PII/creds leaked)
pnpm test:e2e:teardown
```

### 11.3 Verification Timestamp

- **Completed:** 2026-01-02T12:05:00Z
- **Lint:** ✅ PASSED (API package, 0 errors, 120 warnings)
- **TypeScript:** ✅ PASSED (no errors)
- **E2E tests:** ✅ 27/27 PASSED (14 M8.3 + 13 M8.2b)
- **Manual QA:** N/A (backend-only feature)

---

## 12. Parity Notes

### 12.1 bigcapital Parity

| Feature | bigcapital | Nimbus M8.3 | Notes |
|---------|------------|-------------|-------|
| Bill → GL on open | ✅ | ✅ | Implemented |
| Payment → GL | ✅ | ✅ | Implemented |
| Invoice → GL | ✅ | ✅ | Implemented |
| Receipt → GL | ✅ | ✅ | Implemented |
| Period lock check | ✅ | ✅ | Implemented |
| Multi-currency | ✅ | ❌ | Deferred to M8.4 |
| Landed costs | ✅ | ❌ | Out of scope |

### 12.2 killbill Parity

| Feature | killbill | Nimbus M8.3 | Notes |
|---------|----------|-------------|-------|
| Invoice lifecycle | ✅ | ✅ | Implemented |
| Payment lifecycle | ✅ | ✅ | Implemented |
| Void/Reversal | ✅ | ✅ | Implemented |
| Complex allocation | ✅ | ❌ | Out of scope |

---

## Appendix: GL Account Mapping

For M8.3, the following standard accounts are used:

| Transaction | Debit Account | Credit Account |
|-------------|---------------|----------------|
| Open VendorBill | 5000 (Expense) or line-item account | 2100 (Accounts Payable) |
| VendorPayment | 2100 (Accounts Payable) | 1100 (Cash/Bank) |
| Open CustomerInvoice | 1200 (Accounts Receivable) | 4000 (Revenue) |
| CustomerReceipt | 1100 (Cash/Bank) | 1200 (Accounts Receivable) |

Note: Actual account codes are fetched by type (AP, AR, CASH, EXPENSE, REVENUE) to allow org-specific CoA customization.
