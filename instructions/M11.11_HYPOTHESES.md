# M11.11 Inventory Barcode + Scanner Ops - Hypotheses

## Pre-Implementation Hypotheses

These hypotheses must be tested before M11.11 is considered complete.

---

### H1: Barcode Resolve Leaks Cross-Org Items

**Hypothesis:** Barcode resolution returns items from other organizations if orgId is not enforced in the query.

**Confidence:** 90% this will occur if WHERE clause omits orgId

**Failure Mode:** Data leakage; security violation (ASVS breach)

**Test Approach:**
1. Create Org A with Item A and barcode "1234567890123"
2. Create Org B with Item B
3. As Org B user, call `/inventory/barcodes/resolve?value=1234567890123`
4. Assert 404 or empty result (NOT Org A's item)
5. Verify no cross-org data in response

---

### H2: Duplicate Barcode Values Permitted

**Hypothesis:** Missing unique constraint on (orgId, value) allows duplicate barcodes within same org.

**Confidence:** 85% if index is index-only not unique constraint

**Failure Mode:** Ambiguous resolution; operational confusion

**Test Approach:**
1. Add barcode "ABC123" to Item A
2. Attempt to add barcode "ABC123" to Item B (same org)
3. Assert 409 Conflict or DB constraint error
4. Verify only one barcode with that value exists per org

---

### H3: Lot Barcode Allows Consuming Quarantined/Expired Lots

**Hypothesis:** Fast ops (waste/transfer/receive) don't check lot status before consuming.

**Confidence:** 80% if lot status check not in fast-ops service

**Failure Mode:** Quarantined/recalled inventory consumed; traceability broken

**Test Approach:**
1. Create lot with status QUARANTINE
2. Add barcode to the lot
3. Call fast waste with lot barcode
4. Assert 400 with code `LOT_BLOCKED`
5. Repeat with EXPIRED lot status

---

### H4: Stocktake Scan Creates Duplicate Lines

**Hypothesis:** Missing unique constraint on (sessionId, itemId, locationId) allows duplicate lines during scan.

**Confidence:** 75% if upsert not used

**Failure Mode:** Double-counted items; variance drift

**Test Approach:**
1. Start stocktake session
2. Scan item A, location L1, qty 10
3. Scan item A, location L1, qty 15 (update not insert)
4. Assert only 1 line exists with countedQty = 15
5. Verify no duplicate lines

---

### H5: Fast Receive Posts Wrong UOM Conversion

**Hypothesis:** When uomId provided differs from item's base UOM, conversion factor is not applied to ledger qty.

**Confidence:** 70% if UOM conversion omitted in fast-ops

**Failure Mode:** On-hand drift; purchasing/receiving mismatch

**Test Approach:**
1. Item with baseUom = "EA" (1:1)
2. Create UOM "CASE" with conversionFactor = 12
3. Fast receive 5 CASE
4. Verify ledger entry qty = 60 (5 × 12)
5. Verify on-hand = 60

---

### H6: Export Hash Mismatch on Windows

**Hypothesis:** CSV export hash differs from client-computed hash due to BOM or CRLF differences.

**Confidence:** 65% on Windows environments

**Failure Mode:** Integrity verification fails; audit concerns

**Test Approach:**
1. Export barcodes CSV
2. Capture `X-Nimbus-Export-Hash` header
3. Compute SHA256 of response body
4. Assert hashes match exactly
5. Verify BOM present (0xEF, 0xBB, 0xBF)

---

### H7: Rate Limit Uses Timers/Open Handles

**Hypothesis:** Rate limiting implementation uses setInterval or setTimeout, causing open handles.

**Confidence:** 60% if naive implementation

**Failure Mode:** E2E tests hang; production memory leaks

**Test Approach:**
1. Run tests with `--detectOpenHandles`
2. Assert no timer-related handle warnings
3. Verify rate limit uses DB sliding window query
4. Check no cleanup timers in service

---

### H8: Tests Hang Due to Unclosed App/Server

**Hypothesis:** E2E tests hang on completion due to unclosed NestJS app, database connections, or timers.

**Confidence:** 55% based on prior M11 issues

**Failure Mode:** CI/CD times out; test suite unusable

**Test Approach:**
1. Run M11.11 E2E tests with `--detectOpenHandles`
2. Assert no open handle warnings
3. Assert tests complete and exit cleanly without `--forceExit`
4. Verify AfterAll cleanup closes app properly

---

## Test Coverage Matrix

| Hypothesis | E2E Test | UI Test | Covered By |
|------------|----------|---------|------------|
| H1 | ✅ | ❌ | Group 2: Cross-org resolve denied |
| H2 | ✅ | ❌ | Group 1: Barcode uniqueness |
| H3 | ✅ | ❌ | Group 6: Lot status blocking |
| H4 | ✅ | ❌ | Group 3: Stocktake scan upsert |
| H5 | ✅ | ❌ | Group 4: UOM conversion |
| H6 | ✅ | ❌ | Group 7: Export hash |
| H7 | ✅ | ❌ | Group 8: No-hang compliance |
| H8 | ✅ | ❌ | Group 8: Clean exit |

---

## Acceptance Criteria Summary

All hypotheses must have:
- At least 2 assertions in E2E tests, OR
- 1 E2E test + 1 UI smoke test

Tests must:
- Complete without hanging
- Exit cleanly without `--forceExit`
- No open handle warnings
- Pass within timeout constraints
