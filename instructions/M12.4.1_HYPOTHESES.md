# M12.4.1 Hypotheses

## Pre-Implementation Risk Assessment

| ID | Hypothesis | Confidence | Failure Mode | Mitigation |
|----|------------|------------|--------------|------------|
| H1 | Alerts duplicate on repeated preclose/submit | HIGH | Idempotent upsert may fail if unique constraint not applied; multiple PERIOD_CLOSE_BLOCKED alerts per period | Use deterministic alertKey: `${type}:${periodId}` and upsert by key |
| H2 | Alert resolution incorrectly resolves unrelated period alerts | MEDIUM | Resolving alerts by type alone without periodId filter deletes alerts from other periods | Always filter by `referenceId = periodId` AND `type` when resolving |
| H3 | M12.1 tests weakened instead of updated properly | HIGH | Tests pass by removing assertions instead of adding approval flow | Maintain all existing assertions; only add approval setup steps |
| H4 | RBAC mismatch (approve role) causes privilege escalation or blocked ops | MEDIUM | L3 can approve (escalation) or L4 cannot approve (blocked) | Verify controller decorators match; lock on L4+ for approve/reject |
| H5 | Dashboard ordering not deterministic | MEDIUM | Tests flaky due to unstable sort order in dashboard results | Add explicit ORDER BY in dashboard query; assert sorted result |
| H6 | Tests hang due to missing cleanup / open handles | HIGH | Jest never exits; CI timeout | Use cleanup(app) in afterAll; --detectOpenHandles; withTimeout helpers |
| H7 | Force-close audit/event metadata missing forceCloseReason | LOW | Close succeeds but audit trail incomplete for compliance | Verify event.metadata includes forceCloseReason when force-closing |
| H8 | Alert severity mapping incorrect for BLOCKED categories | LOW | All blockers get WARNING when some should be CRITICAL | Map blocking category to severity; draft transfers = WARNING, pending stocktakes = CRITICAL |

## Test Coverage Mapping

| Hypothesis | Test File | Test Case(s) |
|------------|-----------|--------------|
| H1 | inventory-m124-close-approvals-dashboard.e2e-spec.ts | "should not duplicate alerts on repeated preclose check" |
| H2 | inventory-m124-close-approvals-dashboard.e2e-spec.ts | "should only resolve alerts for specific period" |
| H3 | inventory-m121-period-close.e2e-spec.ts | All existing assertions preserved |
| H4 | inventory-m124-close-approvals-dashboard.e2e-spec.ts | "L3 cannot approve", "L4 can approve" |
| H5 | inventory-m124-close-approvals-dashboard.e2e-spec.ts | "dashboard returns stable ordering" |
| H6 | All E2E tests | cleanup(app) + jest.setTimeout |
| H7 | inventory-m124-close-approvals-dashboard.e2e-spec.ts | "force-close includes reason in event" |
| H8 | inventory-m124-close-approvals-dashboard.e2e-spec.ts | "blocked alert severity matches blocker type" |
