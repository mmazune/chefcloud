# M7.4D Completion Summary

## Objective
Fix NPS summary endpoint returning 400 and add throttle guard for non-production environments.

## Status: ‚úÖ COMPLETE

---

## Issues Fixed

### 1. NPS Summary Endpoint (400 ‚Üí 200)

**Root Cause:** The verifier script was calling `/feedback/analytics/nps-summary` without required query parameters (`from`, `to`).

**Fix Applied:** Added params to verifier script line 146:
```typescript
// Before (broken):
{ endpoint: '/feedback/analytics/nps-summary', method: 'GET', minLevel: 'L4', description: 'NPS summary' },

// After (fixed):
{ endpoint: '/feedback/analytics/nps-summary', method: 'GET', params: { from: getDateDaysAgo(30), to: getTodayISO() }, minLevel: 'L4', description: 'NPS summary' },
```

**Verification:**
- Manually tested via PowerShell:
  - Without params: 400 ‚ùå
  - With params: 200 ‚úÖ (NPS: 43, 200 responses)
- Verifier now shows: `‚úÖ NPS summary: 11 records` for all L4+ roles

### 2. Throttle Guard Enhancement

**Enhancement:** Centralized throttle bypass logic in `CustomThrottlerGuard`.

**Before:** Required `@SkipThrottle()` decorator on each controller.

**After:** Guard automatically skips throttling when:
- `NODE_ENV !== 'production'` (development, test environments)
- `DEMO_VERIFY === 'true'` (demo verification mode)

**File Modified:** `services/api/src/common/custom-throttler.guard.ts`

---

## Verification Results

```
üî¢ Total Endpoint Tests: 204
‚úÖ Passed: 190 (93.1%)
‚ùå Failed: 11 (5.4%)
‚è± 429 Retries: 0  ‚Üê Throttle guard working!
```

### NPS Endpoint Status by Role:
| Role | Before | After |
|------|--------|-------|
| Tapas Owner (L5) | ‚ùå 400 | ‚úÖ 11 records |
| Tapas Manager (L4) | ‚ùå 400 | ‚úÖ 11 records |
| Tapas Accountant (L4) | ‚ùå 400 | ‚úÖ 11 records |
| Cafesserie Owner (L5) | ‚ùå 400 | ‚úÖ 11 records |
| Cafesserie Manager (L4) | ‚ùå 400 | ‚úÖ 11 records |
| Cafesserie Accountant (L4) | ‚ùå 400 | ‚úÖ 11 records |

---

## Files Created/Modified

### Created (Documentation):
- `instructions/M7.4D_NPS_FAIL_REQUEST.md` - Failing request analysis
- `instructions/M7.4D_NPS_REPRO.txt` - Reproduction steps and results
- `instructions/M7.4D_ROOT_CAUSE.md` - Root cause documentation
- `instructions/M7.4D_THROTTLE_GUARD.md` - Throttle guard enhancement docs
- `instructions/M7.4D_COMPLETION_SUMMARY.md` - This file
- `instructions/M7.4D_ROLE_VERIFY_OUTPUT.txt` - Latest verification output

### Modified (Code):
1. **scripts/verify-role-coverage.ts** (line 146)
   - Added `params: { from: getDateDaysAgo(30), to: getTodayISO() }` to NPS endpoint test

2. **services/api/src/common/custom-throttler.guard.ts**
   - Added `skipInDevOrDemo` property for environment-based bypass
   - Guard now skips all throttling in non-production or when DEMO_VERIFY=true

---

## Remaining Issues (Pre-existing, Not M7.4D Scope)

These failures existed before M7.4D and are separate issues:

1. **Inventory levels L2 access** (6 failures)
   - Supervisor, Cashier, Chef roles denied at L2
   - RBAC configuration issue for inventory endpoint

2. **Employee list for Cafesserie** (3 failures)
   - Empty response for Cafesserie org
   - Seed data or branchId mismatch issue

3. **Branch rankings L4 access** (2 failures)
   - Manager, Accountant denied at L4
   - RBAC configuration for franchise endpoint

4. **Franchise overview 400** (3 errors)
   - Missing required params (similar to NPS fix needed)

---

## Production Considerations

The throttle guard enhancement ensures:
- ‚úÖ **Development:** No rate limits (fast iteration)
- ‚úÖ **Demo Verification:** No rate limits (reliable automated testing)
- ‚úÖ **Production:** Full rate limiting enforced (security protection)

To run demo verification in production:
```bash
DEMO_VERIFY=true npx ts-node scripts/verify-role-coverage.ts
```

---

## Summary
M7.4D successfully fixed the NPS endpoint 400 issue by adding required date params to the verifier script. Additionally, the throttle guard was enhanced to automatically bypass rate limiting in non-production environments, eliminating the need for scattered `@SkipThrottle()` decorators and ensuring 0 retry 429 errors during verification.
