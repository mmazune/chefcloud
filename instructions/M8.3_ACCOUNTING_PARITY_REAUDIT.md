# M8.3 Accounting Parity Re-Audit

> **Date:** 2026-01-02  
> **Milestone:** M8.3 (AP/AR Document Lifecycle + GL Posting)  
> **Author:** Claude (Claude Opus 4.5)  
> **Status:** COMPLETE  

---

## 1. Reference Repositories Consulted

### Primary References (STUDY-ONLY Pattern)

| Repository | License | Patterns Studied | Files Reviewed |
|------------|---------|------------------|----------------|
| bigcapital/bigcapital | AGPL-3.0 | AP/AR → GL posting, bill lifecycle | BillsGLEntries.ts, OpenBill.service.ts, BillsGL.ts |
| killbill/killbill | Apache-2.0 | Invoice state machine, payment lifecycle | InvoiceStatus.java, PaymentStateMachine.java |
| simonmichael/hledger | GPL-3.0 | Double-entry principles, journal model | Journal.hs, Transaction.hs |

### Clean Room Implementation Protocol

Per [CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md](../CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md):

1. ✅ **STUDY phase completed** - Extracted design patterns only
2. ✅ **No code copied** - Implementation written from scratch
3. ✅ **No API surface copied** - Endpoint naming follows Nimbus conventions
4. ✅ **License compliance** - AGPL repos marked STUDY-ONLY

---

## 2. Traceability Matrix

### 2.1 AP: Vendor Bill Lifecycle

| Feature | Nimbus Implementation | bigcapital Pattern | killbill Pattern | Verdict |
|---------|----------------------|-------------------|------------------|---------|
| **Create bill as DRAFT** | `createVendorBill()` returns bill with status=DRAFT | Bills created as DRAFT by default | N/A (not bill-focused) | ✅ MEETS |
| **Open bill → GL post** | `openVendorBill(billId, userId)` creates JournalEntry | `OpenBill.service.ts` triggers GL write | N/A | ✅ MEETS |
| **Debit Expense, Credit AP** | Lines: debit to expense account, credit to AP account | `BillsGLEntries.ts` pattern | N/A | ✅ MEETS |
| **JE auto-POSTED** | JournalEntry created with status=POSTED | Status transitions in BillsGL.ts | Similar in invoice service | ✅ MEETS |
| **Link journalEntryId** | VendorBill.journalEntryId set after open | Similar linkage pattern | Similar linkage | ✅ MEETS |
| **Payment → GL** | `createVendorPayment()` → Debit AP, Credit Cash | VendorPaymentGL pattern | PaymentStateMachine | ✅ MEETS |
| **Void → reversal** | `voidVendorBill()` creates reversal JE | ReversalJournal pattern | Similar reversal | ✅ MEETS |
| **Period lock check** | `ForbiddenException` if period locked | Period validation | N/A | ✅ MEETS |

**Nimbus Implementation Paths:**
- Service: [accounting.service.ts](../../services/api/src/accounting/accounting.service.ts) lines 650-750
- Controller: [accounting.controller.ts](../../services/api/src/accounting/accounting.controller.ts) lines 180-220
- Schema: [schema.prisma](../../packages/db/prisma/schema.prisma) VendorBill model

### 2.2 AR: Customer Invoice Lifecycle

| Feature | Nimbus Implementation | bigcapital Pattern | killbill Pattern | Verdict |
|---------|----------------------|-------------------|------------------|---------|
| **Create invoice as DRAFT** | `createCustomerInvoice()` returns status=DRAFT | Similar draft state | DRAFT state in InvoiceStatus | ✅ MEETS |
| **Open invoice → GL post** | `openCustomerInvoice(invoiceId, userId)` | Similar open transition | InvoiceStatus.COMMITTED | ✅ MEETS |
| **Debit AR, Credit Revenue** | Lines: debit AR, credit Revenue | Standard AR pattern | Similar | ✅ MEETS |
| **Receipt → GL** | `createCustomerReceipt()` → Debit Cash, Credit AR | Payment receipt pattern | PaymentTransaction | ✅ MEETS |
| **Void → reversal** | `voidCustomerInvoice()` creates reversal | Similar reversal | InvoiceStatus.VOID | ✅ MEETS |
| **Period lock check** | `ForbiddenException` if period locked | Period validation | N/A | ✅ MEETS |

**Nimbus Implementation Paths:**
- Service: [accounting.service.ts](../../services/api/src/accounting/accounting.service.ts) lines 750-900
- Controller: [accounting.controller.ts](../../services/api/src/accounting/accounting.controller.ts) lines 220-280
- Schema: [schema.prisma](../../packages/db/prisma/schema.prisma) CustomerInvoice, CustomerReceipt models

### 2.3 GL Integration

| Feature | Nimbus Implementation | hledger Pattern | bigcapital Pattern | Verdict |
|---------|----------------------|-----------------|-------------------|---------|
| **Double-entry enforcement** | JournalEntry with balanced lines | Transaction.balanced | JournalEntry model | ✅ MEETS |
| **Debit = Credit validation** | Service validates sum(debit) = sum(credit) | Core invariant | createJournalEntry validation | ✅ MEETS |
| **Reversal linking** | JournalEntry.reversesEntryId | Reversal transaction | Similar pattern | ✅ MEETS |
| **Source tracking** | JournalEntry.source enum | N/A | Similar | ✅ MEETS |
| **Trial balance accuracy** | `getTrialBalance()` sums POSTED only | Balance query | trialBalance service | ✅ MEETS |

**Nimbus Implementation Paths:**
- Service: [accounting.service.ts](../../services/api/src/accounting/accounting.service.ts) lines 200-400
- Schema: [schema.prisma](../../packages/db/prisma/schema.prisma) JournalEntry, JournalLine models

---

## 3. State Machine Comparison

### 3.1 Nimbus Bill/Invoice State Machine

```
       ┌──────────────────────────────────────┐
       │                                      │
       ▼                                      │
    ┌──────┐    POST /open     ┌──────┐      │
    │DRAFT ├──────────────────►│ OPEN │      │
    └──────┘                   └──┬───┘      │
                                  │          │
                    ┌─────────────┼──────────┘
                    │             │
         Payment    │             │ POST /void
         creates    │             │
         receipt    │             ▼
                    │         ┌──────┐
                    │         │ VOID │
                    │         └──────┘
                    ▼
                ┌──────┐
                │ PAID │──────────────────────►
                └──────┘    (can also void)
```

### 3.2 bigcapital Bill State Machine (Reference)

```
    DRAFT → OPEN → PAID
              │
              └──► VOID
```

### 3.3 killbill Invoice States (Reference)

```
    DRAFT → COMMITTED → PAID
                 │
                 └──► VOID
```

**Verdict:** Nimbus state machine aligns with industry patterns. ✅

---

## 4. GL Account Mapping Comparison

### Nimbus M8.3 Account Mapping

| Transaction | Debit Account | Credit Account |
|-------------|---------------|----------------|
| Open VendorBill | Expense (or line-item account) | Accounts Payable |
| VendorPayment | Accounts Payable | Cash/Bank |
| Open CustomerInvoice | Accounts Receivable | Revenue |
| CustomerReceipt | Cash/Bank | Accounts Receivable |

### bigcapital Account Mapping (Reference)

| Transaction | Debit Account | Credit Account |
|-------------|---------------|----------------|
| Open Bill | Cost of Sales/Expense | Accounts Payable |
| Bill Payment | Accounts Payable | Cash/Bank |
| Open Invoice | Accounts Receivable | Income |
| Invoice Payment | Cash/Bank | Accounts Receivable |

**Verdict:** Mapping patterns are equivalent. ✅

---

## 5. Deferred Features Analysis

### 5.1 Partial Payments

| System | Support | Implementation |
|--------|---------|----------------|
| bigcapital | ✅ Full | Payment allocation across multiple bills |
| killbill | ✅ Full | Payment splits with allocation |
| Nimbus M8.3 | ⚠️ Deferred | Single payment per bill (M8.4) |

**Justification:** Partial payments require complex allocation logic and UI. Core lifecycle complete without this.

### 5.2 Multi-Currency

| System | Support | Implementation |
|--------|---------|----------------|
| bigcapital | ✅ Full | Exchange rates, currency conversion |
| killbill | ✅ Full | Multi-currency invoicing |
| Nimbus M8.3 | ⚠️ Deferred | Single currency (M8.4) |

**Justification:** Multi-currency requires exchange rate management and currency account handling. Out of scope for core lifecycle.

### 5.3 Credit Notes

| System | Support | Implementation |
|--------|---------|----------------|
| bigcapital | ✅ Full | Credit memo document type |
| killbill | ✅ Full | CreditBalanceAdjustment |
| Nimbus M8.3 | ⚠️ Deferred | Not implemented (M8.5) |

**Justification:** Credit notes are a separate document type with distinct workflow.

---

## 6. Final Parity Verdict

### Required Features (M8.3 Scope)

| Feature | Verdict |
|---------|---------|
| Bill DRAFT → OPEN lifecycle | ✅ MEETS |
| Bill OPEN → GL posting | ✅ MEETS |
| Bill payment → GL posting | ✅ MEETS |
| Bill VOID → reversal | ✅ MEETS |
| Invoice DRAFT → OPEN lifecycle | ✅ MEETS |
| Invoice OPEN → GL posting | ✅ MEETS |
| Receipt → GL posting | ✅ MEETS |
| Invoice VOID → reversal | ✅ MEETS |
| Period lock enforcement | ✅ MEETS |
| Double-entry validation | ✅ MEETS |
| Trial balance accuracy | ✅ MEETS |

### Deferred Features

| Feature | Target Milestone |
|---------|------------------|
| Partial payments | M8.4 |
| Multi-currency | M8.4 |
| Credit notes | M8.5 |
| Recurring invoices | M8.5 |
| AP/AR UI | M8.6 |

---

## 7. Conclusion

M8.3 achieves **MEETS** parity with enterprise accounting systems for core AP/AR → GL posting functionality:

1. **State machine parity** - DRAFT/OPEN/PAID/VOID matches industry patterns
2. **GL integration parity** - Double-entry, auto-posting, reversals
3. **Period lock parity** - API-level enforcement with 403 response
4. **Seed data parity** - 12+ bills/invoices per org exceeds requirement

Deferred features are documented with milestone assignments and do not block M8.3 completion.

**Overall Verdict: ✅ M8.3 MEETS enterprise-grade parity requirements**
