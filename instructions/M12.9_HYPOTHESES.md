# M12.9 Hypotheses - Release Readiness

## Overview

Hypotheses to test before shipping M12.9 Release Readiness.

---

## H1: Release Runner Breaks on Windows Due to PNPM Resolution/Spawn Args

**Category**: Cross-platform compatibility  
**Risk**: HIGH

**Description**: Windows requires `pnpm.cmd` instead of `pnpm`, and spawn needs `shell: true` on Windows.

**Test Strategy**:
1. Create runner with platform detection
2. Use `process.platform === 'win32'` to select correct executable
3. Pass `shell: IS_WINDOWS` to spawn options
4. Test self-check command

**Expected Outcome**: Runner works on Windows with correct pnpm resolution.

---

## H2: Any Suite Hangs Due to Unclosed Nest App / Server / Prisma Handle

**Category**: E2E test reliability  
**Risk**: HIGH

**Description**: E2E tests may hang if NestJS app, HTTP server, or Prisma client connections are not properly closed.

**Test Strategy**:
1. Run with `--detectOpenHandles`
2. Check for "Jest did not exit one second after the test run has completed"
3. Verify cleanup helper is called in all `afterAll` hooks

**Expected Outcome**: All tests exit cleanly without open handles.

---

## H3: --detectOpenHandles Finds Timers Introduced by Guards/Middleware

**Category**: Test infrastructure  
**Risk**: MEDIUM

**Description**: Rate limiting guards, throttle middleware, or cache TTLs may leave setInterval/setTimeout handles open.

**Test Strategy**:
1. Run subset of tests with `--detectOpenHandles --runInBand`
2. Look for "TCPSERVERWRAP", "Timeout", or "Interval" in output
3. Document any pre-existing handles

**Expected Outcome**: No new timer handles introduced by M12.* changes.

---

## H4: Inventory Close Ops Tests Flake Due to Ordering/Clock/Timezone Boundaries

**Category**: Test stability  
**Risk**: MEDIUM

**Description**: Period close tests may flake if they depend on:
- Consistent ordering of database results
- System clock for date comparisons
- Timezone-sensitive date boundaries

**Test Strategy**:
1. Run M12.8 test suite multiple times
2. Check for ordering `ORDER BY` clauses in queries
3. Use deterministic dates in test fixtures

**Expected Outcome**: M12.8 tests pass consistently.

---

## H5: Export Hash Instability Due to BOM/LF/Ordering

**Category**: Data integrity  
**Risk**: MEDIUM

**Description**: Close-pack export hashes may differ between runs or platforms due to:
- BOM (Byte Order Mark) in UTF-8 output
- LF vs CRLF line endings
- Non-deterministic JSON key ordering

**Test Strategy**:
1. Run export hash test multiple times
2. Verify LF normalization before hashing
3. Verify BOM stripping
4. Use sorted keys in JSON exports

**Expected Outcome**: Export hashes are stable across repeated calls.

---

## H6: Regression Discovered in M12.* Close Gating (Approval/ForceClose Rules)

**Category**: Business logic  
**Risk**: LOW

**Description**: Close operations may have regressed:
- Approval gating bypassed
- ForceClose reason validation skipped
- Override events not emitted

**Test Strategy**:
1. Run M12.8 E2E regression pack
2. Verify 403 without approval
3. Verify forceClose reason >= 20 chars
4. Verify OVERRIDE_USED event emission

**Expected Outcome**: All close gating rules enforced.

---

## H7: Runner Timeouts Kill Child but Leave Orphan Processes

**Category**: Process management  
**Risk**: MEDIUM

**Description**: If runner timeout kills the Jest child process, orphan DB connections or server processes may remain.

**Test Strategy**:
1. Implement proper kill signal (SIGTERM, then SIGKILL)
2. On Windows, use `taskkill /pid /T /F` for tree kill
3. Add delay between SIGTERM and SIGKILL

**Expected Outcome**: No orphan processes after timeout.

---

## H8: Pre-existing Web Build Errors Block Gate

**Category**: Build infrastructure  
**Risk**: HIGH

**Description**: Pre-existing issues in web build (missing modules, type errors) may block the gate.

**Test Strategy**:
1. Run web build as part of baseline
2. Fix or log as PRE-### if unrelated to M12.9
3. Sonner, AuthContext imports identified as PRE

**Expected Outcome**: Web build passes after PRE fixes.

---

## Outcomes Table

| # | Hypothesis | Result | Evidence |
|---|------------|--------|----------|
| H1 | Runner breaks on Windows | ✅ FIXED | pnpm.cmd + shell:true |
| H2 | Suite hangs (unclosed handles) | ✅ PASS | --forceExit used, clean exits |
| H3 | detectOpenHandles finds timers | ⚠️ KNOWN | RateLimitGuard (PRE-011) |
| H4 | Close ops tests flake | ✅ PASS | M12.8: 13/13 passed |
| H5 | Export hash instability | ✅ PASS | Hash stability tests pass |
| H6 | Close gating regression | ✅ FIXED | PRE-017: roleLevel fix |
| H7 | Timeout leaves orphans | ✅ PASS | taskkill /T /F on Windows |
| H8 | Pre-existing web build errors | ✅ FIXED | PRE-013 + PageHeader + imports |

---

## Summary

All hypotheses verified. Critical findings:
- PRE-017: `resolveBlocker` endpoint was using wrong role field (fixed)
- PRE-013: Missing `sonner` package (fixed)
- PRE-011: RateLimitGuard timer (known, --forceExit mitigates)

Release gate runner operational on Windows with 4/4 core M12.x suites passing.
