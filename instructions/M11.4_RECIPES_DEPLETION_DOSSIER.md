# M11.4 Recipes/BOM + POS Depletion — Feature Dossier

## 1. Overview

**Milestone:** M11.4 Recipes/BOM + POS Depletion  
**Sprint:** M11 Inventory Essentials  
**Status:** Implementation  
**Commit Base:** 5df6a62 (M11.3 complete)

### Objective
Implement enterprise-grade recipe/BOM management and integrate POS sales to decrement inventory via the append-only ledger.

### Key Deliverables
1. Recipe model with header/line pattern (Recipe → RecipeLine)
2. POS depletion on order completion (CLOSED status) via ledger
3. Idempotent depletion posting with OrderInventoryDepletion record
4. API endpoints for recipe management and depletion visibility
5. CSV exports with BOM + hash
6. Web UI for recipes and depletions

---

## 2. Feature Parity Analysis

### 2.1 InvenTree BOM Patterns (MIT, ADAPT)
| InvenTree Feature | M11.4 Implementation | Status |
|-------------------|---------------------|--------|
| BOM line semantics (part + qty) | RecipeLine with itemId + qtyInput + inputUomId | ✓ |
| Output quantity (yield) | Recipe.outputQtyBase (default 1) | ✓ |
| Consumption traceability | InventoryLedgerEntry with sourceType=ORDER, sourceId=orderId | ✓ |
| Sub-assemblies | Not in M11.4 scope (future: nested recipes) | — |
| Substitute parts | Not in M11.4 scope | — |

### 2.2 TastyIgniter Restaurant Patterns (MIT, ADAPT)
| TastyIgniter Pattern | M11.4 Implementation | Status |
|---------------------|---------------------|--------|
| Menu item → ingredients linkage | Recipe.targetType=MENU_ITEM, Recipe.targetId=menuItemId | ✓ |
| Stock depletion on order | OrderInventoryDepletion + ledger SALE entries | ✓ |
| Kitchen location preference | Branch.depletionLocationId or default KITCHEN location | ✓ |
| Modifier ingredient consumption | ModifierOption can have separate recipe (future) | — |

### 2.3 Depletion Location Rule (CRITICAL)
**Decision:** Use deterministic location resolution:
1. If `Branch.depletionLocationId` is set → use that location
2. Else, find location with code "KITCHEN" in the branch
3. Else, find first active location of type "PRODUCTION" in the branch
4. Else, find first active location in the branch
5. If no location found → depletion fails with LOCATION_NOT_FOUND error

---

## 3. Data Models

### 3.1 Recipe (Header)
```prisma
model Recipe {
  id              String   @id @default(cuid())
  orgId           String
  name            String
  targetType      RecipeTargetType  // MENU_ITEM or INVENTORY_ITEM
  targetId        String            // menuItemId or inventoryItemId
  outputQtyBase   Decimal  @default(1) @db.Decimal(12, 4)
  outputUomId     String?           // Optional: for advanced yield tracking
  isActive        Boolean  @default(true)
  createdById     String
  updatedById     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  org         Org            @relation(fields: [orgId], references: [id])
  lines       RecipeLine[]
  createdBy   User           @relation("RecipeCreator", fields: [createdById], references: [id])
  updatedBy   User?          @relation("RecipeUpdater", fields: [updatedById], references: [id])
  outputUom   UnitOfMeasure? @relation(fields: [outputUomId], references: [id])
  depletions  OrderInventoryDepletion[]

  @@unique([orgId, targetType, targetId])
  @@index([orgId])
  @@index([targetType, targetId])
  @@map("recipes")
}

enum RecipeTargetType {
  MENU_ITEM
  INVENTORY_ITEM
}
```

### 3.2 RecipeLine
```prisma
model RecipeLine {
  id              String   @id @default(cuid())
  recipeId        String
  inventoryItemId String
  qtyInput        Decimal  @db.Decimal(12, 4)  // Quantity in input UOM
  inputUomId      String
  qtyBase         Decimal  @db.Decimal(12, 4)  // Pre-computed in item's base UOM
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  recipe        Recipe         @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem  @relation(fields: [inventoryItemId], references: [id])
  inputUom      UnitOfMeasure  @relation(fields: [inputUomId], references: [id])

  @@index([recipeId])
  @@index([inventoryItemId])
  @@map("recipe_lines")
}
```

### 3.3 OrderInventoryDepletion (Idempotency Record)
```prisma
model OrderInventoryDepletion {
  id          String   @id @default(cuid())
  orgId       String
  orderId     String
  recipeId    String?
  branchId    String
  locationId  String
  status      DepletionStatus @default(PENDING)
  errorCode   String?
  errorMessage String?
  ledgerEntryCount Int @default(0)
  idempotencyKey String?
  createdAt   DateTime @default(now())
  postedAt    DateTime?
  
  // Relations
  order    Order   @relation(fields: [orderId], references: [id])
  branch   Branch  @relation(fields: [branchId], references: [id])
  location InventoryLocation @relation(fields: [locationId], references: [id])
  recipe   Recipe? @relation(fields: [recipeId], references: [id])

  @@unique([orgId, orderId])
  @@index([orderId])
  @@index([branchId, status])
  @@map("order_inventory_depletions")
}

enum DepletionStatus {
  PENDING
  POSTED
  FAILED
  SKIPPED  // No recipe for sold items
}
```

---

## 4. API Endpoints

### 4.1 Recipe Management
| Method | Endpoint | RBAC | Description |
|--------|----------|------|-------------|
| POST | /inventory/recipes | L3+ | Create recipe |
| GET | /inventory/recipes | L2+ | List recipes with filters |
| GET | /inventory/recipes/:id | L2+ | Get recipe detail |
| PATCH | /inventory/recipes/:id | L3+ | Update recipe |
| POST | /inventory/recipes/:id/lines | L3+ | Add recipe line |
| DELETE | /inventory/recipes/lines/:lineId | L3+ | Remove recipe line |
| GET | /inventory/recipes/export | L4+ | Export recipes CSV |

### 4.2 Depletion Visibility
| Method | Endpoint | RBAC | Description |
|--------|----------|------|-------------|
| GET | /inventory/depletions | L3+ | List depletion records |
| GET | /inventory/depletions/status | L3+ | Get status for orderId |
| POST | /inventory/depletions/retry | L4+ | Retry failed depletion |
| GET | /inventory/depletions/export | L4+ | Export depletions CSV |

---

## 5. Depletion Flow

### 5.1 Trigger Point
When `PosService.closeOrder()` transitions order to CLOSED:

```
Order CLOSED
    ↓
DepletionService.postDepletion(orderId)
    ↓
Check OrderInventoryDepletion exists?
    ├─ Yes (status=POSTED) → return {isAlreadyPosted: true}
    ├─ Yes (status=FAILED) → check if eligible for retry
    └─ No → proceed
    ↓
Resolve depletion location (Branch.depletionLocationId → KITCHEN → first active)
    ↓
For each OrderItem:
    ├─ Find Recipe for MenuItem
    └─ If no recipe → skip (log warning)
    ↓
For each RecipeLine:
    Calculate: ingredientQty = soldQty * line.qtyBase / recipe.outputQtyBase
    ↓
Check negative stock policy:
    ├─ If would go negative → mark FAILED, return error
    └─ If OK → create ledger entries
    ↓
Create InventoryLedgerEntry rows:
    - reason: SALE
    - sourceType: ORDER
    - sourceId: orderId
    - qty: -ingredientQty
    ↓
Update OrderInventoryDepletion:
    - status: POSTED
    - ledgerEntryCount: N
    - postedAt: now()
```

### 5.2 Idempotency Guarantee
- UNIQUE(orgId, orderId) on OrderInventoryDepletion prevents duplicate records
- If POSTED, return immediately with isAlreadyPosted=true
- No ledger rows created on repeat calls

### 5.3 Negative Stock Policy
**Decision:** Option A (Allow order, mark depletion FAILED)
- POS flow should not be blocked by inventory issues
- Depletion marked as FAILED with errorCode: INSUFFICIENT_STOCK
- Surfaced in /inventory/depletions with status filter
- Admin can resolve via manual adjustment and retry

---

## 6. Exports

### 6.1 Recipes Export
```csv
recipeId,name,targetType,targetId,targetName,outputQtyBase,isActive,lineCount,createdAt
```

### 6.2 Depletions Export
```csv
depletionId,orderId,orderNumber,branchName,locationCode,status,errorCode,ledgerEntryCount,createdAt,postedAt
```

Both exports include:
- UTF-8 BOM (0xFEFF)
- X-Nimbus-Export-Hash header (SHA-256)
- Stable ordering by createdAt ASC, id ASC

---

## 7. Web UI Pages

### 7.1 /inventory/recipes
- List/search recipes (name, targetType, isActive)
- Create/edit recipe dialog with inline line management
- Show derived qtyBase per line
- Toggle active/inactive
- Link to target MenuItem name

### 7.2 /inventory/depletions
- List depletion records with filters (branch, date, status)
- Show orderId, orderNumber, status, errorCode
- Retry button for FAILED status (L4+ only)
- Link to order detail

---

## 8. Audit Actions
- RECIPE_CREATED
- RECIPE_UPDATED
- RECIPE_DEACTIVATED
- RECIPE_LINE_ADDED
- RECIPE_LINE_REMOVED
- DEPLETION_POSTED
- DEPLETION_FAILED
- DEPLETION_RETRIED

---

## 9. Implementation Order
1. Prisma models + migration
2. Recipe service (CRUD + line management)
3. Depletion service (idempotent posting)
4. Controllers with RBAC
5. POS integration hook
6. Export service extension
7. Web UI pages
8. E2E tests

---

## 10. Non-Goals for M11.4
- Modifier-level ingredient consumption
- Nested recipes (sub-assemblies)
- Recipe costing/margin calculation
- Recipe versioning/history
- Batch/lot-level depletion tracking
