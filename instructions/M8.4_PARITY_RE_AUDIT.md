# M8.4 Parity Re-Audit: Cash/Banking Foundation + Partial Payments

**Date**: 2025-01-02  
**Status**: ✅ COMPLETE  
**Migration**: `20260102145853_m84_partial_payments`

---

## 1. Executive Summary

M8.4 delivers partial payment support for both AP (VendorBill) and AR (CustomerInvoice), along with a PaymentMethodMapping model that allows configuration of GL accounts per payment method. This enables multi-payment settlement workflows and accurate cash/banking GL posting.

---

## 2. Schema Changes

### 2.1 Enum Additions

| Enum | New Value | Purpose |
|------|-----------|---------|
| PaymentMethod | `BANK_TRANSFER` | Wire/ACH payment method option |
| BillStatus | `PARTIALLY_PAID` | Intermediate state between OPEN and PAID |
| InvoiceStatus | `PARTIALLY_PAID` | Intermediate state between OPEN and PAID |

### 2.2 New Fields

| Model | Field | Type | Purpose |
|-------|-------|------|---------|
| VendorBill | `paidAmount` | Decimal(12,2) @default(0) | Tracks cumulative payments |
| CustomerInvoice | `paidAmount` | Decimal(12,2) @default(0) | Tracks cumulative receipts |

### 2.3 New Model

```prisma
model PaymentMethodMapping {
  id        String        @id @default(cuid())
  orgId     String
  org       Org           @relation(fields: [orgId], references: [id])
  method    PaymentMethod
  accountId String
  account   Account       @relation(fields: [accountId], references: [id])
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([orgId, method])
  @@map("payment_method_mappings")
}
```

---

## 3. Service Logic (accounting.service.ts)

### 3.1 Payment Creation Flow

**VendorPayment (`createVendorPayment`)**:
1. Validate payment amount > 0
2. Accept bills with status OPEN or PARTIALLY_PAID
3. Look up PaymentMethodMapping for GL account (fallback to name search)
4. Calculate outstanding = totalAmount - paidAmount
5. Reject if payment > outstanding (overpayment)
6. Update paidAmount += payment amount
7. Transition status: PARTIALLY_PAID if balance remains, PAID if fully settled
8. Post journal entry with mapped GL account

**CustomerReceipt (`createCustomerReceipt`)**:
- Same pattern as VendorPayment for invoices

### 3.2 Void Operations

- `voidVendorBill` and `voidCustomerInvoice` now accept PARTIALLY_PAID status
- Voiding resets status to VOID

### 3.3 Aging Reports

- `getAPAging` and `getARAging` include PARTIALLY_PAID in queries
- Use paidAmount field for outstanding calculation

### 3.4 New Methods

| Method | Purpose |
|--------|---------|
| `getPaymentMethodMappings(orgId)` | List all mappings for org |
| `upsertPaymentMethodMapping(orgId, method, accountId)` | Create or update mapping |
| `deletePaymentMethodMapping(orgId, method)` | Remove mapping |
| `getVendorBillOutstanding(billId)` | Get bill outstanding balance |
| `getCustomerInvoiceOutstanding(invoiceId)` | Get invoice outstanding balance |

---

## 4. API Endpoints (accounting.controller.ts)

| Method | Path | Purpose |
|--------|------|---------|
| GET | `/accounting/payment-methods` | List payment method mappings |
| POST | `/accounting/payment-methods` | Create/update mapping |
| GET | `/accounting/vendor-bills/:billId/outstanding` | Get bill outstanding |
| GET | `/accounting/customer-invoices/:invoiceId/outstanding` | Get invoice outstanding |

---

## 5. Seed Data (seedDemo.ts)

### 5.1 Payment Method Mappings (per org)

| Method | Account Code | Account Name |
|--------|--------------|--------------|
| CASH | 1000 | Cash on Hand |
| CARD | 1010 | Bank Account |
| MOMO | 1010 | Bank Account |
| BANK_TRANSFER | 1010 | Bank Account |

### 5.2 Partially Paid Bills (per org)

| Reference | Total | Paid | Status |
|-----------|-------|------|--------|
| VB-005 | $350 | $100 | PARTIALLY_PAID |
| VB-006 | $275 | $200 | PARTIALLY_PAID |
| VB-013 | $420 | $150 | PARTIALLY_PAID |

### 5.3 Partially Paid Invoices (per org)

| Reference | Total | Paid | Status |
|-----------|-------|------|--------|
| INV-003 | $450 | $200 | PARTIALLY_PAID |
| INV-005 | $580 | $300 | PARTIALLY_PAID |
| INV-013 | $320 | $100 | PARTIALLY_PAID |

---

## 6. E2E Test Coverage

**File**: `test/e2e/accounting-m84-partial-payments.e2e-spec.ts`

| Suite | Test | AC |
|-------|------|----|
| PaymentMethodMapping CRUD | Create mapping for CASH | AC-01 |
| | List mappings | AC-01 |
| | Upsert existing mapping | AC-01 |
| AP: Partial Payment | Posts to mapped account | AC-02 |
| | Transitions to PARTIALLY_PAID | AC-03 |
| | Rejects overpayment | AC-05 |
| | Transitions to PAID | AC-04 |
| AR: Partial Payment | Posts to mapped account | AC-06 |
| | Transitions to PARTIALLY_PAID | AC-07 |
| | Rejects overpayment | - |
| | Transitions to PAID | - |
| Period Lock | Blocks payment in locked period | AC-08 |
| Validation | Rejects negative amount | - |
| | Rejects zero amount | - |

**Result**: 14/14 tests passing

---

## 7. Verification Gates

| Gate | Status | Notes |
|------|--------|-------|
| TypeScript compilation | ✅ PASS | No errors |
| ESLint | ✅ PASS | 0 errors, 120 warnings (pre-existing) |
| E2E Tests | ✅ PASS | 14/14 |
| Teardown Check | ✅ PASS | With warnings (expected for nested suites) |
| Migration Applied | ✅ PASS | Both dev and test databases |

---

## 8. Acceptance Criteria Traceability

| AC | Description | Implementation | Test |
|----|-------------|----------------|------|
| AC-01 | PaymentMethodMapping CRUD | `upsertPaymentMethodMapping`, `getPaymentMethodMappings` | ✅ |
| AC-02 | VendorPayment uses mapped account | `createVendorPayment` lookup | ✅ |
| AC-03 | Partial payment → PARTIALLY_PAID | Status transition logic | ✅ |
| AC-04 | Full payment → PAID | Status transition logic | ✅ |
| AC-05 | Overpayment rejected | Outstanding validation | ✅ |
| AC-06 | CustomerReceipt uses mapped account | `createCustomerReceipt` lookup | ✅ |
| AC-07 | Partial receipt → PARTIALLY_PAID | Status transition logic | ✅ |
| AC-08 | Period lock blocks payments | PeriodLock check | ✅ |

---

## 9. Breaking Changes

**None** - All changes are additive:
- New enum values are backward compatible
- New `paidAmount` field defaults to 0
- New `PaymentMethodMapping` model is optional (fallback to name search)

---

## 10. File Change Summary

| File | Lines Changed | Type |
|------|---------------|------|
| `packages/db/prisma/schema.prisma` | +25 | Schema |
| `services/api/src/accounting/accounting.service.ts` | +180 | Service |
| `services/api/src/accounting/accounting.controller.ts` | +35 | Controller |
| `services/api/prisma/demo/seedDemo.ts` | +60 | Seed |
| `services/api/test/e2e/accounting-m84-partial-payments.e2e-spec.ts` | +350 | Test |
| Migration SQL | +40 | Database |

---

## 11. Next Steps

1. **M8.5**: Bank reconciliation workflows
2. **M8.6**: Multi-currency payment support
3. **M9.x**: Financial reporting dashboards

---

**Auditor**: GitHub Copilot  
**Verified**: 2025-01-02
