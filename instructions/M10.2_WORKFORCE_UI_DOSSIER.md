# M10.2 Workforce UI Feature Dossier

**Created:** 2026-01-03
**Status:** IN_PROGRESS
**Baseline Commit:** d6c2299 (M10.1 complete)

---

## 1. Feature Overview

M10.2 completes the Workforce module by:
- Creating and applying Prisma migration for M10.1 models
- Adding deterministic workforce seed data for DEMO_TAPAS and CAFESSERIE
- Implementing 4 enterprise-minimum UI pages: Schedule, Timeclock, Approvals, Labor
- Making E2E tests runnable and green
- Adding UI smoke tests

---

## 2. Scope

| Component | Description |
|-----------|-------------|
| Migration | ScheduledShift, BreakEntry, WorkforceAuditLog, ShiftStatus enum |
| Seed | Tapas: 6 shifts, 4 time entries, 2 breaks, 6 audit logs |
| Seed | Cafesserie: 12 shifts, 8 time entries, 4 breaks, 12 audit logs |
| UI | /workforce/schedule (L4+) |
| UI | /workforce/timeclock (L2+) |
| UI | /workforce/approvals (L4+) |
| UI | /workforce/labor (L4+) |
| Tests | E2E tests for workforce-m101.e2e-spec.ts |
| Tests | UI smoke tests for all 4 pages |

---

## 3. API Endpoints (from M10.1)

| Endpoint | Method | Role | Purpose |
|----------|--------|------|---------|
| `/workforce/scheduling/templates` | GET/POST | L3+/L4+ | Shift templates |
| `/workforce/scheduling/shifts` | GET/POST | L3+/L4+ | Scheduled shifts |
| `/workforce/scheduling/publish` | POST | L4+ | Publish shifts |
| `/workforce/scheduling/conflicts` | POST | L4+ | Check conflicts |
| `/workforce/scheduling/shifts/:id/approve` | POST | L4+ | Approve shift |
| `/workforce/timeclock/status` | GET | L2+ | Clock status |
| `/workforce/timeclock/clock-in` | POST | L2+ | Clock in |
| `/workforce/timeclock/clock-out` | POST | L2+ | Clock out |
| `/workforce/timeclock/break/start` | POST | L2+ | Start break |
| `/workforce/timeclock/break/end` | POST | L2+ | End break |
| `/workforce/timeclock/entries` | GET | L2+ | Time entries |
| `/workforce/reports/labor` | GET | L4+ | Labor metrics |
| `/workforce/reports/daily` | GET | L4+ | Daily summary |
| `/workforce/reports/export/shifts` | GET | L4+ | Export shifts CSV |
| `/workforce/reports/export/timeentries` | GET | L4+ | Export entries CSV |
| `/workforce/reports/export/labor` | GET | L4+ | Export labor CSV |
| `/workforce/reports/audit` | GET | L5 | Audit logs |

---

## 4. Feature-by-Feature Comparison

### 4.1 Scheduling UX (create/edit/publish/conflicts)

**Kimai (STUDY-only) Behavior:**
- Calendar-based week/month view for shifts
- Drag-and-drop shift creation
- Conflict detection on overlap
- Publish/unpublish workflows
- Template-based quick shift creation

**Nimbus Prior Patterns (reservations/calendar.tsx, reservations/reports.tsx):**
- Date range picker with from/to inputs
- Table-based list view with status badges
- Dialog-based create/edit forms
- Filter dropdowns for branch selection
- Action buttons in table rows

**Nimbus M10.2 Implementation:**
- Week view with date range selector (simpler than calendar)
- Table list of shifts with status badges (DRAFT/PUBLISHED/IN_PROGRESS/COMPLETED/APPROVED/CANCELLED)
- Dialog for create shift (user select + role + times + notes)
- "Publish" button for date range (bulk DRAFT→PUBLISHED)
- Conflict indicators when creating shifts
- Branch filter for multi-branch orgs

### 4.2 Timeclock UX (clock-in/out + breaks)

**Kimai Behavior:**
- Quick-start timer button
- Running timer display
- Break tracking with pause/resume
- Recent entries list

**Nimbus Prior Patterns (hr/index.tsx):**
- Card-based layout for status
- Action buttons with clear states
- Table for recent records

**Nimbus M10.2 Implementation:**
- "Today's Shift" card showing assigned shift (if any)
- Clock-in/Clock-out buttons (mutually exclusive)
- Break Start/End buttons (only when clocked in)
- Current status indicator (CLOCKED_IN / CLOCKED_OUT)
- Last 10 time entries table
- RBAC: staff sees only their own data

### 4.3 Approvals UX (queue + freeze)

**Kimai Behavior:**
- Approval queue with pending timesheets
- Approve/reject actions
- Comments on approval
- Locked state after approval

**Nimbus Prior Patterns (finance/journal.tsx, documents/index.tsx):**
- List of pending items with date filters
- Approve action button
- Status badge changes on action
- Read-only view after finalization

**Nimbus M10.2 Implementation:**
- List of COMPLETED shifts pending approval
- Branch + date range filters
- Approve button per shift row
- After approval: status→APPROVED, display becomes read-only
- Show actuals: planned vs actual minutes, overtime

### 4.4 Labor Reporting UX (filters + breakdowns)

**Kimai Behavior:**
- Date range filters
- User/project breakdown tables
- Export to CSV/PDF
- Summary KPI cards

**Nimbus Prior Patterns (reservations/reports.tsx):**
- StatCard for KPIs (total, actual, variance)
- Date range inputs (from/to)
- Branch filter dropdown
- Table for breakdown data
- Export CSV button

**Nimbus M10.2 Implementation:**
- KPI cards: Planned Minutes, Actual Minutes, Overtime Minutes
- Date range + branch filters
- Per-role breakdown table
- Per-user breakdown table
- Export buttons for CSV downloads

### 4.5 CSV Export UX

**Kimai Behavior:**
- Download buttons in reports
- File naming with date range
- Standard headers

**Nimbus Prior Patterns (reservations/reports.tsx handleExport):**
- Button triggers API call with responseType: 'blob'
- Create download link programmatically
- Filename includes date range
- Toast on success/failure

**Nimbus M10.2 Implementation:**
- Same pattern as reservations/reports.tsx
- Three export buttons: Shifts, Time Entries, Labor Summary
- Filename: `{type}_{from}_to_{to}.csv`

### 4.6 Audit Log UX

**Kimai Behavior:**
- Read-only audit trail
- Filter by user/action/date
- Expand for payload details

**Nimbus Prior Patterns (staff/index.tsx, hr/index.tsx):**
- Table with pagination
- Date range filter
- Action type column

**Nimbus M10.2 Implementation:**
- Read-only table in labor reports page (L5 only)
- Filter by date range
- Columns: Timestamp, User, Action, Entity Type, Entity ID
- Collapsible payload JSON view

---

## 5. UI Files to Create

| Path | Purpose |
|------|---------|
| `apps/web/src/pages/workforce/schedule.tsx` | Manager scheduling view |
| `apps/web/src/pages/workforce/timeclock.tsx` | Staff timeclock |
| `apps/web/src/pages/workforce/approvals.tsx` | Manager approval queue |
| `apps/web/src/pages/workforce/labor.tsx` | Labor reports + exports + audit |

---

## 6. Navigation Updates

Add to OWNER and MANAGER navGroups in `apps/web/src/config/roleCapabilities.ts`:

```typescript
{
  title: 'Workforce',
  items: [
    { label: 'Schedule', href: '/workforce/schedule', icon: Calendar },
    { label: 'Timeclock', href: '/workforce/timeclock', icon: Clock },
    { label: 'Approvals', href: '/workforce/approvals', icon: CheckCircle },
    { label: 'Labor Reports', href: '/workforce/labor', icon: BarChart3 },
  ],
}
```

Add Timeclock access to L2+ roles (SUPERVISOR, CASHIER, CHEF, etc.)

---

## 7. Seed Data Specification

### Tapas (1 branch)

| Model | Count | Details |
|-------|-------|---------|
| ScheduledShift | 6 | 2 DRAFT, 2 PUBLISHED, 1 COMPLETED, 1 APPROVED |
| TimeEntry (workforce) | 4 | 2 complete (with clockOut), 2 in-progress |
| BreakEntry | 2 | Linked to completed time entries |
| WorkforceAuditLog | 6 | SHIFT_CREATED, SHIFT_PUBLISHED, CLOCK_IN, CLOCK_OUT, BREAK_START, BREAK_END |

### Cafesserie (4 branches)

| Model | Count | Details |
|-------|-------|---------|
| ScheduledShift | 12 | 3 per branch (mix of statuses) |
| TimeEntry (workforce) | 8 | 2 per branch |
| BreakEntry | 4 | 1 per branch |
| WorkforceAuditLog | 12 | Mix of actions per branch |

---

## 8. RBAC Matrix

| Page | L1 | L2 | L3 | L4 | L5 |
|------|----|----|----|----|-----|
| /workforce/schedule | ❌ | ❌ | View | Full | Full |
| /workforce/timeclock | ❌ | Self | Self | Self | Full |
| /workforce/approvals | ❌ | ❌ | ❌ | Full | Full |
| /workforce/labor | ❌ | ❌ | ❌ | Full | Full + Audit |

---

## 9. Dependencies

- M10.1 backend (scheduling, timeclock, reports services)
- Prisma migration for new models
- shadcn/ui components (already available)
- @tanstack/react-query for data fetching

---

## 10. Risk Mitigations

| Risk | Mitigation |
|------|------------|
| Migration fails due to FK order | Seed in correct order: Orgs → Branches → Users → Shifts → TimeEntries |
| E2E tests hang | Use withTimeout() wrappers |
| UI build fails on missing imports | Pre-check shadcn components exist |
| Timezone issues | Use branch timezone from constants |
