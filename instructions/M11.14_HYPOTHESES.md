# M11.14 Hypotheses - Demand Forecasting + Reorder Optimization

## Pre-Implementation Hypotheses

These hypotheses MUST be validated through implementation and testing before M11.14 is considered complete.

---

### H1: Demand Aggregation Accidentally Includes COUNT_VARIANCE/ADJUSTMENT
**Confidence:** 85%
**Risk:** Inflated forecast due to stocktake corrections or manual adjustments being counted as consumption

**Failure Mode:**
- Query filter doesn't properly exclude `COUNT_VARIANCE`, `COUNT_VARIANCE_REVERSAL`, `ADJUSTMENT`, `COUNT_ADJUSTMENT`
- Results in artificially high demand forecasts
- Leads to over-ordering suggestions

**Validation:**
- E2E test: Create ledger entries with mixed reasons, verify only SALE + PRODUCTION_CONSUME are aggregated
- Assert COUNT_VARIANCE entries do not affect forecast

---

### H2: Cross-Branch/Cross-Org Leakage in Aggregation Queries
**Confidence:** 90%
**Risk:** Demand data from one org/branch leaks into another's forecast

**Failure Mode:**
- Missing `orgId` filter in aggregation query
- Missing `branchId` filter when branch-specific forecast requested
- Prisma query uses `findMany` without proper where clause

**Validation:**
- E2E test: Create entries for two orgs, verify Org A forecast excludes Org B data
- Assert totals match expected per-org values

---

### H3: Unit Conversion/Precision Drift Breaks suggestedQty Rounding
**Confidence:** 75%
**Risk:** Decimal precision issues cause incorrect rounding in suggested quantities

**Failure Mode:**
- Using JavaScript native floats instead of Prisma Decimal
- Rounding to wrong decimal places for base UOM
- Precision drift accumulates over aggregation

**Validation:**
- E2E test: Use items with 4-decimal-place precision, verify suggestedQty maintains precision
- Assert no floating point artifacts (e.g., 0.999999999 instead of 1.0000)

---

### H4: Duplicate Snapshots/Runs Created Due to Weak Idempotency Hashing
**Confidence:** 80%
**Risk:** Same parameters create multiple snapshots/runs instead of returning existing

**Failure Mode:**
- Hash doesn't include all relevant parameters (missing modelVersion, branchId, etc.)
- Hash uses unstable input (e.g., Date.now() instead of asOfDate)
- Unique constraint not properly enforced

**Validation:**
- E2E test: Call generate twice with identical params, verify same ID returned
- Assert database has exactly 1 record, not 2

---

### H5: On-Order/In-Transit Calculations Double Count Quantities
**Confidence:** 70%
**Risk:** Quantities in transit or on order counted twice, leading to under-ordering

**Failure Mode:**
- Transfer with IN_TRANSIT status counted in both source and destination branch
- PO remaining qty counted when goods already received
- Partial receipt not properly subtracted from onOrderQty

**Validation:**
- E2E test: Create PO with partial receipt, verify onOrderQty = original - received
- E2E test: Create transfer IN_TRANSIT, verify counted only once (at destination)

---

### H6: Export Hash Mismatch on Windows Due to BOM/Newlines/Order
**Confidence:** 85%
**Risk:** SHA-256 hash differs between platforms or doesn't match downloaded content

**Failure Mode:**
- BOM included in hash calculation but not in normalized content
- CRLF vs LF line endings not normalized before hashing
- Column/row ordering not deterministic (e.g., using object iteration order)

**Validation:**
- E2E test: Generate export, compute hash of response body, compare to X-Nimbus-Export-Hash header
- Use explicit LF normalization and stable ordering

---

### H7: RBAC Allows L2 to Generate Runs or Create POs (Privilege Escalation)
**Confidence:** 90%
**Risk:** Staff-level users can generate forecasts or create purchase orders

**Failure Mode:**
- Controller missing `@Roles()` decorator
- Guard checks wrong role level
- Role level constants incorrect

**Validation:**
- E2E test: Authenticate as L2 user, attempt POST /forecasting/snapshots → expect 403
- E2E test: Authenticate as L2 user, attempt POST /reorder/optimize → expect 403
- E2E test: Authenticate as L4 user, same requests → expect 200/201

---

### H8: Forecast Uses Server Timezone Instead of Branch Timezone
**Confidence:** 75%
**Risk:** Day buckets calculated incorrectly when branch is in different timezone

**Failure Mode:**
- `new Date()` used without timezone conversion
- Branch timezone not looked up before bucketing
- UTC fallback not applied when branch has no timezone

**Validation:**
- Unit test: Mock ledger entries spanning midnight in branch TZ, verify correct day assignment
- Document: Branch timezone lookup pattern, fallback behavior

---

### H9: Forecast Model Returns Different Results for Same Inputs
**Confidence:** 65%
**Risk:** Non-deterministic behavior breaks auditability and idempotency

**Failure Mode:**
- Using `Date.now()` in calculations
- Floating point operations order changes between runs
- Random jitter added to confidence bands

**Validation:**
- E2E test: Generate forecast twice with same inputs, verify identical forecastTotalQty
- Store modelVersion for reproducibility

---

### H10: Open PO Remaining Qty Calculation Ignores Partial Receipts
**Confidence:** 80%
**Risk:** Suggested quantity too low because system thinks order is still pending

**Failure Mode:**
- Using PO line qtyOrdered instead of (qtyOrdered - qtyReceived)
- Not checking GoodsReceiptV2Lines linked to PO
- Only counting APPROVED status, missing SUBMITTED

**Validation:**
- E2E test: Create PO with 100 units, receive 40, verify onOrderQty = 60
- Assert optimization line shows correct available qty

---

## Hypothesis Summary Table

| # | Hypothesis | Confidence | Risk Level | Primary Validation |
|---|------------|------------|------------|-------------------|
| H1 | Demand includes non-consumption reasons | 85% | High | E2E filter test |
| H2 | Cross-tenant leakage in aggregation | 90% | Critical | E2E multi-org test |
| H3 | Precision drift in rounding | 75% | Medium | E2E decimal test |
| H4 | Duplicate snapshots/runs | 80% | High | E2E idempotency test |
| H5 | Double-count in-transit/on-order | 70% | High | E2E calculation test |
| H6 | Export hash mismatch | 85% | Medium | E2E hash verification |
| H7 | RBAC bypass | 90% | Critical | E2E role test |
| H8 | Wrong timezone for buckets | 75% | Medium | Unit test + docs |
| H9 | Non-deterministic forecast | 65% | High | E2E determinism test |
| H10 | Ignores partial receipts | 80% | High | E2E PO test |

---

## Post-Implementation Verification

Each hypothesis will be marked VALIDATED or FAILED in M11.14_COMPLETION_REPORT.md with:
- Test file and test name
- Assertion details
- Any remediation taken
