# M10.8 Parity Re-Audit

**Feature:** Payroll GL Posting (Full) + Configurable Mappings  
**Date:** 2026-01-04

---

## Feature Parity Matrix

| Feature Group | Reference Behavior | Nimbus Target | Evidence |
|---------------|-------------------|---------------|----------|
| **A) Full GL Posting** | Double-entry payroll: Dr Expense / Cr Liabilities with breakdown | Same pattern with taxes + deductions + employer contrib | payroll-posting.service.ts |
| **B) Configurable Mapping** | Org-level account config with defaults | PayrollPostingMapping model + endpoints | schema.prisma, payroll-mapping.service.ts |
| **C) UI** | Admin mapping editor + run preview | /workforce/payroll-posting page | apps/web/src/pages/workforce/payroll-posting.tsx |
| **D) Tests** | E2E coverage of posting lifecycle | 7 test scenarios in E2E spec | workforce-m108-payroll-gl.e2e-spec.ts |

---

## Detailed Parity Analysis

### A) Full GL Posting

**Standard Payroll Accounting:**
1. Accrue wages expense when payroll is finalized
2. Split liabilities: wages payable (NET), taxes payable, deductions payable
3. Record employer contributions as separate expense/liability
4. Pay wages by debiting liability, crediting cash
5. Taxes/deductions remain as liabilities until remittance

**Nimbus Implementation:**
- Follows standard pattern exactly
- Uses PayrollRunJournalLink for audit trail
- Supports reversal via VOID transition
- Branch-level posting when payroll run has branchId

### B) Configurable Mapping

**Reference Pattern:**
- QuickBooks/Xero: Payroll settings with account mapping
- Per-organization configuration
- Optional branch-level overrides

**Nimbus Implementation:**
- PayrollPostingMapping model with 7 account fields
- branchId optional for org-wide or branch-specific
- enabled flag for soft disable
- Preview endpoint for validation before posting

### C) UI

**Required Features:**
- View current mapping with account names
- Edit mapping with account selector
- Preview posting lines for specific run
- Show linked journals on run detail

**Nimbus Implementation:**
- /workforce/payroll-posting page with form
- Enhanced payroll-runs/[id] with preview tab
- Links to journal entries when posted

### D) Tests

**Coverage Requirements:**
1. Mapping CRUD
2. Preview determinism
3. Post idempotency
4. Posted totals match run totals
5. Pay posts NET only
6. Void reverses all
7. Branch behavior

**Nimbus Implementation:**
- E2E spec with all 7 scenarios
- UI tests for mapping page

---

## Gap Analysis

| Gap | Severity | Mitigation |
|-----|----------|------------|
| No tax remittance workflow | Low | Deferred to future milestone |
| No per-employee account overrides | Low | Standard pattern uses org-level |
| No multi-currency support | Low | USD only for MVP |

---

## Acceptance Criteria Mapping

| Criterion | Test | Assertion |
|-----------|------|-----------|
| Mapping persists | E2E | GET returns saved values |
| Preview matches run | E2E | Lines match gross-to-net totals |
| Post creates journals | E2E | JournalEntry created with correct lines |
| Post is idempotent | E2E | Second call returns 409 or no-op |
| Pay posts NET | E2E | Payment journal = net pay |
| Void reverses | E2E | Reversal entries exist |
| Branch journals | E2E | Per-branch or documented fallback |
| RBAC enforced | E2E | L4 can view, L5 can post |
