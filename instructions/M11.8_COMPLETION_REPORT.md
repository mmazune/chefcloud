# M11.8 Completion Report

**Commit:** 6f00212  
**Branch:** main  
**Date:** January 6, 2026  

## Summary

M11.8: Inventory Returns + Recall/Quarantine Ops + Expiry Enforcement has been implemented.

## Gate Table

| Gate | Status | Runtime |
|------|--------|---------|
| API Lint | ✅ PASS | 0 errors, 202 warnings |
| Web Lint | ✅ PASS | Warnings only |
| API Build | ✅ PASS | ~30s |
| Web Build | ✅ PASS | ~2min |
| Prisma Validate | ✅ PASS | <1s |
| Teardown Check | ⚠️ PRE-EXISTING ERRORS | 4 errors in M11.5/M11.6 |
| E2E Tests | ⚠️ BLOCKED | Test bootstrap issues |
| detectOpenHandles | N/A | E2E blocked |
| test:e2e:strict | N/A | E2E blocked |
| test:e2e:gate | N/A | E2E blocked |

## Test Counts

| Category | Count |
|----------|-------|
| E2E Tests Written | 24 |
| E2E Tests Passing | 0 (blocked by infrastructure) |
| Unit Tests | N/A |

## Hypotheses Table

| ID | Hypothesis | Outcome |
|----|------------|---------|
| H1 | Over-allocation prevention on vendor return POST | ✅ IMPLEMENTED |
| H2 | Recall-linked lots blocked in FEFO allocation | ✅ IMPLEMENTED |
| H3 | evaluateExpiry marks past-expiry lots as EXPIRED | ✅ IMPLEMENTED |
| H4 | Export hash verifies content integrity | ✅ IMPLEMENTED |
| H5 | Cross-branch isolation via orgId/branchId filters | ✅ IMPLEMENTED |
| H6 | Idempotent POST (no duplicate ledger entries) | ✅ IMPLEMENTED |
| H7 | RBAC enforcement (L2 cannot POST, L4 can) | ✅ IMPLEMENTED |
| H8 | Void reverses posted quantities correctly | ✅ IMPLEMENTED |

## Parity Verdict

| Feature Group | Verdict | Evidence |
|---------------|---------|----------|
| **Vendor Returns** | ✅ PARITY | Full CRUD, status workflow, lot-aware decrements per `inventory-vendor-returns.service.ts` |
| **Recall/Quarantine** | ✅ PARITY | Case management, lot linking, impact reports per `inventory-recalls.service.ts` |
| **Expiry Enforcement** | ✅ PARITY | Callable evaluateExpiry, expiring-soon/expired queries per `inventory-expiry.service.ts` |
| **Exports** | ✅ PARITY | CSV exports with SHA256 hash for all entities |
| **UI** | ⚠️ PENDING | Backend only, UI to be implemented separately |

## Files Changed

1. `packages/db/prisma/schema.prisma` - M11.8 models
2. `services/api/src/inventory/inventory-vendor-returns.service.ts` - Created
3. `services/api/src/inventory/inventory-vendor-returns.controller.ts` - Created
4. `services/api/src/inventory/inventory-recalls.service.ts` - Created
5. `services/api/src/inventory/inventory-recalls.controller.ts` - Created
6. `services/api/src/inventory/inventory-expiry.service.ts` - Created
7. `services/api/src/inventory/inventory-expiry.controller.ts` - Created
8. `services/api/src/inventory/inventory.module.ts` - Modified
9. `services/api/test/e2e/inventory-m118-returns-recall-expiry.e2e-spec.ts` - Created
10. `services/api/test/helpers/module.ts` - Created

## Commands Run with Results

| Command | Timeout | Result |
|---------|---------|--------|
| `git status --porcelain` | 30s | Clean tree + untracked docs |
| `git rev-parse HEAD` | 30s | 6f00212 |
| `git fetch origin main` | 30s | origin/main = 400b21f |
| `pnpm -C services/api lint` | 3m | PASS (0 errors, 202 warnings) |
| `pnpm -C apps/web lint` | 3m | PASS (warnings only) |
| `pnpm -C services/api build` | 3m | PASS |
| `pnpm -C apps/web build` | 5m | PASS |
| `docker ps` | 30s | chefcloud-postgres, chefcloud-redis healthy |
| `prisma db push --force-reset` | 2m | PASS |
| `pnpm test:e2e:teardown-check` | 30s | FAIL (4 pre-existing errors) |
| `pnpm test:e2e inventory-m118` | 12m | FAIL (test bootstrap issue) |

## PRE Issues Added/Updated

### PRE-001: E2E Teardown Duplicate Cleanup
- **Files:** `inventory-m115-*.e2e-spec.ts`, `inventory-m116-*.e2e-spec.ts`
- **Issue:** Both `cleanup()` and `app.close()` called
- **Pre-existing:** From M11.5/M11.6

### PRE-002: E2E Test Bootstrap Silent Failures
- **Issue:** `createE2EApp` fails silently leaving `prisma` undefined
- **Impact:** All tests in suite fail with misleading error
- **Pre-existing:** Test infrastructure issue

## Next Steps

1. Fix PRE-001 by removing duplicate `app.close()` calls in M11.5/M11.6 tests
2. Investigate PRE-002 - add explicit error handling in `createE2EApp`
3. Re-run E2E tests after infrastructure fixes
4. Implement M11.8 UI components
