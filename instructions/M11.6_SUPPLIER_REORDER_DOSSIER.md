# M11.6 Supplier Catalog + Price Lists + Reorder Automation — FEATURE DOSSIER

## 1. Executive Summary

This milestone enables procurement automation for nimbusPOS:
- **Supplier Catalog**: Map vendor items to inventory items with vendor-specific SKUs, UOM conversions, and pack sizes
- **Price History**: Track pricing per supplier item with effective dates; auto-derive from receipts
- **Reorder Engine**: Generate suggestions based on reorder points vs on-hand quantities
- **Draft PO Generation**: Create PurchaseOrderV2 records from suggestions (idempotent)

## 2. Feature-Level Comparison (InvenTree → Nimbus)

### A) Supplier Catalog

| InvenTree Pattern | Nimbus Target |
|-------------------|---------------|
| `SupplierPart` model with `supplier`, `part`, `SKU` | `SupplierItem` with `vendorId`, `inventoryItemId`, `vendorSku` |
| `unique_together = ('part', 'supplier', 'SKU')` | `@@unique([orgId, vendorId, inventoryItemId])` + `@@unique([orgId, vendorId, vendorSku])` |
| `pack_quantity` string with UOM parsing | `vendorUomId` FK + `uomConversionFactorToBase` Decimal |
| `pack_quantity_native` computed field | Compute as `vendorQty × factor = baseQty` |
| `multiple` (order multiple) | `minOrderQtyVendorUom` |
| `lead_time` (duration) | `leadTimeDays` integer |
| `active` boolean | `isActive` boolean |
| No explicit "preferred" | `isPreferred` boolean for vendor selection |

### B) Supplier Pricing

| InvenTree Pattern | Nimbus Target |
|-------------------|---------------|
| `SupplierPriceBreak` with `quantity`, `price`, `price_currency` | `SupplierPrice` with `unitPriceVendorUom`, `currency`, `effectiveFrom/To` |
| Quantity-based breaks (price per tier) | v1: Single price; quantity breaks deferred (document in TODO) |
| Updated timestamp on price break | `effectiveFrom`/`effectiveTo` for history |
| No receipt-derived pricing | `source: MANUAL \| RECEIPT_DERIVED` with idempotent update |

### C) Reorder Automation

| InvenTree Pattern | Nimbus Target |
|-------------------|---------------|
| Part has `minimum_stock` | `InventoryItem.reorderLevel` or `ReorderPolicy.reorderPointBaseQty` |
| Part has `reorder_level` | Same |
| Manual ordering wizard | `ReorderSuggestionRun` + `ReorderSuggestionLine` models |
| Order creation from wizard | `POST /inventory/reorder/runs/:id/generate-pos` |
| N/A | `deterministicHash` for idempotency |

### D) Draft PO Generation

| InvenTree Pattern | Nimbus Target |
|-------------------|---------------|
| `PurchaseOrder.add_line_item(supplier_part, quantity, price)` | Create `PurchaseOrderV2` + `PurchaseOrderLineV2` |
| No explicit idempotency key | `externalKey = "reorder:<runId>:<vendorId>"` via `idempotencyKey` |
| Single order creation | Group by vendor, one PO per vendor per branch |

## 3. Data Model Design

### SupplierItem
```prisma
model SupplierItem {
  id                        String   @id @default(cuid())
  orgId                     String
  vendorId                  String   // FK to Vendor
  inventoryItemId           String   // FK to InventoryItem
  vendorSku                 String   // Vendor's SKU/part number
  vendorUomId               String?  // FK to UnitOfMeasure (ordering unit)
  uomConversionFactorToBase Decimal  @default(1) @db.Decimal(12, 6) // vendorQty × factor = baseQty
  packSizeLabel             String?  // e.g., "12x500ml"
  leadTimeDays              Int      @default(0)
  minOrderQtyVendorUom      Decimal  @default(0) @db.Decimal(12, 4)
  isPreferred               Boolean  @default(false)
  isActive                  Boolean  @default(true)
  metadata                  Json?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([orgId, vendorId, inventoryItemId])
  @@unique([orgId, vendorId, vendorSku])
  @@index([orgId])
  @@index([vendorId])
  @@index([inventoryItemId])
}
```

### SupplierPrice
```prisma
model SupplierPrice {
  id                  String              @id @default(cuid())
  orgId               String
  supplierItemId      String              // FK to SupplierItem
  currency            String              @default("USD")
  unitPriceVendorUom  Decimal             @db.Decimal(12, 4)
  effectiveFrom       DateTime
  effectiveTo         DateTime?
  source              SupplierPriceSource @default(MANUAL)
  sourceReceiptLineId String?             // For RECEIPT_DERIVED, idempotency key
  note                String?
  createdAt           DateTime            @default(now())

  @@index([supplierItemId])
  @@index([orgId])
  @@unique([supplierItemId, sourceReceiptLineId]) // Idempotency for receipt-derived
}

enum SupplierPriceSource {
  MANUAL
  RECEIPT_DERIVED
}
```

### ReorderPolicy
```prisma
model ReorderPolicy {
  id                  String   @id @default(cuid())
  orgId               String
  branchId            String
  inventoryItemId     String
  reorderPointBaseQty Decimal  @db.Decimal(12, 4)
  reorderQtyBaseQty   Decimal  @db.Decimal(12, 4)
  preferredLocationId String?
  preferredVendorId   String?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([orgId, branchId, inventoryItemId])
  @@index([orgId, branchId])
}
```

### ReorderSuggestionRun
```prisma
model ReorderSuggestionRun {
  id               String   @id @default(cuid())
  orgId            String
  branchId         String
  asOf             DateTime @default(now())
  deterministicHash String  // SHA256 of sorted inputs
  createdById      String
  createdAt        DateTime @default(now())

  @@unique([orgId, branchId, deterministicHash])
  @@index([orgId, branchId])
}
```

### ReorderSuggestionLine
```prisma
model ReorderSuggestionLine {
  id                   String              @id @default(cuid())
  orgId                String
  runId                String
  inventoryItemId      String
  onHandBaseQty        Decimal             @db.Decimal(12, 4)
  reorderPointBaseQty  Decimal             @db.Decimal(12, 4)
  suggestedBaseQty     Decimal             @db.Decimal(12, 4)
  suggestedVendorId    String?
  suggestedVendorUomId String?
  suggestedVendorQty   Decimal?            @db.Decimal(12, 4)
  reasonCode           ReorderReasonCode
  createdAt            DateTime            @default(now())

  @@unique([runId, inventoryItemId])
  @@index([runId])
}

enum ReorderReasonCode {
  BELOW_REORDER_POINT
  NEGATIVE_ON_HAND
  MANUAL_TRIGGER
}
```

## 4. Hypotheses (Risk Analysis)

| ID | Hypothesis | Confidence | Failure Mode | Mitigation |
|----|-----------|------------|--------------|------------|
| H1 | SupplierItem vendorSku uniqueness leaks across org if constraints missing | 90% | Vendor A org1 SKU "ABC" conflicts with org2 | `@@unique([orgId, vendorId, vendorSku])` |
| H2 | UOM conversion factor misapplied causing wrong vendor qty | 85% | Off-by-factor ordering (e.g., 10 cases vs 10 bottles) | Unit test factor calculation; round UP |
| H3 | Suggestion run idempotency fails causing duplicate runs/POs | 90% | Multiple runs with same inputs create duplicates | `deterministicHash` unique constraint; return existing |
| H4 | Draft PO externalKey not enforced -> duplicates per vendor | 88% | Multiple POs for same reorder run + vendor | Use `idempotencyKey` on PurchaseOrderV2 |
| H5 | Price history overlap (effectiveTo) causes ambiguous "latest price" | 80% | Wrong price selected for PO | Query `effectiveTo IS NULL` OR `effectiveTo >= now()` with `ORDER BY effectiveFrom DESC LIMIT 1` |
| H6 | Export hash mismatch on Windows due to BOM/LF normalization | 95% | CSV validation fails on Windows | Hash computed on LF-normalized content before BOM |
| H7 | RBAC allows L2 to generate POs (privilege escalation) | 85% | Staff can create unauthorized POs | Explicit `@Roles('L4')` on generate-pos endpoint |
| H8 | Receipt-derived price inference duplicates entries (non-idempotent) | 90% | Multiple SupplierPrice rows for same receipt line | `@@unique([supplierItemId, sourceReceiptLineId])` |

## 5. API Endpoints

### Supplier Catalog (L4+ write, L2+ read)
- `POST /inventory/suppliers/items` - Create supplier item
- `GET /inventory/suppliers/items` - List supplier items (filter by vendor, item)
- `GET /inventory/suppliers/items/:id` - Get supplier item
- `PATCH /inventory/suppliers/items/:id` - Update supplier item
- `POST /inventory/suppliers/items/:id/prices` - Add price
- `GET /inventory/suppliers/items/:id/prices` - List price history

### Reorder Policies (L4+ write, L2+ read)
- `POST /inventory/reorder/policies` - Create/update policy
- `GET /inventory/reorder/policies` - List policies
- `PATCH /inventory/reorder/policies/:id` - Update policy

### Suggestions + Draft PO (L4+)
- `POST /inventory/reorder/runs` - Create or return existing run by hash
- `GET /inventory/reorder/runs/:id` - Get run with lines
- `POST /inventory/reorder/runs/:id/generate-pos` - Generate draft POs (idempotent)
- `GET /inventory/reorder/runs/:id/pos` - List linked POs

### Exports (L4+)
- `GET /inventory/export/supplier-items` - CSV with BOM + hash
- `GET /inventory/export/reorder-suggestions/:runId` - CSV with BOM + hash

## 6. Web UI Pages

| Route | Purpose | Access |
|-------|---------|--------|
| `/inventory/suppliers` | Supplier items CRUD + price history drawer | L2+ read, L4+ write |
| `/inventory/reorder-policies` | Reorder policy CRUD | L2+ read, L4+ write |
| `/inventory/reorder-suggestions` | Run generator, view lines, generate POs, link to POs | L4+ |

## 7. Audit Actions

- `SUPPLIER_ITEM_CREATED`
- `SUPPLIER_ITEM_UPDATED`
- `SUPPLIER_ITEM_DEACTIVATED`
- `SUPPLIER_PRICE_ADDED`
- `REORDER_POLICY_CREATED`
- `REORDER_POLICY_UPDATED`
- `REORDER_RUN_CREATED`
- `REORDER_POS_GENERATED`

## 8. Deferred Features (v2)

- Quantity-based price breaks (tier pricing)
- Automatic reorder scheduling (cron-based)
- Lead time integration with expected delivery dates
- Multi-currency price comparison
- Vendor performance scoring
