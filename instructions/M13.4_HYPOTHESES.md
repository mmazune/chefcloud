# M13.4 Payments Core + Receipts + Cash Management — Hypotheses

**Written BEFORE implementation** per CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md

---

## H1: Cross-Branch Payment Leakage
**Confidence:** 95%
**Hypothesis:** If payment or order queries miss orgId/branchId filtering, a user in Branch A could create/capture/refund payments for orders in Branch B.
**Failure Mode:** Data isolation breach; financial misattribution; compliance violation.
**Mitigation:** Every payment query MUST include `order.branch.orgId === jwt.orgId AND order.branchId === jwt.branchId`.

---

## H2: Double Capture Race Condition
**Confidence:** 90%
**Hypothesis:** If two concurrent capture requests hit the same AUTHORIZED payment, both may succeed without idempotency guards, resulting in double-charging or accounting discrepancy.
**Failure Mode:** Customer overcharged; payment.capturedCents > amountCents; audit trail inconsistent.
**Mitigation:** Use idempotencyKey + status guard. First capture sets CAPTURED; second call returns same result (idempotent).

---

## H3: Refund Exceeds Captured Amount
**Confidence:** 92%
**Hypothesis:** Without strict math validation, a refund request could exceed `capturedCents - refundedCents`, creating negative or invalid refund state.
**Failure Mode:** Financial integrity violation; impossible refund amounts in audit.
**Mitigation:** Validate `amountCents <= capturedCents - refundedCents` BEFORE processing. Reject with clear error code.

---

## H4: Receipt Issued Before Full Payment
**Confidence:** 88%
**Hypothesis:** If receipt issuance checks only "payment exists" instead of "payment is CAPTURED and covers order total", receipts may be issued for unpaid orders.
**Failure Mode:** False receipts; tax/audit issues; customer disputes.
**Mitigation:** Receipt issuance REQUIRES `sum(payment.capturedCents) >= order.totalCents` with all payments in CAPTURED status.

---

## H5: Multiple Open Cash Sessions Per Branch
**Confidence:** 85%
**Hypothesis:** If the unique constraint or open-session guard is missing, a branch could have multiple OPEN cash sessions, breaking cash accountability.
**Failure Mode:** Unclear which session receives cash payments; reconciliation impossible.
**Mitigation:** Before opening, check `CashSession.findFirst({ branchId, status: 'OPEN' })`. Reject if exists.

---

## H6: Export Hash Mismatch (BOM/Newlines)
**Confidence:** 80%
**Hypothesis:** Windows CRLF vs Unix LF differences, or missing UTF-8 BOM, could cause export hash mismatches between generation and verification.
**Failure Mode:** Audit integrity checks fail; export rejected by compliance tools.
**Mitigation:** Force UTF-8 BOM (`\uFEFF`) and consistent `\n` line endings. Hash computed on final buffer, not string.

---

## H7: UI Tests Hang Due to Timers/Polling
**Confidence:** 75%
**Hypothesis:** If checkout or cash session pages use `setInterval` or long `setTimeout` for polling, tests may hang waiting for cleanup.
**Failure Mode:** CI timeout; --forceExit masks real issues.
**Mitigation:** Use React Query or SWR with proper cleanup. In tests, mock timers or use `waitFor` with short intervals.

---

## H8: RBAC Bypass for Refund/Void
**Confidence:** 88%
**Hypothesis:** If refund/void endpoints don't enforce L4+ role check, an L2 user could refund payments, violating separation of duties.
**Failure Mode:** Unauthorized refunds; financial fraud potential.
**Mitigation:** Use `@Roles('L4')` decorator on void/refund endpoints. Test with L2 token → expect 403.

---

## H9: Idempotency Key Collision Across Orgs
**Confidence:** 70%
**Hypothesis:** If idempotencyKey unique constraint is global instead of org-scoped, Org A could accidentally or maliciously reuse Org B's key.
**Failure Mode:** Payment creation fails incorrectly; cross-org data leak potential.
**Mitigation:** Unique constraint must be `@@unique([orgId, idempotencyKey])`, not just `@@unique([idempotencyKey])`.

---

## H10: Cash Payment Not Linked to Open Session
**Confidence:** 82%
**Hypothesis:** If CASH payments don't validate/record the current open session, cash reconciliation at close will be incorrect.
**Failure Mode:** Cash session expectedCashCents doesn't match actual CASH payments.
**Mitigation:** CASH payment creation should capture `cashSessionId` (optional in v1) OR query window is `openedAt <= payment.createdAt <= closedAt`.

---

## Summary Table

| ID | Hypothesis | Confidence | Severity |
|----|------------|------------|----------|
| H1 | Cross-branch payment leakage | 95% | Critical |
| H2 | Double capture race condition | 90% | High |
| H3 | Refund exceeds captured | 92% | High |
| H4 | Receipt before payment | 88% | High |
| H5 | Multiple open sessions | 85% | Medium |
| H6 | Export hash mismatch | 80% | Medium |
| H7 | UI test hangs | 75% | Low |
| H8 | RBAC bypass refund/void | 88% | High |
| H9 | Idempotency key collision | 70% | Medium |
| H10 | Cash session linkage | 82% | Medium |

---

**Date:** 2026-01-08
**Author:** GitHub Copilot
