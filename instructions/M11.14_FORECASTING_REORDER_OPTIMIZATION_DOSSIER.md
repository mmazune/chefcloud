# M11.14 Demand Forecasting + Reorder Optimization Feature Dossier

## Overview
Upgrades reorder from "rules only" to "data-assisted planning" by generating deterministic demand forecasts from actual consumption (POS depletion, waste, production), producing explainable reorder suggestions incorporating lead time + safety stock + reorder point.

## Scope Summary

| Feature Group | Description |
|--------------|-------------|
| A) Forecast Inputs + Aggregation | Daily demand series from ledger entries |
| B) Forecast Model | Trailing moving average, deterministic, explainable |
| C) Reorder Optimization | Safety stock, lead time, in-transit, on-order |
| D) Endpoints | CRUD + generate + export with RBAC |
| E) Web UI | Forecasting + Optimization pages |
| F) Reporting + Exports | CSV with BOM + SHA-256 hash |

---

## A) Forecast Inputs + Aggregation

### Demand Sources
**Included in Demand Calculation (default):**
- `SALE` - POS order depletion
- `PRODUCTION_CONSUME` - Production batch consumption

**Excluded from Demand (non-consumption):**
- `COUNT_VARIANCE` / `COUNT_VARIANCE_REVERSAL` - Stocktake corrections
- `ADJUSTMENT` / `COUNT_ADJUSTMENT` - Manual adjustments
- `WASTAGE` - Excluded from forecast by default (tracked as shrink KPI)
- `PURCHASE` / `RECEIVE` / `PRODUCTION_PRODUCE` - Inbound, not demand
- `TRANSFER_IN` / `TRANSFER_OUT` - Internal movements, zero-sum
- `VENDOR_RETURN` - Outbound but not consumption

### Normalization
- **UOM**: Base UOM only (qty field in ledger is already base)
- **Timezone**: Branch timezone if set, else UTC
- **Daily buckets**: `[00:00, 24:00)` in branch timezone

### Reference Comparison

| Feature | InvenTree | Odoo | Nimbus M11.14 |
|---------|-----------|------|---------------|
| Stock history | StockItemTracking table | Stock moves | InventoryLedgerEntry |
| Consumption filter | Uses stock move types | Configurable rules | reason enum filter |
| Timezone | UTC only | User TZ for reports | Branch TZ with UTC fallback |

---

## B) Forecast Model

### Approach
- **Method**: Trailing Moving Average (TMA)
- **Window options**: 7, 14, 28 days (default: 14)
- **Day-of-week weighting**: Optional (default: disabled for determinism)
- **Horizon**: Configurable, default 14 days forward

### Determinism Requirements
- Same inputs → same outputs
- `modelVersion` string stored for reproducibility
- `deterministicHash` = SHA-256 of (orgId, branchId, itemId, windowDays, horizonDays, asOfDate, modelVersion)

### Output Fields
- `forecastTotalQty`: Sum of daily forecasts over horizon
- `avgDailyQty`: forecastTotalQty / horizonDays
- `confidenceBandLow/High`: ±20% of avgDailyQty (simple, documented)
- `lastObservedDate`: Most recent ledger entry date for this item

### Reference Comparison

| Feature | InvenTree | Odoo | Nimbus M11.14 |
|---------|-----------|------|---------------|
| Forecast method | Manual reorder point | Multiple (MTO, MTS, rules) | TMA (explainable) |
| Lead time | Per supplier | Per product/route | Per policy |
| Safety stock | Manual | Days/qty configurable | Days-based formula |
| Determinism | N/A | Complex (MRP) | Fully deterministic |

---

## C) Reorder Optimization

### Extended ReorderPolicy Fields
```prisma
model ReorderPolicy {
  // ... existing fields ...
  leadTimeDays        Int     @default(3)
  safetyStockDays     Int     @default(2)
  minOrderQty         Decimal? @db.Decimal(12, 4)
  includeOnHandInTransit Boolean @default(true)
  includeOpenPOs      Boolean @default(true)
  includeQuarantinedLots Boolean @default(false)
  includeRecallBlockedLots Boolean @default(false)
}
```

### New Models

**DemandForecastSnapshot**
- Stores a point-in-time forecast for an item at a branch
- Keyed by deterministicHash for idempotency

**ForecastOptimizationRun**
- Batch run generating optimized reorder suggestions
- Links to forecast snapshot(s) used
- Status: DRAFT → GENERATED → PO_CREATED

**ForecastOptimizationLine**
- Per-item suggestions with full breakdown

### Optimization Formula
```
availableQty = onHandQty + (inTransitQty if includeOnHandInTransit)
             + (onOrderQty if includeOpenPOs)
             - (quarantinedQty if includeQuarantinedLots)
             - (recallBlockedQty if includeRecallBlockedLots)

targetStockQty = avgDailyQty * (leadTimeDays + safetyStockDays)

suggestedQty = max(0, ceil(targetStockQty - availableQty))
```

### Reason Codes
- `BELOW_REORDER_POINT` - Current on-hand < reorder point
- `FORECAST_DRIVEN` - Forecast demand exceeds available
- `STOCKOUT_RISK` - Available < (lead time * avg daily)
- `LEAD_TIME_BUFFER` - Adding safety stock buffer

### Reference Comparison

| Feature | InvenTree | Odoo | Nimbus M11.14 |
|---------|-----------|------|---------------|
| Reorder point | Static per item | Per product/route | Per item+branch policy |
| Safety stock | Manual qty | Days or qty | Days-based |
| Lead time | Per supplier | Per route | Per policy (avg) |
| In-transit | Not tracked | WIP moves | Transfer IN_TRANSIT status |
| Open POs | Manual check | MRP considers | Remaining qty on APPROVED/SUBMITTED POs |

---

## D) Endpoints

### Forecasting (L4+ write, L2+ read)
| Method | Path | Description |
|--------|------|-------------|
| POST | /inventory/forecasting/snapshots | Generate snapshot (idempotent) |
| GET | /inventory/forecasting/snapshots | List snapshots with filters |
| GET | /inventory/forecasting/snapshots/:id | Get snapshot detail |
| GET | /inventory/forecasting/items/:itemId/series | Get demand series data |
| GET | /inventory/export/forecasting | CSV export |

### Optimization (L4+ write, L2+ read)
| Method | Path | Description |
|--------|------|-------------|
| POST | /inventory/reorder/optimize | Generate optimization run |
| GET | /inventory/reorder/optimize | List runs with filters |
| GET | /inventory/reorder/optimize/:id | Get run detail |
| POST | /inventory/reorder/optimize/:id/create-po | Create draft POs |
| GET | /inventory/export/reorder-optimization | CSV export |

---

## E) Web UI

### /inventory/forecasting
- Branch selector (L3+ sees all branches)
- Item filter (search/select)
- Generate Snapshot button (L4+)
- Results table: Item, Avg Daily, Forecast Total, Last Observed, Model
- Export CSV button

### /inventory/reorder-optimization
- Branch selector
- Horizon days selector (7/14/28)
- Lead time / safety stock overrides (optional)
- Generate Run button (L4+)
- Results table: Item, On-Hand, In-Transit, On-Order, Available, Target, Suggested, Reason
- Create Draft PO(s) button (L4+)
- Export CSV button

### Navigation Roles
- OWNER, MANAGER: Full access
- STOCK_MANAGER, PROCUREMENT: Read + Generate
- STAFF (L2): Read only

---

## F) Reporting + Exports

### CSV Standards
- UTF-8 with BOM (0xEF, 0xBB, 0xBF)
- LF line endings (normalize before hash)
- Stable column ordering (alphabetical or schema-defined)
- `X-Nimbus-Export-Hash` header with SHA-256 of normalized content

### Export Fields

**Forecasting Export:**
- itemId, itemSku, itemName
- branchId, branchName
- windowDays, horizonDays
- avgDailyQty, forecastTotalQty
- confidenceLow, confidenceHigh
- lastObservedDate, generatedAt

**Optimization Export:**
- itemId, itemSku, itemName
- branchId, branchName
- onHandQty, inTransitQty, onOrderQty, availableQty
- forecastDemandQty, targetStockQty, suggestedQty
- reasonCodes, explanation

---

## Security Considerations

### RBAC
- Snapshots/Runs read: L2+ (all staff)
- Snapshots/Runs generate: L4+ (Manager+)
- Create POs: L4+ (Manager+)

### Tenant Isolation
- All queries filtered by orgId
- Branch-level scoping for branch-specific data
- No cross-tenant data leakage in aggregation

### Determinism
- Hash prevents duplicate snapshots/runs
- Same inputs → same outputs (auditable)
- Model version tracked for reproducibility

---

## Hypotheses Reference
See instructions/M11.14_HYPOTHESES.md for ≥8 hypotheses covering:
- Demand aggregation correctness
- Cross-tenant isolation
- UOM precision
- Idempotency
- Double-counting
- Export integrity
- RBAC
- Timezone handling
