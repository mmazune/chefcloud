# M13.1 Menu Foundation - Feature Dossier

## Overview
Menu + Catalog Foundation for Nimbus POS, enabling categories, items, modifiers, pricing, availability scheduling, and admin UI.

## Reference Systems Analysis

### TastyIgniter (MIT) - Menu Patterns
- **Categories**: Hierarchical with parent_id, priority (sortOrder), status, description
- **Menu Items**: SKU, price, min/max quantities, special dates, availability schedule
- **Option Groups**: Required flag, min/max selections, display type (radio/checkbox/dropdown)
- **Options**: Price modifier (positive/negative), priority, status
- **Availability**: Day-of-week + time ranges, location-specific overrides

### Medusa (MIT) - Product/Variant Patterns  
- **Products**: Handle (slug), status (draft/published), metadata JSON
- **Variants**: SKU, price, inventory_quantity, options (size/color)
- **Prices**: Currency-aware, region-specific pricing, price lists
- **Collections**: Dynamic grouping with conditions

### Square/Toast (Study-Only) - Modifier UX
- **Modifier Lists**: Attached to items, min/max enforcement at POS
- **Modifier Options**: Price delta, enabled/disabled per location
- **Price Overrides**: Location-specific pricing for same item

## Feature Parity Matrix

### A) Catalog Master Data

| Feature | TastyIgniter | Medusa | M13.1 NimbusPOS | Notes |
|---------|--------------|--------|-----------------|-------|
| Category nesting | ✓ parent_id | ✓ collections | ✓ parentCategoryId | Single level for v1 |
| Category sortOrder | ✓ priority | ✓ rank | ✓ sortOrder INT | Stable ordering |
| Category org-scope | ✓ location_id | ✓ store_id | ✓ orgId | Org-scoped, not branch |
| Item SKU | ✓ | ✓ | ✓ sku (unique per org) | Optional field |
| Item base price | ✓ price | ✓ variants.prices | ✓ basePriceCents INT | Cents to avoid decimal issues |
| Item track inventory | ✓ stock_qty | ✓ inventory_quantity | ✓ trackInventory bool | Bridge to M11 recipes |
| Modifier groups | ✓ option_group | ✓ product_options | ✓ ModifierGroup | min/max/required |
| Modifier options | ✓ option_values | ✓ option_values | ✓ ModifierOption | priceDeltaCents |
| Selection type | ✓ display_type | - | ✓ selectionType enum | SINGLE/MULTI |

### B) Availability / Scheduling

| Feature | TastyIgniter | Medusa | M13.1 NimbusPOS | Notes |
|---------|--------------|--------|-----------------|-------|
| Day-of-week rules | ✓ schedule | - | ✓ daysOfWeek int[] | 0=Sun, 6=Sat |
| Time windows | ✓ open/close times | - | ✓ startTime/endTime HH:MM | Branch local time |
| Branch-specific | ✓ location_id | - | ✓ branchId optional | null = all branches |
| Item vs Category | ✓ menu-level | - | ✓ targetType enum | Item overrides category |
| Runtime evaluation | - | - | ✓ isAvailable() service | No cron, on-demand |

### C) API Endpoints

| Endpoint | TastyIgniter | Toast API | M13.1 NimbusPOS | RBAC |
|----------|--------------|-----------|-----------------|------|
| Categories CRUD | ✓ | ✓ | POST/GET/PATCH /menu/categories | L3+ write, L2+ read |
| Items CRUD | ✓ | ✓ | POST/GET/PATCH /menu/items | L3+ write, L2+ read |
| Item detail | ✓ | ✓ | GET /menu/items/:id | L2+ |
| Modifier groups | ✓ | ✓ | POST/GET/PATCH /menu/modifier-groups | L4+ write, L2+ read |
| Modifier options | ✓ | ✓ | POST/GET/PATCH /menu/modifier-options | L4+ write, L2+ read |
| Attach modifiers | ✓ | ✓ | POST /menu/items/:id/modifier-groups | L4+ |
| Availability rules | ✓ | - | POST/GET/PATCH /menu/availability-rules | L4+ write, L2+ read |
| Available items | - | - | GET /menu/items/available?branchId=&at= | L2+ |
| Export CSV | - | ✓ | GET /menu/export/items.csv, modifiers.csv | L4+ |

### D) Web UI

| Page | Description | Pattern |
|------|-------------|---------|
| /menu/categories | List + create/edit dialog | DataTable + Dialog |
| /menu/items | List + filters + create/edit | DataTable + Filters + Dialog |
| /menu/items/[id] | Detail with modifiers | Detail page + nested tables |
| /menu/modifiers | Groups + options tabs | Tabs + DataTable |
| /menu/availability | Rules list + branch filter | DataTable + BranchFilter |

### E) Reporting + Exports

| Feature | Standard | Implementation |
|---------|----------|----------------|
| UTF-8 BOM | ✓ | \uFEFF prefix for Excel compatibility |
| Stable ordering | ✓ | ORDER BY sortOrder, id |
| X-Nimbus-Export-Hash | ✓ | SHA-256 of content (LF normalized) |
| Content-Disposition | ✓ | attachment; filename="items-{date}.csv" |

## Gap Analysis

1. **Existing schema is branch-scoped** - Need to migrate Category/MenuItem to orgId (breaking change)
2. **Missing sortOrder on modifiers** - Need migration
3. **Missing availability system** - New model + service
4. **Missing export endpoints** - New controller methods
5. **basePriceCents vs Decimal** - Keep Decimal for compatibility, add cents conversion
6. **selectionType enum** - Add to ModifierGroup

## Decision: Branch vs Org Scoping

After analysis, keeping **branch-scoped** items makes sense for multi-location restaurants where each branch may have different menus. However, **ModifierGroups** should remain org-scoped as they're shared.

**Resolution**: 
- Keep MenuItem/Category branch-scoped but validate orgId through branch relation
- Add orgId field to Category for cross-branch queries
- Keep ModifierGroup org-scoped
