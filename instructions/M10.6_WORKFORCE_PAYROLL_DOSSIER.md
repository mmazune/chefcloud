# M10.6 Workforce: Payroll Runs + Accounting Posting + Manager/Accountant Ops UI

> **Version:** 1.0  
> **Created:** 2026-01-04  
> **Status:** IN_PROGRESS  

---

## 1. Overview

This milestone introduces enterprise payroll operations built on M10.1–M10.5 timekeeping infrastructure. Key features:

- **A) Payroll Runs (Backend + Model):** State machine workflow from DRAFT → CALCULATED → APPROVED → POSTED → PAID | VOID
- **B) Finance Integration (GL Posting):** Double-entry accounting with Labor Expense / Wages Payable / Cash accounts
- **C) Manager/Accountant Ops UI:** Web pages for payroll run management with role-based actions
- **D) Reporting Extensions:** Payroll KPIs and CSV exports

---

## 2. Data Model

### 2.1 PayrollRunStatus Enum

```
DRAFT      - Created, awaiting calculation
CALCULATED - Totals computed, awaiting approval
APPROVED   - Manager approved, awaiting posting
POSTED     - Posted to GL, awaiting payment
PAID       - Fully paid out
VOID       - Reversed/voided
```

### 2.2 PayrollRun Model

| Field | Type | Description |
|-------|------|-------------|
| id | String (CUID) | Primary key |
| orgId | String | Organization scope |
| branchId | String? | Optional branch scope (null = org-wide) |
| payPeriodId | String | Links to PayPeriod |
| status | PayrollRunStatus | Current state |
| regularHours | Decimal | Total regular hours |
| overtimeHours | Decimal | Total overtime hours |
| breakHours | Decimal | Total break hours |
| paidHours | Decimal | Total paid hours |
| grossAmount | Decimal? | Total gross pay (if rates configured) |
| createdById | String | User who created |
| calculatedAt | DateTime? | When calculated |
| approvedById | String? | User who approved |
| approvedAt | DateTime? | When approved |
| postedById | String? | User who posted |
| postedAt | DateTime? | When posted |
| paidById | String? | User who marked paid |
| paidAt | DateTime? | When paid |
| voidedById | String? | User who voided |
| voidedAt | DateTime? | When voided |

### 2.3 PayrollRunLine Model

| Field | Type | Description |
|-------|------|-------------|
| id | String (CUID) | Primary key |
| payrollRunId | String | Parent run |
| userId | String | Employee |
| regularHours | Decimal | Employee regular hours |
| overtimeHours | Decimal | Employee overtime hours |
| breakHours | Decimal | Employee break hours |
| paidHours | Decimal | Employee paid hours |
| hourlyRate | Decimal? | Optional wage rate |
| grossAmount | Decimal? | Computed gross pay |

### 2.4 PayrollRunJournalLink Model

| Field | Type | Description |
|-------|------|-------------|
| id | String (CUID) | Primary key |
| payrollRunId | String | Payroll run |
| journalEntryId | String | GL journal entry |
| type | String | "ACCRUAL" or "PAYMENT" |

---

## 3. State Machine

```
DRAFT → CALCULATED → APPROVED → POSTED → PAID
                  ↘              ↓
                   (any) → → → VOID
```

### Transitions

| From | To | Action | Actor | Conditions |
|------|-----|--------|-------|------------|
| DRAFT | CALCULATED | calculate | L4+ | PayPeriod not CLOSED/EXPORTED |
| CALCULATED | DRAFT | recalculate | L4+ | PayPeriod not CLOSED/EXPORTED |
| CALCULATED | APPROVED | approve | L4+ | - |
| APPROVED | POSTED | post | L5/Accountant | Creates GL entry |
| POSTED | PAID | pay | L5/Accountant | Creates payment GL entry |
| POSTED | VOID | void | L5 | Creates reversal GL entry |
| PAID | VOID | void | L5 | Creates reversal GL entries |

---

## 4. GL Posting Pattern

### 4.1 POSTED Transition (Accrual)

```
Dr  Labor Expense (6000)     [grossAmount]
  Cr  Wages Payable (2105)   [grossAmount]
```

### 4.2 PAID Transition (Payment)

```
Dr  Wages Payable (2105)     [grossAmount]
  Cr  Cash/Bank (1000/1010)  [grossAmount]
```

### 4.3 VOID (Reversal)

- Creates reversal journal entries with opposite debits/credits
- Links via reversesEntryId per M8.2b pattern

---

## 5. API Endpoints

### 5.1 Payroll Runs Controller

| Method | Path | Description | RBAC |
|--------|------|-------------|------|
| GET | /workforce/payroll-runs | List runs | L3+ |
| GET | /workforce/payroll-runs/:id | Get run detail | L3+ |
| POST | /workforce/payroll-runs | Create run | L4+ |
| POST | /workforce/payroll-runs/:id/calculate | Calculate | L4+ |
| POST | /workforce/payroll-runs/:id/approve | Approve | L4+ |
| POST | /workforce/payroll-runs/:id/post | Post to GL | L5/Accountant |
| POST | /workforce/payroll-runs/:id/pay | Mark paid | L5/Accountant |
| POST | /workforce/payroll-runs/:id/void | Void | L5 |
| GET | /workforce/payroll-runs/:id/export | Export CSV | L4+ |

### 5.2 Payroll Reports

| Method | Path | Description | RBAC |
|--------|------|-------------|------|
| GET | /workforce/reports/payroll/summary | KPI summary | L4+ |
| GET | /workforce/reports/payroll/export/summary | CSV summary | L4+ |
| GET | /workforce/reports/payroll/export/lines | CSV lines | L4+ |
| GET | /workforce/reports/payroll/audit | Audit trail | L5 |

---

## 6. Web Pages

| Path | Purpose | RBAC |
|------|---------|------|
| /workforce/payroll-runs | List + filters | L3+ |
| /workforce/payroll-runs/[id] | Detail + actions | L3+ |

---

## 7. Security & Compliance

- **Period Lock:** 403 if PayPeriod status = CLOSED/EXPORTED
- **Idempotency:** Prevent double-post via status checks
- **RBAC:** Staff (L1-L2) have no access
- **Audit:** All transitions logged to WorkforceAuditLog
- **Immutability:** POSTED entries only reversible via VOID pattern

---

## 8. Files to Create/Modify

### Backend

| File | Action |
|------|--------|
| packages/db/prisma/schema.prisma | Add PayrollRunStatus, PayrollRun, PayrollRunLine, PayrollRunJournalLink |
| services/api/src/workforce/payroll-run.service.ts | Create (state machine + computation) |
| services/api/src/workforce/payroll-posting.service.ts | Create (GL integration) |
| services/api/src/workforce/payroll-reporting.service.ts | Create (KPIs + exports) |
| services/api/src/workforce/payroll-runs.controller.ts | Create (endpoints) |
| services/api/src/workforce/workforce.module.ts | Update (register new services/controllers) |
| services/api/src/workforce/workforce-audit.service.ts | Update (add payroll action types) |

### Web

| File | Action |
|------|--------|
| apps/web/src/pages/workforce/payroll-runs/index.tsx | Create |
| apps/web/src/pages/workforce/payroll-runs/[id].tsx | Create |

### Tests

| File | Action |
|------|--------|
| services/api/test/e2e/workforce-m106-payroll.e2e-spec.ts | Create |
| apps/web/src/__tests__/pages/workforce/m106-payroll-ui.test.tsx | Create |
