# M12.1 Inventory Period Close + Locking + GL Reconciliation Pack

## Overview
Adds enterprise inventory close workflow that:
- Snapshots valuation and movement totals for explicit periods
- Locks inventory-posting into closed periods (with controlled override)
- Reconciles inventory movements vs GL postings (from M11.13)
- Produces audit-grade exports

This is the inventory equivalent of "month-end close" for serious multi-branch operations.

## Scope Summary

| Feature | Description | Status |
|---------|-------------|--------|
| A) Inventory Period Model | Branch-scoped period with OPEN/CLOSED status | Planned |
| B) Period Lock Enforcement | Block posting within closed periods + L5 override | Planned |
| C) Close Operation | Idempotent close with snapshot generation | Planned |
| D) GL Reconciliation Pack | Compare inventory movements vs GL journal postings | Planned |
| E) Exports | Audit-grade CSV with BOM + SHA-256 hash | Planned |
| F) Web UI | Minimal operational UI for period close | Planned |

## Feature-Level Parity Comparison

### A) Inventory Period Model

| System | Pattern | Key Behaviors |
|--------|---------|---------------|
| **InvenTree** | StockItemHistory + valuation snapshots | Per-item history tracking; no explicit period model; snapshots via reporting |
| **Odoo (study-only)** | stock.valuation.layer + account.period | Perpetual valuation layers; period locks via fiscal year close; FIFO/AVCO layers |
| **Nimbus (target)** | InventoryPeriod + InventoryValuationSnapshot + InventoryPeriodMovementSummary | Branch-scoped periods; explicit close; append-only snapshots per period |

**Nimbus Design Decisions:**
- `endDate` is **inclusive** (e.g., Jan 31 means ledger entries with createdAt ≤ 2024-01-31 23:59:59.999)
- Period is branch-scoped (@@unique([orgId, branchId, startDate, endDate]))
- Valuation snapshot is append-only per period (@@unique([periodId, itemId, locationId]))

### B) Period Lock Enforcement

| System | Pattern | Override Mechanism |
|--------|---------|-------------------|
| **InvenTree** | No explicit period lock | Manual adjustments always allowed |
| **Odoo** | Fiscal lock dates | User access rights to bypass; audit trail |
| **Nimbus** | 403 INVENTORY_PERIOD_LOCKED | L5-only override via POST /inventory/periods/:id/override-post with audit logging |

**Nimbus Design Decisions:**
- All posting actions check for closed periods via centralized helper
- Override is L5-only (OWNER/ADMIN)
- Override requires reason string, logs INVENTORY_PERIOD_OVERRIDE_USED
- Single-use override: each override allows one blocked action

### C) Close Operation

| System | Pattern | Blocking States |
|--------|---------|-----------------|
| **InvenTree** | No formal close | N/A |
| **Odoo** | Year-end close; inventory valuation reconciliation | Draft invoices, unposted journals |
| **Nimbus** | POST /inventory/periods/close | See blocking states below |

**Nimbus Blocking States (must clear before close):**
1. No stocktakes in SUBMITTED/APPROVED (not POSTED/VOID) within date range
2. No production batches in DRAFT for that branch within range
3. No transfers IN_TRANSIT older than endDate
4. No pending adjustments PENDING status within range

**Idempotency:** Re-calling close for same params returns existing closed period; does NOT duplicate snapshots.

### D) GL Reconciliation Pack

| System | Pattern | Delta Handling |
|--------|---------|----------------|
| **InvenTree** | No GL integration | N/A |
| **Odoo** | stock.landed.cost + account.move reconciliation | Automatic revaluation entries |
| **Nimbus** | Reconciliation comparing inventorySide vs glSide | MATCH/WARN/FAIL status per category |

**Reconciliation Categories:**
- Receipts: GRNI debits/credits
- Waste: Waste expense debits
- Depletion/COGS: COGS expense debits
- Stocktake variance: Inventory adjustments

### E) Exports

| Feature | Implementation |
|---------|----------------|
| Encoding | UTF-8 with BOM |
| Ordering | Stable deterministic (itemId ASC, locationId ASC) |
| Hash | X-Nimbus-Export-Hash SHA-256 over normalized LF content |
| Endpoints | valuation.csv, movements.csv, reconciliation.csv |

### F) Web UI

| Feature | Implementation |
|---------|----------------|
| Page | /inventory/period-close |
| List | Existing periods per branch |
| Create/Close | Dialog with date range |
| View Tabs | Valuation / Movements / Reconciliation |
| Export | CSV download buttons |
| RBAC | L4+ (OWNER, MANAGER, STOCK_MANAGER, PROCUREMENT) |

## Data Models

### InventoryPeriod
```prisma
model InventoryPeriod {
  id          String              @id @default(cuid())
  orgId       String
  branchId    String
  startDate   DateTime            @db.Date
  endDate     DateTime            @db.Date  // Inclusive
  status      InventoryPeriodStatus @default(OPEN)
  closedAt    DateTime?
  closedById  String?
  lockReason  String?             // e.g., "Month-end close"
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  closedBy  User?    @relation(fields: [closedById], references: [id], onDelete: SetNull)
  
  valuationSnapshots InventoryValuationSnapshot[]
  movementSummaries  InventoryPeriodMovementSummary[]

  @@unique([orgId, branchId, startDate, endDate])
  @@index([orgId, branchId])
  @@index([status])
  @@map("inventory_periods")
}

enum InventoryPeriodStatus {
  OPEN
  CLOSED
}
```

### InventoryValuationSnapshot
```prisma
model InventoryValuationSnapshot {
  id          String   @id @default(cuid())
  orgId       String
  branchId    String
  periodId    String
  itemId      String
  locationId  String
  qtyOnHand   Decimal  @db.Decimal(12, 4)
  wac         Decimal  @db.Decimal(12, 4)
  value       Decimal  @db.Decimal(12, 2)
  asOf        DateTime // Timestamp consistent with endDate boundary
  createdAt   DateTime @default(now())

  // Relations
  period   InventoryPeriod   @relation(fields: [periodId], references: [id], onDelete: Cascade)
  item     InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Restrict)
  location InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Restrict)

  @@unique([periodId, itemId, locationId])
  @@index([periodId])
  @@index([orgId, branchId])
  @@map("inventory_valuation_snapshots")
}
```

### InventoryPeriodMovementSummary
```prisma
model InventoryPeriodMovementSummary {
  id         String   @id @default(cuid())
  orgId      String
  branchId   String
  periodId   String
  itemId     String?  // null = branch total row
  // Receive
  receiveQty    Decimal  @db.Decimal(12, 4) @default(0)
  receiveValue  Decimal  @db.Decimal(12, 2) @default(0)
  // Sales/Depletion
  depletionQty   Decimal  @db.Decimal(12, 4) @default(0)
  depletionValue Decimal  @db.Decimal(12, 2) @default(0)
  // Waste
  wasteQty    Decimal  @db.Decimal(12, 4) @default(0)
  wasteValue  Decimal  @db.Decimal(12, 2) @default(0)
  // Transfers
  transferInQty   Decimal  @db.Decimal(12, 4) @default(0)
  transferOutQty  Decimal  @db.Decimal(12, 4) @default(0)
  // Adjustments
  adjustmentQty   Decimal  @db.Decimal(12, 4) @default(0)
  adjustmentValue Decimal  @db.Decimal(12, 2) @default(0)
  // Count variance (stocktake)
  countVarianceQty   Decimal  @db.Decimal(12, 4) @default(0)
  countVarianceValue Decimal  @db.Decimal(12, 2) @default(0)
  // Production
  productionConsumeQty  Decimal  @db.Decimal(12, 4) @default(0)
  productionConsumeValue Decimal @db.Decimal(12, 2) @default(0)
  productionProduceQty   Decimal  @db.Decimal(12, 4) @default(0)
  productionProduceValue Decimal @db.Decimal(12, 2) @default(0)
  createdAt DateTime @default(now())

  // Relations
  period InventoryPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  item   InventoryItem?  @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@unique([periodId, itemId])
  @@index([periodId])
  @@index([orgId, branchId])
  @@map("inventory_period_movement_summaries")
}
```

## Implementation Files

| File | Purpose |
|------|---------|
| `packages/db/prisma/schema.prisma` | Add models + enums |
| `services/api/src/inventory/inventory-periods.service.ts` | Create/list/close/lock checks |
| `services/api/src/inventory/inventory-valuation-snapshot.service.ts` | Snapshot generation |
| `services/api/src/inventory/inventory-reconciliation.service.ts` | GL reconciliation |
| `services/api/src/inventory/inventory-period-export.service.ts` | CSV + BOM + hash |
| `services/api/src/inventory/inventory-periods.controller.ts` | REST endpoints |
| `apps/web/src/pages/inventory/period-close/index.tsx` | UI page |

## Audit Actions

- `INVENTORY_PERIOD_CLOSED` - Period closed with snapshot
- `INVENTORY_PERIOD_OVERRIDE_USED` - L5 override to post into closed period
- `INVENTORY_PERIOD_EXPORT_GENERATED` - Export downloaded

## RBAC Matrix

| Action | L1 (Waiter) | L2 (Chef) | L3 (Stock) | L4 (Manager) | L5 (Owner) |
|--------|-------------|-----------|------------|--------------|------------|
| List periods | ❌ | ❌ | ❌ | ✅ | ✅ |
| Create period | ❌ | ❌ | ❌ | ✅ | ✅ |
| Close period | ❌ | ❌ | ❌ | ✅ | ✅ |
| View reconciliation | ❌ | ❌ | ❌ | ✅ | ✅ |
| Export CSV | ❌ | ❌ | ❌ | ✅ | ✅ |
| Override post | ❌ | ❌ | ❌ | ❌ | ✅ |

## Related Milestones

- M11.1: Inventory Ledger (append-only ledger entries)
- M11.5: Costing + Valuation (WAC calculation)
- M11.13: GL Integration (InventoryPostingMapping, GlPostingStatus)
- M11.15: Ledger Immutability (middleware blocking update/delete)
