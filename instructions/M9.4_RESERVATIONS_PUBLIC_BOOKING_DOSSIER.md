# M9.4 Reservations Public Booking + Reporting Dossier

## Module Overview

**Version:** M9.4  
**Status:** In Progress  
**Date:** 2026-01-03  
**Baseline:** M9.3 at commit `b1c566a`

### Purpose

M9.4 extends the Reservations module with:
1. **Public Booking API** – Anonymous access to availability and booking creation
2. **Tokenized Access** – Secure cancel/reschedule without authentication
3. **Reporting & KPIs** – Manager-level analytics with CSV export
4. **Rate Limiting** – Anti-abuse protection on public endpoints

---

## M9.4 Scope

### Public Booking Features

| Feature | Description |
|---------|-------------|
| Public Availability | `GET /public/reservations/availability` - Anonymous slot query |
| Public Create | `POST /public/reservations` - Create reservation (HELD or CONFIRMED) |
| Token Cancel | `POST /public/reservations/:id/cancel` - Cancel with access token |
| Token Reschedule | `POST /public/reservations/:id/reschedule` - Reschedule with token |
| Rate Limiting | In-memory limiter on public endpoints (5 req/min per IP) |

### Reporting Features

| Feature | Description |
|---------|-------------|
| Report Summary | `GET /reservations/reports/summary` - KPIs by branch/date range |
| CSV Export | `GET /reservations/reports/export` - Downloadable CSV |
| Conversion Rates | HELD→CONFIRMED, WAITLIST→SEATED tracking |
| Deposit Analytics | Required/paid/applied/refunded/forfeited counts + amounts |

### UI Features

| Feature | Description |
|---------|-------------|
| Public Booking Page | `/book/:branchSlug` - Customer-facing booking flow |
| Reports Dashboard | `/reservations/reports` - Internal analytics (L4+) |

---

## Schema Additions

### ReservationAccessToken Model

```prisma
model ReservationAccessToken {
  id            String    @id @default(cuid())
  reservationId String
  token         String    @unique
  scope         String    // "CANCEL" | "RESCHEDULE" | "VIEW"
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime  @default(now())

  reservation   Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([reservationId])
  @@map("reservation_access_tokens")
}
```

### Branch Additions

```prisma
// Add to Branch model
publicBookingEnabled Boolean @default(false)
publicBookingSlug    String? @unique
```

---

## API Endpoints

### Public (No Auth)

| Method | Path | Description |
|--------|------|-------------|
| GET | `/public/reservations/availability` | Query available slots |
| POST | `/public/reservations` | Create public booking |
| GET | `/public/reservations/:id` | View reservation (token required) |
| POST | `/public/reservations/:id/cancel` | Cancel (token required) |
| POST | `/public/reservations/:id/reschedule` | Reschedule (token required) |

### Internal (Auth Required)

| Method | Path | RBAC | Description |
|--------|------|------|-------------|
| GET | `/reservations/reports/summary` | L4+ | KPI summary |
| GET | `/reservations/reports/export` | L4+ | CSV export |

---

## Rate Limiting Strategy

- **Algorithm:** Sliding window counter (in-memory)
- **Limit:** 5 requests per minute per IP
- **Scope:** Public endpoints only
- **Response:** 429 Too Many Requests with Retry-After header

---

## Acceptance Criteria

| AC | Description |
|----|-------------|
| AC-01 | Public availability returns slots respecting policy |
| AC-02 | Public create works (HELD if deposit required, CONFIRMED otherwise) |
| AC-03 | Access tokens generated on reservation create |
| AC-04 | Cancel/reschedule require valid, unexpired token |
| AC-05 | Rate limiting triggers at threshold |
| AC-06 | Reports summary returns expected KPI keys |
| AC-07 | Export returns valid CSV with headers |
| AC-08 | RBAC enforced (L4+ for reports) |
| AC-09 | Public booking page functional |
| AC-10 | Reports dashboard shows filters + export |

---

## Reference Systems

| System | License | Analysis |
|--------|---------|----------|
| TastyIgniter | MIT | Adapt allowed |
| easyappointments | AGPL | Study only |
| cal.com | AGPL | Study only |

---

## Files to Create/Modify

### New Files
- `services/api/src/reservations/public-booking.controller.ts`
- `services/api/src/reservations/public-booking.service.ts`
- `services/api/src/reservations/reporting.service.ts`
- `services/api/src/reservations/access-token.service.ts`
- `services/api/src/common/rate-limit.guard.ts`
- `apps/web/src/pages/book/[branchSlug].tsx`
- `apps/web/src/pages/reservations/reports.tsx`

### Modified Files
- `packages/db/prisma/schema.prisma`
- `services/api/src/reservations/reservations.module.ts`
- `services/api/src/reservations/reservations.controller.ts`
