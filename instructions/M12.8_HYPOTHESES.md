# M12.8 Hypotheses: Inventory Close Ops v4 (Gate Hardening + Regression Pack)

## Overview

These hypotheses identify potential defects in the close ops finalization that must be verified and addressed.

---

## H1: Preclose Snapshot Cross-Branch Leakage

**Hypothesis**: Preclose snapshots may be queried without proper branchId filtering, causing one branch's readiness status to incorrectly influence another branch's dashboard.

**Risk**: HIGH - Dashboard shows wrong period close status for branches.

**Test Strategy**:
1. Create periods for two branches with different blockers
2. Run preclose check for each
3. Verify dashboard returns correct status per branch (not mixed)

**Detection**:
```typescript
// Ensure queries include branchId
WHERE periodId = ? AND branchId = ?
```

---

## H2: Close-Pack Hash Differs on Windows Due to BOM/Newlines

**Hypothesis**: The bundleHash computation may produce different results on Windows vs Unix due to:
- BOM (`\uFEFF`) being included before hash
- CRLF vs LF line endings not being normalized

**Risk**: MEDIUM - Audit verification fails on different platforms.

**Test Strategy**:
1. Generate close-pack on Windows
2. Verify hash is computed BEFORE BOM is added
3. Verify all content is LF-normalized before hashing

**Detection**: Hash stability test - generate same pack twice, hashes must match.

---

## H3: Approval Gating Regression Blocks L5 ForceClose Path

**Hypothesis**: The L5 forceClose path may be blocked by overly strict approval checks, or the forceCloseReason minimum length (20 chars) may not be enforced.

**Risk**: MEDIUM - Owners cannot emergency-close periods.

**Test Strategy**:
1. Attempt forceClose with short reason (<20 chars) → expect rejection
2. Attempt forceClose with valid reason (≥20 chars) → expect success
3. Verify OVERRIDE_USED event and notification emitted

**Detection**: E2E test for forceClose path with reason validation.

---

## H4: Reconciliation Pack Misses FAILED_GL_POSTINGS Detection

**Hypothesis**: Preclose check may not detect FAILED_GL_POSTINGS status on:
- GoodsReceiptV2 (glPostingStatus = 'FAILED')
- InventoryWaste (glPostingStatus = 'FAILED')
- OrderInventoryDepletion (glPostingStatus = 'FAILED')

**Risk**: HIGH - Periods close with GL posting failures, causing GL mismatch.

**Test Strategy**:
1. Create a document with glPostingStatus = 'FAILED'
2. Run preclose check
3. Verify FAILED_GL_POSTINGS blocker is returned

**Detection**: Check preclose-check.service includes GL posting status checks.

---

## H5: Export Ordering Nondeterministic Causing Hash Drift

**Hypothesis**: Export CSV rows may be ordered differently on repeated calls due to:
- No ORDER BY in queries
- Parallel query races
- Map/Set iteration order

**Risk**: MEDIUM - Close-pack hash differs between runs.

**Test Strategy**:
1. Generate export twice in same test
2. Compare content/hash - must be identical

**Detection**: Add deterministic ORDER BY to all export queries.

---

## H6: Inventory Gate Runner Misses New Test Files

**Hypothesis**: The inventory E2E gate runner may use a hardcoded list that doesn't include M12.7 and M12.8 test files.

**Risk**: LOW - New tests not run in CI gate.

**Test Strategy**:
1. Check gate runner file discovery pattern
2. Verify M12.7 and M12.8 files are included
3. Run gate with verbose discovery output

**Detection**: Pattern should be `inventory-m*.e2e-spec.ts` or similar glob.

---

## H7: Tests Hang Due to Unclosed App/Server or Open Handles

**Hypothesis**: E2E tests may hang due to:
- App not closed in afterAll
- Database connections not released
- Timers/intervals not cleared
- Event emitters with pending listeners

**Risk**: HIGH - CI hangs, gate fails.

**Test Strategy**:
1. Run test with --detectOpenHandles
2. Add explicit app.close() in afterAll
3. Use jest.useFakeTimers() if needed

**Detection**: `--detectOpenHandles` flag in test run.

---

## H8: GL Posting Status Fields Not Updated Consistently on Void

**Hypothesis**: When voiding a document (receipt, waste, stocktake), the glPostingStatus may not be updated, leaving stale POSTED or FAILED status.

**Risk**: MEDIUM - Voided documents still show in FAILED_GL_POSTINGS check.

**Test Strategy**:
1. Create document with glPostingStatus = 'POSTED'
2. Void the document
3. Verify glPostingStatus is set to 'SKIPPED' or cleared

**Detection**: Check void logic in resolution service.

---

## H9: Dashboard Snapshot Stale After Period Reopened

**Hypothesis**: If a period is closed then reopened, the dashboard snapshot may still show CLOSED status until manually refreshed.

**Risk**: LOW - Dashboard shows stale status.

**Test Strategy**:
1. Close period → verify dashboard shows CLOSED
2. Reopen period → verify dashboard shows OPEN
3. No cache/snapshot staleness

**Detection**: Dashboard fetches live status, not cached snapshot.

---

## H10: Close Request Approval Race Condition

**Hypothesis**: Two concurrent approve requests may both succeed, creating duplicate approval records or causing data inconsistency.

**Risk**: LOW - Approval audit trail corrupted.

**Test Strategy**:
1. Use @unique constraint on periodId in CloseRequest
2. Verify approve is idempotent (second call returns same result)

**Detection**: Unique constraint already exists; test idempotency.

---

## Verification Matrix

| ID | Hypothesis | Priority | Test File | Fixed In |
|----|------------|----------|-----------|----------|
| H1 | Cross-branch leakage | HIGH | m128-e2e | M12.8 |
| H2 | BOM/newline hash | MEDIUM | m128-e2e | M12.2 (verify) |
| H3 | ForceClose blocked | MEDIUM | m128-e2e | M12.8 |
| H4 | FAILED_GL detection | HIGH | m128-e2e | M12.8 |
| H5 | Export ordering | MEDIUM | m128-e2e | M12.8 |
| H6 | Gate runner discovery | LOW | gate run | M12.8 |
| H7 | Test hang | HIGH | --detectOpenHandles | M12.8 |
| H8 | Void GL status | MEDIUM | m128-e2e | M12.8 |
| H9 | Dashboard stale | LOW | m128-e2e | M12.8 |
| H10 | Approval race | LOW | unique constraint | M12.4 (verify) |
