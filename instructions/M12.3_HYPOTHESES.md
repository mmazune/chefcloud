# M12.3 Hypotheses — Pre-Implementation Risk Assessment

> **Created**: 2026-01-07  
> **Milestone**: M12.3 Inventory Period Controls v3

---

## Hypothesis Table

| ID | Hypothesis | Confidence | Failure Mode | Mitigation |
|----|------------|------------|--------------|------------|
| H1 | `effectiveAt` migration breaks queries that assume `createdAt` ordering | Medium (60%) | Reports and reconciliations show wrong data because they still use `createdAt` instead of `effectiveAt` | Audit all queries that involve period boundaries; add index on `effectiveAt`; update all services |
| H2 | A write path bypasses `enforcePeriodLock` (regression hole) | High (75%) | Ledger entries posted into closed periods without rejection | Create exhaustive checklist of write paths; add guard tests per path; central enforcement function |
| H3 | L5 override lacks audit trail (compliance gap) | Medium (50%) | Overrides happen without event logging, failing audit requirements | Ensure `InventoryPeriodEvent` OVERRIDE_USED is created atomically with the override; test for event presence |
| H4 | Close pack totals differ when switching from `createdAt` → `effectiveAt` (boundary bug) | High (70%) | Close pack hash changes unexpectedly; reconciliation mismatches | Carefully update boundary queries; add E2E test comparing totals with known effectiveAt values |
| H5 | Export hash mismatch due to BOM/newlines ordering on Windows | Medium (55%) | CI passes on Linux but fails on Windows due to line ending differences | Use consistent UTF-8 encoding with explicit BOM; normalize line endings in hash computation |
| H6 | Tests hang due to open handles or unclosed app/server | High (80%) | Jest process doesn't exit; CI times out | Follow E2E_NO_HANG_STANDARD; use withTimeout; close app in afterAll; avoid timers/intervals |
| H7 | Override allows cross-branch/tenant targeting if reference filters are wrong | Medium (60%) | L5 user from Org A can override period in Org B due to missing orgId validation | Always validate orgId + branchId in override path; add E2E cross-tenant isolation test |
| H8 | Duplicate close pack generation (idempotency failure) | Medium (55%) | Calling `generate-close-pack` twice creates duplicate exports or changes hashes | Use deterministic generation; check for existing exports; ensure same inputs = same outputs |
| H9 | Period lock check uses wrong date field after migration | High (70%) | Lock enforcement still queries `createdAt` instead of `effectiveAt`, allowing bypass | Update `findPeriodByEffectiveDate()` to explicitly use `effectiveAt`; add targeted E2E test |
| H10 | Override event metadata not sanitized, allowing injection | Low (30%) | Malicious reason text causes log injection or XSS in audit views | Sanitize reason before storing; limit metadata JSON size; escape output in UI |

---

## Detailed Failure Mode Analysis

### H1: effectiveAt Migration Breaks Queries

**Scenario**: After adding `effectiveAt`, existing code continues to use `createdAt` for period boundary queries. This causes:
- Transactions dated January 15 (effectiveAt) but created January 20 (createdAt) to be excluded from January close pack
- Reconciliation reports show mismatched totals

**Test Strategy**:
- Create ledger entry with `effectiveAt` < `createdAt` (backdated)
- Verify period queries include it by `effectiveAt`, not `createdAt`

### H2: Write Path Bypasses Period Lock

**Scenario**: Developer adds new inventory operation that doesn't call `enforcePeriodLock()`, creating a bypass.

**Test Strategy**:
- E2E test per write path (goods receipt, waste, transfer, production, stocktake, adjustment, depletion)
- Each test attempts to post into closed period and expects 403

### H3: L5 Override Lacks Audit Trail

**Scenario**: Override mechanism allows posting but doesn't create `InventoryPeriodEvent`, failing SOX compliance.

**Test Strategy**:
- E2E test: perform override, query events, assert OVERRIDE_USED exists with actor + reason

### H4: Close Pack Boundary Bug

**Scenario**: Close pack query boundary is off-by-one when switching to `effectiveAt`. Entry at exactly `endDate 23:59:59.999Z` is excluded or included incorrectly.

**Test Strategy**:
- Create entries at exact boundary times
- Verify close pack includes/excludes correctly

### H5: Export Hash Platform Mismatch

**Scenario**: CSV generation uses platform-specific line endings, causing hash to differ between Windows and Linux.

**Test Strategy**:
- Compute hash in test using same algorithm
- Compare with API-returned hash
- Use `\n` consistently (not `\r\n`)

### H6: Tests Hang

**Scenario**: Test creates HTTP server or timer that isn't closed, causing Jest to wait indefinitely.

**Test Strategy**:
- Use `jest.setTimeout(120_000)`
- Use `withTimeout()` wrapper
- Close app in `afterAll`
- Run with `--detectOpenHandles` in CI

### H7: Cross-Tenant Override

**Scenario**: Override endpoint doesn't validate that periodId belongs to user's org, allowing cross-tenant manipulation.

**Test Strategy**:
- Create two orgs
- Attempt override on Org B's period using Org A's token
- Expect 403 or 404

### H8: Idempotency Failure

**Scenario**: `generate-close-pack` creates new export records each time, changing row counts and hashes.

**Test Strategy**:
- Call endpoint twice
- Compare returned bundleHash both times
- Should be identical

### H9: Period Lock Uses Wrong Date Field

**Scenario**: `findPeriodByEffectiveDate()` query still uses `createdAt` in WHERE clause after migration.

**Test Strategy**:
- Create period Jan 1-31 (CLOSED)
- Create ledger entry with `createdAt` = Feb 1, `effectiveAt` = Jan 15
- Without fix: entry is allowed (createdAt Feb is outside Jan period)
- With fix: entry is blocked (effectiveAt Jan 15 is inside CLOSED period)

### H10: Metadata Injection

**Scenario**: Attacker passes malicious JSON in override reason, causing log pollution or XSS.

**Test Strategy**:
- Attempt override with `reason` containing `<script>`, SQL injection patterns
- Verify stored value is sanitized/escaped
- UI displays escaped content

---

## Implementation Order (Risk-Based)

1. **H6 first**: Ensure test infrastructure doesn't hang
2. **H1, H9**: effectiveAt implementation + period query updates
3. **H2**: Period lock coverage across all paths
4. **H3, H7**: Override with audit trail + tenant isolation
5. **H4, H5, H8**: Close pack accuracy + idempotency
6. **H10**: Sanitization (low risk, last)
