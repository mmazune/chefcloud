# M13.2 POS Ordering Core - Feature Dossier

**Date:** 2026-01-08  
**Scope:** POS Menu Browse + Cart Validation + Modifier Enforcement + Pricing Snapshot + Availability Guard

---

## Feature Matrix (A-D)

### A) POS Menu Browse (Branch-Aware)

| Feature | Toast/Square | TastyIgniter | NimbusCloud M13.2 |
|---------|--------------|--------------|-------------------|
| Branch filtering | ✓ Location-based menus | ✓ Location menus | ✓ branchId filter on items |
| Time-based availability | ✓ Daypart menus | ✓ Schedule groups | ✓ MenuAvailabilityRule (M13.1) |
| Category ordering | ✓ Drag-drop sort | ✓ priority field | ✓ sortOrder on Category |
| Item ordering | ✓ Position in category | ✓ menu_priority | ✓ sortOrder on MenuItem |
| Inactive filtering | ✓ 86'd items hidden | ✓ status=active | ✓ isActive=true filter |

**Endpoint:** `GET /pos/menu?branchId=&at=ISO`

**Returns:**
- Categories (sorted, active only)
- Items per category (sorted, active, available at `at`)
- Modifier groups per item (sorted, active)
- Options per group (sorted, active)

### B) Cart Validation + Pricing Snapshot

| Feature | Toast/Square | TastyIgniter | NimbusCloud M13.2 |
|---------|--------------|--------------|-------------------|
| Modifier min/max enforcement | ✓ Server validates | ✓ Validates on submit | ✓ BEFORE order creation |
| SINGLE selection type | ✓ Radio buttons | ✓ radio option_type | ✓ ModifierSelectionType.SINGLE |
| MULTI selection type | ✓ Checkboxes | ✓ checkbox option_type | ✓ ModifierSelectionType.MULTI |
| Price snapshot on order | ✓ Stored on line | ✓ menu_price snapshot | ✓ basePriceCentsSnapshot + selectedModifiersSnapshot |
| Idempotency | ✓ Transaction ID | ✓ order_id dedup | ✓ X-Idempotency-Key header |

**Pricing Rules (v1):**
```
lineBase = item.basePriceCents
lineMods = sum(selectedOption.priceDelta)
unitPrice = lineBase + lineMods
lineTotal = unitPrice * qty
orderSubtotal = sum(lineTotal)
```

**Snapshot Fields on OrderItem:**
- `itemNameSnapshot` (string)
- `basePriceCentsSnapshot` (int)
- `selectedModifiersSnapshot` (JSON: [{groupName, optionName, priceDelta}])
- `unitPriceCentsSnapshot` (int)
- `lineTotalCentsSnapshot` (int)

**Error Codes:**
- `ITEM_UNAVAILABLE` - Item not available at branch/time
- `INVALID_MODIFIER_SELECTION` - min/max violation
- `INVALID_MODIFIER_OPTION` - Option not in group or inactive
- `ITEM_INACTIVE` - Item inactive
- `BRANCH_SCOPE_VIOLATION` - Item doesn't belong to branch

### C) Web UI (Operational)

| Component | Location | Purpose |
|-----------|----------|---------|
| POS New Order | `/pos/new` | Order creation flow |
| Category List | Left panel | Filter items by category |
| Item Grid | Center | Show available items |
| Cart Panel | Right | Selected items + totals |
| Modifier Modal | Dialog | Select modifiers for item |
| Branch Selector | Header | Switch active branch |

**UI Flow:**
1. Staff opens /pos/new
2. Category list loads from GET /pos/menu
3. Select category → item grid filters
4. Click item → if has modifiers, modal opens
5. Select modifiers (enforced in UI, server validates)
6. Add to cart → cart panel updates
7. Submit → POST /pos/orders
8. Success → show order number

### D) Exports

| Feature | Endpoint | Format |
|---------|----------|--------|
| Orders CSV | `GET /pos/export/orders.csv?from=&to=&branchId=` | UTF-8 BOM + SHA-256 hash |

**Columns:** Order ID, Order Number, Branch, Status, Subtotal, Tax, Total, Created At, Items (JSON)

---

## Parity Audit

### Toast POS (Study Only)
- Modifier groups: Required flag, min/max selection counts
- Pricing: Stored at order time, never recalculated
- Availability: Per-location day/time schedules

### Square POS (Study Only)  
- Modifier lists: Single vs multi-select variants
- Price books: Location-specific pricing
- Item availability: Per-location on/off toggle

### TastyIgniter (Adapt Allowed)
- Menu options: option_type (radio/checkbox), min_selected, max_selected
- Price stored on order_menus.menu_price
- Availability: mealtimes with day/time ranges

---

## Implementation Plan

1. **Schema**: Add snapshot fields to OrderItem model
2. **POS Menu Endpoint**: New method in MenuController or separate PosMenuController
3. **Modifier Validation**: Enhance PosService.createOrder with constraint checks
4. **Pricing Snapshot**: Calculate and store snapshot fields on order creation
5. **Availability Guard**: Call MenuService.isAvailable before adding to order
6. **Export Endpoint**: Add /pos/export/orders.csv route
7. **Web UI**: Create /pos/new page with category/item/cart components
