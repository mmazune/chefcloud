# M12.8 Inventory Close Ops Finalization - Dossier

## Overview

M12.8 finalizes the inventory close operations infrastructure with:
- Regression pack covering all event types (receipts, waste, stocktakes, depletions)
- Cross-branch snapshot correctness
- Close-pack hash stability
- Gate runner integration

## Problem Statement

The close operations implemented in M12.1-M12.7 need:
1. Regression testing to ensure GL reconciliation works across all event types
2. Verification that cross-branch readiness snapshots are correctly scoped
3. Confirmation that close-pack hashes are stable and deterministic
4. Integration into the inventory gate runner

## Scope

### A) Regression Pack: All Event Types

Ensure preclose check detects FAILED_GL_POSTINGS for:
- OrderInventoryDepletion (COGS)
- GoodsReceiptV2 (receipts)
- InventoryWaste (waste)

**Changes**:
- `inventory-preclose-check.service.ts`: Added receipts and waste to GL_POSTING_FAILED check
- `inventory-blockers-engine.service.ts`: Added waste to FAILED_GL_POSTINGS check

### B) Cross-Branch Snapshot Correctness

Dashboard queries must include:
- `orgId` filtering
- `branchId` filtering
- No stale snapshot leakage

**Verification**: E2E test creates two branches with different period states, verifies dashboard returns correct status per branch.

### C) Close Request + Approval + Override Regression

**Tests**:
- Without approved request → 403 CLOSE_REQUEST_REQUIRED
- After approval → close succeeds
- L5 forceClose with short reason → rejected
- L5 forceClose with valid reason → success + FORCE_CLOSE_USED event

### D) Close-Pack Integrity

**Tests**:
- Hash stable across repeated calls
- Export hashes match headers
- LF normalization before hash (H2)
- BOM stripped before hash

### E) Gate Runner Integration

Inventory gate runner pattern `f.startsWith('inventory-')` automatically includes:
- M12.1: inventory-m121-period-close.e2e-spec.ts
- M12.2: inventory-m122-close-ops-v2.e2e-spec.ts
- M12.4: inventory-m124-close-approvals-dashboard.e2e-spec.ts
- M12.6: inventory-m126-close-ops-ux-notify.e2e-spec.ts
- M12.7: inventory-m127-* (if created in test/e2e)
- M12.8: inventory-m128-close-ops-finalization.e2e-spec.ts

## Technical Design

### GL Failed Check Enhancement

```typescript
// Before (M12.7): Only depletions
const depletions = await this.prisma.client.orderInventoryDepletion.findMany({
  where: { glPostingStatus: 'FAILED' }
});

// After (M12.8): Depletions + Receipts + Waste
const depletions = await prisma.client.orderInventoryDepletion.findMany({ ... });
const receipts = await prisma.client.goodsReceiptV2.findMany({ ... });
const waste = await prisma.client.inventoryWaste.findMany({ ... });
const allFailed = [...depletions, ...receipts, ...waste];
```

### E2E Test Coverage

| Scenario | Test |
|----------|------|
| Approval gating (403) | `blocks close without approved request` |
| Approval flow | `allows close after approval` |
| ForceClose short reason | `rejects forceClose with short reason` |
| ForceClose valid | `allows forceClose with valid reason` |
| Cross-branch | `dashboard returns correct status per branch` |
| Close-pack hash | `close-pack hash is stable across repeated calls` |
| FAILED_GL detection | `blockers check includes FAILED_GL_POSTINGS` |
| 409 guard | `returns 409 for close-pack on OPEN period` |
| Override event | `OVERRIDE_USED event is emitted` |

## Files Changed

| File | Change |
|------|--------|
| `services/api/src/inventory/inventory-preclose-check.service.ts` | Added receipts/waste to GL failed check |
| `services/api/src/inventory/inventory-blockers-engine.service.ts` | Added waste to FAILED_GL_POSTINGS check |
| `services/api/test/e2e/inventory-m128-close-ops-finalization.e2e-spec.ts` | New regression E2E test |
| `instructions/M12.8_HYPOTHESES.md` | Hypotheses document (10) |

## Dependencies

- M12.1: Period service
- M12.2: Close-pack service
- M12.4: Close requests service
- M12.6: Notifications service
- M12.7: Blockers engine

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Hash drift on Windows | LF normalization before hash (verified) |
| Cross-branch leakage | branchId filtering in all queries (verified) |
| Gate runner misses files | Glob pattern includes inventory-* (verified) |

## Test Strategy

1. Run new E2E test in isolation with --detectOpenHandles
2. Verify no open handles
3. Run inventory gate runner self-check
4. Run full gate

## Rollback

If issues found, revert to M12.7 commit c3a6326.
