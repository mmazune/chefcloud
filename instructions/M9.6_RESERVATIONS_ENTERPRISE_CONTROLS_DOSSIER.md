# M9.6 Reservations: Enterprise Controls Dossier

**Sprint:** M9.6  
**Status:** IN PROGRESS  
**Parent:** M9.x Reservations Module  
**Baseline Commit:** c547da5 (M9.5 complete)  

---

## Executive Summary

M9.6 delivers enterprise-grade branch controls including operating hours enforcement, blackout windows, capacity rules, SLA monitoring, and integration hardening. This milestone ensures multi-branch deployments have deterministic policy resolution and operational visibility.

---

## Scope

### A) Multi-Branch Reservation Controls

| Feature | Description | Priority |
|---------|-------------|----------|
| Branch Operating Hours | Define open/close times per day of week | P0 |
| Blackout Windows | Block bookings during maintenance/private events | P0 |
| Capacity Rules | Max parties/covers per hour, table mix constraints | P0 |
| Policy Resolution | Org default + branch override, deterministic | P0 |

### B) SLA & Ops Monitoring

| Feature | Description | Priority |
|---------|-------------|----------|
| KPI Metrics | Avg hold duration, confirm latency, no-show rate | P0 |
| Deposit KPIs | Deposit conversion rate, captured vs refunded | P1 |
| Webhook SLA | Delivery latency, success rate | P1 |
| OpsIncident Log | Automated anomaly detection + logging | P1 |

### C) Integration Hardening

| Feature | Description | Priority |
|---------|-------------|----------|
| Webhook Circuit Breaker | Disable after N consecutive failures | P0 |
| Webhook Replay | Replay DEAD_LETTER events (L5 only) | P1 |
| Notification Replay | Replay failed notifications (L5 only) | P1 |
| ICS Timezone Param | Optional timezone for calendar feeds | P2 |

### D) Admin UI

| Feature | Description | Priority |
|---------|-------------|----------|
| Hours/Blackouts Admin | CRUD pages for operating constraints | P0 |
| Capacity Admin | Configure capacity rules | P1 |
| SLA Dashboard | View operational KPIs | P1 |

---

## Reference System Analysis

### TastyIgniter (MIT - ADAPT allowed)

| Feature | TastyIgniter Pattern | Adaptation |
|---------|---------------------|------------|
| Operating Hours | `LocationSchedule` model with day/open/close | Direct adaptation with timezone awareness |
| Holidays/Blackouts | `LocationSchedule.type = 'holiday'` | Separate `BranchBlackout` model for clarity |
| Capacity | Not explicit per-slot; menu-based limits | Explicit per-hour capacity rules |
| Webhooks | Basic event dispatch, no circuit breaker | Add circuit breaker pattern |

### easyappointments (AGPL - STUDY only)

| Feature | easyappointments Pattern | Adaptation |
|---------|-------------------------|------------|
| Working Hours | `ea_working_plan` table with JSON schedule | Similar JSON-based schedule storage |
| Breaks | Embedded in working_plan | Separate blackout model |
| Capacity | Provider-based (1:1 appointments) | Multi-party capacity rules |

### cal.com (AGPL - STUDY only)

| Feature | cal.com Pattern | Adaptation |
|---------|-----------------|------------|
| Availability | `Availability` model with date ranges + schedule | Inspired availability windows |
| Buffer Times | Before/after event buffers | Incorporated in policy |
| Circuit Breaker | Not present in booking; webhook retries only | Novel implementation |

---

## API Design

### Branch Hours Endpoints

```
GET    /reservations/branch-hours?branchId=...
PUT    /reservations/branch-hours
DELETE /reservations/branch-hours/:id
```

### Blackouts Endpoints

```
GET    /reservations/blackouts?branchId=...&start=...&end=...
POST   /reservations/blackouts
PUT    /reservations/blackouts/:id
DELETE /reservations/blackouts/:id
```

### Capacity Rules Endpoints

```
GET    /reservations/capacity-rules?branchId=...
PUT    /reservations/capacity-rules
```

### SLA Reports Endpoints

```
GET    /reservations/reports/sla?branchId=...&start=...&end=...
GET    /reservations/reports/sla/export?...
```

### Replay Endpoints (L5 Only)

```
POST   /integrations/webhooks/replay/:deliveryId
POST   /integrations/notifications/replay/:notificationId
```

---

## Data Models

### BranchOperatingHours

```prisma
model BranchOperatingHours {
  id        String   @id @default(cuid())
  orgId     String
  branchId  String
  dayOfWeek Int      // 0=Sunday, 6=Saturday
  openTime  String   // "09:00"
  closeTime String   // "22:00"
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, dayOfWeek])
}
```

### BranchBlackout

```prisma
model BranchBlackout {
  id        String   @id @default(cuid())
  orgId     String
  branchId  String
  title     String   // "Private Event", "Maintenance"
  startAt   DateTime
  endAt     DateTime
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### BranchCapacityRule

```prisma
model BranchCapacityRule {
  id               String   @id @default(cuid())
  orgId            String
  branchId         String   @unique
  maxPartiesPerHour Int?
  maxCoversPerHour  Int?
  enabled          Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
```

### OpsIncident

```prisma
model OpsIncident {
  id        String   @id @default(cuid())
  orgId     String
  branchId  String?
  type      String   // "WEBHOOK_CIRCUIT_OPEN", "HOLD_EXPIRY_SPIKE", etc.
  severity  String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  title     String
  payload   Json?
  resolved  Boolean  @default(false)
  resolvedAt DateTime?
  createdAt DateTime @default(now())
}
```

### WebhookEndpoint Extensions

```prisma
// Added fields to WebhookEndpoint
failureCount    Int       @default(0)
disabledUntil   DateTime?
lastFailureAt   DateTime?
circuitBreakThreshold Int @default(5)
```

---

## Security Considerations

1. **Tenant Isolation**: All queries scoped by orgId + branchId
2. **Replay Authorization**: Only L5 can replay dead-letter events
3. **Circuit Breaker State**: Visible to L4+ for debugging
4. **Capacity Enforcement**: Server-side only; cannot be bypassed by client

---

## Testing Strategy

| Area | Test Type | Coverage |
|------|-----------|----------|
| Hours Enforcement | E2E | Public booking rejects outside hours |
| Blackout Enforcement | E2E | Booking rejects during blackout |
| Capacity Limits | E2E | Booking rejects when hour full |
| Circuit Breaker | E2E | Endpoint disabled after failures |
| Replay Auth | E2E | L4 rejected, L5 allowed |
| SLA Metrics | E2E | Correct counts returned |

---

## Dependencies

- M9.5: Webhook infrastructure (WebhookEndpoint, WebhookDelivery)
- M9.4: Public booking endpoints
- M9.2: Reservation policies
- M9.1: Core reservation model
