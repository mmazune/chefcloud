# Feature Dossier: M10.5 Workforce Self-Service Portal

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-04  
> **Author:** AI Assistant  
> **Milestone:** M10.5  

---

## 1. Scope

### 1.1 Feature Summary

M10.5 extends the Workforce module with a Staff Self-Service Portal allowing employees to view their own schedules, time entries, and timesheet totals. It also introduces a Timesheet Adjustment workflow for correcting mistakes/missed punches with full audit trail, compliance/policy hardening for rounding, overtime, and break rules, and payroll export enhancements with enterprise columns.

### 1.2 In Scope

- **A) Staff Self-Service Portal (Web)**
  - /workforce/my-schedule - View upcoming shifts (14-30 days)
  - /workforce/my-time - View time entries for pay period
  - /workforce/my-timesheet - View computed totals and approval status
  
- **B) Timesheet Adjustments (Enterprise)**
  - TimeEntryAdjustment model
  - API endpoints for request/approve/reject lifecycle
  - Audit log entries for all adjustment actions
  - Lock semantics (reject if pay period CLOSED/LOCKED)
  
- **C) Compliance & Policy Hardening**
  - Rounding enforcement per policy (clock-in/out, breaks)
  - Overtime threshold computation (daily + weekly)
  - Break compliance (min duration, no overlap, must have start)
  - Double clock-in prevention
  - Max shift length guardrail
  
- **D) Payroll Calculation Hardening + Export Parity**
  - Enterprise CSV columns (employeeId, name, branch, period, hours, approvals)
  - Stable deterministic ordering
  - UTC + branch timezone handling
  
- **E) Reporting Extensions**
  - Adjustment request counts (pending/approved/rejected)
  - Compliance incidents count
  - Export of adjustments + incidents CSV

### 1.3 Out of Scope

- Mobile app self-service (web only for M10.5)
- Shift swap requests (existing in M10.2)
- Advanced scheduling AI/optimization
- Geofencing for clock-in/out

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| services/api | API | New endpoints for self-service + adjustments |
| apps/web | UI | 3 new self-service pages |
| packages/db | Schema | TimeEntryAdjustment model |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| time_entry_adjustments | CREATE | Adjustment request workflow |
| workforce_audit_logs | READ/WRITE | Audit adjustment actions |
| time_entries | READ | Self-service read own entries |
| scheduled_shifts | READ | Self-service read own shifts |
| pay_periods | READ | Self-service read periods |
| timesheet_approvals | READ | Self-service read approval status |

### 1.6 API Endpoints

| Method | Path | RBAC | Description |
|--------|------|------|-------------|
| GET | /workforce/self/schedule | L1-L5 | Own upcoming shifts |
| GET | /workforce/self/time-entries | L1-L5 | Own time entries |
| GET | /workforce/self/timesheet | L1-L5 | Own computed totals |
| POST | /workforce/adjustments | L1-L5 | Request adjustment (own entry) |
| GET | /workforce/adjustments | L3+ | List adjustments |
| POST | /workforce/adjustments/:id/approve | L3+ | Approve adjustment |
| POST | /workforce/adjustments/:id/reject | L3+ | Reject adjustment |
| GET | /workforce/reports/adjustments | L3+ | Adjustment counts |
| GET | /workforce/reports/incidents | L3+ | Compliance incidents |
| GET | /workforce/reports/adjustments/export | L4+ | Export adjustments CSV |
| GET | /workforce/reports/incidents/export | L4+ | Export incidents CSV |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| MySchedulePage | /workforce/my-schedule | Staff schedule viewer |
| MyTimePage | /workforce/my-time | Staff time entries viewer |
| MyTimesheetPage | /workforce/my-timesheet | Staff timesheet totals |

---

## 2. Current Nimbus State

### 2.1 What Exists Today (M10.4)

- **Shift Scheduling (M10.1):** ShiftTemplate, ScheduledShift models with CRUD + publish
- **Timeclock (M10.1):** TimeEntry, BreakEntry with clock-in/out operations
- **Enterprise (M10.3):** WorkforcePolicy, PayPeriod, TimesheetApproval
- **Enterprise UI (M10.4):** /workforce/policies, /workforce/pay-periods, /workforce/timesheets, /workforce/payroll-export
- **Audit Logging:** WorkforceAuditLog with standard actions

### 2.2 Gaps and Limitations

1. **No self-service portal** - Staff cannot view their own data without manager access
2. **No adjustment workflow** - No way to correct mistakes after clock-out
3. **Policy enforcement incomplete** - Rounding/OT computed but not all edge cases
4. **Payroll export basic** - Missing enterprise columns for integration

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| M10.1 Scheduling | Complete | Uses shifts |
| M10.1 Timeclock | Complete | Uses time entries |
| M10.3 Enterprise | Complete | Uses policy/periods |
| M10.4 Enterprise UI | Complete | Base patterns |

---

## 3. Reference Repos (Study-Only)

### 3.1 Kimai Time Tracking Patterns

| Aspect | Kimai Behavior | Nimbus Target |
|--------|----------------|---------------|
| **Rounding** | Per-activity rounding modes (nearest, up, down) | Per-org policy with NEAREST/UP/DOWN |
| **Overtime** | Configurable daily/weekly thresholds | dailyOtThresholdMins + weeklyOtThresholdMins |
| **Adjustments** | Edit timesheet entries directly | Adjustment request → approval workflow |
| **Lock Semantics** | Lock by period/date range | CLOSED PayPeriod blocks modifications |
| **Audit Trail** | Activity log per timesheet change | WorkforceAuditLog with action types |
| **Export** | Multiple formats (CSV, PDF, Excel) | CSV with enterprise columns |

### 3.2 Key Behaviors to Match

1. **Rounding Rules:**
   - NEAREST: Round to nearest interval (15 min → 7:07 becomes 7:00, 7:08 becomes 7:15)
   - UP: Always round up (7:01 becomes 7:15)
   - DOWN: Always round down (7:14 becomes 7:00)

2. **Lock Semantics:**
   - Once PayPeriod.status = CLOSED, all TimeEntry within that period are immutable
   - Adjustment requests for locked entries must be rejected with 403

3. **Adjustment Workflow:**
   - Staff requests adjustment with reason
   - Supervisor/Manager reviews and approves/rejects
   - If approved, original entry updated OR override computed
   - Full audit trail for request → decision → application

4. **Export Format:**
   - Deterministic ordering: orgId, branchId, userId, clockInAt
   - Required columns: employeeId, employeeName, branch, payPeriodStart, payPeriodEnd,
     regularHours, overtimeHours, breakHours, paidHours, approvedBy, approvedAt, roundingMode

---

## 4. Implementation Details

### 4.1 TimeEntryAdjustment Model

```prisma
enum AdjustmentStatus {
  REQUESTED
  APPROVED
  REJECTED
}

model TimeEntryAdjustment {
  id             String           @id @default(cuid())
  orgId          String
  timeEntryId    String
  requestedById  String
  approvedById   String?
  status         AdjustmentStatus @default(REQUESTED)
  originalClockIn  DateTime?
  originalClockOut DateTime?
  newClockIn     DateTime?
  newClockOut    DateTime?
  reason         String
  rejectionReason String?
  appliedAt      DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  org        Org       @relation(fields: [orgId], references: [id])
  timeEntry  TimeEntry @relation(fields: [timeEntryId], references: [id])
  requestedBy User     @relation("RequestedAdjustments", fields: [requestedById], references: [id])
  approvedBy  User?    @relation("ApprovedAdjustments", fields: [approvedById], references: [id])

  @@index([orgId, status])
  @@index([timeEntryId])
  @@map("time_entry_adjustments")
}
```

### 4.2 Self-Service Endpoints Security

All `/workforce/self/*` endpoints:
- Extract userId from JWT token
- Never accept userId as query parameter
- Use req.user.userId for all database queries
- Return only data belonging to authenticated user

### 4.3 Compliance Incidents Logging

Use existing WorkforceAuditLog with new action types:
- `BREAK_VIOLATION_LOGGED`
- `OVERTIME_VIOLATION_LOGGED`
- `DOUBLE_CLOCKIN_BLOCKED`
- `MAX_SHIFT_EXCEEDED`

---

## 5. Acceptance Criteria

### A) Staff Self-Service Portal
- [ ] A1: Staff (L1-L5) can view upcoming shifts for 14-30 days
- [ ] A2: Staff can see shift status (SCHEDULED/PUBLISHED/CANCELLED)
- [ ] A3: Staff can view time entries for selected pay period
- [ ] A4: Staff can see clock-in status (clocked in/out, on break)
- [ ] A5: Staff can view computed timesheet totals
- [ ] A6: Staff can see approval status and lock indicator

### B) Timesheet Adjustments
- [ ] B1: Staff can request adjustment for own entry
- [ ] B2: Supervisor/Manager can list pending adjustments
- [ ] B3: Supervisor/Manager can approve adjustment
- [ ] B4: Supervisor/Manager can reject adjustment with reason
- [ ] B5: Approved adjustment updates canonical time entry
- [ ] B6: Audit log entries exist for all adjustment actions
- [ ] B7: Adjustment rejected with 403 if pay period CLOSED

### C) Compliance & Policy Hardening
- [ ] C1: Rounding applied per policy consistently
- [ ] C2: OT computed correctly for daily threshold
- [ ] C3: OT computed correctly for weekly threshold
- [ ] C4: Break min duration enforced
- [ ] C5: Double clock-in prevented with clear error
- [ ] C6: Max shift length logged as incident

### D) Payroll Export Parity
- [ ] D1: Export CSV includes all required columns
- [ ] D2: Stable deterministic ordering
- [ ] D3: UTC + branch timezone consistent

### E) Reporting Extensions
- [ ] E1: Adjustment counts endpoint returns pending/approved/rejected
- [ ] E2: Compliance incidents count endpoint works
- [ ] E3: Export adjustments CSV (L4+)
- [ ] E4: Export incidents CSV (L4+)

---

## 6. Test Matrix

| AC | E2E Test | UI Test | Notes |
|----|----------|---------|-------|
| A1 | ✓ | ✓ | Fetch own shifts |
| A2 | ✓ | - | Status badge visible |
| A3 | ✓ | ✓ | Time entries list |
| A4 | ✓ | - | Clock status indicator |
| A5 | ✓ | ✓ | Totals computed |
| A6 | ✓ | - | Lock indicator |
| B1 | ✓ | - | Request adjustment |
| B2 | ✓ | - | List pending |
| B3 | ✓ | - | Approve flow |
| B4 | ✓ | - | Reject flow |
| B5 | ✓ | - | Entry updated |
| B6 | ✓ | - | Audit exists |
| B7 | ✓ | - | 403 on locked |
| C1-C6 | ✓ | - | Policy enforcement |
| D1-D3 | ✓ | - | Export validation |
| E1-E4 | ✓ | - | Reports endpoints |
