# M11.5 Parity Re-Audit: Inventory Costing + Valuation + COGS

## Reference System Analysis

### 1. InvenTree Costing Patterns (MIT License)

**Examined:** InvenTree (inventree/InvenTree on GitHub)

#### Stock Value Model
- **StockItem.purchase_price**: Stores per-item cost at purchase
- **StockItemTracking**: Append-only history with cost references
- **Stock value**: Computed as sum(purchase_price × quantity) across StockItems

#### Valuation Concepts
- Per-item valuation available via API
- Location-scoped valuation supported
- No built-in COGS tracking (consumption-focused, not restaurant-focused)

#### Audit Trail
- StockItemTracking with JSON metadata
- Immutable tracking entries
- Cost changes logged but not versioned

#### M11.5 Alignment

| InvenTree Pattern | M11.5 Implementation | Gap |
|-------------------|---------------------|-----|
| StockItem.purchase_price | GoodsReceiptLineV2.unitCost | ✓ Aligned |
| Stock value computation | Valuation = onHand × currentWac | ✓ Aligned |
| Per-item cost | InventoryCostLayer with WAC | ✓ Enhanced |
| Audit trail | Append-only cost layers | ✓ Enhanced |
| COGS tracking | DepletionCostBreakdown | ✓ Added |

---

### 2. Cost Layer Pattern Analysis

InvenTree does not have explicit cost layers - it stores purchase_price per StockItem instance. M11.5 introduces a more sophisticated model:

| Aspect | InvenTree | M11.5 |
|--------|-----------|-------|
| Cost Storage | Per StockItem | Per receipt posting (cost layer) |
| Cost History | Overwritten on update | Append-only, full history |
| WAC Calculation | Not native | Incremental on receive |
| Multiple Costs | Multiple StockItems | Single WAC per (branch, item) |
| Audit Grade | Basic | Enterprise (no UPDATE/DELETE) |

---

### 3. COGS Pattern Analysis

InvenTree focuses on manufacturing BOMs and stock consumption, not restaurant-style COGS:

| Feature | InvenTree | M11.5 |
|---------|-----------|-------|
| Consumption tracking | Build orders | Order depletion |
| Cost at consumption | Not captured | unitCost at posting time |
| COGS reporting | Not native | DepletionCostBreakdown |
| Order linkage | Build order ID | Order ID + depletion ID |

---

### 4. Valuation Query Comparison

| Aspect | InvenTree | M11.5 |
|--------|-----------|-------|
| Valuation endpoint | GET /api/stock/ with filters | GET /inventory/valuation/on-hand |
| Scope | Part-level | Branch → Location → Item |
| Real-time | Yes | Yes (computed from ledger) |
| Export | JSON only | CSV with BOM + hash |
| Integrity verification | None | X-Nimbus-Export-Hash |

---

### 5. Key Implementation Decisions

#### 5.1 Branch-Level WAC (Not Location-Level)
**Rationale:**
- Restaurant operations typically don't need location-level costing
- Simplifies WAC computation (fewer partitions)
- Aligns with branch-scoped operations model
- Location-level can be added in future if needed

#### 5.2 Append-Only Cost Layers
**Rationale:**
- Full audit trail for cost changes
- Supports historical queries ("what was WAC on date X?")
- Matches append-only ledger philosophy
- No UPDATE or DELETE allowed on cost layers

#### 5.3 COGS at Depletion Time
**Rationale:**
- Captures WAC at actual consumption moment
- Idempotent: tied to depletion record
- Survives WAC changes after depletion
- Links directly to order for P&L reporting

---

### 6. Security Considerations

#### InvenTree RBAC
- Permissions: view_stockitem, change_stockitem
- No explicit cost-viewing permission

#### M11.5 RBAC
- L4+: View valuation, COGS, cost layers
- L4+: Export valuation and COGS
- L5: Manual cost layer adjustments (future)
- All operations scoped by orgId (mandatory)

---

### 7. Feature Gap Summary

| Feature | InvenTree | M11.5 | Priority |
|---------|-----------|-------|----------|
| Basic stock value | ✓ | ✓ | M11.5 |
| Cost history (append-only) | ✗ | ✓ | M11.5 |
| WAC computation | ✗ | ✓ | M11.5 |
| COGS tracking | ✗ | ✓ | M11.5 |
| COGS per order | ✗ | ✓ | M11.5 |
| Valuation export | ✗ | ✓ | M11.5 |
| FIFO/LIFO | ✓ | ✗ | Future |
| Standard costing | ✓ | ✗ | Future |
| Cost variance | ✓ | ✗ | Future |

---

## Verdict

**M11.5 achieves parity with InvenTree's basic costing** and **exceeds it** in several areas:

1. ✓ **Stock valuation**: On-par with InvenTree
2. ✓ **Cost history**: Enhanced (append-only layers vs. overwrite)
3. ✓ **WAC computation**: Added (InvenTree doesn't have native WAC)
4. ✓ **COGS tracking**: Added (InvenTree lacks restaurant-style COGS)
5. ✓ **Audit grade**: Enhanced (no UPDATE/DELETE on cost data)
6. ✓ **Export integrity**: Enhanced (BOM + hash)

Future scope items (FIFO/LIFO, standard costing) are documented but not blocking for M11.5.
