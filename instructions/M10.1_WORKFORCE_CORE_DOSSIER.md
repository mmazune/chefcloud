# Feature Dossier: M10.1 Workforce Core (Shifts + Timeclock + Approvals + Reports)

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-03  
> **Author:** AI Assistant  
> **Milestone:** M10.1  

---

## 1. Scope

### 1.1 Feature Summary

M10.1 implements core workforce management capabilities: shift scheduling (templates + planning), timeclock operations (clock-in/out with shift attachment), approvals workflow, and labor reporting with CSV exports. This extends the existing E43 workforce module that provides leave management and basic time entries.

### 1.2 In Scope

- ShiftTemplate CRUD (org + optional branch scope)
- Shift planning with status lifecycle (DRAFT → PUBLISHED → IN_PROGRESS → COMPLETED → APPROVED)
- Schedule publishing with conflict detection (overlap, duration bounds)
- Timeclock clock-in/out attached to published shifts
- Break tracking (optional)
- Time entry approvals that freeze actuals
- Labor reporting endpoints (planned vs actual, overtime, per-role/user breakdowns)
- CSV exports for shifts and timeclock entries
- Audit logging for key scheduling actions
- Web UI for schedule management, timeclock, approvals, and labor reports

### 1.3 Out of Scope

- Advanced payroll calculation (handled by existing PayrollService)
- Leave management (already exists in E43)
- Shift swap workflow (already exists in E43)
- Biometric clock-in integration (deferred)
- Mobile app interfaces
- Geofencing for clock-in validation

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| workforce | API | Extended with scheduling, timeclock, approvals, reporting services |
| web | UI | New pages: schedule, timeclock, approvals, labor reports |
| db | Schema | New models: ShiftTemplate, Shift, BreakEntry; New enums: ShiftStatus |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| shift_templates | CREATE | Reusable shift templates with role, times, break policy |
| shifts | CREATE | Scheduled shifts with status lifecycle |
| break_entries | CREATE | Break tracking for timeclock entries |
| time_entries | ALTER | Add shiftId FK for shift attachment |
| workforce_audit_logs | CREATE | Audit trail for scheduling actions |

### 1.6 API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /workforce/templates | List shift templates |
| POST | /workforce/templates | Create shift template |
| PUT | /workforce/templates/:id | Update shift template |
| DELETE | /workforce/templates/:id | Delete shift template |
| GET | /workforce/shifts | List shifts (with filters) |
| POST | /workforce/shifts | Create shift |
| PUT | /workforce/shifts/:id | Update shift |
| DELETE | /workforce/shifts/:id | Delete shift |
| POST | /workforce/shifts/publish | Publish shifts in date range |
| GET | /workforce/shifts/:id/conflicts | Check conflicts for a shift |
| POST | /workforce/timeclock/clock-in | Clock in to shift |
| POST | /workforce/timeclock/clock-out | Clock out from shift |
| POST | /workforce/timeclock/break-start | Start break |
| POST | /workforce/timeclock/break-end | End break |
| GET | /workforce/timeclock/status | Get current clock status |
| POST | /workforce/approvals/:id/approve | Approve completed shift |
| GET | /workforce/approvals | List pending approvals |
| GET | /workforce/reports/labor | Get labor metrics |
| GET | /workforce/reports/export/shifts | Export shifts CSV |
| GET | /workforce/reports/export/timeclock | Export timeclock CSV |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| SchedulePage | /workforce/schedule | Manager schedule view with create/publish |
| TimeclockPage | /workforce/timeclock | Staff clock-in/out interface |
| ApprovalsPage | /workforce/approvals | Manager approval queue |
| LaborReportPage | /workforce/labor | Labor metrics dashboard |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

The E43 workforce module provides:
- **Leave Management**: LeaveRequest model with PENDING→APPROVED/REJECTED lifecycle
- **Duty Shifts**: DutyShift model for basic shift assignment (no status lifecycle)
- **Shift Swaps**: ShiftSwap model with approval workflow
- **Time Entries**: TimeEntry model for clock-in/out with overtime calculation
- **Payroll Export**: Basic aggregation of hours per employee

### 2.2 Gaps and Limitations

1. **No Shift Status Lifecycle**: DutyShift has no status (DRAFT/PUBLISHED/etc.)
2. **No Shift Templates**: Each shift must be created from scratch
3. **No Conflict Detection**: Overlapping shifts are allowed
4. **No Publish Workflow**: Shifts are immediately visible
5. **Time Entries Not Linked to Shifts**: clockIn/clockOut not validated against shifts
6. **No Approval Workflow for Shifts**: Only time entries have basic approval flag
7. **Limited Reporting**: Only basic payroll export, no planned vs actual comparison
8. **No Break Tracking**: Breaks not tracked separately
9. **No Audit Logging**: No audit trail for scheduling changes
10. **No Web UI**: No frontend pages for workforce management

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| E43 Leave Management | Complete | Uses - shares WorkforceModule |
| E43 Payroll Export | Complete | Uses - shares time entry data |
| Auth/RBAC | Complete | Uses - jobRole-based access |
| Accounting Periods | Complete | None - M10.1 not coupled to periods |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| Kimai | Time tracking | AGPL-3.0 | STUDY-only | Industry reference for timeclock patterns |
| Nimbus E43 | Workforce | MIT | ADAPT | Existing codebase, extend patterns |

### 3.2 Kimai Behavior Analysis (STUDY-ONLY)

#### Scheduling Patterns
- **Timesheet Entry**: Users log time against projects/activities
- **Duration Rounding**: Configurable rounding rules (5/15/30 min)
- **Break Deduction**: Automatic or manual break time handling
- **Approval Workflow**: Timesheet entries require manager approval before export

#### Timeclock Patterns
- **Start/Stop Model**: Click to start, click to stop (similar to clock-in/out)
- **Active Timer**: Only one active timer per user at a time
- **Overlapping Prevention**: Cannot start new entry while one is running

#### Permission Model
- **Team Lead Role**: Can view/edit team members' entries
- **Admin Role**: Full access to all entries and configuration
- **User Role**: Can only manage own entries

#### Export Patterns
- **CSV Export**: Headers include user, date, project, duration, status
- **Date Range Filter**: All exports filtered by start/end date
- **Status Filter**: Can filter by approved/pending/rejected

---

## 4. Implementation Decisions

### 4.1 Shift Status Lifecycle

```
DRAFT ─────┬───► PUBLISHED ───► IN_PROGRESS ───► COMPLETED ───► APPROVED
           │
           └───► CANCELLED (only from DRAFT or PUBLISHED)
```

**Transitions:**
- DRAFT → PUBLISHED: via publish endpoint, batch operation
- PUBLISHED → IN_PROGRESS: automatic on first clock-in
- IN_PROGRESS → COMPLETED: automatic on clock-out or shift end time
- COMPLETED → APPROVED: manual by L4+/Owner
- DRAFT/PUBLISHED → CANCELLED: manual by L3+

### 4.2 Conflict Detection Rules

1. **Same User Overlap**: No two shifts for the same user can overlap in time
2. **Duration Bounds**: Shift duration must be within policy (default: 1-16 hours)
3. **Start Before End**: startAt must be strictly less than endAt
4. **Validation on Create/Update**: Conflicts checked before save
5. **Validation on Publish**: All DRAFT shifts in range validated before publish

### 4.3 Timeclock Rules

1. **Shift Attachment**: Clock-in must attach to a PUBLISHED shift for the user
2. **Grace Window**: 15 minutes early clock-in allowed by default
3. **Self-Service**: Users can only clock for themselves (unless L4+ override)
4. **Single Active**: Cannot clock-in if already clocked in
5. **Must Be Clocked In**: Cannot clock-out without active clock-in
6. **Break Tracking**: Optional, tracked via BreakEntry linked to TimeEntry

### 4.4 Approval Behavior

1. **Freeze Actuals**: Approval freezes actualMinutes, breakMinutes, overtimeMinutes
2. **Status Gate**: Only COMPLETED shifts can be approved
3. **RBAC**: L4 Manager or L5 Owner can approve
4. **Audit**: Approval action logged with approver ID and timestamp

### 4.5 Export Format

**Shifts CSV Headers:**
```
id,branchId,userId,userName,role,startAt,endAt,plannedMinutes,actualMinutes,status,approvedAt
```

**Timeclock CSV Headers:**
```
id,userId,userName,shiftId,clockInAt,clockOutAt,totalMinutes,breakMinutes,overtimeMinutes,approved
```

---

## 5. RBAC Matrix

| Action | L5 Owner | L4 Manager | L3 Supervisor | Staff | Accountant |
|--------|----------|------------|---------------|-------|------------|
| Create shift template | ✓ | ✓ | ✗ | ✗ | ✗ |
| Create/edit shift | ✓ | ✓ | ✗ | ✗ | ✗ |
| Publish schedule | ✓ | ✓ | ✗ | ✗ | ✗ |
| Cancel shift | ✓ | ✓ | ✓ | ✗ | ✗ |
| View all shifts | ✓ | ✓ | ✓ | ✗ | ✓ (read-only) |
| View own shifts | ✓ | ✓ | ✓ | ✓ | ✓ |
| Clock in/out self | ✓ | ✓ | ✓ | ✓ | ✗ |
| Clock override (other) | ✓ | ✓ | ✗ | ✗ | ✗ |
| Approve shifts | ✓ | ✓ | ✗ | ✗ | ✗ |
| View labor reports | ✓ | ✓ | ✗ | ✗ | ✓ |
| Export data | ✓ | ✓ | ✗ | ✗ | ✓ |

---

## 6. Audit Logging

| Action | Logged Data |
|--------|-------------|
| SHIFT_CREATED | shiftId, userId, branchId, createdBy |
| SHIFT_UPDATED | shiftId, changes, updatedBy |
| SHIFT_PUBLISHED | shiftIds[], publishedBy, dateRange |
| SHIFT_CANCELLED | shiftId, cancelledBy, reason |
| SHIFT_APPROVED | shiftId, approvedBy, actualMinutes |
| CLOCK_IN | timeEntryId, shiftId, userId, timestamp |
| CLOCK_OUT | timeEntryId, userId, totalMinutes, timestamp |
| BREAK_STARTED | breakEntryId, timeEntryId, userId |
| BREAK_ENDED | breakEntryId, breakMinutes |

---

## 7. Parity Analysis Summary

See `M10.1_PARITY_REAUDIT.md` for detailed comparison.

| Feature | Kimai Pattern | Nimbus Current | Nimbus Target | Verdict |
|---------|---------------|----------------|---------------|---------|
| Shift Status | N/A (timesheet-based) | None on DutyShift | Full lifecycle | EXCEEDS |
| Conflict Detection | Project overlap allowed | None | User overlap blocked | MEETS |
| Timeclock | Start/stop timer | Basic clock-in/out | Shift-attached | MEETS |
| Breaks | Deduction config | Not tracked | BreakEntry model | MEETS |
| Approvals | Timesheet approval | TimeEntry.approved | Shift-level approval | MEETS |
| Reporting | Duration aggregation | Basic payroll | Planned vs actual | EXCEEDS |
| Exports | CSV with filters | Basic payroll CSV | Full shift+timeclock | MEETS |
| Audit | Activity log | None | WorkforceAuditLog | MEETS |
