# M10.7 Workforce: Payroll Gross-to-Net Feature Dossier

**Milestone:** M10.7  
**Focus:** Compensation Components Engine + Gross-to-Net Calculation + Payslips + Exports  
**Baseline Commit:** 0d8404e (M10.6 complete)  
**Date:** 2026-01-04

---

## 1. Executive Summary

M10.7 extends the payroll infrastructure from M10.6 by implementing a configurable, jurisdiction-agnostic gross-to-net calculation engine. This includes:

- **Compensation Components Engine**: Org-scoped configurable earnings, deductions, taxes, and employer contributions
- **Payroll Run Calculation Upgrade**: Full gross-to-net with deterministic breakdowns
- **Payslips API + Web**: Employee self-service and admin views
- **Exports**: CSV exports for payroll summaries, payslip line-items, and employer costs

---

## 2. Feature Groups

### A) Compensation Components Engine

**Purpose**: Allow orgs to define reusable compensation building blocks

**Component Types**:
| Type | Impact on Net | Examples |
|------|---------------|----------|
| EARNING | +Gross, +Net | Base hourly, OT premium, allowance, bonus |
| DEDUCTION_PRE | -Taxable, -Net | Pre-tax retirement, health contrib |
| DEDUCTION_POST | -Net only | Advances, meals, uniforms |
| TAX | -Net | Percentage withholding with caps |
| EMPLOYER_CONTRIB | Cost only | Employer levy, insurance (no net impact) |

**Calculation Methods**:
| Method | Description |
|--------|-------------|
| FIXED | Fixed amount per period |
| PERCENT_OF_GROSS | % of gross earnings |
| PERCENT_OF_EARNINGS_CODE | % of specific earning component |
| PER_HOUR | Rate × hours worked |

**Component Definition Fields**:
- code (unique per org)
- name
- type (enum)
- calcMethod (enum)
- rate/amount (Decimal)
- capMin/capMax (optional Decimal)
- roundingRule (HALF_UP_CENTS | HALF_UP_UNIT)
- enabled (boolean)
- branchId (optional - branch override)

**User Assignments**:
- EmployeeCompensationProfile: orgId, userId, startDate, endDate (nullable)
- EmployeeCompensationComponent: profileId, componentId, overrideAmount/rate

### B) Payroll Run Calculation Upgrade

**PayrollRunLine Extended Fields**:
| Field | Description |
|-------|-------------|
| grossEarnings | Sum of all EARNING components |
| preTaxDeductions | Sum of DEDUCTION_PRE |
| taxableWages | gross - preTaxDeductions |
| taxesWithheld | Sum of TAX components |
| postTaxDeductions | Sum of DEDUCTION_POST |
| netPay | gross - preTax - taxes - postTax |
| employerContribTotal | Sum of EMPLOYER_CONTRIB |
| totalEmployerCost | gross + employerContribTotal |

**Invariants**:
- netPay = grossEarnings - preTaxDeductions - taxesWithheld - postTaxDeductions
- Totals must match sum of breakdown line-items
- CLOSED/EXPORTED pay periods block recalculation
- Status machine enforced (DRAFT → CALCULATED → APPROVED → POSTED → PAID | VOID)

**Breakdown Records**:
- PayrollRunLineBreakdown: runLineId, componentId, type, amount (persisted, not JSON)

### C) Payslips

**Endpoints**:
- `GET /workforce/payroll-runs/:runId/payslips` - List payslips for run (L4+)
- `GET /workforce/payslips/:id` - Get payslip by ID (L3+ or owner)
- `GET /workforce/me/payslips` - Employee self-service list

**Web Pages**:
- `/workforce/payslips` - Admin list with filters
- `/my-payslips` - Employee self-service

**Payslip Content**:
- Employee info
- Pay period
- Hours breakdown
- Gross, deductions, taxes, net
- Employer cost
- Component breakdown table

### D) Exports

**CSV Exports (L4+)**:
- Payroll run summary: Run ID, period, status, totals
- Payslip line-item: Per employee per component
- Employer cost: For accounting reconciliation

**Export Requirements**:
- Deterministic ordering (by userId, componentCode)
- Headers consistent with persisted data
- UTF-8 BOM for Excel compatibility

### E) GL Posting Enhancement

**Deferred for M10.7** - Rationale:
- Current M10.6 GL posting handles labor expense / wages payable
- Employer contributions and tax liability posting requires:
  - Additional GL account configuration
  - Tax liability account structure (per jurisdiction)
  - Reconciliation with external tax systems
- **Stubs provided** with acceptance criteria for future implementation

---

## 3. Data Models

```prisma
enum CompensationComponentType {
  EARNING
  DEDUCTION_PRE
  DEDUCTION_POST
  TAX
  EMPLOYER_CONTRIB
}

enum CalcMethod {
  FIXED
  PERCENT_OF_GROSS
  PERCENT_OF_EARNINGS_CODE
  PER_HOUR
}

enum RoundingRule {
  HALF_UP_CENTS
  HALF_UP_UNIT
}

model CompensationComponent {
  id            String   @id @default(cuid())
  orgId         String
  branchId      String?
  code          String
  name          String
  type          CompensationComponentType
  calcMethod    CalcMethod
  rate          Decimal  @default(0)
  amount        Decimal  @default(0)
  earningsCode  String?  // For PERCENT_OF_EARNINGS_CODE
  capMin        Decimal?
  capMax        Decimal?
  roundingRule  RoundingRule @default(HALF_UP_CENTS)
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  org           Org      @relation(fields: [orgId], references: [id])
  branch        Branch?  @relation(fields: [branchId], references: [id])
  
  @@unique([orgId, code])
  @@index([orgId, enabled])
}

model EmployeeCompensationProfile {
  id         String   @id @default(cuid())
  orgId      String
  userId     String
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  org        Org      @relation(fields: [orgId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
  components EmployeeCompensationComponent[]
  
  @@index([orgId, userId])
}

model EmployeeCompensationComponent {
  id             String   @id @default(cuid())
  profileId      String
  componentId    String
  overrideRate   Decimal?
  overrideAmount Decimal?
  
  profile   EmployeeCompensationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  component CompensationComponent       @relation(fields: [componentId], references: [id])
  
  @@unique([profileId, componentId])
}

model Payslip {
  id               String   @id @default(cuid())
  orgId            String
  payrollRunId     String
  payrollRunLineId String
  userId           String
  payPeriodStart   DateTime
  payPeriodEnd     DateTime
  grossEarnings    Decimal
  preTaxDeductions Decimal
  taxableWages     Decimal
  taxesWithheld    Decimal
  postTaxDeductions Decimal
  netPay           Decimal
  employerContribTotal Decimal
  totalEmployerCost Decimal
  createdAt        DateTime @default(now())
  
  org           Org      @relation(fields: [orgId], references: [id])
  payrollRun    PayrollRun @relation(fields: [payrollRunId], references: [id])
  payrollRunLine PayrollRunLine @relation(fields: [payrollRunLineId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  lineItems     PayslipLineItem[]
  
  @@unique([payrollRunLineId])
  @@index([orgId, userId])
  @@index([payrollRunId])
}

model PayslipLineItem {
  id          String   @id @default(cuid())
  payslipId   String
  componentId String
  componentCode String
  componentName String
  type        CompensationComponentType
  amount      Decimal
  
  payslip     Payslip  @relation(fields: [payslipId], references: [id], onDelete: Cascade)
  
  @@index([payslipId])
}
```

---

## 4. API Endpoints

| Method | Path | RBAC | Description |
|--------|------|------|-------------|
| GET | /workforce/compensation/components | L4+ | List org components |
| POST | /workforce/compensation/components | L4+ | Create component |
| PATCH | /workforce/compensation/components/:id | L4+ | Update component |
| DELETE | /workforce/compensation/components/:id | L4+ | Disable component |
| GET | /workforce/compensation/profiles | L4+ | List employee profiles |
| POST | /workforce/compensation/profiles | L4+ | Create profile |
| PATCH | /workforce/compensation/profiles/:id | L4+ | Update profile |
| GET | /workforce/payslips | L4+ | List all payslips (filterable) |
| GET | /workforce/payslips/:id | L3+/owner | Get single payslip |
| GET | /workforce/payroll-runs/:id/payslips | L4+ | List payslips for run |
| GET | /workforce/me/payslips | L1+ | Employee self-service |
| GET | /workforce/payroll-runs/:id/export/summary | L4+ | Export run summary CSV |
| GET | /workforce/payroll-runs/:id/export/payslips | L4+ | Export payslip details CSV |
| GET | /workforce/payroll-runs/:id/export/employer-cost | L4+ | Export employer costs CSV |

---

## 5. Acceptance Criteria

### A) Components
- [ ] Component CRUD with validation (capMin < capMax, rate >= 0, etc.)
- [ ] Branch override: branch-scoped component overrides org-level
- [ ] Effective date filtering for profile assignment

### B) Gross-to-Net
- [ ] Calculation produces deterministic netPay
- [ ] Invariant: netPay = gross - preTax - taxes - postTax (rounded)
- [ ] Totals match sum of breakdown records
- [ ] CLOSED pay period blocks recalculation

### C) Payslips
- [ ] Admin can view all payslips
- [ ] Employee can only view own payslips
- [ ] Payslip shows component breakdown

### D) Exports
- [ ] CSV headers match data schema
- [ ] Totals in export match persisted values
- [ ] UTF-8 BOM for Excel

### E) GL Posting
- [ ] DEFERRED: Stubs with acceptance criteria documented

---

## 6. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Rounding drift | Medium | High | Use Decimal, round once at end |
| Component ordering | Medium | High | Sort by type priority |
| RBAC leakage | Low | High | Always filter by userId for self-service |
| Open handles in E2E | Medium | Medium | withTimeout(), cleanup |

---

## 7. Dependencies

- M10.6 (PayrollRun, PayrollRunLine models)
- M8.2b (JournalEntry for GL posting)
- Prisma Decimal support
- date-fns for period calculations

---

## 8. Implementation Order

1. Schema changes (Prisma models)
2. Compensation service (CRUD)
3. Payroll calculation upgrade
4. Payslip service
5. Export service
6. Controllers + routes
7. Web pages
8. E2E tests
9. UI tests
