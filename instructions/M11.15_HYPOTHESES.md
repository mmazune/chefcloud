# M11.15: Inventory Enterprise Hardening â€” Hypotheses

## Pre-Implementation Hypotheses

These hypotheses MUST be validated during implementation and testing.

---

### H1: Middleware Blocks Legitimate Create Paths

**Hypothesis:** The immutability middleware might accidentally block `create` operations due to incorrect action filtering.

**Risk:** HIGH â€” Would break all inventory ledger creation

**Validation:**
- [ ] E2E test creates InventoryLedgerEntry successfully
- [ ] E2E test creates InventoryCostLayer successfully
- [ ] E2E test creates LotLedgerAllocation successfully
- [ ] Middleware explicitly checks `action === 'update' || action === 'delete'`

**Mitigation:** Explicit action check with allowlist for `create`, `findMany`, `findFirst`, `findUnique`, `count`, `aggregate`

---

### H2: Middleware Doesn't Cover All Prisma Client Instances

**Hypothesis:** If middleware is registered per-instance and not on the singleton, some code paths might bypass immutability enforcement.

**Risk:** MEDIUM â€” Code could accidentally mutate ledger via alternate client

**Validation:**
- [ ] Verify `PrismaService` uses singleton pattern
- [ ] Verify `$use()` is called in `onModuleInit`
- [ ] Grep for any direct `new PrismaClient()` usage outside PrismaService

**Mitigation:** Register middleware on the module-scoped singleton in `prisma.service.ts`

---

### H3: New Indexes Cause Migration Failures on Large Tables

**Hypothesis:** Adding indexes to tables with millions of rows could cause migration timeouts in production.

**Risk:** MEDIUM â€” Could block deployment

**Validation:**
- [ ] Indexes are CREATE INDEX CONCURRENTLY (Postgres)
- [ ] Migration can be run separately from deployment
- [ ] No foreign key changes in same migration

**Mitigation:** Index-only migration with `CREATE INDEX CONCURRENTLY` annotation where possible

---

### H4: Gate Runner Fails on Windows Due to pnpm.cmd Resolution

**Hypothesis:** Windows requires `.cmd` extension for pnpm/npx commands when using `spawn()` without shell.

**Risk:** HIGH â€” Would break Windows dev workflow

**Validation:**
- [ ] `--self-check` mode passes on Windows
- [ ] Platform detection uses `os.platform() === 'win32'`
- [ ] Shell option is true on Windows

**Mitigation:** 
- Use `shell: IS_WINDOWS` in spawn options
- Explicit `pnpm.cmd` / `npx.cmd` resolution

---

### H5: Gate Runner Leaves Open Handles on Timeout

**Hypothesis:** Child processes killed via SIGTERM might leave open handles (sockets, file descriptors) causing Jest to hang.

**Risk:** HIGH â€” Would fail the TIMED_OUT guardrail

**Validation:**
- [ ] Gate runner uses SIGTERM followed by SIGKILL after 5s
- [ ] Test files use `withTimeout` pattern from E2E_NO_HANG_STANDARD.md
- [ ] All new tests have proper `afterAll` cleanup

**Mitigation:**
- SIGTERM â†’ wait 5s â†’ SIGKILL pattern
- Track `child.pid` for process group kill on Unix
- Explicit handle cleanup in test files

---

### H6: Health Report Leaks Cross-Tenant Data

**Hypothesis:** Health report query might accidentally aggregate data across organizations.

**Risk:** CRITICAL â€” Tenant isolation violation

**Validation:**
- [ ] All queries include `orgId` filter
- [ ] E2E test verifies org A cannot see org B data
- [ ] RBAC guard enforces `req.user.orgId`

**Mitigation:**
- All Prisma queries must include `where: { orgId }`
- Add tenant isolation assertion in E2E test

---

### H7: Inventory Suite Runtime Exceeds Budget

**Hypothesis:** Running all 15 inventory test files might exceed the 15-minute budget.

**Risk:** MEDIUM â€” Would leave some tests unrun

**Validation:**
- [ ] Measure baseline runtime of inventory suite
- [ ] Per-file average should be < 60s
- [ ] Total should complete in < 15m

**Mitigation:**
- Increase budget if needed
- Optimize slow tests
- Add `--perFileSeconds` and `--totalMinutes` CLI flags

---

### H8: Ledger Immutability Breaks Void/Reversal Flows

**Hypothesis:** Existing void or reversal flows might attempt to update ledger entries.

**Risk:** HIGH â€” Would break stocktake reversals, vendor return voids, etc.

**Validation:**
- [ ] Audit all "void" flows in codebase
- [ ] Confirm they create reversal entries, not update existing
- [ ] StocktakeLine has separate `reversalLedgerEntryId` FK
- [ ] VendorReturn uses `VOID` status, not ledger mutation

**Mitigation:**
- All corrections must use reversal entries (negative qty)
- Status field updates (on parent records) are allowed
- Middleware only blocks the ledger models, not parent entities

---

### H9: Middleware Error Response Format Inconsistent

**Hypothesis:** Throwing a raw Error from middleware might not produce consistent HTTP 403 response.

**Risk:** MEDIUM â€” Client confusion on error format

**Validation:**
- [ ] Middleware throws `HttpException` from `@nestjs/common`
- [ ] Error includes `code: 'LEDGER_IMMUTABLE'`
- [ ] E2E test verifies response shape

**Mitigation:** Throw `ForbiddenException` with standardized body

---

### H10: Health Report Slow on Large Datasets

**Hypothesis:** Counting all ledger entries might be slow on production-scale data.

**Risk:** LOW â€” Health report is admin-only, infrequent

**Validation:**
- [ ] Use COUNT queries, not fetch-all
- [ ] Add optional `branchId` filter for scoped reports
- [ ] Response time < 5s on demo dataset

**Mitigation:**
- Aggregate queries with indexes
- Consider caching for production

---

## Hypothesis Status Tracking

| H# | Status | Notes |
|----|--------|-------|
| H1 | ðŸ”´ OPEN | To be validated in E2E |
| H2 | ðŸ”´ OPEN | Code audit needed |
| H3 | ðŸ”´ OPEN | Migration design needed |
| H4 | ðŸ”´ OPEN | Self-check test needed |
| H5 | ðŸ”´ OPEN | Gate runner design needed |
| H6 | ðŸ”´ OPEN | E2E tenant isolation test needed |
| H7 | ðŸ”´ OPEN | Runtime measurement needed |
| H8 | ðŸ”´ OPEN | Void flow audit needed |
| H9 | ðŸ”´ OPEN | Error format design needed |
| H10 | ðŸ”´ OPEN | Performance test needed |

---

## Post-Implementation Updates

_This section will be updated after implementation with validation results._
