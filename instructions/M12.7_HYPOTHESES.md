# M12.7 Hypotheses: Inventory Close Ops v3

## Summary

Before implementing Close Ops v3 (blockers engine, resolution endpoints, close-pack integrity),
we document testable hypotheses with confidence levels and failure modes.

---

## Hypotheses

### H1: Blockers Query Missing Org/Branch Scoping (Cross-Tenant Leakage)

**Confidence**: 75%  
**Description**: The blockers query for open stocktakes, unposted receipts, etc. may not
properly filter by orgId/branchId, causing data from other tenants to leak into the
preclose check results.

**Test Strategy**: E2E test with two orgs; verify blockers only show data for requesting org.

**Failure Mode**: BLOCKED status shown due to another org's open stocktake.

---

### H2: Resolve Endpoint Privilege Escalation (RBAC Bypass)

**Confidence**: 80%  
**Description**: The blocker resolution endpoint may allow L2 users to post stocktakes
or void receipts, bypassing the required L3+/L4+ role checks.

**Test Strategy**: E2E test attempting resolution with L2 token; expect 403.

**Failure Mode**: L2 user successfully voids a stocktake or posts a receipt.

---

### H3: Resolve Action Duplicates Ledger/GL Postings (Idempotency Gap)

**Confidence**: 70%  
**Description**: Calling resolve with POST_STOCKTAKE or POST_RECEIPT twice may
create duplicate ledger entries or GL postings.

**Test Strategy**: Call resolve twice for same entity; verify only one posting exists.

**Failure Mode**: Double ledger entries, double GL journal entries.

---

### H4: Close-Pack Hashes Differ on Windows (BOM/Newline Ordering)

**Confidence**: 85%  
**Description**: Close-pack bundle hash computed before BOM insertion uses different
newline characters on Windows vs Linux, causing hash verification failures.

**Test Strategy**: Generate close-pack, normalize to LF, verify hash matches header.

**Failure Mode**: X-Nimbus-Export-Hash mismatch on Windows builds.

---

### H5: Revision Mismatch Causes Inconsistent Close-Pack Contents

**Confidence**: 65%  
**Description**: If period revision changes between preclose check and close-pack
generation (e.g., reopen happened), exports may reference stale snapshot data.

**Test Strategy**: Attempt close-pack generation with stale revision; expect 409.

**Failure Mode**: Close-pack contains data from wrong period revision.

---

### H6: Preclose Snapshots Go Stale (Dashboard Shows Wrong Status)

**Confidence**: 60%  
**Description**: Dashboard reads from preclose snapshot that was run hours ago,
but blockers were since resolved. Dashboard shows BLOCKED when actually READY.

**Test Strategy**: Run preclose, resolve blocker, verify dashboard refresh reflects change.

**Failure Mode**: Dashboard shows outdated BLOCKED status.

---

### H7: UI "Resolve" Calls Wrong Route (Route Ordering / :id Shadowing)

**Confidence**: 55%  
**Description**: NestJS route ordering may cause POST /inventory/periods/:id/blockers/resolve
to be shadowed by another :id route, causing 404 or wrong handler.

**Test Strategy**: E2E test calling resolve endpoint; verify correct handler executes.

**Failure Mode**: 404 or wrong period selected for resolution.

---

### H8: Tests Hang Due to Unclosed App/Server (Open Handles)

**Confidence**: 50%  
**Description**: E2E tests may not properly close the NestJS app or leave timers/intervals
running, causing Jest to hang after tests complete.

**Test Strategy**: Run tests with --detectOpenHandles; ensure clean exit.

**Failure Mode**: Tests complete but process doesn't exit.

---

### H9: L5 Override Not Audited (Missing Notification/Event)

**Confidence**: 70%  
**Description**: When L5 user overrides a BLOCKED blocker, no notification or audit
event is emitted, leaving no trail for compliance review.

**Test Strategy**: Override blocker as L5; verify BLOCKER_OVERRIDE_USED notification emitted.

**Failure Mode**: Override happens silently without audit trail.

---

### H10: Generate-Close-Pack Allowed on OPEN Period

**Confidence**: 75%  
**Description**: The generate-close-pack endpoint may not check period status, allowing
pack generation before period is CLOSED.

**Test Strategy**: Attempt generate-close-pack on OPEN period; expect 409.

**Failure Mode**: Close-pack generated for OPEN period.

---

## Test Matrix

| Hypothesis | E2E Test | UI Test | Priority |
|------------|----------|---------|----------|
| H1 | ✅ | - | HIGH |
| H2 | ✅ | - | HIGH |
| H3 | ✅ | - | HIGH |
| H4 | ✅ | - | HIGH |
| H5 | ✅ | - | MEDIUM |
| H6 | ✅ | ✅ | MEDIUM |
| H7 | ✅ | - | MEDIUM |
| H8 | ✅ | - | HIGH |
| H9 | ✅ | - | HIGH |
| H10 | ✅ | - | HIGH |

---

**Created**: M12.7 Implementation
**Status**: Ready for implementation
