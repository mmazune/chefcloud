# M12.2 Inventory Close Ops v2 - Feature Dossier

## Overview

**Module:** M12.2  
**Baseline:** M12.1 complete at commit `716f24c`  
**Goal:** Make Inventory Close operationally usable at enterprise scale with:
- Pre-close checklist with deterministic ready/blocked/warning status
- Auto-generation of monthly OPEN periods per branch
- Reopen workflow (L5-only) with audit-grade period event history
- Close Pack export (audit bundle with all exports + bundle hash)
- UI enhancements for complete self-service workflow

## Scope Matrix

| Feature | Description | RBAC | Priority |
|---------|-------------|------|----------|
| A) Pre-Close Check Engine | Deterministic blockers/warnings check | L4+ | P0 |
| B) Period Auto-Generation | Monthly calendar period creation | L4+ | P0 |
| C) Reopen Workflow | Reopen closed periods with audit trail | L5 | P0 |
| D) Close Pack Export | Audit bundle with all exports + hash | L4+ | P0 |
| E) Web UI Enhancements | Full self-service period close UI | L4+ | P0 |

## A) Pre-Close Check Engine

### Endpoint
```
GET /inventory/periods/preclose-check?branchId=&startDate=&endDate=
```

### Response Schema
```typescript
{
  status: 'READY' | 'BLOCKED' | 'WARNING';
  blockers: Array<{
    code: string;           // e.g., 'STOCKTAKE_IN_PROGRESS'
    category: string;       // e.g., 'STOCKTAKES'
    count: number;
    sampleIds: string[];    // max 5, scoped to org
    description: string;
  }>;
  warnings: Array<{
    code: string;
    category: string;
    count: number;
    sampleIds: string[];
    description: string;
  }>;
  requiredActions: string[];  // human-readable steps
  checkedAt: string;          // ISO timestamp
}
```

### Blocker Conditions
| Code | Condition |
|------|-----------|
| STOCKTAKE_IN_PROGRESS | StocktakeSession.status IN (IN_PROGRESS, SUBMITTED, APPROVED) with overlapping dates |
| PRODUCTION_BATCH_DRAFT | ProductionBatch.status = DRAFT with startedAt/completedAt overlapping |
| TRANSFER_IN_TRANSIT | Transfer.status = IN_TRANSIT with shipDate <= endDate |
| RECEIPT_INCONSISTENT | GoodsReceiptV2 with posted header but missing ledger entries |
| GL_POSTING_FAILED | Inventory GL posting status = FAILED within range |

### Warning Conditions
| Code | Condition |
|------|-----------|
| GL_POSTING_SKIPPED | Inventory GL posting status = SKIPPED within range |
| LARGE_RECONCILIATION_DELTA | Reconciliation variance > threshold (configurable) |
| PENDING_ADJUSTMENTS | StockAdjustment.status = PENDING within range |

## B) Period Auto-Generation

### Endpoint
```
POST /inventory/periods/generate
```

### Request
```typescript
{
  branchId: string;
  fromMonth: string;    // YYYY-MM format
  months: number;       // default 6, max 24
}
```

### Response
```typescript
{
  createdCount: number;
  existingCount: number;
  periods: Array<{ id: string; startDate: string; endDate: string; status: string }>;
}
```

### Behavior
- Creates OPEN periods for each calendar month
- Month boundaries: 1st 00:00:00.000Z to last day 23:59:59.999Z
- Idempotent: existing periods are skipped
- Must not create overlapping periods

## C) Reopen Workflow + Period Event Log

### New Prisma Model: InventoryPeriodEvent
```prisma
model InventoryPeriodEvent {
  id            String   @id @default(cuid())
  orgId         String
  branchId      String
  periodId      String
  type          InventoryPeriodEventType
  actorUserId   String
  occurredAt    DateTime @default(now())
  reason        String?
  metadataJson  Json?
  
  // Relations
  org           Org                @relation(fields: [orgId], references: [id])
  branch        Branch             @relation(fields: [branchId], references: [id])
  period        InventoryPeriod    @relation(fields: [periodId], references: [id])
  actor         User               @relation(fields: [actorUserId], references: [id])
  
  @@index([orgId, branchId])
  @@index([periodId])
}

enum InventoryPeriodEventType {
  CREATED
  CLOSED
  REOPENED
  OVERRIDE_USED
  EXPORT_GENERATED
}
```

### Reopen Endpoint (L5 only)
```
POST /inventory/periods/:id/reopen
```

### Request
```typescript
{
  reason: string;  // required, audit trail
}
```

### Revision Strategy Decision

**Chosen Approach: Snapshot Revisioning (Audit-Safe)**

When a period is reopened and re-closed:
1. Keep existing snapshots immutable
2. Add `revision` field to `InventoryValuationSnapshot` and `InventoryPeriodMovementSummary`
3. On re-close, create new snapshot set with revision + 1
4. Unique constraint: `@@unique([periodId, itemId, locationId, revision])`
5. Exports and reconciliation use latest revision
6. Historical revisions preserved for audit

This approach:
- ✅ Preserves full audit history
- ✅ Allows comparison between revisions
- ✅ No data loss on reopen
- ✅ Deterministic export (always latest revision)

## D) Close Pack Export

### Endpoint
```
GET /inventory/periods/:id/close-pack
```

### Response
```typescript
{
  period: {
    id: string;
    branchId: string;
    startDate: string;
    endDate: string;
    status: string;
    closedAt: string;
    revision: number;
  };
  reconciliation: {
    overallStatus: string;
    categories: ReconciliationCategory[];
  };
  totals: {
    valuationTotal: number;
    itemCount: number;
    movementSummaryCount: number;
  };
  exports: {
    valuation: { url: string; hash: string };
    movements: { url: string; hash: string };
    reconciliation: { url: string; hash: string };
    index: { url: string; hash: string };
  };
  bundleHash: string;  // SHA-256 over concatenated normalized CSV
  generatedAt: string;
}
```

### Index CSV Endpoint
```
GET /inventory/periods/:id/export/close-pack-index.csv
```

Format:
```csv
ExportType,Filename,SHA256Hash,RowCount
valuation,valuation-xxx.csv,abc123...,150
movements,movements-xxx.csv,def456...,150
reconciliation,reconciliation-xxx.csv,ghi789...,4
BUNDLE,,combined_hash...,
```

### Bundle Hash Algorithm
1. Generate valuation, movements, reconciliation CSVs
2. Normalize line endings to LF
3. Strip BOM for hashing
4. Concatenate in order: valuation + movements + reconciliation
5. SHA-256 the concatenated content
6. Apply BOM to final exports

## E) Web UI Enhancements

### /inventory/period-close page additions

1. **Pre-Close Check Panel**
   - Button: "Run Pre-Close Check"
   - Results display: status badge, blockers list, warnings list
   - Required actions with links

2. **Period Generation Modal**
   - Inputs: Branch select, From Month (date picker), Months count (1-24)
   - Results: created vs existing counts

3. **Reopen Button (L5 only)**
   - Visible only for L5 users
   - Requires reason input
   - Confirmation dialog

4. **Close Pack Panel**
   - View close pack summary
   - Export all button (zip or individual)
   - Bundle hash display with copy

## Parity Comparison

### InvenTree (MIT)
| Feature | InvenTree Behavior | M12.2 Adaptation |
|---------|-------------------|------------------|
| Stock History | Append-only ledger, no period concept | We add period boundaries + snapshots |
| Pre-close checks | N/A (no periods) | Invented: blocker/warning engine |
| Reopen | N/A | Invented: L5-only with audit events |
| Export | Basic CSV export | Extended: close pack with bundle hash |

### Odoo (Study-Only)
| Feature | Odoo Behavior | M12.2 Adaptation |
|---------|--------------|------------------|
| Period Close | Fiscal period lock, no reopen | We allow L5 reopen with full audit |
| Closing Entries | Auto-generate entries | We generate snapshots/summaries |
| Audit Trail | Activity log per model | InventoryPeriodEvent model |
| Reports | Multiple report types | Close pack bundles all reports |

## Security Considerations

1. **Org/Branch Scoping**: All queries MUST include orgId filter
2. **Sample IDs**: Capped at 5, scoped to prevent cross-tenant leakage
3. **L5 Reopen**: Strict role check, audit event required
4. **Export Hashes**: Deterministic, verifiable integrity

## API Endpoints Summary

| Method | Path | Description | RBAC |
|--------|------|-------------|------|
| GET | `/inventory/periods/preclose-check` | Pre-close check | L4+ |
| POST | `/inventory/periods/generate` | Generate periods | L4+ |
| POST | `/inventory/periods/:id/reopen` | Reopen period | L5 |
| GET | `/inventory/periods/:id/close-pack` | Close pack summary | L4+ |
| GET | `/inventory/periods/:id/export/close-pack-index.csv` | Index CSV | L4+ |
| GET | `/inventory/periods/:id/events` | Period event log | L4+ |
