# M11.11 Inventory Barcode + Scanner Ops - Feature Dossier

## Overview
Scanner-friendly inventory operations: barcode lookup, lot scanning, and "fast paths" for receiving/counting/transfers/waste with strict security and auditability.

## Reference Analysis

### InvenTree Patterns (MIT, ADAPT allowed)
| InvenTree Concept | Implementation | Nimbus Adaptation |
|-------------------|----------------|-------------------|
| `StockItem.barcode_hash` | Hash of barcode for lookup | Direct value storage + org-unique index |
| `StockLocation.barcode_hash` | Location barcode support | Location barcode (future) |
| `barcode.scan()` endpoint | Single unified scan endpoint | `GET /inventory/barcodes/resolve` |
| Barcode plugin system | Extensible via plugins | Format enum (EAN13, UPC_A, CODE128, QR) |
| `assign_barcode()` | Links barcode to item | `POST /inventory/items/:id/barcodes` |
| `unassign_barcode()` | Removes barcode link | `DELETE /inventory/items/:id/barcodes/:id` |
| Stock item scanning | Scan returns StockItem | Returns {type, itemId, lotId?, ...} |
| Stocktake scanning | Scan during count | `POST /inventory/ops/stocktake/:id/scan` |

### Medusa Patterns (MIT, ADAPT allowed)
| Medusa Concept | Implementation | Nimbus Adaptation |
|----------------|----------------|-------------------|
| Product barcode field | Single string on product | Multi-barcode per item support |
| SKU as identifier | SKU used for lookup | Barcode OR SKU resolution |
| No lot barcode | N/A | Lot barcode model added |
| No scan workflows | Manual entry only | Full fast-ops suite |

### GS1/Open Food Facts (Study-only)
| Concept | Pattern | Nimbus Usage |
|---------|---------|--------------|
| EAN-13 | 13-digit global standard | Supported format |
| UPC-A | 12-digit US standard | Supported format |
| GS1-128 | Variable-length with AIs | CODE128 format |
| Checksum validation | Last digit validates | Optional validation (not enforced) |

---

## ChefCloud M11.11 Implementation

### A) Barcode Data Model

#### New Enum: BarcodeFormat
```prisma
enum BarcodeFormat {
  EAN13
  UPC_A
  CODE128
  QR
  OTHER
}
```

#### New Model: InventoryItemBarcode
```prisma
model InventoryItemBarcode {
  id          String        @id @default(cuid())
  orgId       String
  itemId      String
  format      BarcodeFormat @default(OTHER)
  value       String        // The barcode value (normalized)
  isPrimary   Boolean       @default(false)
  createdById String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  org       Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  item      InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  createdBy User?         @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([orgId, value]) // Barcode value unique per org
  @@index([itemId])
  @@index([value])
  @@map("inventory_item_barcodes")
}
```

#### New Model: InventoryLotBarcode (Optional for direct lot selection)
```prisma
model InventoryLotBarcode {
  id          String        @id @default(cuid())
  orgId       String
  lotId       String
  format      BarcodeFormat @default(OTHER)
  value       String
  createdById String?
  createdAt   DateTime      @default(now())

  // Relations
  org       Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lot       InventoryLot @relation(fields: [lotId], references: [id], onDelete: Cascade)
  createdBy User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([orgId, value])
  @@index([lotId])
  @@map("inventory_lot_barcodes")
}
```

**Validation Rules:**
- Normalize: trim whitespace, remove leading/trailing spaces
- Length: 1-64 characters (covers EAN-13, UPC-A, CODE128, QR)
- No duplicate values within org (enforced by DB unique constraint)

---

### B) Barcode Resolution Endpoints

| Method | Endpoint | RBAC | Description |
|--------|----------|------|-------------|
| GET | `/inventory/barcodes/resolve?value=` | L2+ | Resolve barcode to item/lot |
| POST | `/inventory/items/:id/barcodes` | L4+ | Add barcode to item |
| GET | `/inventory/items/:id/barcodes` | L2+ | List item barcodes |
| DELETE | `/inventory/items/:id/barcodes/:barcodeId` | L4+ | Remove barcode |
| POST | `/inventory/lots/:id/barcodes` | L4+ | Add barcode to lot |
| GET | `/inventory/lots/:id/barcodes` | L2+ | List lot barcodes |
| DELETE | `/inventory/lots/:id/barcodes/:barcodeId` | L4+ | Remove lot barcode |

**Resolution Response Shape:**
```typescript
interface BarcodeResolveResult {
  type: 'ITEM' | 'LOT';
  itemId: string;
  lotId?: string;
  sku?: string;
  name: string;
  unit: string;
  expiryDate?: Date;
  status?: LotStatus;
  remainingQty?: number; // For lots
}
```

---

### C) Scanner-Friendly Fast Ops

#### C1) Fast Receiving
```
POST /inventory/ops/receive
Body: {
  branchId: string,
  locationId: string,
  barcodeValue: string,
  qty: number,
  uomId?: string,
  unitCost?: number,
  lotNumber?: string,
  expiryDate?: Date,
  idempotencyKey?: string
}
```
- Resolves barcode → item
- Creates lot if lotNumber provided and item is lot-tracked
- Posts RECEIVE ledger entry
- Returns: { itemId, lotId?, ledgerEntryId, newOnHand }

#### C2) Fast Stocktake Scan
```
POST /inventory/ops/stocktake/:sessionId/scan
Body: {
  barcodeValue: string,
  locationId?: string,  // Optional if session is location-scoped
  countedQty: number
}
```
- Resolves barcode → item
- Finds or creates StocktakeLine
- Enforces blindCount rules (no expectedQty leak)
- Returns: { lineId, itemId, countedQty }

#### C3) Fast Waste
```
POST /inventory/ops/waste
Body: {
  branchId: string,
  locationId: string,
  barcodeValue: string,
  qty: number,
  reason?: string,
  notes?: string
}
```
- Resolves barcode → item (or lot)
- Posts WASTAGE ledger entry
- If lot barcode: validates lot status (blocks QUARANTINE/EXPIRED)
- Returns: { itemId, lotId?, ledgerEntryId, newOnHand }

#### C4) Fast Transfer (Simplified)
```
POST /inventory/ops/transfer
Body: {
  fromLocationId: string,
  toLocationId: string,
  barcodeValue: string,
  qty: number
}
```
- Creates and posts transfer in one call
- Returns: { transferId, ledgerEntryIds }

---

### D) Fraud/Integrity Controls

| Control | Implementation |
|---------|----------------|
| Org Scoping | All queries include `WHERE orgId = ?` |
| Branch Scoping | Location verified belongs to branch |
| Lot Status | QUARANTINE/EXPIRED lots blocked from fast ops |
| Negative Stock | Default reject unless `allowNegative` flag |
| Rate Limiting | DB sliding window (no timers) - 100 scans/minute/user |
| Duplicate Prevention | Idempotency key for receives (stored 24h) |
| Audit Trail | All fast ops logged with user, timestamp, source |

**Rate Limit Implementation:**
- Table: `inventory_barcode_rate_limits` with (userId, windowStart, count)
- Query-based check: no timers/intervals
- Cleanup via periodic cron (not in-request)

---

### E) Web UI

**Pages:**

1. `/inventory/barcodes` - Barcode Management
   - Search/resolve tool with real-time lookup
   - Item barcode CRUD table
   - Bulk import (CSV)

2. `/inventory/stocktakes/[id]` - Enhancement
   - "Scan Mode" toggle
   - Barcode input field + qty
   - Quick count entry via scan

**Navigation:**
- roleCapabilities: OWNER, MANAGER, STOCK_MANAGER see barcodes page
- Counters (L3) see scan field on stocktake detail

---

### F) Reporting + Exports

| Endpoint | RBAC | Description |
|----------|------|-------------|
| GET `/inventory/barcodes/export` | L4+ | CSV with BOM + hash |

**Export Columns:**
- Barcode Value, Format, Type (ITEM/LOT), Item SKU, Item Name, Lot Number, Created At, Created By

**KPIs (added to inventory reporting):**
- `barcode_scans_total` - Total resolve calls
- `barcode_resolve_hits` - Successful resolutions
- `barcode_resolve_misses` - Unknown barcodes
- `blocked_quarantine` - Blocked due to quarantine
- `blocked_expired` - Blocked due to expiry

---

## Parity Verdict

| Feature Group | InvenTree | Nimbus M11.11 | Verdict |
|---------------|-----------|---------------|---------|
| A) Barcode Model | Single hash field | Multi-barcode + format enum | ✅ EXCEEDS |
| B) Resolution | scan() endpoint | resolve + CRUD | ✅ PARITY |
| C) Fast Ops | Limited stocktake scan | Full suite (receive/count/waste/transfer) | ✅ EXCEEDS |
| D) Integrity | Basic validation | Rate limit + lot status + org scope | ✅ EXCEEDS |
| E) Web UI | Basic barcode display | Full management + scan mode | ✅ EXCEEDS |
| F) Reporting | None | Export + KPIs | ✅ EXCEEDS |

---

## Files to Create/Modify

### New Files
- `services/api/src/inventory/inventory-barcodes.service.ts`
- `services/api/src/inventory/inventory-barcodes.controller.ts`
- `services/api/src/inventory/inventory-fast-ops.service.ts`
- `services/api/src/inventory/inventory-fast-ops.controller.ts`
- `services/api/test/e2e/inventory-m1111-barcodes-fastops.e2e-spec.ts`
- `apps/web/src/pages/inventory/barcodes.tsx`
- `apps/web/__tests__/m1111-barcodes-pages.test.tsx`
- `instructions/M11.11_HYPOTHESES.md`
- `instructions/M11.11_PARITY_REAUDIT.md`
- `instructions/M11.11_COMPLETION_REPORT.md`

### Modified Files
- `packages/db/prisma/schema.prisma` - Add BarcodeFormat enum, InventoryItemBarcode, InventoryLotBarcode
- `services/api/src/inventory/inventory.module.ts` - Register new services/controllers
- `services/api/src/inventory/inventory-stocktake.service.ts` - Add scan method
- `apps/web/src/pages/inventory/stocktakes/[id].tsx` - Add scan mode UI

---

## Audit Actions

| Action | Trigger |
|--------|---------|
| `BARCODE_CREATED` | Barcode added to item/lot |
| `BARCODE_DELETED` | Barcode removed |
| `FAST_RECEIVE_POSTED` | Fast receive completed |
| `FAST_WASTE_POSTED` | Fast waste completed |
| `FAST_TRANSFER_POSTED` | Fast transfer completed |
| `STOCKTAKE_SCAN_ENTERED` | Stocktake scan recorded |
| `BARCODE_RESOLVE_BLOCKED` | Resolution blocked (quarantine/expired) |
