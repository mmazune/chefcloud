# M10.22 Workforce Kiosk Ops Hardening - Completion Report

## Summary

M10.22 implements production-grade kiosk hardening for the workforce timeclock module:
- **Offline-safe event queue + replay** with idempotent batch processing
- **Device health monitoring** with computed status (no timers)
- **Fraud controls** with DB-based rate limiting and anomaly detection
- **Operational reporting** with SHA-256 hashed CSV exports

## Files Changed

### Schema (`packages/db/prisma/schema.prisma`)
- Extended `WorkforcePolicy` with:
  - `kioskHeartbeatStaleSeconds` (default 120)
  - `kioskHeartbeatOfflineSeconds` (default 900)
  - `kioskMaxInvalidPinsPerMinute` (default 10)
- Added `KioskEvent` model with UNIQUE(kioskDeviceId, idempotencyKey) for H1
- Added `KioskEventIngest` model for batch tracking with UNIQUE(kioskDeviceId, batchId)
- Added relations to KioskDevice, User, Org, Branch

### New Services
1. **kiosk-batch-ingest.service.ts**
   - `processBatch()` - Idempotent batch event ingestion (H1)
   - `processEvent()` - Individual event with sequence validation (H2)
   - `validateSequence()` - Clock state transition checks

2. **kiosk-health.service.ts**
   - `computeStatus()` - ONLINE/STALE/OFFLINE/DISABLED via DB query (H3)
   - `updateHeartbeat()` - Update device and session heartbeat
   - `getDevicesHealth()` / `getDeviceHealth()` - Health status queries
   - `getHealthMetrics()` - Aggregated metrics by branch

3. **kiosk-fraud.service.ts**
   - `checkRateLimit()` - DB sliding window rate limiting (H3, H6)
   - `logPinAttempt()` - Log attempts with masked PIN only (H4)
   - `getFraudMetrics()` - Fraud analytics with anomaly detection
   - `exportAttempts()` - CSV with BOM + SHA-256 hash (H5)

4. **kiosk-ops-reporting.service.ts**
   - `exportEvents()` - CSV with normalized LF + SHA-256 hash (H5)
   - `getBatchHistory()` - Batch ingest history per device
   - `getDeviceEvents()` - Recent events with filters

### Updated Controllers
- **public-kiosk.controller.ts**: Added batch endpoint and enhanced heartbeat
- **kiosk-device.controller.ts**: Added health, fraud, and export endpoints

### Audit Actions (`workforce-audit.service.ts`)
- Added 6 new actions: KIOSK_EVENT_BATCH_RECEIVED, KIOSK_EVENT_ACCEPTED, KIOSK_EVENT_REJECTED, KIOSK_HEARTBEAT, KIOSK_OFFLINE_QUEUE_USED, KIOSK_FRAUD_BLOCKED

## Hypotheses Implemented

| ID | Hypothesis | Mitigation |
|----|------------|------------|
| H1 | Idempotency | UNIQUE(kioskDeviceId, idempotencyKey) constraint |
| H2 | Sequence ordering | `validateSequence()` checks clock state |
| H3 | No timers | All expiry computed via DB queries |
| H4 | PIN security | Only masked PIN stored in attempt logs |
| H5 | Export hash | SHA-256 on normalized LF content |
| H6 | Fair rate limiting | DB sliding window per device |
| H7 | Audit completeness | All batch events logged |
| H8 | UI queue flush | User action triggers sync (no timer) |

## API Endpoints

### Public (Kiosk Device)
- `POST /public/workforce/kiosk/:publicId/events/batch` - Batch event ingest
- `POST /public/workforce/kiosk/:publicId/heartbeat` - Enhanced with health tracking

### Admin (L4+ Required)
- `GET /workforce/kiosk/health` - Device health status
- `GET /workforce/kiosk/health/metrics` - Aggregated health metrics
- `GET /workforce/kiosk/devices/:id/health` - Single device health
- `GET /workforce/kiosk/fraud` - Fraud metrics
- `GET /workforce/kiosk/fraud/export` - CSV export with hash
- `GET /workforce/kiosk/devices/:id/batch-history` - Batch history
- `GET /workforce/kiosk/devices/:id/events` - Device events
- `GET /workforce/kiosk/export/batch-events` - CSV export with hash

## Tests

- Created `workforce-m1022-kiosk-ops.e2e-spec.ts` with:
  - A1-A4: Batch Event Ingest tests
  - B1-B3: Device Health tests
  - C1-C3: Fraud Controls tests
  - D1-D2: CSV Export with Hash tests
  - E1-E2: Batch History + Device Events tests
  - F1: Idempotency validation
  - G1: Enhanced Heartbeat tests

## Verification

```
ESLint: 0 errors, 3 warnings (unused vars in existing code)
TypeScript: 0 errors
Build: Success
```

## Commit

All changes ready for commit to main branch.
