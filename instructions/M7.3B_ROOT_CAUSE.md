# M7.3B Root Cause Analysis: Inventory Realism Fix

**Date:** 2025-12-23  
**Issue:** "Everything appears critical" in inventory screens  
**Actual Root Cause:** **NO INVENTORY SEEDED AT ALL**

---

## üìä Baseline Measurements

### Current State (All Branches)
```
Branch              Total     OK        Low       Critical    Critical %
------------------------------------------------------------------------
Tapas               0         0         0         0           NaN%
Village Mall        0         0         0         0           NaN%
Acacia Mall         0         0         0         0           NaN%
Arena Mall          0         0         0         0           NaN%
Mombasa             0         0         0         0           NaN%
```

**Summary:**
- InventoryItem count (org-level): Unknown (need to check)
- StockBatch count (branch-level): **0 for all branches**
- Current distribution: N/A (no data)
- Expected distribution: 70-85% OK, 10-20% Low, 2-8% Critical

---

## üîç Root Cause

**Primary Issue:** **Zero inventory batches seeded**

The inventory system has two key tables:
1. **InventoryItem** (org-level): Defines items (name, SKU, reorderLevel, unit)
2. **StockBatch** (branch-level): Tracks actual stock per branch (remainingQty, branchId, itemId)

**What We Found:**
- All branches have `0` stock batches
- This means there's no physical inventory tracked at any branch
- Without StockBatch records, there's nothing to display in inventory screens
- The UI likely shows "everything critical" as a fallback when no data exists

**Why This Happened:**
- The comprehensive seed script (`seedComprehensive.ts`) focuses on:
  - ‚úÖ Tables
  - ‚úÖ Reservations
  - ‚úÖ Suppliers
  - ‚úÖ Service Providers
  - ‚úÖ Orders (with orderItems + payments)
  - ‚úÖ Journal Entries
  - ‚úÖ Employees
  - ‚úÖ Time Entries
  - ‚úÖ Staff Awards
  - ‚úÖ Feedback
  - ‚ùå **Inventory Items** (not seeded)
  - ‚ùå **Stock Batches** (not seeded)

---

## üìÅ Files Involved

### Seed Files to Modify
1. **`services/api/prisma/demo/seedComprehensive.ts`**
   - **Current:** Seeds orders, tables, reservations, etc.
   - **Needs:** Add `seedInventoryItems()` and `seedStockBatches()` functions
   - **Location:** Will add new functions around line ~900-1000

2. **Potential Existing Inventory Seed (if any):**
   - Need to search for existing inventory seeding logic
   - May exist in `prisma/tapas/` or `prisma/demo/` folders

### Schema Reference
- **`packages/db/prisma/schema.prisma`**
  - Lines 1472-1530: InventoryItem model (org-level, no branchId)
  - Lines 1532-1563: StockBatch model (branch-level, has branchId)

### Verification Script
- **`services/api/scripts/check-inventory-distribution.ts`** (created today)
  - Queries StockBatch grouped by itemId per branch
  - Calculates OK/Low/Critical distribution

---

## üéØ Fix Strategy

### Step 1: Create InventoryItem Seeds (Org-Level)
**Goal:** Define ~30-50 inventory items per org with realistic reorderLevel values

**Category-Based ReorderLevel Baselines:**
- **Produce** (tomatoes, lettuce, onions): `reorderLevel: 5-15 kg`, `unit: 'kg'`
- **Meat** (chicken, beef, pork): `reorderLevel: 10-20 kg`, `unit: 'kg'`
- **Dairy** (milk, cheese, butter): `reorderLevel: 3-10 ltr/kg`, `unit: 'ltr' or 'kg'`
- **Spirits** (vodka, whiskey, rum): `reorderLevel: 3-8 bottles`, `unit: 'bottle'`
- **Wine** (red, white, rose): `reorderLevel: 5-15 bottles`, `unit: 'bottle'`
- **Beer** (lager, ale, stout): `reorderLevel: 20-50 bottles`, `unit: 'bottle'`
- **Packaging** (cups, plates, napkins): `reorderLevel: 100-500 pcs`, `unit: 'pcs'`
- **Dry Goods** (flour, sugar, rice): `reorderLevel: 10-50 kg`, `unit: 'kg'`

**Implementation:**
```typescript
async function seedInventoryItems(prisma: PrismaClient, orgId: string): Promise<InventoryItem[]> {
  const items = [
    // Produce
    { name: 'Tomatoes', category: 'produce', reorderLevel: 10, unit: 'kg', sku: 'PROD-001' },
    { name: 'Lettuce', category: 'produce', reorderLevel: 8, unit: 'kg', sku: 'PROD-002' },
    // ... more items

    // Meat
    { name: 'Chicken Breast', category: 'meat', reorderLevel: 15, unit: 'kg', sku: 'MEAT-001' },
    // ... more items

    // Spirits
    { name: 'Vodka (750ml)', category: 'spirits', reorderLevel: 5, unit: 'bottle', sku: 'SPRT-001' },
    // ... more items
  ];

  const createdItems = [];
  for (const item of items) {
    const created = await prisma.inventoryItem.upsert({
      where: { orgId_sku: { orgId, sku: item.sku } },
      update: {},
      create: {
        orgId,
        ...item,
        reorderQty: item.reorderLevel * 2, // Order 2x reorderLevel when restocking
      },
    });
    createdItems.push(created);
  }
  return createdItems;
}
```

### Step 2: Create StockBatch Seeds (Branch-Level)
**Goal:** Seed stock batches for each branch with realistic distribution

**Distribution Strategy:**
- **OK (70-85%)**: Stock = 1.5x to 6x reorderLevel
- **Low (10-20%)**: Stock = 0.6x to 1.2x reorderLevel
- **Critical (2-8%)**: Stock = 0x to 0.5x reorderLevel

**Implementation:**
```typescript
async function seedStockBatches(
  prisma: PrismaClient,
  branchId: string,
  orgId: string,
  items: InventoryItem[]
): Promise<number> {
  let count = 0;

  for (const item of items) {
    // Randomly assign status
    const rand = Math.random();
    let stockMultiplier: number;

    if (rand < 0.05) {
      // 5% Critical (0-0.5x reorderLevel)
      stockMultiplier = Math.random() * 0.5;
    } else if (rand < 0.20) {
      // 15% Low (0.6-1.2x reorderLevel)
      stockMultiplier = 0.6 + Math.random() * 0.6;
    } else {
      // 80% OK (1.5-6x reorderLevel)
      stockMultiplier = 1.5 + Math.random() * 4.5;
    }

    const stockQty = Number(item.reorderLevel) * stockMultiplier;
    
    await prisma.stockBatch.upsert({
      where: { id: `${branchId}-${item.id}-batch-001` },
      update: {},
      create: {
        id: `${branchId}-${item.id}-batch-001`,
        orgId,
        branchId,
        itemId: item.id,
        batchNumber: `BATCH-${Date.now()}-${count}`,
        receivedQty: stockQty,
        remainingQty: stockQty,
        unitCost: 1000 + Math.random() * 5000, // Random cost 1000-6000 UGX
        receivedAt: new Date(),
      },
    });

    count++;
  }

  return count;
}
```

### Step 3: Wire Into Main Seed
```typescript
export async function seedComprehensive(prisma: PrismaClient): Promise<void> {
  // ... existing seeds ...

  // NEW: Seed inventory
  await seedInventory(prisma);

  console.log('\n‚úÖ Comprehensive demo data seeded successfully!');
}

async function seedInventory(prisma: PrismaClient): Promise<void> {
  console.log('\nüì¶ Seeding Inventory...');

  // Seed Tapas inventory
  const tapasItems = await seedInventoryItems(prisma, ORG_TAPAS_ID);
  console.log(`  ‚úÖ Created ${tapasItems.length} inventory items for Tapas`);

  const tapasBatches = await seedStockBatches(prisma, BRANCH_TAPAS_MAIN_ID, ORG_TAPAS_ID, tapasItems);
  console.log(`  ‚úÖ Created ${tapasBatches} stock batches for Tapas`);

  // Seed Cafesserie inventory
  const cafeItems = await seedInventoryItems(prisma, ORG_CAFESSERIE_ID);
  console.log(`  ‚úÖ Created ${cafeItems.length} inventory items for Cafesserie`);

  for (const branchId of [
    BRANCH_CAFE_VILLAGE_MALL_ID,
    BRANCH_CAFE_ACACIA_MALL_ID,
    BRANCH_CAFE_ARENA_MALL_ID,
    BRANCH_CAFE_MOMBASA_ID,
  ]) {
    const batches = await seedStockBatches(prisma, branchId, ORG_CAFESSERIE_ID, cafeItems);
    console.log(`  ‚úÖ Created ${batches} stock batches for branch ${branchId.slice(-4)}`);
  }
}
```

---

## üìä Expected After Fix

```
Branch              Total     OK        Low       Critical    Critical %
------------------------------------------------------------------------
Tapas               40        32        6         2           5.0%
Village Mall        40        34        5         1           2.5%
Acacia Mall         40        33        5         2           5.0%
Arena Mall          40        32        6         2           5.0%
Mombasa             40        31        7         2           5.0%
```

**Target Distribution:**
- OK: 70-85% (28-34 items per branch)
- Low: 10-20% (4-8 items per branch)
- Critical: 2-8% (1-3 items per branch)

---

## ‚ö†Ô∏è Hard Fail Criteria

After fix, `scripts/verify-demo-health.ts` must fail if:
- `criticalPct > 10%` for any branch
- `total inventory items < 30` for any branch
- `total stock batches < 30` for any branch

---

## üìù Implementation Checklist

- [ ] Search for existing inventory seed logic
- [ ] Create `seedInventoryItems()` function
- [ ] Create `seedStockBatches()` function
- [ ] Wire into `seedComprehensive()` main export
- [ ] Update `verify-demo-health.ts` to check inventory distribution
- [ ] Run seed script
- [ ] Verify distribution with `check-inventory-distribution.ts`
- [ ] Document before/after in M7.3B_COMPLETION_SUMMARY.md

---

**Status:** Root cause identified ‚úÖ  
**Next:** Implement inventory seeding functions
