# M12.6 Hypotheses — Close Ops UX + Notifications + Full E2E Gates

**Date:** 2026-01-08
**Baseline Commit:** 01a47157e1a2ecf862d97697511eafa4ab18ad36 (M12.5 complete)

---

## H1: Branch/Org Scoping Leak via Dashboard Aggregation

**Confidence:** 85% (high risk)

**Hypothesis:** The dashboard aggregation queries could leak cross-tenant data if:
- branchId filter is not properly combined with orgId filter
- Aggregation queries do not include orgId in WHERE clauses
- Join queries allow access to branches from other orgs

**Failure Modes:**
- User sees periods from other organizations
- User sees branches they don't have access to
- Aggregation counts include cross-tenant data

**Mitigation:**
- All dashboard queries must include `orgId` in WHERE clause
- Validate branchId belongs to orgId before filtering
- E2E test with multi-tenant isolation assertion

**Validation:** E2E test creates separate org and verifies no cross-tenant data appears.

---

## H2: Approval Actions Allow L3 to Approve (RBAC Regression)

**Confidence:** 90% (high risk)

**Hypothesis:** RBAC decorators may incorrectly allow L3 users to:
- Approve close requests (should be L5+ only)
- Reject close requests (should be L5+ only)
- Access export endpoints (should be L4+ only)

**Failure Modes:**
- L3 user approves period close request
- Unauthorized role accesses restricted endpoint
- Controller decorator mismatch with business logic

**Mitigation:**
- Controller uses `@Roles('L5')` for approve/reject
- Service layer validates roleLevel >= RoleLevel.L5
- E2E test verifies 403 for L3 user attempting approve

**Validation:** E2E test with L3 token gets 403 on approve/reject endpoints.

---

## H3: Notifications Leak Sensitive Fields (Unsafe Subset Violation)

**Confidence:** 80% (medium risk)

**Hypothesis:** Notification payloads may include:
- Internal IDs that expose database structure
- User emails or personal information
- Financial amounts or cost data

**Failure Modes:**
- Notification contains userId instead of userName
- Notification exposes internal periodId without context
- Metadata contains sensitive cost/pricing data

**Mitigation:**
- Define "safe subset" interface for notification content
- Only include: branchName, period range, status, actor role, timestamps
- Review all notification payload constructions

**Validation:** Unit test asserts notification payload only contains safe fields.

---

## H4: Export Hash Mismatch Due to BOM/Newline Ordering on Windows

**Confidence:** 75% (medium risk)

**Hypothesis:** CSV export hash computation may vary across platforms:
- Windows CRLF vs Unix LF line endings
- BOM inclusion/exclusion inconsistency
- Non-deterministic row ordering from database

**Failure Modes:**
- Hash computed on server differs from hash verification on client
- Same export produces different hashes on different runs
- Windows development produces different hashes than Linux production

**Mitigation:**
- Normalize to LF before hash computation
- Include UTF-8 BOM in content but compute hash on normalized content
- Use stable ORDER BY in all export queries

**Validation:** E2E test verifies hash header matches recomputed hash on response body.

---

## H5: UI Calls Wrong Routes Due to Route Ordering/Param Shadowing

**Confidence:** 70% (medium risk)

**Hypothesis:** NestJS route resolution may incorrectly match:
- `/inventory/periods/:id` before `/inventory/periods/close-requests`
- `/:id/approve` shadowing other `:id/xxx` patterns
- Static routes not registered before parameterized routes

**Failure Modes:**
- UI request to `/close-requests` treated as period ID lookup
- 404 errors on valid routes
- Wrong controller method executed

**Mitigation:**
- Static routes registered BEFORE parameterized routes in controller
- Verify route ordering in module imports
- E2E test hits all endpoint variations

**Validation:** E2E tests for all route patterns succeed without 404/500.

---

## H6: Tests Hang Due to Unclosed App/Server or Open Handles

**Confidence:** 95% (very high risk based on prior milestones)

**Hypothesis:** E2E tests may hang indefinitely due to:
- app.listen() not matched with app.close()
- Prisma connections not properly closed
- Timers or intervals not cleared
- Unresolved promises in test lifecycle

**Failure Modes:**
- Jest --detectOpenHandles shows pending operations
- Test suite times out after 30000ms
- Manual process termination required

**Mitigation:**
- Always call app.close() in afterAll
- Use PrismaService.$disconnect()
- No setInterval/setTimeout without cleanup
- withTimeout wrapper on all async operations

**Validation:** `--detectOpenHandles` shows clean exit with no warnings.

---

## H7: Close Request Creation Duplicates (Idempotency Gap)

**Confidence:** 85% (high risk)

**Hypothesis:** Multiple rapid requests to create close request may:
- Create duplicate requests before unique constraint triggers
- Race condition between check and insert
- Different error codes on retry vs first attempt

**Failure Modes:**
- Two close requests for same period
- 500 error instead of 409 Conflict
- Inconsistent behavior on retry

**Mitigation:**
- Use database unique constraint on periodId
- Catch and translate Prisma unique violation to 409
- Service returns existing request on duplicate attempt

**Validation:** E2E test sends concurrent create requests, verifies exactly one created.

---

## H8: Force-Close Path Does Not Emit OVERRIDE_USED Notification

**Confidence:** 80% (medium risk)

**Hypothesis:** When L5 uses forceClose to bypass approval:
- OVERRIDE_USED notification event may not be emitted
- Audit trail may be incomplete
- Security monitoring may miss override usage

**Failure Modes:**
- L5 force close succeeds but no notification recorded
- Notification has wrong type or incomplete metadata
- Notification emitted for normal close path (false positive)

**Mitigation:**
- validateApprovalForClose returns forceUsed flag
- closePeriod emits OVERRIDE_USED when forceUsed=true
- Only emit for actual override, not for approved request path

**Validation:** E2E test verifies OVERRIDE_USED notification after L5 forceClose.

---

## H9: Notification Acknowledgement Race Condition

**Confidence:** 70% (medium risk)

**Hypothesis:** Acking a notification may fail if:
- Notification already acked by concurrent request
- Status transition from SENT->ACKED not atomic
- No idempotency on ack endpoint

**Failure Modes:**
- Error on second ack attempt
- Ack count incorrect
- Lost ack due to race

**Mitigation:**
- Ack is idempotent (already acked returns success)
- Use atomic update with status check
- Return current state regardless of transition

**Validation:** E2E test acks same notification twice, both succeed.

---

## H10: Dashboard Status Thresholds Not Configurable

**Confidence:** 60% (low risk)

**Hypothesis:** Dashboard WARNING/CRITICAL thresholds may be:
- Hardcoded values that don't meet all org requirements
- Not documented for operators
- Inconsistent between service and UI

**Failure Modes:**
- Org needs different threshold but can't configure
- UI and API disagree on what's CRITICAL
- Missing documentation on threshold meaning

**Mitigation:**
- Document thresholds in dossier
- Use constants with clear naming
- Consider future ConfigValue support

**Validation:** Dossier includes threshold documentation; constants defined.

---

## Implementation Order

1. ✅ Write hypotheses (this document)
2. Backend: Extend notification infrastructure for inventory events
3. Backend: Add close-request exports endpoint
4. Backend: Add notification exports endpoint
5. Web: Create /inventory/close-requests page
6. Web: Create /inventory/period-dashboard page
7. Web: Update period-close page for approval integration
8. E2E: Create comprehensive test suite
9. UI: Create smoke test
10. Verification gates
11. Commit and push

---

## Risk Assessment

| Hypothesis | Confidence | Severity | Priority |
|------------|------------|----------|----------|
| H6 (hangs) | 95% | Critical | P0 |
| H2 (RBAC) | 90% | High | P1 |
| H1 (scoping) | 85% | High | P1 |
| H7 (duplicates) | 85% | High | P1 |
| H8 (override notify) | 80% | Medium | P2 |
| H3 (sensitive data) | 80% | Medium | P2 |
| H4 (hash mismatch) | 75% | Medium | P2 |
| H5 (routes) | 70% | Medium | P3 |
| H9 (ack race) | 70% | Low | P3 |
| H10 (thresholds) | 60% | Low | P4 |
