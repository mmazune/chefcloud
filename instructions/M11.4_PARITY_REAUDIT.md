# M11.4 Parity Re-Audit: Recipes/BOM + POS Depletion

## Reference System Analysis

### 1. InvenTree BOM/Consumption Patterns

**Examined:** InvenTree (MIT License) - inventree/InvenTree on GitHub

#### BOM Model Structure
- **BillOfMaterialsItem**: Links parent part to component parts with quantity
- **Output quantity**: Stored at BOM level (yield/output_quantity field)
- **Sub-assemblies**: Recursive BOM structure (component can itself have BOM)
- **Substitutes**: BOMSubstitute model for alternative parts

#### Consumption Tracking
- **StockItem**: Tracks individual stock instances with quantity, location
- **StockItemTracking**: Append-only tracking of all stock movements
- **Build Order**: Explicit build process that consumes ingredients

#### M11.4 Alignment
| InvenTree Pattern | M11.4 Implementation | Gap |
|-------------------|---------------------|-----|
| BOMItem (parent→child→qty) | RecipeLine (recipe→item→qty) | ✓ Aligned |
| Output quantity | Recipe.outputQtyBase | ✓ Aligned |
| StockItemTracking (append-only) | InventoryLedgerEntry (append-only) | ✓ Aligned |
| Build Order (explicit consumption) | OrderInventoryDepletion (automatic) | Different trigger (POS vs manual) |
| Substitutes | Not implemented | Future scope |

---

### 2. TastyIgniter Restaurant Patterns

**Examined:** TastyIgniter (MIT License) - tastyigniter/TastyIgniter on GitHub

#### Menu/Stock Integration
- **Menuitem**: Core sellable item with price, categories
- **Stock**: Inventory items with quantity tracking
- **Stockhistory**: Movement log for stock changes
- **Locations**: Restaurant locations with their own stock

#### Stock Depletion on Order
- **Order completion triggers stock deduction**
- **Menuitem_option_values**: Modifier ingredients can also deplete stock
- **Settings-based location selection**: Default stock location configurable

#### M11.4 Alignment
| TastyIgniter Pattern | M11.4 Implementation | Gap |
|---------------------|---------------------|-----|
| Menuitem → ingredients | Recipe.targetType=MENU_ITEM | ✓ Aligned |
| Stock deduction on order | SALE ledger entries on CLOSED | ✓ Aligned |
| Configurable default location | Branch.depletionLocationId | ✓ Aligned |
| Modifier ingredients | Not in M11.4 scope | Future scope |
| Stockhistory (log) | InventoryLedgerEntry | ✓ Aligned |

---

### 3. Critical Implementation Decisions

#### 3.1 Idempotency Record Pattern
**Reference:** Both InvenTree and TastyIgniter use explicit tracking records

M11.4 implements `OrderInventoryDepletion`:
- UNIQUE(orgId, orderId) prevents duplicates
- Status tracks PENDING → POSTED | FAILED
- Re-processing returns existing result without side effects

#### 3.2 Negative Stock Policy
**Reference:** InvenTree allows configurable negative stock; TastyIgniter blocks

M11.4 Decision:
- **Allow order completion** (don't block POS flow)
- **Mark depletion as FAILED** with INSUFFICIENT_STOCK error
- **Surface in reporting** for manual resolution
- **Rationale:** Restaurant operations cannot stop serving customers due to inventory system sync issues

#### 3.3 Location Resolution
**Reference:** TastyIgniter uses settings-based default location

M11.4 implements cascading resolution:
1. `Branch.depletionLocationId` (explicit setting)
2. Location with code "KITCHEN" (convention)
3. First location type "PRODUCTION" (fallback)
4. First active location (last resort)
5. FAILED with LOCATION_NOT_FOUND (no silent skip)

---

### 4. Feature Gap Summary

| Feature | InvenTree | TastyIgniter | M11.4 | Priority |
|---------|-----------|--------------|-------|----------|
| Basic BOM/Recipe | ✓ | ✓ | ✓ | M11.4 |
| Order depletion | Manual | Automatic | Automatic | M11.4 |
| Idempotency | Build Order | ✗ | ✓ | M11.4 |
| Negative stock handling | Config | Block | Fail+Report | M11.4 |
| Modifier ingredients | ✗ | ✓ | ✗ | Future |
| Sub-assemblies | ✓ | ✗ | ✗ | Future |
| Substitutes | ✓ | ✗ | ✗ | Future |
| Recipe costing | ✓ | ✗ | ✗ | Future |
| Batch traceability | ✓ | ✗ | ✗ | Future |

---

### 5. Security Considerations

#### InvenTree RBAC Model
- Permissions: view_bomitem, add_bomitem, change_bomitem, delete_bomitem
- Stock operations require change_stock permission

#### M11.4 RBAC
- L2+: Read recipes and depletions
- L3+: Create/update recipes, add/remove lines
- L4+: Export, retry failed depletions
- All operations scoped by orgId (mandatory)

---

### 6. Audit Trail Comparison

| System | Audit Approach |
|--------|---------------|
| InvenTree | StockItemTracking with JSON metadata |
| TastyIgniter | Stockhistory with action type |
| M11.4 | AuditEvent + InventoryLedgerEntry (dual trail) |

M11.4 provides:
- Immutable ledger entries for stock movements
- Separate audit events for recipe/depletion actions
- Full traceability from order → depletion → ledger entries

---

## Verdict

**M11.4 achieves parity** with core BOM/recipe and consumption tracking patterns from both reference systems, with appropriate adaptations for restaurant POS context:

1. ✓ Recipe/BOM model with quantity and UOM
2. ✓ Automatic depletion on order completion
3. ✓ Idempotent processing (exceeds TastyIgniter)
4. ✓ Append-only ledger (matches InvenTree principle)
5. ✓ RBAC with tiered permissions
6. ✓ Configurable depletion location

Future scope items (modifiers, sub-assemblies, costing) are documented but not blocking for M11.4.
