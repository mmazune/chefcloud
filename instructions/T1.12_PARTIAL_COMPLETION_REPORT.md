# T1.12 ‚Äî Fix E2E Timeouts: PARTIAL COMPLETION

**Date:** 2025-12-29  
**Status:** ‚ö†Ô∏è **BLOCKED** by seed script issue
**Dataset:** DEMO_TAPAS (not seeded - seed script broken)

---

## STEPS COMPLETED

### STEP 0 ‚Äî Baseline Confirmation ‚úÖ

Ran matrix, confirmed **12 files timeout at 120s each:**

1. test/a3-pos.e2e-spec.ts
2. test/auth.e2e-spec.ts
3. test/b3-multi-tenant.e2e-spec.ts
4. test/e22-franchise.e2e-spec.ts
5. test/e23-roles-access.e2e-spec.ts
6. test/e24-subscriptions.e2e-spec.ts
7. test/e26-kpis.e2e-spec.ts
8. test/e27-costing.e2e-spec.ts
9. test/e2e/auth.e2e-spec.ts
10. test/e2e/badge-revocation.e2e-spec.ts
11. test/e2e/devportal.slice.e2e-spec.ts
12. test/e2e/franchise.slice.e2e-spec.ts

### STEP 1 ‚Äî Hypotheses ‚úÖ

Documented 4 hypotheses in `/instructions/T1.12_HYPOTHESES.md`:

- **H1:** `enableShutdownHooks()` called AFTER `app.init()` (90% confidence)
- **H2:** Files bypass shared bootstrap helper (70% confidence)
- **H3:** Open handles block shutdown (50% confidence)
- **H4:** Long-lived workers don't stop (40% confidence)

### STEP 2 ‚Äî Systemic Fix ‚úÖ

Enhanced `/test/helpers/e2e-bootstrap.ts`:

- Added `createE2EApp()` helper that enforces proper lifecycle:
  1. Create test module
  2. Create app
  3. Apply validation pipe (optional)
  4. **Call `app.enableShutdownHooks()`** ‚Üê CRITICAL
  5. Call `await app.init()`

Updated `/test/helpers/cleanup.ts`:

- Removed late `enableShutdownHooks()` call
- Now just calls `app.close()` (works correctly if hooks enabled before init)

### STEP 3 ‚Äî Test Conversion ‚úÖ

Converted **ALL 12 timeout files** to use proper bootstrap:

- **10 files:** Migrated to `createE2EApp()` helper
- **2 files:** Manually added `enableShutdownHooks()` before `init()` (slice tests using builder pattern)

**Files changed:**

1. test/helpers/e2e-bootstrap.ts (added createE2EApp)
2. test/helpers/cleanup.ts (removed late enableShutdownHooks)
3. test/a3-pos.e2e-spec.ts
4. test/auth.e2e-spec.ts
5. test/b3-multi-tenant.e2e-spec.ts
6. test/e22-franchise.e2e-spec.ts
7. test/e23-roles-access.e2e-spec.ts
8. test/e24-subscriptions.e2e-spec.ts
9. test/e26-kpis.e2e-spec.ts
10. test/e27-costing.e2e-spec.ts
11. test/e2e/auth.e2e-spec.ts
12. test/e2e/badge-revocation.e2e-spec.ts
13. test/e2e/devportal.slice.e2e-spec.ts
14. test/e2e/franchise.slice.e2e-spec.ts

### STEP 4 ‚Äî Verification ‚ö†Ô∏è **BLOCKED**

#### Ran matrix after fix:

- **Still 12 timeouts (no improvement)**
- Duration: 25m 2s, processed 27 of 57 files

#### Root Cause Investigation:

Timeouts are happening DURING test execution, not during cleanup. Tests are waiting for:

- Database seed data (E2E_USERS, menu items, etc.)
- Prerequisite entities (org, branch, tables)

#### Seed Script Status: ‚ùå **BROKEN**

```bash
$ pnpm test:e2e:setup

# Error 1: Foreign key constraint (after partial seeding)
Foreign key constraint violated: `stock_movements_itemId_fkey (index)`

# Error 2 (after reset): Schema mismatch
The column `users.jobRole` does not exist in the current database.
```

**Diagnosis:**

- Seed script `prisma/seed.ts` references fields that don't exist in current schema
- Indicates schema/seed drift (someone updated schema without updating seed)
- Tests CANNOT run without seed data (they reference E2E_USERS, demo menu items, etc.)

---

## FINDINGS

### What We Fixed ‚úÖ

1. **Systemic enforcement of shutdown hook ordering**
   - All tests now call `enableShutdownHooks()` before `init()`
   - Proper lifecycle management via shared `createE2EApp()` helper
   - Cleanup helper simplified (removed late enableShutdownHooks)

2. **Code quality improvements**
   - Removed 10+ duplicate app bootstrap patterns
   - Centralized validation pipe configuration
   - Added comprehensive JSDoc documentation

### What We Discovered ‚ùå

1. **The timeouts are NOT caused by shutdown hooks**
   - Timeouts occur DURING test execution (in beforeAll)
   - Tests are waiting for database queries that never return
   - Root cause: Missing seed data

2. **Seed script is broken**
   - References `users.jobRole` (doesn't exist in schema)
   - Foreign key violations in inventory cleanup
   - Needs schema/seed synchronization

3. **Matrix runner doesn't seed database**
   - `e2e-runtime-matrix.mjs` spawns Jest directly
   - Skips `pretest:e2e` hook (which calls test:e2e:setup)
   - Each test expects pre-seeded data to exist

---

## REQUIRED NEXT STEPS (T1.12a ‚Äî Separate Task)

### 1. Fix Seed Script ‚ö†Ô∏è **CRITICAL**

**File:** `services/api/prisma/seed.ts`

**Issues:**

- Remove reference to `users.jobRole` (use correct field name)
- Fix foreign key cleanup order (delete stock_movements before inventoryItem)
- Verify seed produces DEMO_TAPAS dataset (not generic "Demo Restaurant")

**Test:**

```bash
cd packages/db
npx prisma migrate reset --force --skip-seed
cd ../../services/api
pnpm test:e2e:setup  # Should succeed without errors
```

### 2. Update Matrix Runner to Seed Database

**File:** `services/api/scripts/e2e-runtime-matrix.mjs`

**Add before running tests:**

```javascript
console.log('üå± Seeding test database...');
const setupResult = spawnSync('pnpm', ['test:e2e:setup'], {
  stdio: 'inherit',
  shell: true,
});
if (setupResult.status !== 0) {
  console.error('‚ùå Database setup failed');
  process.exit(1);
}
```

### 3. Re-Run Matrix After Seed Fix

```bash
timeout 30m node scripts/e2e-runtime-matrix.mjs --perFileSeconds=120 --totalMinutes=25
```

**Expected outcome:**

- 0 timeouts (tests complete with seed data)
- Some tests may still FAIL (test logic issues), but won't timeout

---

## COMMANDS RUN (WITH TIMEOUTS)

| Command                                                       | Timeout | Result                                     | Duration |
| ------------------------------------------------------------- | ------- | ------------------------------------------ | -------- |
| `pnpm test:e2e:teardown-check`                                | 30s     | ‚úÖ PASS with warnings                      | ~1s      |
| `node scripts/e2e-runtime-matrix.mjs` (baseline)              | 30m     | ‚è±Ô∏è Budget exhausted                        | 25m 11s  |
| `pnpm test:e2e -- test/a3-pos.e2e-spec.ts` (before fix)       | 3m      | ‚è∞ TIMEOUT                                 | 3m       |
| `pnpm lint`                                                   | 5m      | ‚ö†Ô∏è 122 warnings, 0 errors                  | ~30s     |
| `pnpm test:e2e -- test/blackbox/billing.blackbox.e2e-spec.ts` | 30s     | ‚úÖ PASS                                    | ~2s      |
| `node scripts/e2e-runtime-matrix.mjs` (after fix)             | 30m     | ‚è±Ô∏è Budget exhausted, **still 12 timeouts** | 25m 2s   |
| `pnpm test:e2e:setup`                                         | 2m      | ‚ùå FAIL (seed broken)                      | ~20s     |
| `prisma migrate reset --force --skip-seed`                    | 2m      | ‚úÖ SUCCESS                                 | ~45s     |
| `pnpm test:e2e:setup` (after reset)                           | 2m      | ‚ùå FAIL (jobRole column missing)           | ~15s     |

---

## MATRIX RESULTS BEFORE VS AFTER

| Metric              | Before (Baseline) | After (With Fix) | Change               |
| ------------------- | ----------------- | ---------------- | -------------------- |
| **Total files run** | 29 of 57          | 27 of 57         | -2 (random variance) |
| **Timed out**       | **12**            | **12**           | **0 improvement** ‚ö†Ô∏è |
| **Failed**          | 11                | 10               | -1 (variance)        |
| **Passed**          | 6                 | 5                | -1 (variance)        |
| **Duration**        | 25m 11s           | 25m 2s           | -9s (noise)          |

**Conclusion:** Shutdown hook fix did NOT resolve timeouts. Tests are timing out DURING execution (waiting for seed data), not during cleanup.

---

## GIT STATUS

‚úÖ **NO RESETS NEEDED** ‚Äî All changes are beneficial even though they didn't fix the timeout root cause:

- Improved code quality (centralized bootstrap)
- Proper lifecycle management for future tests
- Better error messages in cleanup

**Files changed (14 total):**

- 2 helpers (e2e-bootstrap.ts, cleanup.ts)
- 12 test files converted to use new helper

**Lint status:** ‚úÖ 0 errors, 122 warnings (unused imports ‚Äî cosmetic)

---

## BLOCKER DETAILS

### Seed Script Error 1 (Foreign Key Constraint)

```
Invalid `prisma.inventoryItem.deleteMany()` invocation
Foreign key constraint violated: `stock_movements_itemId_fkey (index)`
```

**Fix:** Delete `stock_movements` before `inventoryItem` in cleanup phase

### Seed Script Error 2 (Column Missing)

```
Invalid `prisma.user.upsert()` invocation
The column `users.jobRole` does not exist in the current database.
```

**Fix:** Update seed.ts to use correct User model field names from schema.prisma

---

## FINAL STATUS

**Hypothesis H1 DENIED:**

- `enableShutdownHooks()` timing was NOT the root cause
- Tests timeout waiting for data, not waiting for cleanup

**Actual Root Cause:**

- **Seed script broken** (schema/seed drift)
- Tests wait forever for queries that depend on non-existent seed data
- Matrix runner doesn't seed database before running tests

**Recommended Next Task:**

1. Fix seed script (remove `jobRole`, fix FK cleanup order)
2. Update matrix runner to call `test:e2e:setup` before running tests
3. Re-run matrix to validate fix
4. If still timeouts, use `--detectOpenHandles` on specific files

---

**END OF REPORT**
