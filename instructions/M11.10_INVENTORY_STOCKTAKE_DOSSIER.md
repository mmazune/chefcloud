# M11.10 Inventory Stocktake v2 - Feature Dossier

## Overview
Enterprise-grade physical stocktake workflow with blind counting, multi-stage approvals, variance thresholds, and controlled posting into the immutable stock ledger.

## Reference Analysis

### InvenTree Patterns (MIT, ADAPT allowed)
| InvenTree Concept | Implementation | Notes |
|-------------------|----------------|-------|
| `stocktake()` method | Direct quantity update | No approval workflow |
| `StockHistoryCode.STOCK_COUNT` | Tracking code | Records count event |
| `stocktake_date`, `stocktake_user` | Per-item fields | Last stocktake info |
| No blind count | Pre-filled quantity | Counter sees expected |
| No approval gates | Immediate update | No RBAC separation |
| No variance thresholds | Accepts any count | No variance controls |

### Odoo/ERPNext Patterns (Study-only)
| Concept | Pattern | ChefCloud Adaptation |
|---------|---------|----------------------|
| Inventory Adjustment | Wizard-based | Session-based workflow |
| Validation | Two-step optional | Mandatory approval gates |
| Locations | Multi-warehouse | Branch+Location scoped |

## ChefCloud M11.10 Implementation

### A) StocktakeSession Model (Enterprise Workflow)

```
StocktakeSession
├─ orgId, branchId (mandatory)
├─ locationId? (optional: single-location scope OR null for multi-location)
├─ status: DRAFT → IN_PROGRESS → SUBMITTED → APPROVED → POSTED | VOID
├─ blindCount: Boolean (default true)
├─ varianceThresholdPct: Decimal (default 10.0%)
├─ varianceThresholdAbs?: Decimal (optional absolute threshold)
├─ startedAt, submittedAt, approvedAt, postedAt, voidedAt
├─ startedById, submittedById, approvedById, postedById, voidedById
├─ voidReason?: String
├─ notes?: String
├─ metadata?: Json
└─ lines: StocktakeLine[]
```

### B) StocktakeLine Model

```
StocktakeLine
├─ sessionId
├─ itemId, locationId
├─ expectedQty: Decimal (snapshot at IN_PROGRESS transition)
├─ countedQty?: Decimal (nullable until counted)
├─ varianceQty: Decimal (computed: countedQty - expectedQty)
├─ varianceValue?: Decimal (computed: varianceQty × WAC, if costing enabled)
├─ countedById?, countedAt?
└─ notes?
```

### C) Blind Count UX + Snapshot Consistency

**Blind Count Rules:**
- If `blindCount=true`:
  - API responses to L2/L3 users must NOT expose `expectedQty` until session is SUBMITTED
  - Only L4+ can see `expectedQty` at any time
- `expectedQty` is a snapshot taken when session transitions to IN_PROGRESS
- Snapshot is frozen - does not change even if stock moves later via other transactions

**Snapshot Implementation:**
- On `start()`: Query current on-hand per item/location and populate `expectedQty`
- Store as immutable snapshot in `StocktakeLine.expectedQty`

### D) Posting Rules (Ledger + Idempotency)

**On POSTED:**
1. For each line where `countedQty IS NOT NULL`:
   - Create `COUNT_VARIANCE` ledger entry with qty = (countedQty - expectedQty)
   - `reason = 'COUNT_VARIANCE'`, `sourceType = 'STOCKTAKE'`, `sourceId = sessionId`
2. Reject posting if any line is missing `countedQty`
3. Update session status to `POSTED`, set `postedAt`, `postedById`

**Idempotent POST:**
- If session already POSTED, return success with existing data, no new ledger entries

**On VOID:**
1. Create reversal ledger entries for all posted variances (negate qty)
2. Mark session VOID with `voidedAt`, `voidedById`, `voidReason`

**Idempotent VOID:**
- If session already VOID, return success with existing data, no new reversals

### E) RBAC Matrix

| Action | L1 | L2 | L3 | L4 | L5 |
|--------|----|----|----|----|-----|
| List sessions | ❌ | ✅ | ✅ | ✅ | ✅ |
| View session (blind rules) | ❌ | ✅* | ✅* | ✅ | ✅ |
| Create session | ❌ | ❌ | ✅ | ✅ | ✅ |
| Start session | ❌ | ❌ | ✅ | ✅ | ✅ |
| Enter counts | ❌ | ❌ | ✅ | ✅ | ✅ |
| Submit | ❌ | ❌ | ✅ | ✅ | ✅ |
| Approve | ❌ | ❌ | ❌ | ✅ | ✅ |
| Post | ❌ | ❌ | ❌ | ✅ | ✅ |
| Void | ❌ | ❌ | ❌ | ✅ | ✅ |
| Export | ❌ | ❌ | ❌ | ✅ | ✅ |

*L2/L3 with `blindCount=true`: `expectedQty` hidden until SUBMITTED

### F) Audit Actions
- `STOCKTAKE_CREATED` - Session created
- `STOCKTAKE_STARTED` - Session transitioned to IN_PROGRESS, snapshot taken
- `STOCKTAKE_LINE_COUNTED` - Count entered (itemId, locationId, countedQty)
- `STOCKTAKE_SUBMITTED` - Session submitted for approval
- `STOCKTAKE_APPROVED` - Session approved
- `STOCKTAKE_POSTED` - Variance ledger entries created
- `STOCKTAKE_VOIDED` - Reversal entries created

### G) API Endpoints

| Method | Endpoint | RBAC | Description |
|--------|----------|------|-------------|
| POST | `/inventory/stocktakes` | L3+ | Create DRAFT session |
| GET | `/inventory/stocktakes` | L2+ | List sessions (filter by branchId, status, dates) |
| GET | `/inventory/stocktakes/:id` | L2+ | Get session detail (blind rules apply) |
| POST | `/inventory/stocktakes/:id/start` | L3+ | Start session → IN_PROGRESS + snapshot |
| PATCH | `/inventory/stocktakes/:id/lines/:lineId` | L3+ | Enter countedQty |
| POST | `/inventory/stocktakes/:id/submit` | L3+ | Submit for approval |
| POST | `/inventory/stocktakes/:id/approve` | L4+ | Approve session |
| POST | `/inventory/stocktakes/:id/post` | L4+ | Post variances to ledger |
| POST | `/inventory/stocktakes/:id/void` | L4+ | Void posted session |
| GET | `/inventory/stocktakes/export` | L4+ | CSV with BOM + X-Nimbus-Export-Hash |

### H) Web UI

**Pages:**
1. `/inventory/stocktakes` - List view
   - Create session button
   - Filters: status, date range, location
   - Status badges
   - Action buttons per row based on status

2. `/inventory/stocktakes/[id]` - Detail view
   - Session info card
   - Variance summary: total items, variance qty, variance value
   - Lines table with count inputs
   - Action buttons: Start/Submit/Approve/Post/Void (RBAC gated)
   - Blind count: hide expectedQty for counters until submitted

**Navigation:**
- roleCapabilities: OWNER, MANAGER, STOCK_MANAGER see stocktakes pages

## Schema Changes

### New Enum: StocktakeStatus
```prisma
enum StocktakeStatus {
  DRAFT
  IN_PROGRESS
  SUBMITTED
  APPROVED
  POSTED
  VOID
}
```

### New Model: StocktakeSession
```prisma
model StocktakeSession {
  id                    String          @id @default(cuid())
  orgId                 String
  branchId              String
  locationId            String?         // Optional: scope to single location
  sessionNumber         String          // Auto-generated: ST-YYYYMMDD-001
  status                StocktakeStatus @default(DRAFT)
  blindCount            Boolean         @default(true)
  varianceThresholdPct  Decimal         @default(10.0) @db.Decimal(5, 2)
  varianceThresholdAbs  Decimal?        @db.Decimal(12, 4)
  notes                 String?
  metadata              Json?
  
  // Workflow timestamps & actors
  startedAt             DateTime?
  startedById           String?
  submittedAt           DateTime?
  submittedById         String?
  approvedAt            DateTime?
  approvedById          String?
  postedAt              DateTime?
  postedById            String?
  voidedAt              DateTime?
  voidedById            String?
  voidReason            String?
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  org                   Organization    @relation(...)
  branch                Branch          @relation(...)
  location              InventoryLocation? @relation(...)
  startedBy             User?           @relation("StocktakeStarter", ...)
  submittedBy           User?           @relation("StocktakeSubmitter", ...)
  approvedBy            User?           @relation("StocktakeApprover", ...)
  postedBy              User?           @relation("StocktakePoster", ...)
  voidedBy              User?           @relation("StocktakeVoider", ...)
  lines                 StocktakeLine[]
  
  @@unique([orgId, sessionNumber])
  @@index([orgId, branchId])
  @@index([status])
  @@map("stocktake_sessions")
}
```

### New Model: StocktakeLine
```prisma
model StocktakeLine {
  id            String          @id @default(cuid())
  sessionId     String
  itemId        String
  locationId    String
  expectedQty   Decimal         @db.Decimal(12, 4) // Snapshot at start
  countedQty    Decimal?        @db.Decimal(12, 4) // Nullable until counted
  varianceQty   Decimal?        @db.Decimal(12, 4) // Computed
  varianceValue Decimal?        @db.Decimal(12, 4) // WAC × varianceQty
  notes         String?
  countedById   String?
  countedAt     DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  session       StocktakeSession @relation(...)
  item          InventoryItem    @relation(...)
  location      InventoryLocation @relation(...)
  countedBy     User?            @relation(...)
  
  @@unique([sessionId, itemId, locationId])
  @@index([sessionId])
  @@map("stocktake_lines")
}
```

### Ledger Extensions
- Add to `LedgerEntryReason`: `COUNT_VARIANCE`
- Add to `LedgerSourceType`: `STOCKTAKE`

## Parity Verdict

| Feature Group | InvenTree | Nimbus M11.10 | Verdict |
|---------------|-----------|---------------|---------|
| A) Workflow states | 1 state | 6 states with gates | ✅ EXCEEDS |
| B) Blind count | None | Full blind UX | ✅ EXCEEDS |
| C) Snapshot | None | Frozen at start | ✅ EXCEEDS |
| D) Approval gates | None | L4+ approve/post | ✅ EXCEEDS |
| E) Variance thresholds | None | Pct + Abs thresholds | ✅ EXCEEDS |
| F) Audit trail | Basic | Full action tracking | ✅ EXCEEDS |
| G) Export | None | CSV + hash | ✅ EXCEEDS |

## Files to Create/Modify

### New Files
- `services/api/src/inventory/inventory-stocktake.service.ts`
- `services/api/src/inventory/inventory-stocktake.controller.ts`
- `services/api/test/e2e/inventory-m1110-stocktakes.e2e-spec.ts`
- `apps/web/src/pages/inventory/stocktakes/index.tsx`
- `apps/web/src/pages/inventory/stocktakes/[id].tsx`
- `apps/web/src/__tests__/pages/inventory/m1110-stocktakes-pages.test.tsx`
- `instructions/M11.10_HYPOTHESES.md`
- `instructions/M11.10_PARITY_REAUDIT.md`
- `instructions/M11.10_COMPLETION_REPORT.md`

### Modified Files
- `packages/db/prisma/schema.prisma` - Add StocktakeSession, StocktakeLine
- `services/api/src/inventory/inventory-ledger.service.ts` - Add COUNT_VARIANCE, STOCKTAKE
- `services/api/src/inventory/inventory.module.ts` - Register new service/controller
- `apps/web/src/components/layout/navigation.ts` - Add stocktakes to roleCapabilities
