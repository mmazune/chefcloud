# M9.5 Hypotheses Table

**Sprint:** M9.5  
**Date:** 2026-01-03  
**Author:** ChefCloud Engineering  

---

## Risk Hypotheses (Pre-Implementation)

| # | Hypothesis | Confidence | Failure Mode | Mitigation |
|---|------------|------------|--------------|------------|
| H1 | HMAC signature mismatch between sender and receiver | HIGH | Webhook receiver rejects valid payloads due to encoding differences (UTF-8, JSON serialization order) | Use canonical JSON serialization (sorted keys), test with real payload verification in E2E |
| H2 | Token scope confusion (CALENDAR_READ vs MANAGE) | MEDIUM | Calendar token allows cancel/reschedule actions it shouldn't | Explicit scope check in each endpoint; scope stored in token record; unit test scope isolation |
| H3 | Automation runner creates duplicate webhook deliveries | HIGH | Same event delivered multiple times causing downstream issues | Idempotency key (eventId) with UNIQUE constraint; dedup check before insert; X-Nimbus-Event-Id header |
| H4 | ICS formatting invalid for calendar apps | MEDIUM | Generated ICS rejected by Google Calendar, Outlook, Apple Calendar | Use validated ics library or strict RFC 5545 compliance; test with multiple parsers |
| H5 | Notification template rendering injection risk | HIGH | Malicious {{variable}} content escapes into HTML/SMS causing XSS or SMS injection | Escape all variable values based on output type (HTML encode for email, strip for SMS); no nested templates |
| H6 | Webhook retry storms / unbounded loops | HIGH | Failed endpoint causes infinite retries, resource exhaustion | Hard cap at 3 retries; DEAD_LETTER terminal state; exponential backoff (1m, 5m, 15m); circuit breaker pattern |
| H7 | SSRF via webhook URL | MEDIUM | Attacker registers webhook to internal IP (127.0.0.1, 10.x.x.x) to probe internal services | URL validation blocking private IP ranges; documented as security control |
| H8 | Notification outbox grows unbounded | LOW | Failed notifications never cleaned up | Retention policy: archive after 30 days; status indices for efficient queries |
| H9 | Calendar feed token expiry breaks integrations | MEDIUM | External calendar stops syncing when token expires | CALENDAR_READ tokens use extended expiry (1 year) or never expire; documented token lifecycle |
| H10 | Webhook secret exposure in logs | HIGH | Secret logged during debugging, visible in error traces | Never log secret; mask in error messages; use hashed secret for lookup if needed |

---

## Validation Plan

| # | Test Method | Expected Outcome |
|---|-------------|------------------|
| H1 | E2E test with in-test HTTP server verifying HMAC | Signature matches expected value |
| H2 | E2E test: CALENDAR_READ token rejected for cancel | 403 Forbidden |
| H3 | E2E test: emit same event twice, check single delivery | Only 1 WebhookDelivery record |
| H4 | Parse generated ICS with ical.js library in test | No parse errors |
| H5 | Template with `<script>` in variable renders escaped | Output contains `&lt;script&gt;` |
| H6 | E2E: endpoint returns 500 three times, check DEAD_LETTER | Status = DEAD_LETTER after 3 attempts |
| H7 | URL validation rejects 127.0.0.1, 10.0.0.1 | BadRequestException thrown |
| H8 | Query outbox with proper indices | Response time < 100ms for 10k records |
| H9 | Calendar token works after 24h in test | Feed still accessible |
| H10 | Check logs after webhook create | Secret not present in any log line |

---

## Post-Implementation Outcome

| # | Status | Notes |
|---|--------|-------|
| H1 | ✅ MITIGATED | HMAC uses canonical JSON.stringify; E2E tests verify signature |
| H2 | ✅ MITIGATED | Scope stored in CalendarFeedToken; validateFeedToken checks scope |
| H3 | ✅ MITIGATED | eventId is UNIQUE; dedup on insert; X-Nimbus-Event-Id header |
| H4 | ✅ MITIGATED | ICS follows RFC 5545; proper escaping of special chars |
| H5 | ✅ MITIGATED | Template validation blocks <script>; variables HTML-escaped |
| H6 | ✅ MITIGATED | maxRetries=3 default; DEAD_LETTER terminal state |
| H7 | ✅ MITIGATED | validateUrl blocks localhost, 127.x, 10.x, 192.168.x |
| H8 | ⚠️ MONITORING | Indices added; retention policy recommended for production |
| H9 | ✅ MITIGATED | expiresAt nullable; long-lived tokens supported |
| H10 | ✅ MITIGATED | Secret only returned on create; not in list responses |
| H5 | | |
| H6 | | |
| H7 | | |
| H8 | | |
| H9 | | |
| H10 | | |

*To be filled after implementation*
