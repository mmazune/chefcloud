# M13.4 Payments Core + Receipts + Cash Management — Feature Dossier

**Milestone:** M13.4
**Date:** 2026-01-08
**Status:** In Progress

---

## 1. Executive Summary

M13.4 implements a production-grade, PCI-neutral payments core for NimbusPOS:
- **Payment Lifecycle**: Create → Authorize → Capture → Void/Refund
- **Method Support**: CASH, CARD (via FakeCardProvider stub), OTHER
- **Receipts**: Immutable, sequential, exportable with hash integrity
- **Cash Sessions**: Open/close per branch for cash accountability
- **Audit Trail**: Append-only PosPaymentEvent for every state change

---

## 2. Feature-Level Comparison Matrix

### A) Payment Intent/Auth/Capture Flow

| Behavior | Square | Toast | Medusa (MIT) | NimbusPOS M13.4 |
|----------|--------|-------|--------------|-----------------|
| Create payment intent | `CreatePayment` with `autocomplete=false` | `orderPayment.create` | `PaymentService.create()` with idempotency_key | `POST /pos/orders/:id/payments` with idempotencyKey |
| Authorize vs capture | Two-step: authorize then complete | Similar two-step | `authorize()` then `capture()` | AUTHORIZED → CAPTURED via `/payments/:id/capture` |
| Idempotency | `idempotency_key` header | `guid` field | `idempotency_key` in body | `idempotencyKey` body + `@@unique([orgId, idempotencyKey])` |
| Provider abstraction | Square SDK | Toast SDK | PaymentProviderService interface | `PaymentProvider` interface + `FakeCardProvider` |
| Multi-tender support | Yes (split payments) | Yes | Yes via multiple payment records | v1: single payment per order; v2: multi allowed |

**NimbusPOS Approach:**
- Two-step for CARD (authorize → capture); one-step for CASH (auto-capture optional)
- FakeCardProvider returns deterministic results for testing
- idempotencyKey scoped to org to prevent cross-org collision

### B) Refund/Void Controls

| Behavior | Square | Toast | Medusa | NimbusPOS M13.4 |
|----------|--------|-------|--------|-----------------|
| Void timing | Before capture only | Before close | AUTHORIZED only | PENDING/AUTHORIZED only |
| Refund timing | After capture | After close | CAPTURED only | CAPTURED only |
| Partial refund | Yes | Yes | Yes | Yes (amountCents <= remaining) |
| Reason required | Optional | Optional | Optional | Required (10 chars min) |
| RBAC | Manager role | Manager role | Admin | L4+ only |
| Audit trail | RefundEvent | VoidReason | PaymentEvent | PosPaymentEvent (VOIDED/REFUNDED) |

**NimbusPOS Approach:**
- Strict state validation: void PENDING/AUTHORIZED; refund CAPTURED only
- Reason required with 10-char minimum for audit
- L4+ role enforcement via decorator

### C) Cash Drawer Session

| Behavior | Square | Toast | Medusa | NimbusPOS M13.4 |
|----------|--------|-------|--------|-----------------|
| Open session | Cash drawer open event | Shift open | N/A | `POST /pos/cash-sessions/open` |
| Opening float | Recorded | Recorded | N/A | `openingFloatCents` required |
| Close session | Cash drawer close | Shift close | N/A | `POST /pos/cash-sessions/:id/close` |
| Expected cash | Computed from sales | Computed | N/A | Sum of CASH captures in window |
| Counted cash | Recorded at close | Recorded | N/A | `countedCashCents` at close |
| Variance | Computed | Computed | N/A | Computed: counted - expected |
| One open per branch | Enforced | Enforced | N/A | Enforced via query guard |

**NimbusPOS Approach:**
- Simple v1: open/close with float and count
- Expected computed from CASH payments between openedAt and closedAt
- One OPEN session per branch enforced

### D) Receipt Issuance + Export

| Behavior | Square | Toast | Medusa | NimbusPOS M13.4 |
|----------|--------|-------|--------|-----------------|
| Receipt trigger | After payment | After close | Order confirmation | After full capture |
| Sequential number | Optional | Optional | Order number | `receiptNumber` org-scoped sequential |
| Idempotent issue | Yes | Yes | N/A | Yes (unique on orderId or receiptNumber) |
| Totals snapshot | Yes | Yes | Yes | `totalsSnapshot` JSON (immutable) |
| Export format | PDF | PDF | N/A | CSV with UTF-8 BOM |
| Export integrity | N/A | N/A | N/A | SHA-256 in `X-Nimbus-Export-Hash` |

**NimbusPOS Approach:**
- Receipt requires sum(capturedCents) >= order.total
- Idempotent via unique constraint
- Export with BOM + hash per inventory/workforce standard

---

## 3. Data Model Design

### PosPayment
```prisma
model PosPayment {
  id             String          @id @default(cuid())
  orgId          String
  branchId       String
  orderId        String
  method         PaymentMethod   // CASH | CARD | OTHER
  status         PaymentStatus   // PENDING | AUTHORIZED | CAPTURED | VOIDED | REFUNDED | FAILED
  currency       String          @default("USD")
  amountCents    Int
  capturedCents  Int             @default(0)
  refundedCents  Int             @default(0)
  provider       PaymentProvider // INTERNAL | FAKE_CARD
  providerRef    String?
  idempotencyKey String
  createdById    String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  @@unique([orgId, idempotencyKey])
  @@index([orgId, branchId, orderId])
}
```

### PosPaymentEvent
```prisma
model PosPaymentEvent {
  id         String   @id @default(cuid())
  orgId      String
  paymentId  String
  type       String   // CREATED | AUTHORIZED | CAPTURED | VOIDED | REFUNDED | FAILED
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())
  createdById String
  
  @@index([paymentId])
}
```

### CashSession
```prisma
model CashSession {
  id                String    @id @default(cuid())
  orgId             String
  branchId          String
  openedById        String
  openedAt          DateTime  @default(now())
  closedById        String?
  closedAt          DateTime?
  openingFloatCents Int
  expectedCashCents Int?
  countedCashCents  Int?
  status            String    @default("OPEN") // OPEN | CLOSED
  note              String?
  
  @@index([orgId, branchId, status])
}
```

### PosReceipt
```prisma
model PosReceipt {
  id            String   @id @default(cuid())
  orgId         String
  branchId      String
  orderId       String
  receiptNumber String
  issuedAt      DateTime @default(now())
  issuedById    String
  totalsSnapshot Json
  
  @@unique([orgId, receiptNumber])
  @@unique([orgId, orderId]) // One receipt per order
}
```

---

## 4. API Endpoints

### Payment Lifecycle
| Endpoint | Method | Role | Description |
|----------|--------|------|-------------|
| `/pos/orders/:id/payments` | POST | L2+ | Create payment for order |
| `/pos/payments/:id/capture` | POST | L2+ | Capture authorized payment |
| `/pos/payments/:id/void` | POST | L4+ | Void pending/authorized |
| `/pos/payments/:id/refund` | POST | L4+ | Refund captured payment |

### Receipts
| Endpoint | Method | Role | Description |
|----------|--------|------|-------------|
| `/pos/orders/:id/receipt` | POST | L2+ | Issue receipt for paid order |
| `/pos/receipts/:id` | GET | L1+ | Get receipt details |
| `/pos/export/receipts.csv` | GET | L4+ | Export with hash |

### Cash Sessions
| Endpoint | Method | Role | Description |
|----------|--------|------|-------------|
| `/pos/cash-sessions/open` | POST | L3+ | Open new session |
| `/pos/cash-sessions/:id/close` | POST | L3+ | Close session |
| `/pos/cash-sessions` | GET | L2+ | List sessions |

---

## 5. Security Controls

| Control | Implementation |
|---------|----------------|
| Org/Branch scoping | All queries filter by JWT orgId + branchId |
| Idempotency | Unique constraint + status guards |
| RBAC | L2+ for payment; L3+ for cash; L4+ for void/refund |
| No secrets stored | Card tokens never persisted |
| Audit trail | PosPaymentEvent for all state changes |
| Rate limiting | DB sliding window (not timers) |

---

## 6. Integration Seam (PCI-Neutral)

The `PaymentProvider` interface allows future integration:
```typescript
interface PaymentProvider {
  authorize(amount: number, token: string): Promise<AuthResult>;
  capture(authId: string): Promise<CaptureResult>;
  void(authId: string): Promise<VoidResult>;
  refund(authId: string, amount: number): Promise<RefundResult>;
}
```

`FakeCardProvider` implements this with deterministic behavior:
- `test-token-success` → authorization succeeds
- `test-token-decline` → authorization fails
- All captures/refunds succeed for valid authIds

---

## 7. Test Strategy

| Test Type | Coverage |
|-----------|----------|
| E2E | Full payment lifecycle, idempotency, RBAC |
| Unit | Provider logic, math validation |
| UI Smoke | Page rendering, essential controls |

---

**Author:** GitHub Copilot
