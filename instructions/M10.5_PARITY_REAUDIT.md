# M10.5 Parity Re-Audit

> **Created:** 2026-01-04  
> **Milestone:** M10.5  
> **Purpose:** Deep feature-by-feature comparison against Kimai patterns and internal standards

---

## 1. Feature Group A: Staff Self-Service Portal

### 1.1 Kimai Reference Behavior

| Behavior | Kimai Pattern | Source |
|----------|---------------|--------|
| View own timesheets | "My Times" menu - user sees only own entries filtered by date range | Study-only |
| View schedule | Integrated with project/activity assignments | Study-only |
| Filter by period | Date range picker with presets (this week, last week, custom) | Study-only |
| Clock status | Current running timer with duration counter | Study-only |

### 1.2 Nimbus Target Behavior

| Behavior | Implementation | Evidence |
|----------|----------------|----------|
| View own schedule | GET /workforce/self/schedule returns ScheduledShifts where userId = req.user.userId | [workforce-self.service.ts](../services/api/src/workforce/workforce-self.service.ts) |
| Filter shifts | Query params: from, to (default 14-30 days ahead) | Self-service controller |
| Shift status | DRAFT/PUBLISHED/IN_PROGRESS/COMPLETED/CANCELLED badges | Uses existing ShiftStatus enum |
| View own time | GET /workforce/self/time-entries with payPeriodId or date range | [workforce-self.service.ts] |
| Clock status | Derived from TimeEntry where clockOutAt IS NULL | Reuses timeclock logic |
| View timesheet | GET /workforce/self/timesheet computes totals using payroll-engine | [workforce-self.service.ts] |

### 1.3 Security Model (RBAC)

| Access Level | Can View | Cannot View |
|--------------|----------|-------------|
| L1 (Waiter) | Own shifts, entries, timesheet | Other users' data |
| L2 (Cashier) | Own shifts, entries, timesheet | Other users' data |
| L3 (Supervisor) | Own + team summary (if needed) | Other orgs' data |
| L4-L5 (Manager/Owner) | Full access via existing pages | N/A |

**Security Invariant:** Self-service endpoints NEVER accept userId as parameter - always derive from JWT.

---

## 2. Feature Group B: Timesheet Adjustments

### 2.1 Kimai Reference Behavior

| Behavior | Kimai Pattern | Notes |
|----------|---------------|-------|
| Edit timesheet | Direct edit with audit log | Kimai allows inline edits |
| Approval workflow | Optional per configuration | Some setups require manager sign-off |
| Lock mechanism | Lock by date range/month | Prevents edits to closed periods |
| Audit trail | Activity log shows all changes | Full before/after capture |

### 2.2 Nimbus Target Behavior

| Behavior | Implementation | Evidence |
|----------|----------------|----------|
| Request adjustment | POST /workforce/adjustments with newClockIn/newClockOut + reason | [adjustments.service.ts] |
| Approval required | All adjustments require supervisor approval (per compliance) | Design decision for audit |
| Status workflow | REQUESTED → APPROVED/REJECTED | AdjustmentStatus enum |
| Lock enforcement | Check PayPeriod.status before allowing request | 403 if CLOSED |
| Audit entries | ADJUSTMENT_REQUESTED, ADJUSTMENT_APPROVED, ADJUSTMENT_REJECTED, ADJUSTMENT_APPLIED | WorkforceAuditLog |

### 2.3 Lock Semantics Detail

```
1. Staff requests adjustment for TimeEntry T
2. System finds PayPeriod P where P.startDate <= T.clockInAt <= P.endDate
3. If P.status = 'CLOSED' → 403 Forbidden
4. If P.status = 'OPEN' → Create TimeEntryAdjustment
5. Manager approves → Update T.clockIn/clockOut, create audit entry
6. Manager rejects → Set rejection reason, create audit entry
```

---

## 3. Feature Group C: Compliance & Policy Hardening

### 3.1 Kimai Reference Behavior

| Behavior | Kimai Pattern |
|----------|---------------|
| Rounding | Per-activity rounding in 5/10/15/30 minute intervals |
| Overtime | Custom fields / export calculations |
| Break compliance | Not enforced at platform level |

### 3.2 Nimbus Target Behavior

| Behavior | Implementation | Evidence |
|----------|----------------|----------|
| Rounding modes | NEAREST/UP/DOWN per WorkforcePolicy | [schema.prisma#RoundingMode] |
| Rounding interval | roundingIntervalMins (default 15) | [WorkforcePolicy model] |
| Daily OT threshold | dailyOtThresholdMins (default 480 = 8h) | Applied per day |
| Weekly OT threshold | weeklyOtThresholdMins (default 2400 = 40h) | Applied per week |
| Break min duration | Configurable, validate endedAt - startedAt | [compliance checks] |
| Double clock-in | Check TimeEntry.clockOutAt IS NULL before clockIn | [timeclock.service.ts] |
| Max shift length | Log incident if shift exceeds policy max (default 12h) | WorkforceAuditLog |

### 3.3 Rounding Algorithm

```typescript
function applyRounding(minutes: number, interval: number, mode: RoundingMode): number {
  switch (mode) {
    case 'NEAREST':
      return Math.round(minutes / interval) * interval;
    case 'UP':
      return Math.ceil(minutes / interval) * interval;
    case 'DOWN':
      return Math.floor(minutes / interval) * interval;
  }
}
```

### 3.4 OT Computation Logic

```typescript
function computeOvertimeMinutes(
  totalWorkedMins: number,
  dailyThreshold: number,
  weeklyTotal: number,
  weeklyThreshold: number
): { daily: number; weekly: number } {
  const dailyOT = Math.max(0, totalWorkedMins - dailyThreshold);
  const weeklyOT = Math.max(0, weeklyTotal - weeklyThreshold);
  return { daily: dailyOT, weekly: weeklyOT };
}
```

---

## 4. Feature Group D: Payroll Export Parity

### 4.1 Kimai Reference Behavior

| Behavior | Kimai Pattern |
|----------|---------------|
| Export formats | CSV, XLSX, PDF |
| Required columns | User, Project, Activity, Duration, Rate |
| Ordering | Configurable by user preference |

### 4.2 Nimbus Target Behavior

| Column | Source | Notes |
|--------|--------|-------|
| employeeId | user.id | Stable identifier |
| employeeName | user.firstName + lastName | Full name |
| branch | branch.name | Location reference |
| payPeriodStart | payPeriod.startDate | ISO date |
| payPeriodEnd | payPeriod.endDate | ISO date |
| regularHours | computed | Total - OT |
| overtimeHours | computed | Daily + weekly OT |
| breakHours | sum(breakEntries.minutes) | Total break time |
| paidHours | regularHours + overtimeHours | Billable time |
| approvedBy | timesheetApproval.approvedBy.name | Approver name |
| approvedAt | timesheetApproval.approvedAt | ISO timestamp |
| roundingMode | policy.roundingMode | For audit |

### 4.3 Deterministic Ordering

```typescript
const orderBy = [
  { orgId: 'asc' },
  { branchId: 'asc' },
  { userId: 'asc' },
  { clockInAt: 'asc' },
];
```

---

## 5. Feature Group E: Reporting Extensions

### 5.1 Endpoints

| Endpoint | Returns | RBAC |
|----------|---------|------|
| GET /workforce/reports/adjustments | { pending: n, approved: n, rejected: n } | L3+ |
| GET /workforce/reports/incidents | { breakViolations: n, otViolations: n, doubleClockIn: n } | L3+ |
| GET /workforce/reports/adjustments/export | CSV of adjustments | L4+ |
| GET /workforce/reports/incidents/export | CSV of incidents | L4+ |

### 5.2 Implementation

Query WorkforceAuditLog with action type filters for counts.
Generate CSV with deterministic ordering for exports.

---

## 6. Internal Standards Compliance

### 6.1 E2E_NO_HANG_STANDARD.md

| Requirement | Compliance |
|-------------|------------|
| jest.setTimeout(120_000) | ✓ All test files |
| withTimeout() for async | ✓ All database queries, HTTP calls |
| afterAll cleanup | ✓ Close app, disconnect prisma |
| test:e2e:strict gate | ✓ Must pass |

### 6.2 DATA_PERSISTENCE_AND_CONSISTENCY_STANDARD.md

| Invariant | Compliance |
|-----------|------------|
| Single source of truth | ✓ TimeEntry is canonical, adjustments update it |
| Cross-role consistency | ✓ Staff sees same data as manager (filtered by userId) |
| Multi-org isolation | ✓ All queries include orgId filter |
| Idempotent operations | ✓ Adjustment approve is idempotent |

### 6.3 E2E_EXPANSION_CONTRACT.md

| AC | Min Assertions | Actual |
|----|----------------|--------|
| A1-A6 | 2 each | ✓ E2E + UI test |
| B1-B7 | 2 each | ✓ E2E tests |
| C1-C6 | 2 each | ✓ E2E tests |
| D1-D3 | 2 each | ✓ E2E tests |
| E1-E4 | 2 each | ✓ E2E tests |

---

## 7. Parity Verdict Summary

| Feature Group | Verdict | Notes |
|---------------|---------|-------|
| A) Staff Self-Service | MEETS | Matches Kimai "My Times" concept |
| B) Adjustments | EXCEEDS | Formal approval workflow vs inline edit |
| C) Compliance | MEETS | Standard rounding/OT logic |
| D) Export | MEETS | Enterprise columns + deterministic order |
| E) Reporting | MEETS | Count endpoints + CSV export |

---

## 8. Open Questions (Resolved)

| Question | Resolution |
|----------|------------|
| Adjustment model: update entry or override? | Update canonical entry (simpler) |
| Incidents: use OpsIncident or WorkforceAuditLog? | WorkforceAuditLog (module boundary) |
| Break compliance: strict enforce or warn? | Log incident, do not block |
| Max shift: configurable per policy? | Default 720 mins (12h), log if exceeded |
