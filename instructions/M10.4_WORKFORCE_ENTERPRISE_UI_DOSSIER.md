# Feature Dossier: M10.4 Workforce Enterprise UI

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-03  
> **Author:** Agent  
> **Milestone:** M10.4  

---

## 1. Scope

### 1.1 Feature Summary

M10.4 adds the web UI pages to exercise M10.3 workforce enterprise backend capabilities. This includes policy management, pay period lifecycle, timesheet bulk approval, and payroll export. Additionally, it establishes migration hygiene (formal migration for M10.3 schema) and E2E no-hang hardening standards.

### 1.2 In Scope

- Workforce policy page (view/edit OT thresholds, rounding rules, approval settings)
- Pay periods page (list/generate/close periods, status badges, lock indicators)
- Timesheets page (per-period employee list, totals, bulk approve/reject)
- Payroll export page (download CSV for period, show last export timestamp)
- RBAC enforcement (L4+: full access; L3: timesheet approvals only)
- E2E no-hang hardening standard (instructions + script + gate)
- Migration hygiene (formalize M10.3 db push into proper migration)

### 1.3 Out of Scope

- Staff self-service time entry viewing (deferred to M10.5)
- Payroll integration with external systems (deferred)
- Break/meal compliance alerts (separate feature)
- Mobile-responsive optimizations (general effort)

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| services/api/src/workforce | API | M10.3 endpoints already exist |
| apps/web/src/pages/workforce | UI | NEW pages: policies, pay-periods, timesheets, payroll-export |
| packages/db/prisma/migrations | DB | NEW migration for M10.3 formalization |
| instructions | Docs | E2E_NO_HANG_STANDARD.md, dossiers, completion report |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| workforce_policies | READ/WRITE | Policy CRUD via M10.3 endpoints |
| pay_periods | READ/WRITE | Generate, list, close periods |
| timesheet_approvals | READ/WRITE | Bulk approve/reject |
| workforce_audit_logs | READ | Display audit trail |

### 1.6 API Endpoints (M10.3 - Already Exist)

| Method | Path | Description |
|--------|------|-------------|
| GET | /workforce/policy | Get current policy |
| PUT | /workforce/policy | Update policy (L4+) |
| GET | /workforce/pay-periods | List periods |
| POST | /workforce/pay-periods/generate | Generate periods |
| POST | /workforce/pay-periods/:id/close | Close period |
| GET | /workforce/timesheets/pending | List pending approvals |
| POST | /workforce/timesheets/approve | Bulk approve |
| POST | /workforce/timesheets/reject | Bulk reject |
| POST | /workforce/payroll/export | Export CSV/JSON |

### 1.7 UI Components (NEW)

| Component | Route | Description |
|-----------|-------|-------------|
| PoliciesPage | /workforce/policies | View/edit workforce policy |
| PayPeriodsPage | /workforce/pay-periods | Manage pay periods |
| TimesheetsPage | /workforce/timesheets | Bulk approval workflow |
| PayrollExportPage | /workforce/payroll-export | Export payroll data |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

- M10.3 backend is complete with all enterprise endpoints
- 19 E2E tests verify RBAC, CRUD, audit logging
- PRE-007 (WaitlistModule DI) is resolved
- Schema synced via `prisma db push` (NOT formal migration)

### 2.2 Gaps and Limitations

- No UI pages to exercise M10.3 capabilities
- Migration hygiene issue (db push instead of migration file)
- E2E suite lacks formalized no-hang enforcement
- No `test:e2e:strict` gate for hanging test prevention

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| M10.3 Workforce Enterprise Backend | Complete | Uses |
| M10.2 Workforce UI (scheduling/timeclock) | Complete | Uses patterns |
| M10.1 Core Workforce | Complete | Uses |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| Kimai | Timekeeping | AGPL | study-only | Pay periods, approvals, exports |

### 3.2 Kimai Pattern Analysis (Study-Only)

**Pay Period Concepts:**
- Kimai uses "timesheet lock" for periods that cannot be modified
- Export function generates CSV/Excel for selected date ranges
- Approval workflow is per-entry or bulk
- Audit trail tracks all modifications

**Nimbus Implementation:**
- PayPeriod model with OPEN/CLOSED/EXPORTED status
- TimesheetApproval linked to TimeEntry
- WorkforceAuditLog tracks all enterprise actions
- Bulk approve/reject with lock enforcement

---

## 4. Acceptance Criteria

### 4.1 Policy Management (H1)

| ID | Criterion | E2E Test | UI Test |
|----|-----------|----------|---------|
| H1.1 | Owner can view current policy | ✅ M10.3 | smoke |
| H1.2 | Owner can update OT thresholds | ✅ M10.3 | interaction |
| H1.3 | Supervisor cannot modify policy | ✅ M10.3 | - |

### 4.2 Pay Period Management (H2)

| ID | Criterion | E2E Test | UI Test |
|----|-----------|----------|---------|
| H2.1 | Generate weekly/biweekly/monthly periods | ✅ M10.3 | smoke |
| H2.2 | Close period locks further edits | NEW | interaction |
| H2.3 | Status badges show OPEN/CLOSED/EXPORTED | NEW | smoke |

### 4.3 Timesheet Approval (H3)

| ID | Criterion | E2E Test | UI Test |
|----|-----------|----------|---------|
| H3.1 | List pending approvals with totals | ✅ M10.3 | smoke |
| H3.2 | Bulk approve selected entries | ✅ M10.3 | interaction |
| H3.3 | Reject with reason | ✅ M10.3 | interaction |

### 4.4 Payroll Export (H4)

| ID | Criterion | E2E Test | UI Test |
|----|-----------|----------|---------|
| H4.1 | Export CSV with correct headers | ✅ M10.3 | - |
| H4.2 | Export marks period as EXPORTED | NEW | smoke |
| H4.3 | Show last export timestamp | - | smoke |

---

## 5. RBAC Matrix

| Role | Policies | Pay Periods | Timesheets | Export |
|------|----------|-------------|------------|--------|
| L5 (Owner) | RW | RW | RW | RW |
| L4 (Manager) | RW | RW | RW | RW |
| L3 (Supervisor) | R | R | RW | - |
| L2 (Cashier) | - | - | R (own) | - |
| L1 (Staff) | - | - | R (own) | - |

---

## 6. Implementation Notes

### 6.1 UI Patterns to Follow

- Use existing Card/Table/Badge components
- Toast for success/error feedback
- ConfirmDialog for destructive actions
- useQuery/useMutation with QueryClient invalidation
- FilterBar pattern from approvals.tsx

### 6.2 Migration Hygiene

1. Run `prisma migrate diff` to generate SQL
2. Create migration folder with timestamp
3. Apply via `prisma migrate deploy`
4. Verify with `prisma migrate status`

### 6.3 E2E No-Hang Standard

- All tests must use afterAll cleanup
- All waits must use withTimeout
- forceExit flag required
- detectOpenHandles for debugging

---

## 7. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| UI calls wrong endpoints | Medium | Low | M10.3 E2E coverage |
| Lock enforcement gaps | Low | High | E2E negative tests |
| Migration conflicts | Low | High | diff review + test DB verify |
| E2E hanging | Medium | Medium | strict gate + standard |

---

*Last Updated: 2026-01-03*
