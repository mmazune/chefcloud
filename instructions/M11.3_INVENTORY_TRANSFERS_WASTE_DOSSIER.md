# M11.3: Inventory Transfers + Waste Ops Dossier

## Overview
This milestone adds inter-branch transfers and waste documentation to the inventory system.

**Transfers** move stock between branches (or locations within a branch) using a Ship/Receive workflow.  
**Waste** documents stock losses due to damage, expiry, theft, or other reasons.

Both features integrate with the append-only ledger system established in M11.1.

---

## Feature Parity to InvenTree / Industry Standards

| Feature | InvenTree | nimbusPOS M11.3 | Notes |
|---------|-----------|-----------------|-------|
| Transfer document header | StockTransfer | InventoryTransfer | Similar structure |
| Transfer lines | StockTransferItem | InventoryTransferLine | Per-item tracking |
| Transfer statuses | Pending/Completed | DRAFT → IN_TRANSIT → RECEIVED | Added VOID state |
| Idempotent receive | ❌ | ✅ | Prevents double-post |
| Ship/Receive workflow | ✅ | ✅ | Full two-phase |
| Ledger entries | Separate stock records | InventoryLedgerEntry | Append-only |
| Waste document | StockWaste (concept) | InventoryWaste | Formalized workflow |
| Waste reasons | Various | DAMAGED, EXPIRED, THEFT, SPOILED, SAMPLE, OTHER | Enum-driven |
| Negative stock prevention | Config-driven | Default reject | Strict by default |
| CSV exports | ✅ | ✅ with BOM + hash | Enterprise-grade |

---

## Data Models

### InventoryTransferStatus (Enum)
```
DRAFT       - Transfer created, lines editable
IN_TRANSIT  - Shipped from source, awaiting receipt
RECEIVED    - All lines received at destination
VOID        - Cancelled (only from DRAFT)
```

### InventoryTransfer (Header)
| Field | Type | Description |
|-------|------|-------------|
| id | cuid | Primary key |
| orgId | String | Organization scope |
| fromBranchId | String | Source branch |
| toBranchId | String | Destination branch |
| transferNumber | String | Auto-generated (TRF-YYMM-XXXXX) |
| status | InventoryTransferStatus | Workflow state |
| shippedAt | DateTime? | When shipped |
| shippedById | String? | Who shipped |
| receivedAt | DateTime? | When received |
| receivedById | String? | Who received |
| notes | String? | Free text |
| idempotencyKey | String? | Unique per org |
| metadata | Json? | Extension data |
| createdById | String | Creator |
| createdAt | DateTime | Creation timestamp |
| updatedAt | DateTime | Last update |

### InventoryTransferLine
| Field | Type | Description |
|-------|------|-------------|
| id | cuid | Primary key |
| transferId | String | Parent transfer |
| itemId | String | Inventory item |
| fromLocationId | String | Source location (in fromBranch) |
| toLocationId | String | Destination location (in toBranch) |
| qtyShipped | Decimal(12,4) | Quantity shipped |
| qtyReceived | Decimal(12,4) | Quantity received (may differ) |
| notes | String? | Line notes |
| createdAt | DateTime | Creation timestamp |
| updatedAt | DateTime | Last update |

### InventoryWasteStatus (Enum)
```
DRAFT   - Waste document created, lines editable
POSTED  - Waste posted to ledger (stock deducted)
VOID    - Cancelled (only from DRAFT)
```

### InventoryWasteReason (Enum)
```
DAMAGED   - Physical damage
EXPIRED   - Past expiry date
THEFT     - Stolen/missing
SPOILED   - Quality degradation
SAMPLE    - Used for sampling
OTHER     - Catch-all
```

### InventoryWaste (Header)
| Field | Type | Description |
|-------|------|-------------|
| id | cuid | Primary key |
| orgId | String | Organization scope |
| branchId | String | Branch scope |
| wasteNumber | String | Auto-generated (WST-YYMM-XXXXX) |
| status | InventoryWasteStatus | Workflow state |
| reason | InventoryWasteReason | Primary reason |
| postedAt | DateTime? | When posted |
| postedById | String? | Who posted |
| notes | String? | Free text |
| idempotencyKey | String? | Unique per org |
| metadata | Json? | Extension data |
| createdById | String | Creator |
| createdAt | DateTime | Creation timestamp |
| updatedAt | DateTime | Last update |

### InventoryWasteLine
| Field | Type | Description |
|-------|------|-------------|
| id | cuid | Primary key |
| wasteId | String | Parent waste document |
| itemId | String | Inventory item |
| locationId | String | Location from which wasted |
| qty | Decimal(12,4) | Quantity wasted (positive) |
| unitCost | Decimal(12,4)? | Optional cost tracking |
| reason | InventoryWasteReason? | Line-level override |
| notes | String? | Line notes |
| createdAt | DateTime | Creation timestamp |
| updatedAt | DateTime | Last update |

---

## API Endpoints

### Transfers API (`/inventory/transfers`)

| Method | Path | Description | RBAC |
|--------|------|-------------|------|
| GET | / | List transfers | L2+ |
| GET | /:id | Get transfer detail | L2+ |
| POST | / | Create draft transfer | L3+ |
| PATCH | /:id | Update draft transfer | L3+ |
| POST | /:id/ship | Ship transfer (OUT entries) | L3+ |
| POST | /:id/receive | Receive transfer (IN entries) | L3+ |
| POST | /:id/void | Void draft transfer | L4+ |
| GET | /export | CSV export | L4+ |

### Waste API (`/inventory/waste`)

| Method | Path | Description | RBAC |
|--------|------|-------------|------|
| GET | / | List waste documents | L2+ |
| GET | /:id | Get waste detail | L2+ |
| POST | / | Create draft waste | L3+ |
| PATCH | /:id | Update draft waste | L3+ |
| POST | /:id/post | Post waste (WASTE entries) | L3+ |
| POST | /:id/void | Void draft waste | L4+ |
| GET | /export | CSV export | L4+ |

---

## Ledger Entries

### Transfer Ship (TRANSFER_OUT)
- Created when transfer is shipped
- Quantity is NEGATIVE (stock leaving source)
- sourceType: 'TRANSFER'
- sourceId: transfer.id
- One entry per line at fromLocationId

### Transfer Receive (TRANSFER_IN)
- Created when transfer is received
- Quantity is POSITIVE (stock arriving at destination)
- sourceType: 'TRANSFER'
- sourceId: transfer.id
- One entry per line at toLocationId

### Waste Post (WASTE)
- Created when waste document is posted
- Quantity is NEGATIVE (stock removed)
- sourceType: 'WASTE'
- sourceId: waste.id
- One entry per line at locationId

---

## State Machine Rules

### Transfer State Machine
```
DRAFT → IN_TRANSIT (via ship)
IN_TRANSIT → RECEIVED (via receive)
DRAFT → VOID (via void)
```

### Waste State Machine
```
DRAFT → POSTED (via post)
DRAFT → VOID (via void)
```

---

## Idempotency

### Transfer Receive
- Check if transfer.status === 'RECEIVED'
- If already received, return `{ isAlreadyReceived: true }`
- Do NOT create duplicate ledger entries

### Waste Post
- Check if waste.status === 'POSTED'
- If already posted, return `{ isAlreadyPosted: true }`
- Do NOT create duplicate ledger entries

---

## Negative Stock Prevention

- TRANSFER_OUT entries check source location on-hand before shipping
- WASTE entries check location on-hand before posting
- Default: reject if resulting on-hand < 0
- Throw `BadRequestException` with clear message

---

## CSV Export Format

### Transfers Export
```csv
Transfer Number,Status,From Branch,To Branch,Shipped At,Received At,Created At
TRF-2501-00001,RECEIVED,Branch A,Branch B,2025-01-15T10:00:00Z,2025-01-15T14:00:00Z,2025-01-15T09:00:00Z
```

### Waste Export
```csv
Waste Number,Status,Branch,Reason,Posted At,Total Qty,Created At
WST-2501-00001,POSTED,Main Store,DAMAGED,2025-01-15T10:00:00Z,25.0000,2025-01-15T09:00:00Z
```

### Export Headers
- Content-Type: text/csv; charset=utf-8
- X-Nimbus-Export-Hash: SHA-256 of body
- UTF-8 BOM prefix: \uFEFF

---

## Web UI Pages

### `/inventory/transfers` (List)
- Table with transfer number, status, from/to branch, dates
- Status filter dropdown
- Create button (L3+)
- Link to detail page

### `/inventory/transfers/[id]` (Detail)
- Header card with status badge, from/to branches, dates
- Lines table with item, qty shipped/received
- Ship button (from DRAFT, L3+)
- Receive button (from IN_TRANSIT, L3+)
- Void button (from DRAFT, L4+)

### `/inventory/waste` (List)
- Table with waste number, status, branch, reason, posted date
- Status/reason filters
- Create button (L3+)
- Link to detail page

### `/inventory/waste/[id]` (Detail)
- Header card with status badge, reason, dates
- Lines table with item, location, qty, cost
- Post button (from DRAFT, L3+)
- Void button (from DRAFT, L4+)

---

## E2E Test Coverage

1. **Transfer create with lines** - Creates draft transfer
2. **Transfer ship creates TRANSFER_OUT ledger entries** - Negative qty at source
3. **Transfer receive creates TRANSFER_IN ledger entries** - Positive qty at destination
4. **Transfer receive idempotency** - Double-receive returns same result
5. **Transfer void from DRAFT** - Only DRAFT can be voided
6. **Transfer ship rejects negative stock** - Insufficient on-hand
7. **Waste create and post** - Creates WASTE ledger entries
8. **Waste post idempotency** - Double-post returns same result
9. **Waste post rejects negative stock** - Insufficient on-hand
10. **CSV export with BOM and hash** - Verifies headers and format
11. **RBAC enforcement** - L2 read, L3 write, L4 void

---

## Files to Create/Modify

### Prisma
- `packages/db/prisma/schema.prisma` - Add models and enums

### Services
- `services/api/src/inventory/inventory-transfers.service.ts`
- `services/api/src/inventory/inventory-waste.service.ts`

### Controllers
- `services/api/src/inventory/inventory-transfers.controller.ts`
- `services/api/src/inventory/inventory-waste.controller.ts`

### Module
- `services/api/src/inventory/inventory.module.ts` - Register new services/controllers

### Web UI
- `apps/web/src/pages/inventory/transfers/index.tsx`
- `apps/web/src/pages/inventory/transfers/[id].tsx`
- `apps/web/src/pages/inventory/waste/index.tsx`
- `apps/web/src/pages/inventory/waste/[id].tsx`
- `apps/web/src/config/roleCapabilities.ts` - Add nav items for L3+ roles

### Tests
- `services/api/test/e2e/inventory-m113-transfers-waste.e2e-spec.ts`
- `apps/web/__tests__/m113-inventory-transfers-waste-pages.test.tsx`

---

## Implementation Order

1. Add Prisma enums and models
2. Run migration
3. Create transfer service
4. Create waste service
5. Create transfer controller
6. Create waste controller
7. Register in module
8. Create transfer list page
9. Create transfer detail page
10. Create waste list page
11. Create waste detail page
12. Update roleCapabilities
13. Write E2E tests
14. Write UI smoke tests
15. Verify all gates pass

---

## Success Criteria

- [ ] All API endpoints functional with correct RBAC
- [ ] Ledger entries created correctly on ship/receive/post
- [ ] Idempotency works on receive and post
- [ ] Negative stock rejected by default
- [ ] CSV exports include BOM and hash header
- [ ] UI pages render and interact correctly
- [ ] E2E tests pass (8+ test groups)
- [ ] No lint errors
- [ ] No type errors
- [ ] Clean commit to main
