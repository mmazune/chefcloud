# M12.5 Hypotheses — Preclose Engine Fix + M12.2 Finalization

**Date:** 2025-01-23
**Baseline Commit:** 5b3186fc4ddb34c19ef9cde6e7d0067ad7da2340 (M12.4.1 complete)

---

## H1: Prisma Query Bug with `in: ['FAILED', null]`

**Location:** `inventory-preclose-check.service.ts` line 220

**Issue:** Prisma's `in` operator does not accept `null` in the array. The pattern `{ in: ['FAILED', null] }` will cause a Prisma validation error:
```
Argument `in`: Invalid value provided. Expected ListEnumGlPostingStatusFieldRefInput or Null
```

**Fix:** Replace with explicit OR conditions:
```typescript
// Before (INVALID)
glPostingStatus: { in: ['FAILED', null] }

// After (VALID)
OR: [
  { glPostingStatus: 'FAILED' },
  { glPostingStatus: null }
]
```

**Validation:** Pre-close check endpoint should return 200 with valid status instead of 500.

---

## H2: M12.2 Tests Need forceClose for L5 Direct Close

**Issue:** With M12.4 approval gating, L5 users cannot close periods directly without:
1. An existing APPROVED close request, OR
2. `forceClose: true` + `forceCloseReason` (≥10 chars)

**Affected Tests:** All M12.2 tests that call `/inventory/periods/close` directly:
- Reopen Workflow beforeAll (lines ~215)
- Close Pack Export beforeAll (lines ~310)  
- Period Events test (lines ~397)
- Revision History beforeAll (lines ~450)
- H5 Bundle Hash test (lines ~520)

**Fix:** Add `forceClose: true` and `forceCloseReason` to all close requests in M12.2 tests.

**Validation:** M12.2 E2E tests should pass without 403 CLOSE_APPROVAL_REQUIRED errors.

---

## H3: No Additional Prisma `in: null` Patterns Exist

**Hypothesis:** The bug pattern may exist elsewhere in the codebase.

**Verification:** Grep search for `in:.*null` pattern across all service files.

**Finding:** Only one occurrence found in `checkReceiptsInconsistent()`. Other check methods (checkGLPostingFailed, checkGLPostingSkipped) use correct patterns:
- `glPostingStatus: 'FAILED'` (single value, correct)
- `glPostingStatus: 'SKIPPED'` (single value, correct)

---

## H4: M12.1 Tests Remain Stable

**Hypothesis:** M12.1 tests were already updated in M12.4.1 to use forceClose pattern.

**Verification:** M12.1 E2E test suite should pass without regressions.

**Prior Fix (M12.4.1):** Updated L5 direct close tests to use `forceClose: true`.

---

## H5: M12.4 Dashboard/Approval Tests Remain Stable

**Hypothesis:** M12.4 tests do not depend on the preclose-check bug.

**Verification:** M12.4 E2E test suite should pass without regressions.

**Rationale:** M12.4 tests focus on approval workflow, not preclose validation.

---

## H6: Pre-close Check Returns Correct Status After Fix

**Hypothesis:** After fixing the Prisma bug, preclose-check should return:
- `READY` when no blockers/warnings
- `BLOCKED` when blockers exist (stocktakes, draft batches)
- `WARNING` when warnings exist (inconsistent receipts)

**Validation:** M12.2 Pre-Close Check tests should pass with correct status values.

---

## H7: Force Close Reason Minimum Length Enforced

**Requirement:** `forceCloseReason` must be ≥10 characters per `validateApprovalForClose`.

**Test Data:** All M12.2 test forceCloseReason strings should be ≥10 chars.

**Example:** "M12.2 test close operation for E2E testing" (valid, >10 chars)

---

## H8: Close Pack Bundle Hash Determinism Preserved

**Hypothesis:** The Prisma fix does not affect close pack generation.

**Validation:** H5 (bundle hash deterministic) test in M12.2 should pass.

---

## Implementation Plan

### Step 1: Fix Prisma Query Bug
- File: `inventory-preclose-check.service.ts`
- Line 220: Replace `in: ['FAILED', null]` with OR conditions

### Step 2: Update M12.2 Tests
- File: `inventory-m122-close-ops-v2.e2e-spec.ts`
- Add forceClose + forceCloseReason to all close operations

### Step 3: Verification
1. Run M12.2 E2E suite
2. Run M12.1 E2E suite (regression check)
3. Run M12.4 E2E suite (regression check)

### Step 4: Commit
- All 3 suites must pass
- Push to main with verification proof
