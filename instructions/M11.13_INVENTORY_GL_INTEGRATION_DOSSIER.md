# M11.13 Inventory → Accounting GL Integration Feature Dossier

## Executive Summary

M11.13 bridges inventory operations (receipts, depletions, waste, stocktake) with the General Ledger. Each inventory movement automatically creates a posted journal entry, ensuring financial records reflect real-time inventory asset changes, COGS recognition, and shrinkage/waste expense tracking.

---

## Feature Group A: Posting Mappings (Org + Branch Override)

### A.1 InventoryPostingMapping Model

| Aspect | Specification |
|--------|---------------|
| **Purpose** | Map inventory movement types to GL accounts |
| **Scope** | Org-level default with optional branch-level override |
| **Required Accounts** | `inventoryAssetAccountId`, `cogsAccountId`, `wasteExpenseAccountId`, `shrinkExpenseAccountId`, `grniAccountId` |
| **Optional Accounts** | `inventoryGainAccountId` (for positive stocktake variance), `productionWipAccountId` (future) |
| **Constraint** | `@@unique([orgId, branchId])` - one mapping per org/branch combo |
| **Resolution** | Branch-specific mapping takes precedence over org default (branchId=null) |

### A.2 Account Mapping Resolution Flow

```
1. Look for mapping where orgId=X AND branchId=Y (specific branch)
2. If not found, look for mapping where orgId=X AND branchId=NULL (org default)
3. If not found, throw BadRequestException (GL integration not configured)
```

### A.3 RBAC

| Operation | Required Role |
|-----------|---------------|
| Create/Update/Delete Mapping | L4 (OWNER) or L5 (SUPER_ADMIN) |
| View Mappings | L3+ (MANAGER+) |

---

## Feature Group B: Auto-Posting Events (Idempotent)

### B.1 Events and Journal Entries

| Event | Source | Trigger | Debit Account | Credit Account | Amount |
|-------|--------|---------|---------------|----------------|--------|
| Goods Receipt POST | `receipts.service.ts` | `post()` after ledger entries | Inventory Asset | GRNI | Line total (qty × unitCost) |
| Order Depletion SUCCESS | `inventory-depletion.service.ts` | `depleteForOrder()` → POSTED | COGS | Inventory Asset | COGS breakdown total |
| Waste POST | `inventory-waste.service.ts` | `post()` after ledger entries | Waste Expense | Inventory Asset | Line total (qty × unitCost) |
| Stocktake POST (negative variance) | `inventory-stocktake.service.ts` | `postSession()` for lines with variance < 0 | Shrink Expense | Inventory Asset | |variance| × WAC |
| Stocktake POST (positive variance) | `inventory-stocktake.service.ts` | `postSession()` for lines with variance > 0 | Inventory Asset | Inventory Gain | variance × WAC |

### B.2 GRNI (Goods Received Not Invoiced) Rationale

Using GRNI instead of direct AP posting allows:
1. Two-way matching: Receipt → PO → Vendor Bill
2. Bill posting will: Dr GRNI, Cr AP (clears the GRNI balance)
3. Clear audit trail: GRNI balance = received but not yet billed

### B.3 Idempotency Strategy

**Approach:** Unique constraint on `(source, sourceId)` in JournalEntry model
- `source`: e.g., 'GOODS_RECEIPT', 'ORDER_DEPLETION', 'WASTE', 'STOCKTAKE'
- `sourceId`: The document ID (receiptId, depletionId, wasteId, sessionId)

**Before creating journal:**
```typescript
const existing = await tx.journalEntry.findFirst({
  where: { orgId, source, sourceId }
});
if (existing) return { journalEntryId: existing.id, isIdempotent: true };
```

### B.4 Period Lock Enforcement

Before creating any journal entry, check:
```typescript
const period = await tx.fiscalPeriod.findFirst({
  where: {
    orgId,
    startsAt: { lte: journalDate },
    endsAt: { gte: journalDate },
  },
});
if (period?.status === 'LOCKED') {
  throw new ForbiddenException(`Cannot post in locked fiscal period: ${period.name}`);
}
```

### B.5 Journal Entry Source Values

| Source Constant | Usage |
|-----------------|-------|
| `INV_GOODS_RECEIPT` | Goods receipt posting |
| `INV_DEPLETION` | Order depletion COGS |
| `INV_WASTE` | Waste document posting |
| `INV_STOCKTAKE` | Stocktake variance posting |
| `INV_GOODS_RECEIPT_VOID` | Receipt void reversal |
| `INV_WASTE_VOID` | Waste void reversal |
| `INV_STOCKTAKE_VOID` | Stocktake void reversal |

---

## Feature Group C: Posting Status + Preview + Exports

### C.1 Posting Status Tracking

Add to inventory documents:
- `glJournalEntryId?: string` - Link to created journal entry
- `glPostingStatus?: 'PENDING' | 'POSTED' | 'FAILED' | 'SKIPPED'`
- `glPostingError?: string` - Error message if FAILED

### C.2 Preview Endpoint

`GET /inventory/gl-preview/:documentType/:documentId`

Returns preview of journal entry that WOULD be created:
```json
{
  "documentType": "GOODS_RECEIPT",
  "documentId": "abc123",
  "previewDate": "2025-01-18T...",
  "lines": [
    { "account": "1200 - Inventory Asset", "debit": 1500.00, "credit": 0 },
    { "account": "2100 - GRNI", "debit": 0, "credit": 1500.00 }
  ],
  "total": 1500.00,
  "balanced": true
}
```

### C.3 Posting Report Endpoint

`GET /inventory/gl-postings`

Query params: `fromDate`, `toDate`, `documentType`, `status`, `branchId`

Returns list of inventory GL postings with journal links.

### C.4 CSV Export

`GET /inventory/gl-postings/export`

Same filters as report, returns CSV with:
- Document Number, Document Type, Document Date
- Journal Entry Number, Journal Date, Journal Status
- Total Debit, Total Credit
- GL Accounts affected

**Integrity Hash:** SHA-256 of CSV content in `X-Content-Hash` header.

---

## Feature Group D: Web UI

### D.1 Accounting Mappings Page

**Route:** `/inventory/accounting-mappings`

| Component | Functionality |
|-----------|---------------|
| MappingsTable | List org + branch mappings with account names |
| MappingForm | Create/edit mapping with account dropdowns |
| BranchOverrideToggle | Enable branch-specific override |
| DeleteConfirmModal | Confirm before deleting mapping |

### D.2 Accounting Postings Page

**Route:** `/inventory/accounting-postings`

| Component | Functionality |
|-----------|---------------|
| PostingsTable | List inventory GL postings with filters |
| DateRangeFilter | Filter by posting date |
| DocumentTypeFilter | Filter by GOODS_RECEIPT, DEPLETION, etc. |
| StatusFilter | Filter by POSTED, FAILED, SKIPPED |
| JournalLink | Click to navigate to journal entry |
| ExportButton | Download CSV with hash |

---

## Feature Group E: Reversals (Void Handling)

### E.1 Reversal Pattern

When voiding an inventory document that has a GL journal:

1. Create a new reversing journal entry with:
   - `reversesEntryId` = original journal ID
   - Swapped debit/credit lines
   - `source` = original source + '_VOID'
   - `status` = 'POSTED'

2. Update original journal:
   - `status` = 'REVERSED'
   - `reversedById`, `reversedAt`

### E.2 Void Eligibility

- Receipts: Can only void POSTED receipts (L4+)
- Waste: Can only void POSTED waste (L4+)
- Stocktake: Can only void POSTED sessions (L4+)
- Depletion: Currently no void (order-driven)

---

## Feature Group F: Audit Logging

### F.1 Audit Events

| Action | Resource Type | Logged Data |
|--------|---------------|-------------|
| `gl.posting.created` | JournalEntry | documentType, documentId, journalId, amounts |
| `gl.posting.failed` | JournalEntry | documentType, documentId, error |
| `gl.posting.reversed` | JournalEntry | originalJournalId, reversalJournalId |
| `inventory.mapping.created` | InventoryPostingMapping | mappingId, accounts |
| `inventory.mapping.updated` | InventoryPostingMapping | changes |
| `inventory.mapping.deleted` | InventoryPostingMapping | mappingId |

---

## Integration Points Summary

### Services to Modify

| Service | Method | Integration Point |
|---------|--------|-------------------|
| `receipts.service.ts` | `post()` | After ledger entries, call `glPostingService.postGoodsReceipt()` |
| `inventory-depletion.service.ts` | `depleteForOrder()` | After POSTED status, call `glPostingService.postDepletion()` |
| `inventory-waste.service.ts` | `post()` | After ledger entries, call `glPostingService.postWaste()` |
| `inventory-stocktake.service.ts` | `postSession()` | After ledger entries, call `glPostingService.postStocktake()` |

### New Files

| File | Purpose |
|------|---------|
| `inventory-posting-mapping.service.ts` | CRUD for InventoryPostingMapping |
| `inventory-gl-posting.service.ts` | GL journal creation for inventory events |
| `inventory-gl-posting.controller.ts` | API endpoints for mappings, preview, export |
| `apps/web/src/pages/inventory/accounting-mappings.tsx` | Mappings UI |
| `apps/web/src/pages/inventory/accounting-postings.tsx` | Postings UI |

---

## Schema Changes

### New Model: InventoryPostingMapping

```prisma
model InventoryPostingMapping {
  id                      String   @id @default(cuid())
  orgId                   String
  branchId                String?  // null = org default
  
  inventoryAssetAccountId String
  cogsAccountId           String
  wasteExpenseAccountId   String
  shrinkExpenseAccountId  String
  grniAccountId           String
  inventoryGainAccountId  String?  // Optional for positive variances
  productionWipAccountId  String?  // Future: production costing
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  createdById             String?
  
  inventoryAssetAccount   Account  @relation("InvAssetAccount", ...)
  cogsAccount             Account  @relation("CogsAccount", ...)
  wasteExpenseAccount     Account  @relation("WasteExpenseAccount", ...)
  shrinkExpenseAccount    Account  @relation("ShrinkExpenseAccount", ...)
  grniAccount             Account  @relation("GrniAccount", ...)
  inventoryGainAccount    Account? @relation("InvGainAccount", ...)
  productionWipAccount    Account? @relation("ProductionWipAccount", ...)
  
  @@unique([orgId, branchId])
  @@index([orgId])
  @@map("inventory_posting_mappings")
}
```

### Additions to Existing Models

#### GoodsReceiptV2
```prisma
glJournalEntryId    String?
glPostingStatus     GlPostingStatus?
glPostingError      String?
glJournalEntry      JournalEntry?  @relation(...)
```

#### InventoryWaste
```prisma
glJournalEntryId    String?
glPostingStatus     GlPostingStatus?
glPostingError      String?
glJournalEntry      JournalEntry?  @relation(...)
```

#### StocktakeSession
```prisma
glJournalEntryId    String?
glPostingStatus     GlPostingStatus?
glPostingError      String?
glJournalEntry      JournalEntry?  @relation(...)
```

#### OrderInventoryDepletion
```prisma
glJournalEntryId    String?
glPostingStatus     GlPostingStatus?
glPostingError      String?
glJournalEntry      JournalEntry?  @relation(...)
```

### New Enum
```prisma
enum GlPostingStatus {
  PENDING
  POSTED
  FAILED
  SKIPPED
}
```

---

## Non-Functional Requirements

| Requirement | Specification |
|-------------|---------------|
| Idempotency | Same document posting must not create duplicate journals |
| Immutability | Posted journals cannot be edited, only reversed |
| Atomicity | Journal creation in same transaction as inventory posting |
| Period Lock | Enforce fiscal period lock before posting |
| Performance | GL posting should not add >100ms to document post |
| Audit | Full audit trail of all GL posting events |

---

## Test Coverage Targets

| Category | Coverage |
|----------|----------|
| E2E Tests | Mapping CRUD, auto-posting all 4 event types, void reversals, period lock, idempotency |
| UI Tests | Mapping form, postings table, export, filtering |
| Edge Cases | Missing mapping, wrong account type, period locked, duplicate posting |

---

## Version

- **Dossier Version:** 1.0
- **Created:** 2025-01-18
- **Milestone:** M11.13
