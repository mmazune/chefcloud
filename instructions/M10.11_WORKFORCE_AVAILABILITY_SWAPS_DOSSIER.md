# Feature Dossier: M10.11 Workforce Availability, Shift Swaps, Open Shifts, Conflict Enforcement, Notifications

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-04  
> **Author:** AI Agent  
> **Milestone:** M10.11  

---

## 1. Scope

### 1.1 Feature Summary

M10.11 adds employee availability management, enterprise-grade shift swap workflows, open shift claiming, centralized conflict enforcement, and workforce notifications. This transforms scheduling from static assignment to dynamic, employee-driven collaboration with proper approval chains and audit trails.

### 1.2 In Scope

**A) Employee Availability**
- Weekly recurring availability per user (dayOfWeek, start/end times, timezone-aware)
- Date-based exceptions (unavailable days, special windows)
- Self-service for employees + manager override capability
- Validation: no overlaps per day, start < end, max 24h

**B) Shift Swap Workflow**
- Two swap types: DIRECT_SWAP (1:1 with coworker) and OFFER_SHIFT (open pool)
- Status lifecycle: DRAFT → REQUESTED → (ACCEPTED | DECLINED) → APPROVED → APPLIED (+ CANCELLED from any state)
- Employees create/cancel own requests; target can accept/decline
- Manager (L4+) approves; shifts update atomically only after approval
- Full audit trail for all state transitions

**C) Open Shifts + Claiming**
- Manager can mark shifts OPEN or create OPEN shifts
- Employees claim (subject to availability + conflicts)
- Optional manager approval toggle via WorkforcePolicy.openShiftRequiresApproval

**D) Conflict Enforcement**
- Centralized checks: overlapping shifts, max hours (daily/weekly OT thresholds), availability windows, pay period locks
- Applied uniformly across scheduling, swaps, and claims

**E) Notifications**
- Workforce notification log for key events
- Events: SWAP_REQUESTED, SWAP_ACCEPTED, SWAP_APPROVED, SHIFT_OPENED, OPEN_SHIFT_CLAIMED, etc.

### 1.3 Out of Scope

- External notification delivery (email/SMS/push) - DEFERRED to future milestone
- Complex shift bidding/auction systems
- Seniority-based auto-approval rules
- Availability integration with external calendars

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| services/api/src/workforce | API | availability, swaps, open-shifts, conflicts services |
| apps/web/src/pages | UI | my-availability, my-swaps, open-shifts, workforce/swaps |
| packages/db/prisma | Schema | Availability models, enhanced ShiftSwap, OpenShift tracking |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| workforce_availability | CREATE | Weekly recurring availability per user |
| workforce_availability_exceptions | CREATE | Date-based availability exceptions |
| shift_swap_requests | CREATE | Enhanced swap request with lifecycle |
| open_shift_claims | CREATE | Claims on open shifts |
| workforce_notification_logs | CREATE | Notification event log |
| workforce_policies | ALTER | Add openShiftRequiresApproval |
| scheduled_shifts | ALTER | Add isOpen flag for open shifts |

### 1.6 API Endpoints

| Method | Path | RBAC | Description |
|--------|------|------|-------------|
| GET | /workforce/availability/me | L1+ | Get my availability |
| PUT | /workforce/availability/me | L1+ | Update my availability |
| GET | /workforce/availability/users/:userId | L4+ | Get user's availability |
| PUT | /workforce/availability/users/:userId | L4+ | Override user's availability |
| GET | /workforce/swaps | L1+ | List my swap requests |
| POST | /workforce/swaps | L1+ | Create swap request |
| POST | /workforce/swaps/:id/cancel | L1+ | Cancel my swap request |
| POST | /workforce/swaps/:id/accept | L1+ | Accept swap (target) |
| POST | /workforce/swaps/:id/decline | L1+ | Decline swap (target) |
| GET | /workforce/swaps/pending | L4+ | List pending approvals |
| POST | /workforce/swaps/:id/approve | L4+ | Approve swap request |
| POST | /workforce/swaps/:id/reject | L4+ | Reject swap request |
| GET | /workforce/open-shifts | L1+ | List open shifts |
| POST | /workforce/scheduling/shifts/:id/open | L4+ | Mark shift as open |
| POST | /workforce/open-shifts | L4+ | Create open shift |
| POST | /workforce/open-shifts/:id/claim | L1+ | Claim open shift |
| POST | /workforce/open-shifts/:id/approve | L4+ | Approve claim |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| MyAvailability | /my-availability | Edit weekly + exceptions |
| MySwaps | /my-swaps | View/request swaps |
| OpenShiftsPage | /open-shifts | Browse + claim |
| SwapsManagement | /workforce/swaps | Manager approval queue |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

**Schema:**
- `ShiftSwap` model (basic: PENDING/APPROVED/REJECTED/CANCELLED)
- `ScheduledShift` model with status lifecycle
- `WorkforcePolicy` with OT thresholds and rounding
- `WorkforceAuditLog` for audit events
- `PayPeriod` with OPEN/CLOSED/EXPORTED status

**Services:**
- `WorkforceSchedulingService`: shift CRUD, conflict detection, publishing
- `WorkforceAuditService`: audit log writing
- `WorkforceEnterpriseService`: policy + pay period management

### 2.2 Gaps and Limitations

- No availability modeling (weekly or exceptions)
- ShiftSwap is minimal (no lifecycle, no target acceptance, no apply step)
- No open shift concept or claiming
- Conflict checks exist but not centralized
- No workforce-specific notifications

---

## 3. Reference Architecture Comparison

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| Kimai | Time Tracking | AGPL-3.0 | STUDY-ONLY | Approval workflows, timesheet patterns |
| cal.com | Scheduling | MIT | ADAPT | Availability modeling, timezone handling |
| Calendso | Booking | MIT | ADAPT | Availability windows, conflict detection |

### 3.2 Feature Parity Matrix

See M10.11_PARITY_REAUDIT.md for detailed comparison.

---

## 4. Acceptance Criteria

| ID | Criterion | Test Strategy |
|----|-----------|---------------|
| AC-01 | Employee can CRUD availability (weekly + exceptions); invalid windows rejected | E2E: create, update, delete; overlap/invalid rejected |
| AC-02 | Manager can override user's availability (RBAC enforced) | E2E: L4+ can PUT, L1 gets 403 |
| AC-03 | Employee can create swap request; status transitions logged; cannot modify others | E2E: create, verify audit log, test cross-user rejection |
| AC-04 | Target employee can accept/decline direct swap | E2E: accept/decline status, audit + notification |
| AC-05 | Manager approval required before shifts update; atomic update | E2E: approve, verify both shifts changed transactionally |
| AC-06 | Swap apply blocked if conflicts (overlap/max hours/availability) | E2E: create conflict, expect 409 |
| AC-07 | Open shift creation + listing; eligible employees can claim | E2E: create open, list, claim |
| AC-08 | PayPeriod CLOSED/EXPORTED blocks applying swaps and claims | E2E: close period, attempt apply/claim, expect 403 |
| AC-09 | Notification logs created for key events (≥5 event types) | E2E: verify logs exist |
| AC-10 | E2E strict runner completes; no hangs | CI gate |

---

## 5. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Availability overlap validation bugs | Medium | Medium | Comprehensive E2E tests |
| Swap approval creates orphan state | Medium | High | Transactional apply with rollback |
| Conflict detection misses edge cases | Medium | High | Centralized service, thorough tests |
| PayPeriod bypass allows changes to locked periods | Low | High | Check at service layer, E2E test |
| RBAC leak allows unauthorized actions | Low | High | Guard decorators + tests |
| E2E hangs due to notification polling | Low | Medium | Synchronous log-only pattern |
| Open shift race condition on claim | Medium | Medium | Unique constraint + optimistic lock |

---

## 6. Implementation Plan

### Phase 1: Schema + Migration
- Add availability models
- Enhance ShiftSwap model
- Add open shift support
- Add notification log model
- Update WorkforcePolicy

### Phase 2: Core Services
- availability.service.ts
- swaps.service.ts (full lifecycle + apply)
- open-shifts.service.ts
- workforce-conflicts.service.ts (centralized)
- workforce-notifications.service.ts

### Phase 3: Controllers + RBAC
- All endpoints with proper guards

### Phase 4: Web UI
- Employee pages (my-availability, my-swaps, open-shifts)
- Manager pages (workforce/swaps)

### Phase 5: E2E Tests
- All ACs covered
- No-hang compliance
