# Feature Dossier: M11.2 Purchasing & Receiving Core

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-05  
> **Author:** AI Assistant  
> **Milestone:** M11.2  

---

## 1. Scope

### 1.1 Feature Summary

M11.2 implements enterprise-grade procurement fundamentals: Purchase Orders with approval workflow, Partial Receiving into inventory ledger, Cost Capture for receipts, and Procurement Exports. This creates the foundation for vendor relationship management, cost-of-goods tracking, and audit-ready receiving workflows.

### 1.2 In Scope

- Purchase Order model with state machine workflow (DRAFT → SUBMITTED → APPROVED → PARTIALLY_RECEIVED → RECEIVED → CANCELLED)
- Purchase Order Lines with UOM conversion to base units and unit cost capture
- Goods Receipt model with idempotent posting behavior
- Goods Receipt Lines with ledger posting in BASE UOM
- Over-receipt policy enforcement (per-line configuration)
- Procurement KPIs (open POs, overdue POs, receipts count)
- CSV/JSON exports for POs and Receipts
- Web UI for PO management and Receipt workflow
- Audit logging for all procurement actions

### 1.3 Out of Scope

- Multi-currency support (deferred to M11.x)
- Vendor invoice matching (deferred to accounting integration)
- Purchase requisitions / approval chains (deferred)
- Return to vendor / credit memos (deferred)
- Backorder management (deferred)
- EDI / automated PO placement (deferred)

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| inventory | API | New purchase-orders and receipts services/controllers |
| inventory | API | Extended export service for PO/receipt exports |
| inventory | API | New procurement-reporting service |
| web | UI | New /inventory/purchase-orders and /inventory/receipts pages |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| purchase_orders_v2 | CREATE | Enterprise PO with vendor FK, status enum, approval tracking |
| purchase_order_lines_v2 | CREATE | Lines with UOM conversion, cost capture, over-receipt policy |
| goods_receipts_v2 | CREATE | Receipt with idempotency, posting status |
| goods_receipt_lines_v2 | CREATE | Lines with ledger reference, location assignment |

### 1.6 API Endpoints

| Method | Path | Description | RBAC |
|--------|------|-------------|------|
| POST | /inventory/purchase-orders | Create PO | L3+ |
| GET | /inventory/purchase-orders | List POs | L2+ |
| GET | /inventory/purchase-orders/:id | Get PO details | L2+ |
| PATCH | /inventory/purchase-orders/:id | Update draft/submitted PO | L3+ |
| POST | /inventory/purchase-orders/:id/submit | Submit PO | L3+ |
| POST | /inventory/purchase-orders/:id/approve | Approve PO | L4+ |
| POST | /inventory/purchase-orders/:id/cancel | Cancel PO | L4+ |
| POST | /inventory/receipts | Create receipt draft | L3+ |
| GET | /inventory/receipts | List receipts | L2+ |
| GET | /inventory/receipts/:id | Get receipt details | L2+ |
| POST | /inventory/receipts/:id/post | Post receipt (creates ledger) | L3+ |
| POST | /inventory/receipts/:id/void | Void posted receipt | L4+ |
| GET | /inventory/reports/procurement-kpis | Procurement KPIs | L4+ |
| GET | /inventory/export/purchase-orders | Export POs CSV | L4+ |
| GET | /inventory/export/receipts | Export receipts CSV | L4+ |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| PurchaseOrdersPage | /inventory/purchase-orders | List with filters, create wizard |
| PurchaseOrderDetailPage | /inventory/purchase-orders/[id] | PO detail with lines, actions |
| ReceiptsPage | /inventory/receipts | List receipts, create from PO |
| ReceiptDetailPage | /inventory/receipts/[id] | Receipt detail, post action |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

- **PurchaseOrder model (legacy)**: Exists with `supplierId` FK to Supplier table, simple status (draft/placed/received/cancelled), no approval workflow
- **GoodsReceipt model (legacy)**: Basic receipt model without idempotency or ledger integration
- **Vendor model (accounting)**: Full vendor model used for VendorBill/VendorPayment
- **InventoryLedgerEntry**: Append-only ledger with sourceType/sourceId reference (M11.1)
- **UOM conversion**: Complete with factor-based conversion (M11.1)
- **InventoryLocation**: Location hierarchy with default receiving flag (M11.1)

### 2.2 Gaps and Limitations

- Legacy PO uses Supplier instead of Vendor (duplicate entities)
- No approval workflow for POs
- No base UOM conversion on PO lines
- No over-receipt policy
- GoodsReceipt doesn't create ledger entries
- No idempotency on receipt posting
- No procurement KPIs or exports

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| M11.1 Inventory Foundation | Complete | Uses: Ledger, UOM, Locations |
| Vendor (accounting) | Complete | Uses: Vendor model for POs |
| UOM Conversions | Complete | Uses: Convert to base UOM |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| InvenTree | Inventory/Procurement | MIT | ADAPT | PO workflow, partial receiving, stock movements |
| Medusa | E-commerce inventory | MIT | ADAPT | Product/inventory primitives |
| TastyIgniter | Restaurant POS | MIT | REVIEW | Restaurant procurement patterns |

### 3.2 InvenTree Patterns (Primary Reference)

**PurchaseOrder Model:**
- Status enum: PENDING, PLACED, COMPLETE, CANCELLED, LOST, RETURNED
- Reference field for external PO numbers
- Target date for expected delivery
- Notes/description fields
- Line items with quantity, purchase_price, destination (location)

**Stock Receiving:**
- StockItem created for each received item
- Tracks batch/serial numbers
- Location assignment on receive
- Partial receiving allows multiple receive events
- Over-delivery handling (configurable)

**Key Differences from Nimbus M11.2:**
- InvenTree tracks each stock item individually (serial/batch)
- Nimbus uses aggregate ledger (qty-based)
- InvenTree has returns workflow (deferred for Nimbus)

### 3.3 Nimbus Adaptations

| InvenTree Pattern | Nimbus Adaptation |
|-------------------|-------------------|
| StockItem per receive | InventoryLedgerEntry (aggregate) |
| destination field | locationId with branch default |
| purchase_price | unitCost on line |
| Over-delivery toggle | allowOverReceipt per line |
| PENDING → PLACED | DRAFT → SUBMITTED |
| Target date | expectedAt |

---

## 4. Implementation Design

### 4.1 State Machine

```
     ┌─────────────────────────────────────────┐
     │               CANCELLED                 │
     └─────────────────────────────────────────┘
              ↑              ↑
              │              │
     ┌────────┴────────┐     │
     │     DRAFT       │─────┤
     └────────┬────────┘     │
              │ submit       │
              ↓              │
     ┌────────────────┐      │
     │   SUBMITTED    │──────┤
     └────────┬───────┘      │
              │ approve      │ cancel
              ↓              │
     ┌────────────────┐      │
     │    APPROVED    │──────┤
     └────────┬───────┘      │
              │ receive (partial)
              ↓              │
     ┌────────────────────┐  │
     │ PARTIALLY_RECEIVED │──┘
     └────────┬────────────┘
              │ receive (complete)
              ↓
     ┌────────────────┐
     │    RECEIVED    │
     └────────────────┘
```

### 4.2 Ledger Integration

When GoodsReceipt is POSTED:
1. For each GoodsReceiptLine:
   - Convert qtyReceivedInput to qtyReceivedBase using item.uomId
   - Create InventoryLedgerEntry:
     - reason: 'RECEIVE'
     - sourceType: 'GOODS_RECEIPT'
     - sourceId: receipt.id
     - qty: qtyReceivedBase (positive)
2. Update PO line qtyReceivedBase
3. Check if PO is fully received → update status

### 4.3 Idempotency

- GoodsReceipt.idempotencyKey is UNIQUE per org
- POST /receipts/:id/post checks if already POSTED
- If already POSTED: return { isAlreadyPosted: true, ... }
- Never duplicate ledger entries

### 4.4 Over-Receipt Policy

- Default: reject if totalReceived > qtyOrderedBase
- PurchaseOrderLine.allowOverReceipt = true → allow
- Returns 409 OVER_RECEIPT_NOT_ALLOWED if violated

---

## 5. Audit Actions

| Action | Trigger | Metadata |
|--------|---------|----------|
| PURCHASE_ORDER_CREATED | POST /purchase-orders | vendorId, lineCount |
| PURCHASE_ORDER_UPDATED | PATCH /purchase-orders/:id | changedFields |
| PURCHASE_ORDER_SUBMITTED | POST /purchase-orders/:id/submit | - |
| PURCHASE_ORDER_APPROVED | POST /purchase-orders/:id/approve | approvedById |
| PURCHASE_ORDER_CANCELLED | POST /purchase-orders/:id/cancel | reason |
| GOODS_RECEIPT_CREATED | POST /receipts | purchaseOrderId |
| GOODS_RECEIPT_POSTED | POST /receipts/:id/post | ledgerEntryCount |
| GOODS_RECEIPT_VOIDED | POST /receipts/:id/void | reason |
