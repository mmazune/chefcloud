# M11.12 Inventory Analytics + Alerts — Feature Dossier

## Executive Summary
This milestone adds enterprise-grade inventory analytics KPIs (shrink, waste, dead stock, expiry risk, reorder health) with an alerts system for proactive inventory management. All analytics are derived from existing data sources (ledger, stocktakes, lots, reorder policies).

---

## Feature Group A: Inventory Analytics KPIs

### A1. Shrink / Variance

| Aspect | InvenTree | Odoo | M11.12 Target |
|--------|-----------|------|---------------|
| Data Source | Stock history + adjustments | Inventory valuation layer | StocktakeSession/Line variance field |
| Value Calculation | Uses cost from StockItem | Uses product cost per valuation method | Use InventoryItem.lastCost or weighted avg from ledger |
| Aggregation | By location/part | By product/warehouse/date | By branch, location, item, time window |
| Export | Yes (CSV) | Yes (Excel) | CSV with hash |

**InvenTree Reference**: Stock adjustments track variance via `StockItemTracking` with quantity delta. Reports aggregate by date range.

**M11.12 Decision**: Query `StocktakeLine.variance` aggregated by item/location/branch. Value = qty × lastCost.

### A2. Waste

| Aspect | InvenTree | Odoo | M11.12 Target |
|--------|-----------|------|---------------|
| Tracking | Manual stock removal | Scrap orders | InventoryLedgerEntry with reason=WASTAGE |
| Top Items | Custom report | BI dashboards | Aggregate by itemId, rank by qty |
| Time Window | Supported | Supported | from/to params |

**M11.12 Decision**: Sum ledger entries where `reason IN ('WASTAGE', 'WASTE')` or `sourceType = 'FAST_WASTE'`.

### A3. Dead Stock

| Aspect | InvenTree | Odoo | M11.12 Target |
|--------|-----------|------|---------------|
| Definition | No movement in N days | No sales in N days | No ledger movement (excluding COUNT_VARIANCE/adjustment) in N days |
| Default N | Configurable | 90 days | 30 days (param) |
| Calculation | Check last transaction date | Stock rotation report | MAX(ledgerEntry.createdAt) < (now - N) AND onHand > 0 |

**InvenTree Reference**: Dead stock calculated via `last_stocktake` and transaction history on `StockItem`.

**M11.12 Decision**: 
- Query items with `onHand > 0`
- Check latest ledger entry per item/branch excluding `COUNT_VARIANCE`, `COUNT_VARIANCE_REVERSAL`
- If `MAX(createdAt) < (now - deadStockDays)` → dead stock

### A4. Expiry Risk

| Aspect | InvenTree | Odoo | M11.12 Target |
|--------|-----------|------|---------------|
| Tracking | StockItem.expiry_date | Lot expiration | InventoryLot.expiryDate |
| Thresholds | Configurable | Alerts module | 7/30/60 days buckets |
| Status Check | Active lots only | Active lots | status = ACTIVE (exclude EXPIRED, CONSUMED, QUARANTINE) |

**M11.12 Decision**:
- Query `InventoryLot WHERE status = ACTIVE AND expiryDate IS NOT NULL`
- Bucket into: expired, ≤7 days, ≤30 days, ≤60 days
- Include count of QUARANTINE lots separately

### A5. Reorder Health

| Aspect | InvenTree | Odoo | M11.12 Target |
|--------|-----------|------|---------------|
| Below Reorder Point | Part.minimum_stock | Reordering rules | InventoryItem.reorderLevel vs calculated onHand |
| Suggestion Status | Via BOM | Purchase quotation draft | ReorderSuggestion → draft PO conversion tracking |

**M11.12 Decision**:
- Query items where `onHand < reorderLevel`
- Count suggestion runs from `ReorderRun` table
- Count suggestions that resulted in draft POs

---

## Feature Group B: Alerts Model + Lifecycle

### Alert Types

| Type | Trigger | Severity Default |
|------|---------|-----------------|
| DEAD_STOCK | Item with no movement > N days | WARN |
| EXPIRY_SOON | Lot expiring within threshold | WARN |
| EXPIRED | Lot past expiry date | CRITICAL |
| BELOW_REORDER_POINT | onHand < reorderLevel | WARN |
| HIGH_WASTE | Waste qty > threshold (optional) | WARN |
| HIGH_VARIANCE | Variance > threshold (optional) | CRITICAL |

### Lifecycle States

```
OPEN → ACKNOWLEDGED → RESOLVED
         ↓
       RESOLVED (direct from OPEN allowed)
```

### Idempotency Policy
- Unique constraint: `(orgId, branchId, type, entityType, entityId, status=OPEN)`
- If details materially change (e.g., expiry date changes), allow new alert
- "Materially changed" = detailsJson hash differs

### InvenTree Reference
InvenTree uses notifications system with triggers for low stock, expiring stock. Stores in `NotificationEntry` with user targeting.

### Odoo Reference  
Odoo has activity/alert framework with scheduling. We avoid timers per project standards.

### M11.12 Decision
Manual trigger via `POST /inventory/alerts/evaluate`. Callable by scheduler externally if needed.

---

## Feature Group C: Exports

| Export | Fields | Ordering |
|--------|--------|----------|
| shrink | branch, location, item, sku, varianceQty, varianceValue, period | branch, item, location |
| waste | branch, item, sku, wasteQty, wasteValue, period | branch, wasteQty DESC |
| dead-stock | branch, item, sku, onHand, lastMovementDate, daysSinceMovement | branch, daysSinceMovement DESC |
| expiry-risk | branch, lotNumber, item, expiryDate, daysToExpiry, qty, status | branch, daysToExpiry ASC |
| alerts | id, type, severity, entityType, entityId, title, status, createdAt | createdAt DESC |

**Hash Standard**: SHA-256 of content with normalized LF (before BOM insertion). Header: `X-Nimbus-Export-Hash`.

---

## Feature Group D: Web UI

### /inventory/analytics
- Dashboard layout with cards/tabs
- Filters: branch (dropdown), date range (from/to)
- Cards: Shrink, Waste, Dead Stock, Expiry Risk, Reorder Health
- Each card: summary stat + "View Details" + "Export CSV"

### /inventory/alerts
- Table with columns: Type, Severity, Entity, Title, Status, Created, Actions
- Filters: status (OPEN/ACKNOWLEDGED/RESOLVED/all), type, branch
- Actions: Acknowledge (button), Resolve (button)
- "Evaluate Alerts" button (L4+ only)

### RBAC
| Role | Analytics View | Exports | Alerts View | Alert Actions |
|------|----------------|---------|-------------|---------------|
| L2_TEAM_MEMBER | ✅ | ❌ | ✅ | ❌ |
| L3_SUPERVISOR | ✅ | ❌ | ✅ | ❌ |
| L4_MANAGER | ✅ | ✅ | ✅ | ✅ |
| L5_ADMIN | ✅ | ✅ | ✅ | ✅ |
| L6_SUPER_ADMIN | ✅ | ✅ | ✅ | ✅ |

---

## Parity Verdict Summary

| Feature | InvenTree | Odoo | M11.12 |
|---------|-----------|------|--------|
| Shrink/Variance reporting | ✅ | ✅ | ✅ |
| Waste aggregation | ~ | ✅ | ✅ |
| Dead stock detection | ✅ | ✅ | ✅ |
| Expiry risk buckets | ✅ | ✅ | ✅ |
| Reorder health | ✅ | ✅ | ✅ |
| Alert model | Notifications | Activities | InventoryAlert |
| Manual trigger (no cron) | ❌ | ❌ | ✅ (project standard) |
| CSV export with hash | ❌ | ❌ | ✅ (enterprise audit) |

**Verdict**: M11.12 achieves feature parity with InvenTree/Odoo analytics capabilities while adding enterprise audit features (hash integrity, explicit RBAC, manual trigger for compliance).
