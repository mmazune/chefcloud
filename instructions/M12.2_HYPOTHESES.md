# M12.2 Hypotheses - Inventory Close Ops v2

## Overview

Hypotheses documented BEFORE code changes to guide testing and prevent known failure modes.

---

## H1: Pre-Close Check Misses Blockers Due to Incorrect Date Overlap Logic

**Confidence:** 70%  
**Category:** A) Pre-Close Check Engine

### Description
The pre-close check queries for blockers (stocktakes, production batches, transfers) may use incorrect date comparison operators, missing items that fall exactly on the boundary or span the period partially.

### Failure Mode
- Stocktake started on `endDate` is missed (uses `< endDate` instead of `<= endDate`)
- Transfer with shipDate exactly at boundary is incorrectly included/excluded
- User closes period with active blockers

### Test Strategy
1. Create stocktake with startedAt = period.endDate exactly
2. Run pre-close check, expect it to be listed as blocker
3. Create transfer with shipDate = period.endDate, expect blocker

### Mitigation
- Use consistent `gte`/`lte` operators for inclusive boundaries
- Document boundary semantics clearly in dossier
- E2E tests for exact boundary conditions

---

## H2: Period Generation Creates Overlapping Periods (Boundary Bug)

**Confidence:** 65%  
**Category:** B) Period Auto-Generation

### Description
Month boundary calculation may create periods that overlap by 1 millisecond or have gaps due to timezone or date-fns calculation errors.

### Failure Mode
- Jan 2024 ends at `2024-01-31T23:59:59.999Z`
- Feb 2024 starts at `2024-02-01T00:00:00.000Z`
- No overlap, but calculation using local time could shift boundaries

### Test Strategy
1. Generate 12 months of periods
2. Assert no period.endDate >= next period.startDate
3. Assert no gaps between consecutive periods (endDate + 1ms = next startDate)

### Mitigation
- Use UTC exclusively in date-fns functions
- Use `endOfMonth` and `startOfMonth` with explicit UTC
- Idempotency check prevents duplicate creation

---

## H3: Reopen Allows Posting Without Proper Audit Trail (Missing Events)

**Confidence:** 60%  
**Category:** C) Reopen Workflow

### Description
Reopen endpoint may succeed but fail to create InventoryPeriodEvent, leaving no audit trail of who reopened and why.

### Failure Mode
- Reopen succeeds (status changes to OPEN)
- Event insertion fails silently (non-transactional)
- Audit trail is incomplete

### Test Strategy
1. Reopen a period as L5 user
2. Query InventoryPeriodEvent for that periodId
3. Assert REOPENED event exists with correct actor and reason

### Mitigation
- Wrap reopen + event creation in single transaction
- Assert event count increases on every reopen
- E2E test: query events after reopen, verify count

---

## H4: Snapshot Revisioning Duplicates/Overwrites Incorrectly (History Loss)

**Confidence:** 75%  
**Category:** C) Reopen Workflow / Revision Strategy

### Description
When a period is reopened and re-closed, the snapshot revision logic may:
- Overwrite existing revision 1 instead of creating revision 2
- Create duplicate snapshots with same revision
- Fail unique constraint

### Failure Mode
- Re-close creates revision 1 again (unique constraint violation)
- Or silently overwrites revision 1 (history lost)

### Test Strategy
1. Close period → generates revision 1 snapshots
2. Reopen period
3. Add/change stock
4. Close period again → should generate revision 2
5. Assert revision 1 and revision 2 both exist
6. Assert exports use revision 2 (latest)

### Mitigation
- Query max(revision) before insert
- Increment revision = maxRevision + 1
- Unique constraint `@@unique([periodId, itemId, locationId, revision])`

---

## H5: Close Pack Bundle Hash Mismatches on Windows (BOM/Newlines/Order)

**Confidence:** 80%  
**Category:** D) Close Pack Export

### Description
Bundle hash computation may differ across platforms due to:
- CRLF vs LF line endings
- BOM inclusion/exclusion in hash input
- Non-deterministic export row ordering

### Failure Mode
- Same period on Windows produces different bundle hash than Linux
- Audit verification fails

### Test Strategy
1. Generate close pack twice on same period
2. Assert bundleHash is identical both times
3. Assert individual hashes are also identical
4. Explicitly check: hash is over LF-normalized, BOM-stripped content

### Mitigation
- Normalize to LF before hashing
- Strip BOM before hashing (apply BOM to final output after hash)
- Sort rows by deterministic key (itemId, locationId)

---

## H6: Cross-Tenant Leakage in Period Queries (Missing orgId Scope)

**Confidence:** 85%  
**Category:** All

### Description
Pre-close check sample IDs or period listings may return data from other orgs if orgId filter is missing from any query.

### Failure Mode
- User from Org A sees sample IDs (stocktake IDs) from Org B
- Period list includes periods from other branches in other orgs

### Test Strategy
1. Create two orgs with periods in same date range
2. Run pre-close check as Org A user
3. Assert no Org B IDs in blockers/warnings
4. List periods as Org A, assert no Org B periods

### Mitigation
- Every query MUST include `where: { orgId }` as first filter
- Sample IDs capped AND scoped
- E2E test with two orgs

---

## H7: UI Allows Close When Blockers Exist (Front-End Gating Bug)

**Confidence:** 60%  
**Category:** E) Web UI

### Description
Close button may be enabled even when pre-close check returns BLOCKED status, allowing user to attempt close.

### Failure Mode
- Pre-close check returns BLOCKED
- UI doesn't disable close button
- User clicks close, gets 400 error

### Test Strategy
1. Mock pre-close check returning BLOCKED
2. Assert close button is disabled
3. Mock READY, assert button is enabled

### Mitigation
- UI state gating based on pre-close status
- Backend should also reject close if blockers exist
- Double defense: UI + backend validation

---

## H8: Tests Hang Due to Leftover Servers/App Not Closed

**Confidence:** 70%  
**Category:** Testing

### Description
E2E tests may hang due to:
- NestJS app not closed properly in afterAll
- Active database connections
- Timers or intervals not cleared

### Failure Mode
- Test suite completes but process doesn't exit
- Requires --forceExit (forbidden)
- Jest reports open handles

### Test Strategy
1. Run E2E with `--detectOpenHandles`
2. Assert no open handles reported
3. Assert exit code 0 without timeout

### Mitigation
- Use `cleanup(app)` helper in afterAll
- Close PrismaService connection explicitly
- No setInterval/setTimeout without clear

---

## H9: Pre-Close Check Performance Degrades with Large Dataset

**Confidence:** 50%  
**Category:** A) Pre-Close Check Engine

### Description
Pre-close check runs multiple queries (stocktakes, transfers, receipts, etc.). With large datasets, this may timeout.

### Failure Mode
- Check takes >30 seconds
- User gives up, closes without check
- Or server times out

### Test Strategy
1. Not directly testable in E2E (would need large seed)
2. Monitor query plans

### Mitigation
- Add indexes on date fields
- Cap sample IDs to 5
- Use COUNT queries, not full selects

---

## H10: Reopen Fails for Non-L5 User But Returns Wrong Error Code

**Confidence:** 55%  
**Category:** C) Reopen Workflow

### Description
L4 user attempting reopen should get 403 Forbidden, but may get 404 or 500 due to guard ordering.

### Failure Mode
- L4 user gets 404 instead of 403
- Leaks information about period existence

### Test Strategy
1. Create period as L5
2. Attempt reopen as L4 user
3. Assert exactly 403 Forbidden

### Mitigation
- Role guard before period lookup
- Consistent error handling

---

## Summary Table

| ID | Hypothesis | Confidence | Feature |
|----|------------|------------|---------|
| H1 | Pre-close misses boundary blockers | 70% | A |
| H2 | Period generation overlap/gap | 65% | B |
| H3 | Reopen missing audit events | 60% | C |
| H4 | Revision overwrite/duplicate | 75% | C |
| H5 | Bundle hash platform mismatch | 80% | D |
| H6 | Cross-tenant leakage | 85% | All |
| H7 | UI allows close with blockers | 60% | E |
| H8 | Tests hang (open handles) | 70% | Testing |
| H9 | Pre-close check timeout | 50% | A |
| H10 | Reopen wrong error code | 55% | C |
