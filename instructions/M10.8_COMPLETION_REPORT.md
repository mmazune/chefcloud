# M10.8 Completion Report

**Milestone:** M10.8  
**Feature:** Payroll GL Posting (Full) + Configurable Mappings  
**Status:** IN PROGRESS  
**Date:** 2026-01-04  
**Baseline Commit:** a302b98

---

## 1. Hypotheses Table

| ID | Hypothesis | Confidence | Failure Mode | Mitigation | Outcome |
|----|-----------|------------|--------------|------------|---------|
| H1 | Posting imbalance due to rounding drift | 60% | Journal debits ≠ credits due to Decimal rounding | Use Prisma.Decimal throughout, round only at line level with HALF_UP_CENTS | PENDING |
| H2 | Idempotency bug creates duplicate journals under retry | 55% | Network retry posts same payroll twice | Check existing journal links before creating; return 409 on duplicate | PENDING |
| H3 | Branch attribution mismatch causes wrong branch financials | 50% | Payroll posted to wrong branch, trial balance incorrect | Use run.branchId for all journal lines, validate on posting | PENDING |
| H4 | Missing mapping fields cause runtime failures | 45% | Org has no PayrollPostingMapping, posting fails cryptically | Validate mapping exists before post, return 400 with clear message | PENDING |
| H5 | RBAC allows non-L5 to post/pay/void | 40% | L4 user can call POST transition | Use @Roles('L5') decorator on mutation endpoints | PENDING |
| H6 | Void reversal leaves orphan journal links | 50% | Reversal entry not linked to PayrollRunJournalLink | Create reversal link with type='REVERSAL', link to original | PENDING |
| H7 | Net pay invariant violated in journal | 55% | Cr Wages Payable ≠ calculated netPay | Assert invariant before posting: net = gross - preTax - taxes - postTax | PENDING |
| H8 | Fiscal period lock bypass | 45% | Posting to locked period allowed | Check FiscalPeriod.status before posting, reject if CLOSED | PENDING |

---

## 2. Implementation Checklist

### Schema
- [ ] PayrollPostingMapping model
- [ ] Migration file

### Services
- [ ] payroll-mapping.service.ts
- [ ] Upgrade payroll-posting.service.ts (full gross-to-net)
- [ ] Preview endpoint logic
- [ ] Void reversal logic

### Controllers
- [ ] payroll-mapping.controller.ts
- [ ] Preview endpoint in payroll-runs.controller.ts

### Web Pages
- [ ] /workforce/payroll-posting (mapping editor)
- [ ] Enhanced payroll-runs/[id] (preview + links)

### Tests
- [ ] E2E: workforce-m108-payroll-gl.e2e-spec.ts
- [ ] UI: m108-payroll-posting.test.tsx

---

## 3. Commands Run

| Command | Timeout | Result |
|---------|---------|--------|
| git status --porcelain | 30s | Clean |
| git rev-parse HEAD | 30s | a302b98 |
| pnpm -C services/api build | 3m | PASS |
| pnpm -C apps/web build | 5m | PASS |

---

## 4. File Changes

*(To be populated after implementation)*

### Created
- instructions/M10.8_PAYROLL_GL_POSTING_DOSSIER.md
- instructions/M10.8_PARITY_REAUDIT.md
- instructions/M10.8_COMPLETION_REPORT.md

### Modified
- TBD

---

## 5. Parity Verdict

| Feature Group | Verdict | Evidence |
|---------------|---------|----------|
| A) Full GL Posting | PENDING | |
| B) Configurable Mapping | PENDING | |
| C) UI | PENDING | |
| D) Tests | PENDING | |

---

## 6. PRE Issues

*(None added for M10.8)*

---

## 7. Final Status

**M10.8 Complete — cumulative XX%**

*(To be updated after all gates pass)*

---

## 8. Gate Summary

| Gate | Status |
|------|--------|
| API lint | PENDING |
| Web lint | PENDING |
| API build | PENDING |
| Web build | PENDING |
| E2E teardown-check | PENDING |
| E2E coverage-check | PENDING |
| E2E strict | PENDING |
| UI tests | PENDING |

---

## 9. Test Counts

- E2E tests: PENDING
- UI tests: PENDING

---

## 10. Commit Info

- SHA: PENDING
