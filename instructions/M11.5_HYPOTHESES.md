# M11.5 Hypotheses â€” Inventory Costing + Valuation + COGS

## Pre-Implementation Risk Assessment

| ID | Hypothesis | Confidence | Failure Mode | Mitigation |
|----|------------|------------|--------------|------------|
| H1 | WAC drift due to rounding each receipt (must round only at report/export) | HIGH | Accumulated rounding errors cause valuation discrepancy | Use Decimal(12,4) end-to-end; round only at export/display boundary; store priorWac/newWac with full precision |
| H2 | Cost layers not org/branch scoped causing cross-tenant leakage | HIGH | Org A sees Org B's cost data; incorrect WAC calculation | Mandatory orgId/branchId on all queries; enforce in service layer; E2E test with multi-org data |
| H3 | Receipt line UOM cost normalization wrong (base conversion bug) | HIGH | unitCost in receipt UOM not converted to base UOM; WAC incorrect | unitCost on GoodsReceiptLineV2 already in base UOM; verify during cost layer creation; document assumption |
| H4 | COGS computed twice due to depletion retry/idempotency failure | HIGH | Double COGS entries inflate cost reports | UNIQUE(depletionId, itemId) on DepletionCostBreakdown; check existing before insert; return idempotent result |
| H5 | Export hash mismatch on Windows due to BOM/newline normalization | MEDIUM | CRLF vs LF causes different hash; repeated exports produce different hashes | Use explicit \n in CSV generation; compute hash before BOM prefix; normalize to LF before hash |
| H6 | Tests hang due to open handles/unclosed app/server | HIGH | Jest --detectOpenHandles shows unclosed connections; CI times out | Proper app.close() in afterAll; no setInterval/setTimeout without cleanup; await all promises before teardown |
| H7 | RBAC allows L2 to view valuation/COGS (privilege escalation) | HIGH | L2 user can access financial data without authorization | Explicit @Roles('L4') on all valuation/COGS endpoints; E2E test verifying 403 for L2/L3 users |
| H8 | Depletion posts before cost layer exists (ordering race) | MEDIUM | Order closes and depletes before first receipt posts cost layer; COGS uses zero WAC | Handle gracefully: if no cost layer exists, use 0 or skip COGS computation; surface in reporting with warning |
| H9 | Valuation double-counts due to branch/location overlap | MEDIUM | Same stock counted at both branch and location level | Clear scoping: branch is mandatory, location is filter; never aggregate both simultaneously |
| H10 | Cost layer created for zero-qty receipt | LOW | Receipt with 0 qty posted creates invalid cost layer | Validate qtyReceived > 0 before creating cost layer; skip with warning if zero |

---

## Validation Approach

### H1: WAC Precision
- E2E test: Post two receipts with fractional costs (1234.5678); verify stored WAC matches formula exactly
- E2E test: Export and verify displayed value rounds correctly (2 decimals) while internal stays precise

### H2: Org/Branch Scoping
- E2E test: Create cost layers in two orgs; query with orgId filter; verify no cross-org data
- E2E test: Create cost layers in two branches; verify WAC computed independently per branch

### H3: UOM Cost Normalization
- E2E test: Receipt with non-base UOM; verify cost layer unitCost matches expected base UOM conversion
- Document: GoodsReceiptLineV2.unitCost is already in receipt UOM; cost layer stores in base UOM

### H4: COGS Idempotency
- E2E test: Trigger depletion twice for same order; assert DepletionCostBreakdown count unchanged
- E2E test: Verify UNIQUE constraint enforced (P2002 error on duplicate insert)

### H5: Export Hash Consistency
- E2E test: Call export twice; assert same X-Nimbus-Export-Hash header
- E2E test: Verify hash computed on normalized LF content

### H6: Test Cleanup
- All tests use proper afterAll with app.close()
- Run with --detectOpenHandles to verify no leaks
- No --forceExit allowed

### H7: RBAC
- E2E test: L2 token calls GET /inventory/valuation/on-hand; assert 403
- E2E test: L4 token calls same endpoint; assert 200

### H8: Missing Cost Layer
- E2E test: Deplete item that has never been received; verify COGS breakdown uses 0 or is skipped
- E2E test: Verify warning/flag in depletion metadata

### H9: Branch/Location Scoping
- E2E test: Valuation by branch returns sum across locations
- E2E test: Valuation by location returns subset only

### H10: Zero Qty Receipt
- E2E test: Post receipt line with qty=0; verify no cost layer created
- E2E test: Verify warning logged but no error thrown
