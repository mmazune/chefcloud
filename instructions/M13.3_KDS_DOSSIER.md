# M13.3 KDS + Kitchen Routing Dossier

## Feature Overview
Kitchen Display System (KDS) with order-to-ticket routing, station-based queue management, lifecycle state machine, and order completion tracking.

## Competitive Analysis

### Toast KDS
- **Ticket States**: NEW → DOING → DONE (3-state simplified)
- **Routing**: Items route to "kitchen" or "bar" based on menu item config
- **Bump**: Single tap to advance state, long-press to recall
- **Completion**: Order auto-completes when all items bumped
- **Void**: Manager-only with PIN

### Square KDS
- **Ticket States**: OPEN → IN_PROGRESS → READY → COMPLETE
- **Routing**: Category-based station assignment
- **Bump**: Swipe gestures for state transitions
- **Completion**: Manual or auto based on setting
- **Void**: Requires void reason, manager approval

### TastyIgniter (Open Source - Adapt Allowed)
- **Ticket States**: pending → accepted → preparing → ready → completed
- **Routing**: Uses "locations" and "areas" with assignment rules
- **Bump**: Button-based UI, supports partial bumps per item
- **Completion**: Order status tracks aggregate ticket status
- **Export**: Basic CSV with order details

## NimbusCloud M13.3 Design

### A) Data Model

| Entity | Key Fields | Notes |
|--------|-----------|-------|
| KdsTicket (existing) | id, orderId, station, status, sentAt, readyAt | Extend with branchId via Order relation |
| KdsTicketLine (NEW) | ticketId, orderItemId, itemNameSnapshot, qty, modifiersSnapshot, status | Per-item tracking |

**Ticket Status Enum (extend existing)**:
- QUEUED → IN_PROGRESS → READY → DONE | VOID

**No KitchenStation table needed**: MenuItem.station already exists with StationTag enum (GRILL, FRYER, BAR, KITCHEN, OTHER).

### B) Routing Rules

| Rule | Behavior |
|------|----------|
| MenuItem.station | Routes to that station (default OTHER) |
| Fallback | If station is OTHER, create ticket on KITCHEN |
| Multi-station order | Create one ticket per unique station |

**Routing Algorithm**:
```
for each orderItem:
  station = menuItem.station ?? 'KITCHEN'
  if station == 'OTHER': station = 'KITCHEN'
  add to stationMap[station]
  
for each station in stationMap:
  create KdsTicket(orderId, station)
  for each itemId in stationMap[station]:
    create KdsTicketLine(ticketId, itemId, snapshot fields)
```

### C) Order Lifecycle

| Order Status | Trigger |
|-------------|---------|
| NEW | Order created (M13.2) |
| SENT | sendToKitchen called (existing) |
| IN_KITCHEN | Any ticket starts |
| READY | All tickets READY |
| SERVED | closeOrder called |
| VOIDED | voidOrder called |

**Ticket Lifecycle State Machine**:
```
QUEUED --(start)--> IN_PROGRESS --(ready)--> READY --(done)--> DONE
    \                     \                    \
     \---(void L4+)--------\---(void L4+)------\---(void L4+)---> VOID
```

### D) API Endpoints

| Endpoint | Method | RBAC | Description |
|----------|--------|------|-------------|
| /kds/board | GET | L2+ | Get tickets by station/status |
| /kds/tickets/:id/start | POST | L2+ | QUEUED → IN_PROGRESS |
| /kds/tickets/:id/ready | POST | L2+ | IN_PROGRESS → READY |
| /kds/tickets/:id/done | POST | L2+ | READY → DONE |
| /kds/tickets/:id/void | POST | L4+ | Any → VOID (reason required) |
| /kds/export/tickets.csv | GET | L4+ | Export with hash |

**Error Codes**:
- INVALID_STATE_TRANSITION
- TICKET_NOT_FOUND
- VOID_REASON_REQUIRED
- STATION_SCOPE_VIOLATION

### E) Web UI

**/kds/[branchId] Page**:
- Station selector dropdown
- 3 columns: QUEUED | IN_PROGRESS | READY
- Ticket cards with:
  - Order number
  - Table (if assigned)
  - Item list with modifiers
  - Time since sent (color-coded by SLA)
- Big buttons: "Start", "Ready", "Done"
- Manual refresh button (no auto-polling to avoid test hangs)

### F) Invariants

1. **Snapshot Integrity**: Ticket lines MUST use M13.2 snapshots, never live menu data
2. **Branch Isolation**: All queries MUST filter by branchId (via Order join)
3. **Idempotency**: Ticket generation must not create duplicates on retry
4. **State Machine**: Enforce valid transitions, reject invalid
5. **Completion Guard**: Order completes only when ALL tickets DONE

### G) Parity Matrix

| Feature | Toast | Square | TastyIgniter | M13.3 |
|---------|-------|--------|-------------|-------|
| Station routing | ✓ | ✓ | ✓ | ✓ MenuItem.station |
| State machine | 3-state | 4-state | 5-state | 4-state (QUEUED→IN_PROGRESS→READY→DONE) |
| Per-item tracking | ✓ | ✓ | ✓ | ✓ KdsTicketLine |
| Manager void | ✓ | ✓ | ✓ | ✓ L4+ only |
| Auto-complete | ✓ | optional | ✓ | ✓ on all DONE |
| Recall | ✓ | ✓ | ✗ | ✓ (existing) |
| SLA colors | ✓ | ✓ | ✗ | ✓ (existing) |
| Export | ✗ | ✗ | ✓ | ✓ CSV + hash |
| Real-time | WebSocket | WebSocket | Polling | WebSocket (existing gateway) |
