# M11.10 Inventory Stocktake v2 - Hypotheses

## Pre-Implementation Hypotheses

These hypotheses must be tested before M11.10 is considered complete.

---

### H1: Blind Count Leaks expectedQty to Counters

**Hypothesis:** When `blindCount=true`, the API exposes `expectedQty` in GET responses to L2/L3 users before the session is SUBMITTED.

**Confidence:** 85% this will happen if not explicitly filtered

**Failure Mode:** Counters can see expected quantities, defeating blind count purpose

**Test Approach:**
1. Create session with `blindCount=true`
2. Start session (snapshot taken)
3. As L3 user, GET session detail
4. Assert `expectedQty` is NOT in response for lines
5. Submit session
6. As L3 user, GET session detail again
7. Assert `expectedQty` IS now visible

---

### H2: Snapshot expectedQty Drifts If Recomputed Later

**Hypothesis:** If `expectedQty` is computed dynamically rather than frozen at start, subsequent stock movements will change the expected qty, causing variance drift.

**Confidence:** 90% this will occur without explicit snapshot

**Failure Mode:** Variance calculations become incorrect; audits unreliable

**Test Approach:**
1. Create and start session (snapshot taken)
2. Record `expectedQty` for an item
3. Simulate stock movement via ledger entry for same item
4. Re-fetch session
5. Assert `expectedQty` is UNCHANGED (frozen snapshot)

---

### H3: POST Not Idempotent → Duplicate Ledger Entries

**Hypothesis:** Calling POST multiple times creates duplicate COUNT_VARIANCE ledger entries.

**Confidence:** 80% if no idempotency check

**Failure Mode:** On-hand becomes incorrect; audit trail corrupted

**Test Approach:**
1. Create, start, count, submit, approve session
2. POST session → assert success + ledger entry count
3. POST same session again
4. Assert response is still success (already posted)
5. Assert ledger entry count is UNCHANGED (no duplicates)

---

### H4: VOID Not Reversing Variances Correctly → On-Hand Drift

**Hypothesis:** VOID creates incorrect reversal entries (wrong qty/sign), leaving on-hand in drifted state.

**Confidence:** 75% if reversal logic has sign error

**Failure Mode:** Inventory on-hand becomes permanently incorrect

**Test Approach:**
1. Record on-hand before stocktake
2. Complete full workflow: create → start → count → submit → approve → post
3. Record on-hand after post (should reflect variance)
4. VOID session
5. Record on-hand after void
6. Assert on-hand equals original value (variances reversed)

---

### H5: Cross-Branch Leakage via locationId Not Org/Branch Scoped

**Hypothesis:** A user can specify a locationId from a different branch and access/modify that location's stocktake data.

**Confidence:** 70% if location validation only checks orgId

**Failure Mode:** Data leakage across branches; security violation

**Test Approach:**
1. Create Branch A with Location A1
2. Create Branch B with Location B1
3. As user of Branch A, attempt to create stocktake with locationId = B1
4. Assert request is REJECTED (location not in user's branch)

---

### H6: Export Hash Mismatch Due to BOM/Newlines on Windows

**Hypothesis:** CSV export hash computed on server doesn't match client-recomputed hash due to BOM or CRLF differences.

**Confidence:** 65% on Windows environments

**Failure Mode:** Integrity verification fails; audit concerns

**Test Approach:**
1. Export stocktakes CSV
2. Capture `X-Nimbus-Export-Hash` from response header
3. Compute SHA256 of response body (with BOM if present)
4. Assert hashes match exactly

---

### H7: RBAC Regression Allows L2 to Approve/Post

**Hypothesis:** RBAC guards don't properly block L2 users from approve/post actions.

**Confidence:** 60% if copy-paste error in role decorators

**Failure Mode:** Unauthorized users can finalize stocktakes

**Test Approach:**
1. Create session, complete through SUBMITTED state
2. As L2 user, attempt POST /stocktakes/:id/approve
3. Assert 403 Forbidden
4. As L2 user, attempt POST /stocktakes/:id/post
5. Assert 403 Forbidden

---

### H8: Tests Hang Due to Unclosed App/Server or Open Handles

**Hypothesis:** E2E tests hang on completion due to unclosed NestJS app, database connections, or timers.

**Confidence:** 55% based on prior issues

**Failure Mode:** CI/CD times out; test suite unusable

**Test Approach:**
1. Run M11.10 E2E tests with `--detectOpenHandles`
2. Assert no open handle warnings
3. Assert tests complete and exit cleanly without `--forceExit`
4. Verify AfterAll cleanup closes app properly

---

## Test Coverage Matrix

| Hypothesis | E2E Test | UI Test | Covered By |
|------------|----------|---------|------------|
| H1 | ✅ | ❌ | Group 3: Blind count API filtering |
| H2 | ✅ | ❌ | Group 2: Snapshot stability |
| H3 | ✅ | ❌ | Group 5: Post idempotency |
| H4 | ✅ | ❌ | Group 6: Void reversal |
| H5 | ✅ | ❌ | Group 7: Cross-branch isolation |
| H6 | ✅ | ❌ | Group 8: Export hash verification |
| H7 | ✅ | ❌ | Group 4: RBAC enforcement |
| H8 | ✅ | ❌ | Test runner exit behavior |

---

## Acceptance Criteria Summary

All hypotheses must have:
- At least 2 assertions in E2E tests, OR
- 1 E2E test + 1 UI smoke test

Tests must:
- Complete without hanging
- Exit cleanly without `--forceExit`
- No open handle warnings
- Pass within timeout constraints
