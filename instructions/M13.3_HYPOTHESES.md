# M13.3 KDS + Kitchen Routing Hypotheses

Written BEFORE code implementation per CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.

## H1: Cross-branch ticket leakage if station/branch filters miss orgId/branchId
- **Confidence**: 85%
- **Risk**: High - data isolation breach
- **Mitigation**: All KDS queries must filter by orgId AND branchId. KdsTicket needs branchId column or join through Order.branchId.
- **Test**: Create tickets in two branches, query one branch, verify isolation.
- **Failure Mode**: User at Branch A sees tickets from Branch B.

## H2: Routing fallback creates tickets with null stationId (data integrity)
- **Confidence**: 75%
- **Risk**: Medium - orphaned tickets with no station
- **Mitigation**: MenuItem.station defaults to 'OTHER'. Ticket creation uses menuItem.station directly. If menu item has no station, use fallback 'KITCHEN'.
- **Test**: Create order with item that has undefined station mapping, verify ticket has valid station.
- **Failure Mode**: Ticket stuck in limbo, invisible on KDS boards.

## H3: Ticket generation duplicates on repeated submit (idempotency failure)
- **Confidence**: 90%
- **Risk**: High - duplicate KDS tickets cause confusion
- **Mitigation**: Add idempotencyKey to KdsTicket OR use orderId+station unique constraint. Check before creating.
- **Test**: Call submit twice on same order, verify same ticket IDs returned, no duplicates.
- **Failure Mode**: Kitchen sees same order twice, prepares double.

## H4: Ticket snapshot uses live menu names (historical drift)
- **Confidence**: 80%
- **Risk**: Medium - ticket shows wrong item name after menu rename
- **Mitigation**: Ticket lines must use itemNameSnapshot from OrderItem (M13.2), not live MenuItem.name.
- **Test**: Create order, rename menu item, verify ticket still shows original name.
- **Failure Mode**: KDS shows "NEW ITEM NAME" instead of what was ordered.

## H5: Invalid state transitions allow DONE from NEW (workflow break)
- **Confidence**: 85%
- **Risk**: Medium - tickets can skip workflow states
- **Mitigation**: Enforce state machine: NEW → IN_PROGRESS → READY → DONE. Only L4+ can void from any state.
- **Test**: Try to mark NEW ticket as DONE, expect INVALID_STATE_TRANSITION error.
- **Failure Mode**: Order marked complete without ever being prepared.

## H6: Export hash mismatch due to BOM/newlines ordering (Windows)
- **Confidence**: 70%
- **Risk**: Low - audit compliance issue
- **Mitigation**: Use UTF-8 BOM prefix, consistent line endings (\n not \r\n), stable sort order by id.
- **Test**: Export twice, compare hashes match. Test on Windows.
- **Failure Mode**: Same data produces different hashes, failing audit trail verification.

## H7: UI introduces polling timers that create open handles in Jest
- **Confidence**: 95%
- **Risk**: Medium - tests hang forever
- **Mitigation**: No automatic polling in React components. Provide manual refresh button. Polling only behind feature flag.
- **Test**: Run E2E tests with --detectOpenHandles, verify no timer warnings.
- **Failure Mode**: Tests timeout, CI blocks.

## H8: Tests hang due to missing app/server cleanup
- **Confidence**: 90%
- **Risk**: Medium - CI pipeline stalls
- **Mitigation**: Use proper beforeAll/afterAll with app.close(). Use withTimeout wrapper per E2E_NO_HANG_STANDARD.
- **Test**: Run test suite twice in a row, verify clean exit both times.
- **Failure Mode**: Second run hangs waiting for first run's resources.

## H9: Order completion race condition when multiple tickets finish simultaneously
- **Confidence**: 65%
- **Risk**: Medium - order might never complete or complete twice
- **Mitigation**: Check all tickets DONE in a transaction, update order atomically. Use Prisma transaction.
- **Test**: Mark two tickets DONE in rapid succession, verify order status updated exactly once.
- **Failure Mode**: Order stays IN_PROGRESS or gets duplicate completion events.

## H10: KDS board shows items from wrong station (filter bug)
- **Confidence**: 70%
- **Risk**: Medium - kitchen sees bar items, bar sees kitchen items
- **Mitigation**: Filter ticket items by station when querying, not just ticket by station.
- **Test**: Create order with KITCHEN and BAR items, verify each board shows only its items.
- **Failure Mode**: Bartender tries to cook steak.

## Summary

| ID | Hypothesis | Confidence | Risk |
|----|-----------|------------|------|
| H1 | Cross-branch leakage | 85% | High |
| H2 | Null stationId | 75% | Medium |
| H3 | Duplicate tickets | 90% | High |
| H4 | Live menu lookup | 80% | Medium |
| H5 | Invalid state machine | 85% | Medium |
| H6 | Export hash mismatch | 70% | Low |
| H7 | Polling timers in tests | 95% | Medium |
| H8 | App cleanup missing | 90% | Medium |
| H9 | Completion race | 65% | Medium |
| H10 | Station filter bug | 70% | Medium |
