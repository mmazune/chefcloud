# M9.5 Reservations: Integrations + Customer Self-Service + Webhooks/ICS + Enterprise Notifications

**Sprint:** M9.5  
**Author:** ChefCloud Engineering  
**Baseline Commit:** d86a107 (M9.4 complete)  
**Date:** 2026-01-03  

---

## Executive Summary

M9.5 delivers enterprise-grade integration capabilities for the reservations module:
- **A) Outbound Webhooks** - Event-driven notifications to external systems
- **B) ICS Calendar Feed** - External calendar integration for reservations
- **C) Enterprise Notifications** - Template-based notifications with delivery tracking
- **D) Customer Self-Service** - Token-based reservation management portal
- **E) Reporting Extensions** - Integration/ops metrics and exports

---

## Scope Breakdown

### A) Outbound Webhooks (Enterprise Integration)

**Events:**
| Event | Trigger Point |
|-------|---------------|
| reservation.created | On new reservation |
| reservation.confirmed | On status → CONFIRMED |
| reservation.cancelled | On status → CANCELLED |
| reservation.no_show | On status → NO_SHOW |
| waitlist.added | On waitlist entry |
| waitlist.promoted | On waitlist → confirmed |
| deposit.required | On deposit created |
| deposit.paid | On deposit status → COLLECTED |
| deposit.refunded | On deposit status → REFUNDED |

**Endpoint Management:**
- CRUD for webhook endpoints (RBAC L4+)
- Fields: url, enabled, eventTypes[], secret, maxRetries, timeoutMs, isBranchScoped, branchId

**Delivery Mechanism:**
- WebhookEventOutbox table with status: PENDING → ATTEMPTED → DELIVERED | FAILED | DEAD_LETTER
- Retry schedule: 1m, 5m, 15m (capped at 3 retries)
- HMAC SHA256 signature header: X-Nimbus-Signature
- Idempotency header: X-Nimbus-Event-Id

### B) ICS Calendar Feed

**Endpoint:** `GET /public/reservations/:branchSlug/calendar.ics?token=...`

**ICS Content:**
- DTSTART/DTEND from reservation times
- SUMMARY: "Reservation: {name} ({partySize} guests)"
- UID: stable per reservation (reservation.id)
- LOCATION: branch name + address
- DESCRIPTION: source, status, deposit status

**Token Scope:** CALENDAR_READ (read-only, non-expiring or long-lived)

### C) Enterprise Notifications

**NotificationTemplate Model:**
- type: SMS | EMAIL | WHATSAPP | PUSH
- event: string (reservation.confirmed, etc.)
- body: string with {{variables}}
- enabled: boolean
- branchId: optional (branch-specific override)

**Variables Supported:**
- {{name}}, {{time}}, {{date}}, {{partySize}}
- {{branch}}, {{depositAmount}}, {{manageUrl}}

**NotificationOutbox:**
- Status tracking: PENDING → SENT | FAILED | RETRYING
- Retry policy: 3 attempts with backoff
- FakeProvider for E2E testing

### D) Customer Self-Service Portal

**Page:** `/manage/reservation/[token]`

**Features:**
- View reservation details (date, time, party size, status)
- Cancel reservation (if policy allows)
- Reschedule reservation (if policy allows)
- View deposit status (required/paid/refunded/forfeited/applied)
- Notification history summary (latest 5)

### E) Reporting Extensions

**New Metrics:**
- Webhook delivery KPIs: delivered/failed/dead-letter counts
- Notification KPIs: sent/failed/retried counts
- CSV export for webhook deliveries and notifications

---

## Acceptance Criteria

| AC | Description | Evidence |
|----|-------------|----------|
| AC-01 | Webhook endpoints CRUD works with RBAC L4+ | POST/GET/PUT/DELETE /integrations/webhooks |
| AC-02 | Events emitted on reservation lifecycle | WebhookEventOutbox records created |
| AC-03 | HMAC signature included and verifiable | X-Nimbus-Signature header |
| AC-04 | Retry logic with status progression | PENDING → ATTEMPTED → DELIVERED/FAILED |
| AC-05 | ICS feed returns valid calendar | GET /public/reservations/:slug/calendar.ics |
| AC-06 | ICS includes correct event details | DTSTART, SUMMARY, UID, LOCATION |
| AC-07 | Notification templates CRUD | POST/GET/PUT/DELETE /integrations/notifications/templates |
| AC-08 | Template preview renders variables | POST /integrations/notifications/templates/preview |
| AC-09 | Self-service page loads with token | /manage/reservation/[token] |
| AC-10 | Self-service cancel works | POST via token |
| AC-11 | Self-service reschedule works | POST via token |
| AC-12 | Integration reporting endpoints | /reservations/reports/webhooks, /notifications |

---

## Technical Design

### Prisma Models (New)

```prisma
model WebhookEndpoint {
  id            String   @id @default(cuid())
  orgId         String
  org           Org      @relation(fields: [orgId], references: [id])
  branchId      String?
  branch        Branch?  @relation(fields: [branchId], references: [id])
  url           String
  secret        String
  eventTypes    String[] // JSON array of event names
  enabled       Boolean  @default(true)
  maxRetries    Int      @default(3)
  timeoutMs     Int      @default(5000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deliveries    WebhookDelivery[]
  @@index([orgId])
  @@index([branchId])
}

model WebhookDelivery {
  id            String   @id @default(cuid())
  endpointId    String
  endpoint      WebhookEndpoint @relation(fields: [endpointId], references: [id])
  eventType     String
  eventId       String   @unique // Idempotency key
  payload       Json
  status        WebhookDeliveryStatus @default(PENDING)
  attempts      Int      @default(0)
  lastAttemptAt DateTime?
  responseCode  Int?
  responseBody  String?  // Truncated
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  @@index([endpointId])
  @@index([status])
  @@index([eventId])
}

enum WebhookDeliveryStatus {
  PENDING
  ATTEMPTED
  DELIVERED
  FAILED
  DEAD_LETTER
}

model NotificationTemplate {
  id        String   @id @default(cuid())
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id])
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  type      NotificationType
  event     String
  subject   String?
  body      String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([orgId, branchId, type, event])
  @@index([orgId])
}

enum NotificationType {
  SMS
  EMAIL
  WHATSAPP
  PUSH
}

model NotificationOutbox {
  id          String   @id @default(cuid())
  orgId       String
  recipientId String?
  type        NotificationType
  event       String
  subject     String?
  body        String
  status      NotificationStatus @default(PENDING)
  attempts    Int      @default(0)
  lastError   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([status])
  @@index([orgId])
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  RETRYING
}
```

### Service Architecture

```
webhook.service.ts
  ├── createEndpoint()
  ├── updateEndpoint()
  ├── deleteEndpoint()
  ├── listEndpoints()
  └── emitEvent(eventType, payload, orgId, branchId?)

webhook-dispatcher.service.ts
  ├── processOutbox()
  ├── deliverWebhook(delivery)
  ├── signPayload(payload, secret)
  └── recordResult(deliveryId, status, response)

ics.service.ts
  ├── generateFeed(branchId, reservations)
  └── formatEvent(reservation)

template-render.service.ts
  ├── render(template, variables)
  └── preview(templateId, sampleData)

notification-dispatcher.service.ts
  ├── processOutbox()
  ├── send(notification)
  └── recordResult()
```

---

## Dependencies

- M9.2: Deposit lifecycle (for deposit events)
- M9.3: Automation runner (for outbox processing)
- M9.4: Access tokens (for calendar feed tokens)

---

## Risks and Mitigations

See M9.5_HYPOTHESES.md for detailed risk analysis.
