# M13.5.3 Hypotheses — POS Payments + KDS Enterprise Stabilization

## Baseline Analysis

**Commit:** 4931759 (M13.5.2 complete)
**Date:** 2026-01-09

### Failure Summary
- `pos-m134-payments.e2e-spec.ts`: 17/27 PASS (10 failing)
- `m1-kds-enterprise.e2e-spec.ts`: 0/7 PASS (7 failing - setup error)

---

## Hypotheses

### H1: Test assertions misaligned with API status codes
**Confidence:** 95%
**Observation:** Several tests expect HTTP 200 for capture/refund operations, but API returns 201 for successful create operations. The API is correct (201 for resource creation), but tests expect 200.
**Failure Modes:** 
- `should capture authorized CARD payment` expects 200, gets 201
- `should allow partial refund` expects 200, gets 201

### H2: Test assertions expect case-insensitive string matching
**Confidence:** 90%
**Observation:** Test expects `message.toContain('insufficient')` but API returns `"Insufficient funds on the card"`. The `toContain` is case-sensitive.
**Failure Modes:**
- `should reject insufficient funds token` expects lowercase "insufficient"

### H3: Cash session duplicate rejection expects HTTP 409, API returns 400
**Confidence:** 95%
**Observation:** Test expects HTTP 409 Conflict for "already open" session, but PosCashSessionsService throws BadRequestException (400).
**Failure Modes:**
- `should reject second OPEN session for same branch`

### H4: Cash session close test uses undefined session ID
**Confidence:** 90%
**Observation:** HTTP log shows `/pos/cash-sessions/undefined/close`, indicating openRes.body.id is undefined. Either the open fails or the response shape is different.
**Failure Modes:**
- `should close session and calculate expected cash`

### H5: Cross-org security tests expect HTTP 404, API returns 400
**Confidence:** 95%
**Observation:** Tests expect 404 for cross-org access, but API throws BadRequestException with "ORDER_NOT_FOUND" message (400).
**Failure Modes:**
- `should reject payment on other org order`
- `should reject capture on other org payment`

### H6: Receipt rejection message mismatch
**Confidence:** 95%
**Observation:** Test expects `message.toContain('not fully paid')` but API returns `"Order requires X cents but only Y cents captured"`.
**Failure Modes:**
- `should reject receipt for unpaid order`

### H7: Void fails for CAPTURED payments, test voids right after CASH auto-capture
**Confidence:** 90%
**Observation:** CASH payments auto-capture, making them CAPTURED immediately. Test tries to void, but void only works on PENDING/AUTHORIZED.
**Failure Modes:**
- `should allow void by L4 user`

### H8: Idempotency returns existing payment but test expects 201 twice
**Confidence:** 80%
**Observation:** Second idempotency request returns existing payment with 200 (idempotent return) or different validation error.
**Failure Modes:**
- `should enforce idempotency on duplicate key`

### H9: KDS enterprise test uses L1 waiter role for /menu/items (requires L2+)
**Confidence:** 99%
**Observation:** The test uses `E2E_USERS.waiter` (L1) to call `/menu/items` which requires `@Roles('L2')`. API returns 400 (actually should be 403), but the response body is an error object, not an array, causing `menuResponse.body.find is not a function`.
**Failure Modes:**
- All 7 KDS enterprise tests fail in beforeAll setup

### H10: Open handle risk after fixes
**Confidence:** 60%
**Observation:** Any async operations (timers, unclosed connections) could cause Jest hangs.
**Mitigation:** Ensure cleanup in afterAll, run with --detectOpenHandles.

---

## Fix Strategy

### Category A: Test assertion alignment (most failures)
Fix tests to match actual API contracts:
1. Change 200 → 201 for capture/refund operations
2. Use case-insensitive matching (`.toLowerCase()` or regex)
3. Fix message substring expectations
4. Change 404 → 400 for cross-org security (API uses BadRequest consistently)
5. Change 409 → 400 for duplicate session rejection

### Category B: Void logic fix
Either:
- Create CARD payment (stays AUTHORIZED) for void test, OR
- Change void to also allow CAPTURED payments, OR  
- Fix test to void an AUTHORIZED (not auto-captured) payment

### Category C: Cash session close test fix
Ensure session ID is captured properly from open response.

### Category D: KDS enterprise fix
Use L2+ role (e.g., `E2E_USERS.manager` or `E2E_USERS.chef`) for menu fetch.

---

## Implementation Priority
1. H9 (KDS) — Single fix unblocks all 7 tests
2. H1-H6 (Test assertions) — Align with API contracts
3. H7 (Void) — Fix test to use AUTHORIZED payment
4. H8 (Idempotency) — Verify behavior and align test
