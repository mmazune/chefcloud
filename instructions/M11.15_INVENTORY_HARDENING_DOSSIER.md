# M11.15: Inventory Enterprise Hardening — Feature Dossier

## Executive Summary

M11.15 makes the Inventory module "release-grade" by enforcing immutable ledger invariants at the ORM layer, adding performance indexes for high-volume queries, introducing a cross-platform inventory regression gate runner, and providing a minimal inventory health report endpoint.

---

## Feature Deliverables

### A) Ledger Immutability Hardening

**Models Affected:**
- `InventoryLedgerEntry` (schema.prisma line 5704)
- `InventoryCostLayer` (schema.prisma line 6328)
- `LotLedgerAllocation` (schema.prisma line 6732)

**Implementation:**
- Prisma middleware blocks `update` and `delete` operations on these models
- Error code: `LEDGER_IMMUTABLE`
- HTTP 403 response when triggered
- Applies to ALL Prisma clients (via `$use()` registration in PrismaService)

**Rationale:**
- These ledger models are append-only audit trails
- Once created, they must NEVER be modified or deleted
- Comments in schema: "NEVER updated after creation"
- Enterprise audit requirements demand immutability

### B) Inventory Performance + Index Hygiene

**Current Indexes (verified):**

`InventoryLedgerEntry`:
```prisma
@@index([orgId, branchId, itemId])
@@index([itemId, locationId])
@@index([sourceType, sourceId])
@@index([createdAt])
```

`InventoryCostLayer`:
```prisma
@@index([orgId, branchId, itemId])
@@index([itemId, effectiveAt])
@@index([sourceType, sourceId])
```

`LotLedgerAllocation`:
```prisma
@@index([lotId])
@@index([ledgerEntryId])
@@index([sourceType, sourceId])
```

**Additional Indexes Needed:**
1. `InventoryLedgerEntry`: `@@index([branchId, createdAt])` — for branch-level time-series queries
2. `LotLedgerAllocation`: `@@index([orgId, sourceType])` — for org-level allocation queries
3. `InventoryItem`: `@@index([orgId, categoryId, isActive])` — for filtered item lists (if not exists)

### C) Inventory Regression Gate (Cross-Platform + No-Hang)

**Implementation:**
- `scripts/inventory-gate-runner.mjs` — Node-based, follows `e2e-gate-runner.mjs` pattern
- Cross-platform: Windows (pnpm.cmd) and Linux (pnpm)
- Per-file timeout: 120s default
- Total budget: 15m default
- GUARDRAIL: Fails on TIMED_OUT/KILLED files

**Test Files Included:**
```
test/e2e/inventory-m111-foundation.e2e-spec.ts
test/e2e/inventory-m112-procurement.e2e-spec.ts
test/e2e/inventory-m113-transfers-waste.e2e-spec.ts
test/e2e/inventory-m114-recipes-depletion.e2e-spec.ts
test/e2e/inventory-m115-costing-valuation-cogs.e2e-spec.ts
test/e2e/inventory-m116-supplier-reorder.e2e-spec.ts
test/e2e/inventory-m117-lots-traceability.e2e-spec.ts
test/e2e/inventory-m118-returns-recall-expiry.e2e-spec.ts
test/e2e/inventory-m119-production.e2e-spec.ts
test/e2e/inventory-m1110-stocktakes.e2e-spec.ts
test/e2e/inventory-m1111-barcodes-fastops.e2e-spec.ts
test/e2e/inventory-m1112-analytics-alerts.e2e-spec.ts
test/m1113-inventory-gl-posting.e2e-spec.ts
test/e2e/inventory-m1114-forecasting-reorder.e2e-spec.ts
test/e2e/inventory-m1115-hardening.e2e-spec.ts (new)
```

**Package.json Scripts:**
```json
"test:e2e:inventory": "node scripts/inventory-gate-runner.mjs"
"test:e2e:inventory:self-check": "node scripts/inventory-gate-runner.mjs --self-check"
```

### D) Minimal Inventory Health Report

**Endpoint:** `GET /inventory/health-report`
**RBAC:** L4+ (Manager+)
**Response Shape:**
```typescript
interface InventoryHealthReport {
  orgId: string;
  generatedAt: string;
  metrics: {
    totalItems: number;
    activeItems: number;
    inactiveItems: number;
    totalLedgerEntries: number;
    totalCostLayers: number;
    totalLotAllocations: number;
    itemsWithNegativeStock: number;
    orphanedLedgerEntries: number;
  };
  health: 'HEALTHY' | 'WARNING' | 'CRITICAL';
  warnings: string[];
}
```

**Health Logic:**
- `CRITICAL`: orphanedLedgerEntries > 0 OR itemsWithNegativeStock > 10
- `WARNING`: itemsWithNegativeStock > 0
- `HEALTHY`: all checks pass

---

## Prior Art & Parity

### InvenTree
- Uses soft-delete for stock entries (not hard immutability)
- Has "stock adjustment" as separate entity
- Dashboard health widgets

### Odoo
- `stock.move` entries are immutable by convention
- Uses reversal entries for corrections
- Has inventory valuation reports

### ChefCloud Approach
- ORM-level enforcement (middleware) — stronger than Odoo
- Matches InvenTree separation of adjustments
- Health report similar to Odoo valuation reports

---

## Files Created/Modified

| File | Action | Description |
|------|--------|-------------|
| `src/common/ledger-immutability.middleware.ts` | CREATE | Prisma middleware for ledger models |
| `src/prisma.service.ts` | MODIFY | Register immutability middleware |
| `packages/db/prisma/schema.prisma` | MODIFY | Add performance indexes |
| `scripts/inventory-gate-runner.mjs` | CREATE | Cross-platform inventory gate runner |
| `src/inventory/inventory-health.service.ts` | CREATE | Health report service |
| `src/inventory/inventory-health.controller.ts` | CREATE | Health report endpoint |
| `src/inventory/inventory.module.ts` | MODIFY | Register health components |
| `test/e2e/inventory-m1115-hardening.e2e-spec.ts` | CREATE | E2E tests for M11.15 |
| `package.json` | MODIFY | Add inventory gate scripts |

---

## Baseline Status (STEP 0)

- **Git:** Branch=main, HEAD=origin/main=`961940201f10169df99e3c8229ae0efa075a5a39` (clean tree)
- **Build:** ✅ `pnpm build` passes
- **Lint:** ✅ 0 errors, 221 warnings (all pre-existing)
- **TypeScript:** ✅ `tsc --noEmit` passes

---

## Success Criteria

1. ✅ `prisma.inventoryLedgerEntry.update()` throws `LEDGER_IMMUTABLE`
2. ✅ `prisma.inventoryLedgerEntry.delete()` throws `LEDGER_IMMUTABLE`
3. ✅ Same for `InventoryCostLayer` and `LotLedgerAllocation`
4. ✅ `pnpm test:e2e:inventory` runs all inventory tests with no hangs
5. ✅ Health report returns 200 with correct shape
6. ✅ No TypeScript errors
7. ✅ No new lint errors
8. ✅ All new E2E tests pass
