# M7.4D Throttle Guard Enhancement

## Objective
Lock `@SkipThrottle()` behavior so it only applies in non-production environments or when `DEMO_VERIFY=true`.

## Solution: Centralized Guard Logic

Rather than adding `@SkipThrottle()` decorators to every controller, we enhanced the `CustomThrottlerGuard` to centrally handle the bypass logic.

### File Modified
`services/api/src/common/custom-throttler.guard.ts`

### Change Summary
Added environment-based throttle bypass at the guard level:

```typescript
/**
 * Skip throttling if:
 * 1. NODE_ENV is not 'production' (development, test)
 * 2. DEMO_VERIFY env var is set to 'true' (demo verification mode)
 */
private readonly skipInDevOrDemo = 
  process.env.NODE_ENV !== 'production' || process.env.DEMO_VERIFY === 'true';

protected async shouldSkip(context: ExecutionContext): Promise<boolean> {
  // Skip all throttling in development or demo verification mode
  if (this.skipInDevOrDemo) {
    return true;
  }
  // ... rest of logic
}
```

## Behavior Matrix

| NODE_ENV | DEMO_VERIFY | Throttling |
|----------|-------------|------------|
| development | - | SKIPPED |
| test | - | SKIPPED |
| production | false/unset | ENFORCED |
| production | true | SKIPPED |

## Benefits

1. **Centralized Logic**: All throttle bypass decisions in one place
2. **No Decorator Pollution**: Controllers don't need `@SkipThrottle()` everywhere
3. **Production Protection**: Throttling is always enforced in production (unless explicitly running demo verification)
4. **Development Experience**: No rate limits during local development
5. **Demo Verification**: Automated tests can run without hitting rate limits when `DEMO_VERIFY=true`

## Existing @SkipThrottle Decorators
The following controllers already have `@SkipThrottle()` decorators which are now redundant in non-production but provide defense-in-depth:

- MeController
- BranchesController  
- PosController
- MenuController
- InventoryController
- AnalyticsController
- ServiceProvidersController
- AuthController (login endpoint)
- HealthController

These can be optionally removed in the future since the guard now handles it centrally, but keeping them provides additional safety.

## Testing
Run the verifier to confirm no 429 errors:
```powershell
cd services/api; npx ts-node ../scripts/verify-role-coverage.ts | tee instructions/M7.4D_ROLE_VERIFY_OUTPUT.txt
```
