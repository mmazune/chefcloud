# M11.12 Hypotheses — Pre-Implementation Risk Analysis

## H1: Alerts Duplication Due to Missing Unique Constraint
**Confidence**: 95%
**Failure Mode**: Multiple identical OPEN alerts created for same entity when evaluate is called repeatedly.
**Mitigation**: Add unique constraint `@@unique([orgId, branchId, type, entityType, entityId, status])` where status = OPEN. Use upsert pattern in evaluate.
**Verification**: E2E test calls evaluate twice, asserts alert count unchanged.

## H2: Dead Stock Calculation Ignores Transfers/Waste → False Positives
**Confidence**: 85%
**Failure Mode**: Items with recent TRANSFER_OUT or WASTAGE marked as dead stock because only considering RECEIVE/SALE.
**Mitigation**: Include ALL ledger entry reasons except COUNT_VARIANCE and COUNT_VARIANCE_REVERSAL in "movement" definition.
**Verification**: E2E seeds item with recent transfer, verifies NOT in dead stock list.

## H3: Shrink Value Calculation Drifts Due to Rounding/Missing Costing
**Confidence**: 75%
**Failure Mode**: varianceValue shows incorrect totals if item has no lastCost or multiple cost layers.
**Mitigation**: Use `item.lastCost ?? Decimal(0)`. Apply rounding to 4 decimals consistently. Document that value is approximate if FIFO/weighted not implemented.
**Verification**: E2E seeds stocktake with known variance, verifies value = qty × lastCost.

## H4: Export Hash Mismatch on Windows Due to BOM/Newlines
**Confidence**: 90%
**Failure Mode**: Hash computed with CRLF doesn't match header (computed with LF), causing audit failures.
**Mitigation**: Normalize to LF before hashing. Insert BOM AFTER hash computation. Use consistent pattern from M11.11.
**Verification**: E2E downloads export, recomputes hash with LF normalization, asserts match.

## H5: Alerts Evaluate Endpoint Heavy Query Abuse
**Confidence**: 80%
**Failure Mode**: Calling evaluate with huge date range or no branch filter causes DB timeout or high load.
**Mitigation**: Require branchId OR limit unbounded queries. Add reasonable limit on items processed (e.g., 1000). Log evaluation time.
**Verification**: Document limits. E2E uses bounded params.

## H6: Tests Hang Due to Open Handles or Unclosed Server
**Confidence**: 95%
**Failure Mode**: E2E tests don't exit cleanly, require --forceExit.
**Mitigation**: Use app.close() in afterAll. Use --detectOpenHandles. Follow E2E_NO_HANG_STANDARD.md patterns.
**Verification**: Run with --detectOpenHandles, no warnings.

## H7: RBAC Allows L2 to Acknowledge/Resolve Alerts
**Confidence**: 90%
**Failure Mode**: Missing @Roles guard on acknowledge/resolve endpoints allows L2 users to change alert status.
**Mitigation**: Add `@Roles('L4_MANAGER', 'L5_ADMIN', 'L6_SUPER_ADMIN')` to acknowledge and resolve endpoints.
**Verification**: E2E test with L2 token attempts acknowledge, expects 403.

## H8: Cross-Branch Leakage in Analytics Queries
**Confidence**: 85%
**Failure Mode**: Omitting branchId in analytics query returns data from all branches including those user shouldn't access.
**Mitigation**: Always include `orgId` in WHERE clause. If branchId omitted, aggregate across branches but only within user's org. Never allow branchId from different org.
**Verification**: E2E creates data in two branches, queries with specific branchId, asserts only that branch's data returned.

---

## Summary Table

| ID | Risk | Confidence | Mitigation |
|----|------|------------|------------|
| H1 | Alert duplication | 95% | Unique constraint + upsert |
| H2 | Dead stock false positives | 85% | Include all movement types |
| H3 | Value rounding drift | 75% | Use lastCost, round to 4dp |
| H4 | Export hash mismatch | 90% | LF normalization before hash |
| H5 | Query abuse | 80% | Require branchId, limit items |
| H6 | Test hangs | 95% | app.close(), detectOpenHandles |
| H7 | RBAC escalation | 90% | @Roles guards |
| H8 | Cross-branch leakage | 85% | Always org-scope |
