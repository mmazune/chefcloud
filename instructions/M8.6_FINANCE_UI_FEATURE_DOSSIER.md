# Feature Dossier: M8.6 Finance UI (Accountant Ops Suite)

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-03  
> **Author:** Copilot  
> **Milestone:** M8.6  

---

## 1. Scope

### 1.1 Feature Summary

M8.6 delivers an enterprise-grade Finance UI for the Accountant Ops Suite, providing full lifecycle management for Accounts Payable (vendor bills), Accounts Receivable (customer invoices), Credit Notes (customer & vendor), Payment Method GL Mappings, and CSV exports. All pages are RBAC-aware, support multi-branch filtering for franchise orgs, and integrate with the M8.2–M8.5 backend APIs.

### 1.2 In Scope

- Vendors: list/create vendor, vendor detail view with bills/payments/outstanding
- Vendor Bills (AP): list with filters, detail with open/void/payment actions, outstanding balance, journal links
- Customers: list/create customer, customer detail view with invoices/receipts/outstanding
- Customer Invoices (AR): list with filters, detail with open/void/receipt actions, outstanding balance, journal links
- Credit Notes: Customer & Vendor tabs, list/detail, open/void/allocate/refund actions
- Payment Method Mapping: CRUD UI for PaymentMethod → GL account mapping
- CSV Exports: Export buttons on accounts, journal, TB, P&L, balance sheet, bills, invoices, credit notes
- Multi-branch filter (for Cafesserie franchise: branch selector + "All branches" mode)
- RBAC: Actions hidden/disabled based on role capabilities
- Error/empty/loading states per UX standards

### 1.3 Out of Scope

- Banking reconciliation (future M8.7)
- Multi-currency (future)
- Budgets vs actuals (placeholder only)
- Dunning/collections workflows

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| apps/web | UI | Finance pages + components |
| apps/web | UI | roleCapabilities nav updates |
| services/api | API | Minor additions if needed (list endpoints, exports) |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| Vendor | READ | List/detail queries |
| VendorBill | READ | List with filters |
| VendorPayment | READ | Payment history |
| Customer | READ | List/detail queries |
| CustomerInvoice | READ | List with filters |
| CustomerReceipt | READ | Receipt history |
| CustomerCreditNote | READ | Credit note lifecycle |
| VendorCreditNote | READ | Credit note lifecycle |
| PaymentMethodMapping | CRUD | GL account mappings |
| JournalEntry | READ | Reference links |

### 1.6 API Endpoints (Already Exist from M8.2-M8.5)

| Method | Path | Description |
|--------|------|-------------|
| POST | /accounting/vendors | Create vendor |
| GET | /accounting/vendors | List vendors |
| POST | /accounting/vendor-bills | Create bill |
| POST | /accounting/vendor-bills/:id/open | Open bill |
| POST | /accounting/vendor-bills/:id/void | Void bill |
| POST | /accounting/vendor-payments | Create payment |
| GET | /accounting/vendor-bills/:id/outstanding | Get outstanding |
| GET | /accounting/ap/aging | AP aging report |
| POST | /accounting/customers | Create customer |
| GET | /accounting/customers | List customers |
| POST | /accounting/customer-invoices | Create invoice |
| POST | /accounting/customer-invoices/:id/open | Open invoice |
| POST | /accounting/customer-invoices/:id/void | Void invoice |
| POST | /accounting/customer-receipts | Create receipt |
| GET | /accounting/customer-invoices/:id/outstanding | Get outstanding |
| GET | /accounting/ar/aging | AR aging report |
| POST | /accounting/credit-notes/customer | Create customer CN |
| GET | /accounting/credit-notes/customer | List customer CNs |
| POST | /accounting/credit-notes/customer/:id/open | Open CN |
| POST | /accounting/credit-notes/customer/:id/void | Void CN |
| POST | /accounting/credit-notes/customer/:id/allocate | Allocate CN |
| POST | /accounting/credit-notes/customer/:id/refund | Refund CN |
| POST | /accounting/credit-notes/vendor | Create vendor CN |
| GET | /accounting/credit-notes/vendor | List vendor CNs |
| POST | /accounting/credit-notes/vendor/:id/open | Open vendor CN |
| POST | /accounting/credit-notes/vendor/:id/void | Void vendor CN |
| POST | /accounting/credit-notes/vendor/:id/allocate | Allocate vendor CN |
| POST | /accounting/credit-notes/vendor/:id/refund | Refund vendor CN |
| GET | /accounting/payment-methods | List payment method mappings |
| POST | /accounting/payment-methods | Create/update mapping |
| GET | /accounting/export/accounts | Export accounts CSV |
| GET | /accounting/export/journal | Export journal CSV |
| GET | /accounting/export/trial-balance | Export TB CSV |

### 1.7 UI Components (New)

| Component | Route | Description |
|-----------|-------|-------------|
| VendorsPage | /finance/vendors | List/create vendors |
| VendorDetailPage | /finance/vendors/[id] | Vendor detail with bills/payments |
| VendorBillsPage | /finance/vendor-bills | List bills with filters |
| VendorBillDetailPage | /finance/vendor-bills/[id] | Bill detail with actions |
| CustomersPage | /finance/customers | List/create customers |
| CustomerDetailPage | /finance/customers/[id] | Customer detail with invoices |
| CustomerInvoicesPage | /finance/customer-invoices | List invoices with filters |
| CustomerInvoiceDetailPage | /finance/customer-invoices/[id] | Invoice detail with actions |
| CreditNotesPage | /finance/credit-notes | Tabbed: customer/vendor CNs |
| PaymentMethodMappingPage | /finance/payment-methods | CRUD for PM→GL mapping |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

- Accountant workspace landing page with KPIs (/workspaces/accountant)
- Chart of Accounts page (/finance/accounts)
- Journal Entries page with create dialog (/finance/journal)
- Fiscal Periods page (/finance/periods)
- Trial Balance, P&L, Balance Sheet pages
- AP/AR Aging pages (basic)
- Backend APIs for all AP/AR/credit note operations (M8.2-M8.5)

### 2.2 Gaps and Limitations

- No Vendors list/detail page
- No Vendor Bills list/detail page with actions
- No Customers list/detail page
- No Customer Invoices list/detail page with actions
- No Credit Notes UI
- No Payment Method Mapping UI
- No CSV export buttons on existing pages
- No multi-branch filter on finance pages
- Existing pages lack loading skeletons and proper empty states

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| M8.1 Role-based navigation | Complete | Uses |
| M8.2 Double-entry accounting | Complete | Uses |
| M8.3 AP/AR GL integration | Complete | Uses |
| M8.4 Partial payments | Complete | Uses |
| M8.5 Credit notes | Complete | Uses |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| bigcapital | Accounting | AGPL-3.0 | STUDY-ONLY | Full AP/AR/GL reference patterns |
| killbill | Billing | Apache-2.0 | ADAPT | Invoice/payment lifecycle patterns |
| appsmith | UI | Apache-2.0 | ADAPT | Table/form/modal patterns |
| tremor | Dashboard | Apache-2.0 | ADAPT | KPI cards, table styling, badges |

### 3.2 Study Notes (from bigcapital - AGPL study only)

**Navigation Information Architecture:**
- Sidebar groups: Sales → Invoices, Receipts, Customers; Purchases → Bills, Payments, Vendors
- Financial Statements separate section
- Settings for chart of accounts and payment methods

**Table Ergonomics:**
- Status filter chips (Draft, Open, Paid, Void)
- Date range picker
- Search by document number, customer/vendor name
- Pagination with configurable page size
- Sortable columns

**Document Lifecycle UX:**
- Draft → Open (validation runs, creates GL entries)
- Open → Paid (via payment/receipt)
- Any non-posted → Void (soft delete, no GL impact)
- Posted → Void creates reversal entries
- Clear status badges with colors

**Allocation/Refund Flows:**
- Credit note shows available balance
- Allocate modal shows eligible invoices/bills
- Amount validation (cannot exceed available or remaining)
- Refund requires payment method selection

**Export UX:**
- Export button in page header
- Downloads CSV with headers
- Shows loading spinner during generation

**Auditability Cues:**
- Posted documents show lock icon
- Journal entry reference links
- Created by / date stamps
- Reversal entries link back to original

**Multi-branch Filters:**
- Branch dropdown in header for franchise orgs
- "All branches" option for org-wide views
- Filter persisted to URL

**Error Handling:**
- Form validation with inline errors
- Toast notifications for actions
- Error boundary with retry option
- Period lock rejection shows clear message

---

## 4. Acceptance Criteria (30 Criteria)

### Vendors (AC-01 to AC-03)
- **AC-01:** Vendors page lists all vendors with search and pagination
- **AC-02:** Create vendor modal validates required fields (name, code)
- **AC-03:** Vendor detail shows bills, payments, and outstanding balance

### Vendor Bills / AP (AC-04 to AC-10)
- **AC-04:** Vendor bills page lists bills with status filter (DRAFT/OPEN/PARTIALLY_PAID/PAID/VOID)
- **AC-05:** Vendor bills page supports vendor filter and date range
- **AC-06:** Bill detail shows line items, total, outstanding balance
- **AC-07:** "Open Bill" action transitions DRAFT→OPEN with period lock validation
- **AC-08:** "Void Bill" action transitions to VOID with confirmation dialog
- **AC-09:** "Create Payment" modal allows partial payment with amount validation
- **AC-10:** Bill detail shows linked journal entries (read-only)

### Customers (AC-11 to AC-13)
- **AC-11:** Customers page lists all customers with search and pagination
- **AC-12:** Create customer modal validates required fields
- **AC-13:** Customer detail shows invoices, receipts, and outstanding balance

### Customer Invoices / AR (AC-14 to AC-20)
- **AC-14:** Customer invoices page lists invoices with status filter
- **AC-15:** Customer invoices page supports customer filter and date range
- **AC-16:** Invoice detail shows line items, total, outstanding balance
- **AC-17:** "Open Invoice" action transitions DRAFT→OPEN with period lock validation
- **AC-18:** "Void Invoice" action transitions to VOID with confirmation dialog
- **AC-19:** "Create Receipt" modal allows partial receipt with amount validation
- **AC-20:** Invoice detail shows linked journal entries

### Credit Notes (AC-21 to AC-26)
- **AC-21:** Credit notes page has tabs for Customer/Vendor credit notes
- **AC-22:** Credit note list shows status, amount, available balance
- **AC-23:** "Open" action transitions DRAFT→OPEN
- **AC-24:** "Void" action transitions to VOID with confirmation
- **AC-25:** "Allocate" modal shows eligible invoices/bills with amount input
- **AC-26:** "Refund" modal requires payment method selection and creates GL entries

### Payment Method Mapping (AC-27 to AC-28)
- **AC-27:** Payment methods page shows CRUD table for PM→GL mappings
- **AC-28:** Validation prevents duplicate mappings and non-existent accounts

### Exports (AC-29)
- **AC-29:** Export CSV buttons on accounts, journal, TB, P&L, balance sheet, bills, invoices, credit notes pages

### Multi-branch & UX (AC-30 to AC-32)
- **AC-30:** Multi-branch orgs show branch selector with "All branches" option
- **AC-31:** All pages show loading skeletons during data fetch
- **AC-32:** All pages show empty state with CTA when no data

### RBAC (AC-33)
- **AC-33:** Action buttons hidden/disabled for roles without permission (non-accountant/owner)

---

## 5. Parity Targets Checklist

| Sub-feature | Reference Pattern | Nimbus Target |
|-------------|-------------------|---------------|
| AP list with status chips | bigcapital Bills index | MEETS |
| AR list with status chips | bigcapital Invoices index | MEETS |
| Document lifecycle UX | bigcapital + killbill | MEETS |
| Partial payment modal | killbill payment flow | MEETS |
| Credit note allocation | bigcapital CN allocation | MEETS |
| Payment method mapping | bigcapital payment settings | MEETS |
| CSV exports | bigcapital export | MEETS |
| Table pagination/sort | appsmith TableWidgetV2 | MEETS |
| Status badges | tremor Badge | MEETS |
| Loading skeletons | tremor patterns | MEETS |
| Empty states | appsmith patterns | MEETS |
| Multi-branch filter | bigcapital branch filter | MEETS |

---

## 6. Data Persistence Traceability

Per DATA_PERSISTENCE_AND_CONSISTENCY_STANDARD.md:

### Finance/Reporting Checks
- [ ] Owner rollups reconcile to branch-level totals → Branch filter respects org scope
- [ ] Accountant reports reconcile to operational events → Journal links on all documents
- [ ] Date-range boundaries consistent → API date params used consistently

### Cross-Role Persistence
- [ ] Vendor bills created by procurement visible to accountant
- [ ] Customer invoices visible across authorized roles
- [ ] Credit note allocations reduce outstanding correctly
- [ ] Payment method mappings org-scoped and consistent

---

## 7. Security & RBAC

- All finance pages wrapped in `<RequireRole minRole={RoleLevel.L4}>` (Accountant level)
- Action buttons check role capabilities before rendering
- API calls use existing JWT auth with org/branch scoping

---

## 8. Testing Requirements

### E2E API Tests (Jest)
- List vendors/customers endpoints
- List vendor bills/invoices with filters
- Open/void bill/invoice lifecycle
- Create partial payment/receipt with period lock rejection
- Credit note open/allocate/refund paths
- Export endpoints return CSV with headers

### E2E UI Tests (Playwright)
- Login as accountant (DEMO_TAPAS)
- Navigate to finance pages
- Verify tables render data or empty state
- Verify export triggers download
- Verify modal opens/closes without crash

---

## 9. Implementation Notes

### File Structure
```
apps/web/src/pages/finance/
├── vendors/
│   ├── index.tsx          # Vendors list
│   └── [id].tsx           # Vendor detail
├── vendor-bills/
│   ├── index.tsx          # Bills list
│   └── [id].tsx           # Bill detail
├── customers/
│   ├── index.tsx          # Customers list
│   └── [id].tsx           # Customer detail
├── customer-invoices/
│   ├── index.tsx          # Invoices list
│   └── [id].tsx           # Invoice detail
├── credit-notes/
│   └── index.tsx          # Tabbed CN page
├── payment-methods/
│   └── index.tsx          # PM mapping CRUD
```

### Shared Components to Create
- `StatusBadge` - Colored badge for document status
- `BranchFilter` - Branch selector dropdown
- `ExportButton` - CSV export with loading state
- `CreatePaymentModal` - Reusable payment/receipt modal
- `ConfirmDialog` - Reusable confirmation modal

---

## 10. Verification Gates

1. `pnpm -C services/api lint` — passes
2. `pnpm -C services/api build` — passes
3. `pnpm -C apps/web lint` — passes
4. `pnpm -C apps/web build` — passes
5. E2E tests pass with E2E_DATASET=ALL
6. Manual smoke test of all new pages

---

## 11. Completion Criteria

- [ ] All 33 acceptance criteria implemented
- [ ] All pages have loading/empty/error states
- [ ] All new E2E tests pass
- [ ] Parity re-audit confirms MEETS/EXCEEDS
- [ ] Committed to main with clean tree
