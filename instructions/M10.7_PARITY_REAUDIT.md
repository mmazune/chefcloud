# M10.7 Parity Re-Audit

**Milestone:** M10.7  
**Date:** 2026-01-04  
**Baseline:** 0d8404e (M10.6 complete)

---

## Reference Analysis

Since this is a domain-specific payroll implementation that must remain jurisdiction-agnostic (no country-specific tax tables), we follow these design patterns:

### Reference Patterns Used

| Pattern Source | License | Usage |
|----------------|---------|-------|
| Clean-room design | N/A | Generic component-based payroll (no external code) |
| Nimbus M10.6 | Internal | Base PayrollRun model, state machine |
| Enterprise payroll best practices | N/A | EARNING → DEDUCTION_PRE → TAX → DEDUCTION_POST ordering |
| Prisma Decimal patterns | MIT | Deterministic decimal handling |

**Note**: No external GPL/AGPL code was referenced. All patterns are derived from standard enterprise payroll accounting principles.

---

## Feature Parity Matrix

| Feature Group | Reference Behavior | Nimbus Target Behavior | Verdict | Evidence |
|---------------|-------------------|----------------------|---------|----------|
| **A1: Component Types** | 5 types: Earning, Pre-tax deduction, Post-tax deduction, Tax withholding, Employer contribution | Enum: EARNING, DEDUCTION_PRE, DEDUCTION_POST, TAX, EMPLOYER_CONTRIB | MEETS | schema.prisma: CompensationComponentType |
| **A2: Calc Methods** | Fixed, percentage-based, per-hour | FIXED, PERCENT_OF_GROSS, PERCENT_OF_EARNINGS_CODE, PER_HOUR | MEETS | schema.prisma: CalcMethod enum |
| **A3: Caps/Bounds** | Min/max caps for components | capMin, capMax Decimal fields | MEETS | CompensationComponent model |
| **A4: Rounding** | Round to cents (half-up) or whole unit | HALF_UP_CENTS, HALF_UP_UNIT enum | MEETS | RoundingRule enum |
| **A5: Branch Override** | Branch-level override of org component | branchId optional on CompensationComponent | MEETS | Branch relation in model |
| **A6: Effective Dates** | Profile start/end dates | startDate required, endDate nullable | MEETS | EmployeeCompensationProfile |
| **B1: Gross Calc** | Sum of earnings | grossEarnings = Σ EARNING components | MEETS | payroll-calculation.service.ts |
| **B2: Pre-tax Deductions** | Reduce taxable, reduce net | preTaxDeductions before tax calc | MEETS | Calculation order enforced |
| **B3: Taxable Wages** | Gross - pre-tax | taxableWages = gross - preTax | MEETS | Invariant check |
| **B4: Tax Withholding** | Percentage with optional caps | TAX type with capMin/capMax | MEETS | Component application |
| **B5: Post-tax Deductions** | Reduce net only | postTaxDeductions after tax calc | MEETS | Calculation order |
| **B6: Net Pay Invariant** | net = gross - preTax - tax - postTax | Enforced with rounding | MEETS | Service validation |
| **B7: Employer Cost** | gross + employer contributions | totalEmployerCost field | MEETS | PayrollRunLine, Payslip |
| **B8: Breakdown Records** | Persisted line-items, not JSON | PayslipLineItem model | MEETS | Relational model |
| **B9: Lock Enforcement** | Closed period blocks changes | PayPeriod status check | MEETS | payroll-run.service.ts |
| **C1: Admin Payslip List** | Filter by run, period, branch, employee | Query params on endpoint | MEETS | payslips.controller.ts |
| **C2: Employee Self-Service** | View own payslips only | JWT userId filter | MEETS | /workforce/me/payslips |
| **C3: Payslip Content** | Full breakdown including hours, components | All fields populated | MEETS | Payslip model |
| **D1: Summary Export** | CSV with run totals | GET /payroll-runs/:id/export/summary | MEETS | payroll-export.service.ts |
| **D2: Payslip Export** | Per-employee per-component CSV | GET /payroll-runs/:id/export/payslips | MEETS | Deterministic ordering |
| **D3: Employer Cost Export** | Accounting reconciliation | GET /payroll-runs/:id/export/employer-cost | MEETS | Separate export endpoint |
| **E1: GL Employer Contrib** | Dr Employer Tax Expense / Cr Employer Tax Payable | — | DEFERRED | Requires additional GL account config |
| **E2: GL Tax Liability** | Dr Wages Payable / Cr Taxes Payable | — | DEFERRED | Requires tax liability account structure |

---

## Verdicts Summary

| Feature Group | Verdict | Notes |
|---------------|---------|-------|
| A) Compensation Components | **MEETS** | Full component type coverage, calc methods, caps, rounding |
| B) Gross-to-Net Calculation | **MEETS** | Deterministic with enforced invariants |
| C) Payslips | **MEETS** | Admin + self-service with RBAC |
| D) Exports | **MEETS** | Three export types with deterministic ordering |
| E) GL Posting Enhancement | **DEFERRED** | Stubs provided, requires future GL account expansion |

---

## Deferred Items Rationale

### E) GL Posting Enhancement

**Current State (M10.6)**:
- On POSTED: Dr Labor Expense (6000) / Cr Wages Payable (2105)
- On PAID: Dr Wages Payable (2105) / Cr Cash (1000)

**Required for Full Implementation**:
1. GL accounts for employer tax expense (e.g., 6010)
2. GL accounts for employer tax payable (e.g., 2110)
3. GL accounts for tax withholding payable (e.g., 2115)
4. Configuration UI for org-level account mapping
5. Jurisdiction-specific posting rules

**Decision**: Defer to M10.8 or dedicated GL Enhancement milestone

**Stub Location**: `services/api/src/workforce/payroll-gl-stub.service.ts`

---

## Validation Checkpoints

- [ ] All MEETS items have corresponding code paths
- [ ] DEFERRED items have documented stubs
- [ ] No external GPL/AGPL code referenced
- [ ] Clean-room implementation verified
