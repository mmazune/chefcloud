# Feature Dossier: M10.10 Remittance Automation + Provider Directory

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-04  
> **Author:** AI Agent  
> **Milestone:** M10.10  

---

## 1. Scope

### 1.1 Feature Summary

M10.10 extends M10.9 remittances with operational automation: auto-generation from payroll runs, provider/payee directory with component mapping, reconciliation metadata (settlement proof), and enhanced exports. This makes remittances operationally "real" for finance teams.

### 1.2 In Scope

- Remittance Provider directory (CRUD + RBAC L4+)
- Component → Provider mapping (CRUD + RBAC L4+)
- Generate remittance batch from payroll runs (idempotent)
- Reconciliation metadata (externalReference, settledAt, settlementMethod, receiptNote)
- Mark settled endpoint (L5 only)
- Enhanced exports (batches, lines, bank upload stub)
- Web UI for providers, mappings, generate wizard, mark settled
- Period lock enforcement (finalize from M10.9)

### 1.3 Out of Scope

- External bank API integrations (ACH/SEPA/Mobile Money)
- Automatic payment execution
- Multi-currency conversions within single batch
- Scheduled/recurring remittance generation

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| services/api/src/workforce | API | remittance-provider.service, remittance.service extensions |
| apps/web/src/pages/workforce | UI | providers, mappings pages, enhanced remittances |
| packages/db/prisma | Schema | RemittanceProvider, CompensationRemittanceMapping, batch fields |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| remittance_providers | CREATE | Provider directory entity |
| compensation_remittance_mappings | CREATE | Component → provider mapping |
| remittance_batches | ALTER | Add reconciliation fields |
| remittance_source_links | CREATE | Link batches to payroll runs (duplicate prevention) |

### 1.6 API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /workforce/remittance-providers | List providers |
| POST | /workforce/remittance-providers | Create provider |
| GET | /workforce/remittance-providers/:id | Get provider |
| PATCH | /workforce/remittance-providers/:id | Update provider |
| DELETE | /workforce/remittance-providers/:id | Delete provider |
| GET | /workforce/remittance-mappings | List component mappings |
| POST | /workforce/remittance-mappings | Create mapping |
| DELETE | /workforce/remittance-mappings/:id | Delete mapping |
| POST | /workforce/remittances/generate | Generate batch from payroll runs |
| POST | /workforce/remittances/:id/mark-settled | Mark batch as settled (L5) |
| GET | /workforce/reports/export/remittances-bank-upload | Bank upload stub CSV |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| RemittanceProviderList | /workforce/remittance-providers | Provider directory |
| RemittanceMappings | /workforce/remittance-mappings | Component mappings |
| GenerateDialog | (modal) | Generate batch from payroll |
| MarkSettledDialog | (modal) | Reconciliation form |

---

## 2. Current Nimbus State

### 2.1 What Exists Today (M10.9)

- RemittanceBatch with state machine (DRAFT→APPROVED→POSTED→PAID→VOID)
- RemittanceLine with liability/counter accounts
- Journal creation on PAID, reversal on VOID
- Manual batch creation via UI
- Period lock check on pay transition
- KPI and export endpoints

### 2.2 Gaps and Limitations

- No automated generation from payroll runs
- No provider directory (payees are free-text)
- No mapping from compensation components to remittance providers
- No reconciliation metadata (settlement reference, method)
- Duplicate prevention for repeated generate calls not enforced

---

## 3. Reference Architecture Comparison

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| Kill Bill | Billing/Payments | Apache 2.0 | ADAPT | Idempotency patterns, payment lifecycle |
| Apache OFBiz | ERP/Accounting | Apache 2.0 | ADAPT | Accounts payable workflows |

### 3.2 Feature Parity Matrix

| Feature | Kill Bill | OFBiz | Nimbus M10.10 |
|---------|-----------|-------|---------------|
| **Provider/Payee Directory** | PartyContactMechanism | Vendor/Party | RemittanceProvider |
| **Component Mapping** | Subscription→Product | InvoiceItem→Party | CompensationRemittanceMapping |
| **Idempotent Generation** | Plugin-based key | N/A | Deterministic key from inputs |
| **Reconciliation Metadata** | PaymentAttempt history | PaymentApplication | externalReference, settledAt, method |
| **Duplicate Prevention** | Transaction history | Invoice→Payment links | RemittanceSourceLink |
| **Exports** | Custom plugins | CSV/PDF | CSV batches, lines, bank stub |

### 3.3 Design Decisions

**D1: Provider Scope**
- Providers can be org-wide or branch-scoped (nullable branchId)
- Branch-scoped providers only visible to that branch

**D2: Mapping Model**
- Separate CompensationRemittanceMapping table (componentId → providerId + type)
- Allows flexible component reuse without schema churn

**D3: Idempotency Key for Generation**
- Deterministic: hash of (orgId, branchId, sorted payrollRunIds, type)
- Returns existing batch if key exists (200 with idempotentHit: true)

**D4: Reconciliation Flow**
- mark-settled endpoint sets externalReference + settledAt + method
- Does NOT auto-transition status (batch must already be PAID)
- Separate from pay transition to allow settlement proof after payment

---

## 4. Acceptance Criteria

| ID | Criterion | Test Strategy |
|----|-----------|---------------|
| AC-01 | Provider CRUD with RBAC (L4+) | E2E: create, list, update, delete; L3 gets 403 |
| AC-02 | Component → provider mapping CRUD with RBAC | E2E: create, list, delete mapping |
| AC-03 | Generate remittance batch from payroll runs (idempotent) | E2E: call twice, second returns idempotentHit: true |
| AC-04 | Generated line totals use Decimal (no drift) | E2E: compare payroll totals to batch totals |
| AC-05 | Duplicate prevention across repeated generate calls | E2E: second call returns existing batch ID |
| AC-06 | Period lock blocks settlement journal (403) | E2E: lock period, attempt pay, expect 403 |
| AC-07 | Mark settled stores reconciliation metadata (L5 only) | E2E: mark-settled with reference, verify fields |
| AC-08 | Exports return valid CSV with headers and rows | E2E: check content-type, headers, row count |
| AC-09 | Multi-branch: branch-scoped providers isolated | E2E: branch A provider not visible on branch B |
| AC-10 | E2E strict runner completes without hanging | CI gate |

---

## 5. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Idempotency key collision | Medium | High | Use hash of sorted inputs |
| Decimal drift in totals | Low | High | Use Prisma.Decimal throughout |
| Provider branch leakage | Medium | Medium | Filter by orgId + branchId in queries |
| RBAC bypass for mark-settled | Low | High | Explicit @Roles('L5') decorator |
| Export memory issues | Low | Medium | Stream CSV for large exports |

---

## 6. Implementation Plan

### Phase 1: Schema + Migration
- RemittanceProvider, CompensationRemittanceMapping, RemittanceSourceLink
- Add reconciliation fields to RemittanceBatch

### Phase 2: Provider + Mapping Services
- CRUD with RBAC

### Phase 3: Generation Service
- Idempotent generation from payroll runs
- Deterministic key calculation
- Source link tracking

### Phase 4: Reconciliation + Exports
- mark-settled endpoint
- Enhanced exports

### Phase 5: Web UI
- Provider pages
- Mapping pages
- Generate wizard
- Mark settled dialog

### Phase 6: E2E Tests
- All acceptance criteria covered
