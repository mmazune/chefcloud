# M0.2 Completion Report — Feature-Level Comparison Workflow & Clean-Room Protocol

> **Completed:** 2026-01-02  
> **Milestone:** M0.2 (cumulative 4%)  
> **Author:** Nimbus Team

---

## Objective

Create a "feature-by-feature comparison + clean-room implementation" SOP that can be included in future prompts to reliably produce enterprise-grade implementations with expanding E2E coverage.

---

## Deliverables

### ✅ 1. FEATURE_LEVEL_COMPARISON_WORKFLOW.md

**Location:** [instructions/FEATURE_LEVEL_COMPARISON_WORKFLOW.md](./FEATURE_LEVEL_COMPARISON_WORKFLOW.md)

**Content:**
- 6-step workflow diagram (Selection → References → Dossier → Implementation → E2E → Verification)
- Step-by-step procedures with examples
- License tag system (ADAPT / STUDY-ONLY / DO-NOT-USE)
- Integration with MANIFEST.json
- Verification gates (pnpm lint, test, test:e2e:gate)
- Checklist for future prompts

### ✅ 2. CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md

**Location:** [instructions/CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md](./CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md)

**Content:**
- License classification table (MIT, Apache, GPL, AGPL, etc.)
- Permissive license workflow (ADAPT with attribution)
- Copyleft license workflow (STUDY-ONLY, 4-phase clean-room)
  - Phase 1: Study (reference open)
  - Phase 2: Isolation (reference closed)
  - Phase 3: Implementation (from notes)
  - Phase 4: Review (different person)
- DO / DON'T quick reference table
- Rollback policy with severity levels
- Declaration templates for both license types

### ✅ 3. FEATURE_DOSSIER_TEMPLATE.md

**Location:** [instructions/FEATURE_DOSSIER_TEMPLATE.md](./FEATURE_DOSSIER_TEMPLATE.md)

**Content:**
13 sections covering:
1. Scope (in/out, modules, tables, endpoints, UI)
2. Current Nimbus State
3. Reference Repos (with license tags)
4. Domain Invariants (business rules, state machines)
5. Data Model (Prisma schema, relationships)
6. UX Requirements (user stories, flows)
7. Failure Modes (error scenarios, rollback)
8. Security Considerations (auth, validation, audit)
9. Acceptance Criteria (testable requirements)
10. E2E Expansions (test count, datasets)
11. Verification Gates
12. Implementation Notes
13. Verification Record (sign-off)

### ✅ 4. E2E_EXPANSION_CONTRACT.md

**Location:** [instructions/E2E_EXPANSION_CONTRACT.md](./E2E_EXPANSION_CONTRACT.md)

**Content:**
- Minimum test count formula: `(AC × 2) + (Errors × 1)`
- Dataset requirements (DEMO_EMPTY, DEMO_TAPAS, DEMO_CAFESSERIE_FRANCHISE)
- Mandatory dataset declaration in test files
- Timeout limits (30s per test, 15min total)
- Fail-fast configuration
- Test structure template
- Deterministic testing rules (idempotency)
- Anti-patterns to avoid
- Gate commands (`pnpm test:e2e:gate`)

### ✅ 5. Updated OPEN_SOURCE_REFERENCE_WORKFLOW.md

**Location:** [OPEN_SOURCE_REFERENCE_WORKFLOW.md](../OPEN_SOURCE_REFERENCE_WORKFLOW.md)

**Changes:**
- Added "Feature-Level Workflow (M0.2)" section at line 9
- Links to all 4 new documents
- Quick start guide for feature implementation

### ✅ 6. Updated OPEN_SOURCE_POS_COMPARISON_MATRIX.md

**Location:** [OPEN_SOURCE_POS_COMPARISON_MATRIX.md](../OPEN_SOURCE_POS_COMPARISON_MATRIX.md)

**Changes:**
- Added "Feature-Level Reference Repos (M0.1)" section at line 11
- Summary table of 18 repos by domain
- Links to detailed documentation

---

## Directory Structure Created

```
instructions/
├── FEATURE_LEVEL_COMPARISON_WORKFLOW.md    ← NEW
├── CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md   ← NEW
├── FEATURE_DOSSIER_TEMPLATE.md             ← NEW
├── E2E_EXPANSION_CONTRACT.md               ← NEW
├── REFERENCE_FEATURE_REPOS_OVERVIEW.md     (from M0.1)
├── REFERENCE_FEATURE_SIDE_BY_SIDE_INDEX.md (from M0.1)
├── feature-dossiers/                       ← NEW (empty, for future dossiers)
└── reference-feature-maps/                 (from M0.1)
    └── *.md                                (18 MAP files)
```

---

## Verification Gates

| Gate | Command | Result |
|------|---------|--------|
| Git status | `timeout 30s git status --porcelain` | ✅ Shows new files |
| File 1 exists | `test -f instructions/FEATURE_LEVEL_COMPARISON_WORKFLOW.md` | ✅ PASS |
| File 2 exists | `test -f instructions/CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md` | ✅ PASS |
| File 3 exists | `test -f instructions/FEATURE_DOSSIER_TEMPLATE.md` | ✅ PASS |
| File 4 exists | `test -f instructions/E2E_EXPANSION_CONTRACT.md` | ✅ PASS |
| Workflow updated | `grep -n "Feature-Level Workflow" OPEN_SOURCE_REFERENCE_WORKFLOW.md` | ✅ Line 9 |
| Matrix updated | `grep -n "Feature-Level Reference Repos" OPEN_SOURCE_POS_COMPARISON_MATRIX.md` | ✅ Line 11 |
| MANIFEST valid | `node -e "require('./reference-feature-repos/MANIFEST.json')"` | ✅ 18 repos |

---

## Hypotheses Validated

| ID | Hypothesis | Validation |
|----|------------|------------|
| H1 | Without standardized dossier format, clean-room implementation becomes inconsistent | ✅ FEATURE_DOSSIER_TEMPLATE.md provides 13-section structure |
| H2 | License constraints require explicit "adapt vs study-only" decision per feature | ✅ CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md defines ADAPT/STUDY-ONLY/DO-NOT-USE tags |
| H3 | E2E coverage must be tied directly to feature acceptance criteria | ✅ E2E_EXPANSION_CONTRACT.md requires ≥2 tests per AC with dataset declaration |

---

## Usage in Future Prompts

Add this preamble to any feature implementation prompt:

```markdown
## Prerequisites
Before implementing this feature, follow:
1. [FEATURE_LEVEL_COMPARISON_WORKFLOW.md](instructions/FEATURE_LEVEL_COMPARISON_WORKFLOW.md)
2. [CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md](instructions/CLEAN_ROOM_IMPLEMENTATION_PROTOCOL.md)
3. Create dossier using [FEATURE_DOSSIER_TEMPLATE.md](instructions/FEATURE_DOSSIER_TEMPLATE.md)
4. Expand E2E per [E2E_EXPANSION_CONTRACT.md](instructions/E2E_EXPANSION_CONTRACT.md)
```

---

## Next Steps

| Priority | Task | Notes |
|----------|------|-------|
| P1 | First dossier pilot | Create dossier for next feature to validate template |
| P2 | Team training | Review clean-room protocol with all contributors |
| P3 | CI integration | Add dossier existence check to PR workflow |

---

## Summary

**M0.2 complete — cumulative 4%**

All 6 deliverables created and verified:
- 4 new instruction documents
- 2 updated existing documents
- 1 new directory (feature-dossiers/)
- All verification gates passed
