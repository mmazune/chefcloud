# M13.1 Menu Foundation - Hypotheses

## Pre-Implementation Hypotheses (BEFORE Code Changes)

| ID | Hypothesis | Confidence | Failure Mode | Mitigation |
|----|------------|------------|--------------|------------|
| H1 | Cross-org leakage via item/category queries missing orgId filters | HIGH (85%) | Service queries use branchId but don't validate branch.orgId matches user.orgId, allowing cross-tenant data access | Add orgId filter to all queries; validate branch ownership in service layer |
| H2 | Modifier selection constraints not enforced (min/max) | HIGH (80%) | ModifierGroup has min/max but nothing validates at order creation time; invalid orders can be created | Add validation in order creation service; return error if modifier count violates group rules |
| H3 | Availability evaluation wrong due to timezone/HH:MM parsing | MEDIUM (70%) | Branch timezone not considered when evaluating "isAvailable" against HH:MM rules; 18:00 in branch timezone treated as UTC | Store/evaluate times relative to branch timezone; use proper date-fns-tz or similar |
| H4 | Rule precedence bug (category vs item override) | MEDIUM (65%) | When item has availability rule AND its category has rule, unclear which wins; could show item as available when it shouldn't be | Document and implement: item rules override category rules (more specific wins) |
| H5 | Export hash mismatch on Windows due to BOM/newlines | HIGH (90%) | CSV export uses CRLF on Windows but hash computed with LF; X-Nimbus-Export-Hash won't match client-computed hash | Normalize to LF before hashing; use consistent newline handling |
| H6 | Route ordering shadows static paths under :id | HIGH (95%) | Express routes like `/items/:id` match before `/items/available`, causing 404 or wrong handler | Order routes: specific paths before parameter paths |
| H7 | RBAC escalation (L2 can write) | MEDIUM (60%) | Roles decorator misconfigured allowing L2 users to POST/PATCH menu data | Test RBAC explicitly; verify L2 gets 403 on write endpoints |
| H8 | Tests hang due to unclosed app/server | HIGH (90%) | E2E tests don't properly close NestJS app, causing Jest to hang | Use cleanup() helper; wrap with withTimeout; no --forceExit needed |
| H9 | sortOrder not enforced on create/update | MEDIUM (70%) | New items/categories created without sortOrder get 0, causing arbitrary ordering | Auto-assign max(sortOrder)+1 on create if not provided |
| H10 | SKU uniqueness not org-scoped | HIGH (85%) | SKU unique constraint applied globally instead of per-org; org A can't use same SKU as org B | Add @@unique([orgId, sku]) or validate in service layer |

## Verification Plan

Each hypothesis will be tested during E2E test development:
- H1, H7: RBAC tests with cross-org access attempts
- H2: Order creation tests with invalid modifier counts (deferred to M13.2)
- H3, H4: Availability tests with timezone scenarios
- H5: Export tests comparing hash on content
- H6: Route tests hitting `/items/available` before `/items/:id`
- H8: Test teardown verification
- H9, H10: CRUD tests with sortOrder and SKU validation
