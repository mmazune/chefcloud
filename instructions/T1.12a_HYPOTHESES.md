# T1.12a — Hypotheses for E2E Seed/Setup Fix

**Date:** 2025-12-29  
**Context:** E2E setup fails with "users.jobRole does not exist in the current database"

---

## Evidence Gathered (STEP 0)

### Schema Investigation
```bash
$ grep -n "jobRole" packages/db/prisma/schema.prisma
375:  jobRole        JobRole? // M8.1: Job role for role-specific UX
```
✅ **jobRole exists in schema.prisma (line 375)**

### Migration Investigation
```bash
$ grep -r "jobRole" packages/db/prisma/migrations/
# No results
```
❌ **No migration contains jobRole**

### Seed Investigation
```bash
$ grep -n "jobRole" services/api/prisma/seed.ts
# No results
```
✅ **Seed doesn't explicitly reference jobRole** (but Prisma Client types include it)

### Database Status
```bash
$ npx prisma migrate status
Database schema is up to date!
```
⚠️ **Migrations say "up to date" but column doesn't exist**

### Error Details
```
Invalid `prisma.user.upsert()` invocation
The column `users.jobRole` does not exist in the current database.
```

---

## H1: jobRole added to schema without migration (95% confidence) ✅ **PRIMARY CAUSE**

### Evidence
1. **schema.prisma contains jobRole** (line 375, added in M8.1 comment)
2. **No migration file contains "jobRole" or "job_role"** (searched all 68 migrations)
3. **Prisma Client generated** with jobRole in User type (includes it in upsert operations)
4. **Database rejects writes** because column doesn't physically exist

### Pattern Analysis
```typescript
// When Prisma Client generates types from schema.prisma:
interface User {
  // ...
  jobRole?: JobRole; // ← This field is in the generated types
}

// When seed calls:
await prisma.user.upsert({
  where: { email: 'admin@demo.local' },
  update: { /* ... */ },
  create: { /* implicitly includes ALL fields from User type */ }
});

// Prisma tries to INSERT/UPDATE jobRole column → DB error
```

### Smallest Experiment
```bash
# Check if creating migration fixes it:
cd packages/db
timeout 30s npx prisma migrate dev --name add_missing_jobrole_column --create-only
# Inspect generated migration.sql - should contain ALTER TABLE users ADD COLUMN jobRole
```

### Confirmation Method
- If migration adds `ALTER TABLE users ADD COLUMN "jobRole" ...`: H1 is confirmed
- If no changes detected: jobRole was added but later removed (check git history)

---

## H2: Migrations not deployed to test DB (20% confidence) ❌ **DENIED**

### Evidence
```bash
$ export $(cat .env.e2e | xargs) && npx prisma migrate status
Database schema is up to date!
```
✅ **Migrate status says "up to date"** for chefcloud_test database

### Why This Seemed Plausible
- Error says "column doesn't exist"
- Could mean migrations weren't applied
- Setup script runs `migrate deploy` but maybe it's skipped

### Why It's Actually Wrong
- Migrations ARE applied (status confirms)
- The issue is no migration exists for jobRole
- It's a schema→migration drift, not a migration→DB drift

### Smallest Experiment
```bash
# Force re-deploy all migrations:
timeout 2m npx prisma migrate reset --force --skip-seed
timeout 2m npx prisma migrate deploy
# Then check if jobRole column exists
```

### Expected Outcome
- Migration deploy succeeds
- Column STILL doesn't exist (because no migration adds it)
- Confirms H1, denies H2

---

## H3: Seed references outdated field names (30% confidence) ⚠️ **PARTIAL**

### Evidence
- Seed failed with jobRole error
- But seed.ts doesn't explicitly mention jobRole
- Prisma Client implicitly includes all schema fields in operations

### Pattern Analysis
```typescript
// Seed doesn't say:
create: { jobRole: 'CHEF' } // ← Not in seed.ts

// But Prisma Client DOES include it via type completion:
const user = await prisma.user.upsert({
  where: { email },
  create: {
    email,
    // ... TypeScript suggests jobRole because it's in schema
  }
});
```

### Why It's Partially True
- Seed uses Prisma Client types
- Those types include jobRole (from schema.prisma)
- When upsert happens, Prisma tries to write NULL for unspecified optional fields
- DB rejects because column doesn't exist

### Smallest Experiment
```bash
# Check Prisma Client generated types:
timeout 30s grep -A 5 "export type User" node_modules/.pnpm/@prisma+client*/node_modules/@prisma/client/index.d.ts | head -50
# Look for jobRole in User interface
```

### Confirmation Method
- If jobRole is in generated User type: Confirms Prisma Client includes it
- Seed doesn't need to explicitly reference it for the error to occur

---

## H4: Tests fail fast gate missing (50% confidence) ✅ **CONTRIBUTING FACTOR**

### Evidence
- When seed fails, tests still run
- Tests wait for data that never arrives
- Timeout after 120s per file (12 files × 120s = 24 minutes wasted)

### Why This Matters
Even if we fix jobRole, we need a fail-fast mechanism:
1. **If seed fails**: Tests should NOT run (exit immediately with error)
2. **If seed succeeds but data incomplete**: Verify before tests run
3. **If seed is stale**: Detect and re-run setup

### Smallest Experiment
```bash
# Manually break seed, then run tests:
cd services/api
timeout 30s pnpm test:e2e:setup || echo "SETUP FAILED"
timeout 3m pnpm test:e2e -- --runTestsByPath test/a3-pos.e2e-spec.ts --runInBand
# Observe: Do tests run even when setup failed?
```

### Expected Behavior
- **Current**: Setup fails, but tests run anyway and timeout waiting for data
- **Desired**: Setup fails → tests DON'T run → clear error message

### Fix Strategy
1. Add verification script after seed
2. Matrix/CI runners check setup exit code
3. Fail immediately if setup !== 0

---

## HYPOTHESIS RANKING

| Hypothesis | Confidence | Ease of Fix | Evidence | Priority |
|------------|-----------|-------------|----------|----------|
| **H1: jobRole schema drift** | 95% | **EASY** (create migration) | Schema has field, no migration exists | **1** |
| **H4: Missing fail-fast gate** | 50% | MEDIUM (add verification) | Tests run despite setup failures | **2** |
| **H3: Implicit Prisma types** | 30% | N/A (consequence of H1) | Prisma Client includes all schema fields | **3** |
| **H2: Migrations not deployed** | 20% | N/A (already deployed) | Status says "up to date" | **4 (DENIED)** |

---

## RECOMMENDED FIX SEQUENCE

### Phase 1: Fix Schema Drift (H1) - CRITICAL
1. Create migration for jobRole column:
   ```bash
   cd packages/db
   npx prisma migrate dev --name add_missing_jobrole_column
   ```
2. Verify migration adds:
   ```sql
   ALTER TABLE "users" ADD COLUMN "jobRole" "JobRole";
   ```
3. Deploy to test DB:
   ```bash
   export $(cat ../../services/api/.env.e2e | xargs)
   npx prisma migrate deploy
   ```

### Phase 2: Add Fail-Fast Gate (H4) - IMPORTANT
1. Create `scripts/verify-e2e-seed.mjs`:
   - Check DEMO_TAPAS has: org, branch, menu items, users
   - Check DEMO_EMPTY has: org, branch, no menu/items
   - Exit non-zero if checks fail
2. Update `test:e2e:setup` to run verification after seed
3. Update matrix/CI runners to check setup exit code

### Phase 3: Dataset Selection - COMPLIANCE
1. Add `E2E_DATASET` env var (default: DEMO_TAPAS)
2. Print selected dataset at start of setup
3. Seed only requested dataset (not all 3)

---

**END OF HYPOTHESES**
