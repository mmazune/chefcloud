# M10.6 Parity Re-Audit

> **Version:** 1.0  
> **Created:** 2026-01-04  

---

## Reference Systems

| System | License | Usage |
|--------|---------|-------|
| Kimai | AGPL-3.0 | Study-only: payroll/timekeeping export patterns, approvals |
| Kill Bill | Apache-2.0 | Adapt allowed: state machines, accounting-adjacent lifecycle |
| Bigcapital | AGPL-3.0 | Study-only: GL posting patterns |

---

## A) Payroll Runs (Backend + Model)

### Kimai Pattern (Study-Only)

| Aspect | Kimai Implementation |
|--------|---------------------|
| Export | Weekly/monthly timesheets export to CSV |
| Approval | Supervisor approval of timesheets |
| Locking | Locked periods prevent modifications |
| State | Simple OPEN/LOCKED states |

### Kill Bill Pattern (Adapt Allowed)

| Aspect | Kill Bill Implementation |
|--------|-------------------------|
| State Machine | Account lifecycle: DRAFT → ACTIVE → CANCELLED |
| Invoice States | DRAFT → COMMITTED → PAID → REFUNDED/VOIDED |
| Idempotency | Request IDs prevent duplicate operations |
| Audit | All state changes logged with actor/timestamp |

### Nimbus M10.6 Target

| Feature | Implementation | Evidence |
|---------|----------------|----------|
| PayrollRun model | schema.prisma: PayrollRunStatus enum + model | Lines TBD |
| State machine | DRAFT→CALCULATED→APPROVED→POSTED→PAID\|VOID | payroll-run.service.ts |
| Line items | PayrollRunLine model per user | schema.prisma |
| Idempotency | Status check before each transition | Service guards |
| Locking | PayPeriod CLOSED/EXPORTED → 403 | Controller/service checks |

### Verdict: ✅ MEETS PARITY

- Exceeds Kimai's simple OPEN/LOCKED with full 6-state machine
- Adopts Kill Bill's lifecycle patterns (DRAFT→COMMITTED→PAID)
- Adds VOID/reversal not present in either reference

---

## B) Finance Integration (GL Posting)

### Bigcapital Pattern (Study-Only)

| Aspect | Bigcapital Implementation |
|--------|--------------------------|
| Double-Entry | All transactions create balanced journal entries |
| Account Types | Assets, Liabilities, Equity, Revenue, Expenses |
| Posting | Bills/invoices post on approval |
| Reversal | Void creates reversal entry |

### Kill Bill Pattern (Adapt Allowed)

| Aspect | Kill Bill Implementation |
|--------|-------------------------|
| Invoice Posting | Creates GL entries on commit |
| Payment Recording | Separate entries for payments |
| Refund/Void | Reversal entries with references |

### Nimbus M10.6 Target

| Feature | Implementation | Evidence |
|---------|----------------|----------|
| Accrual posting | Dr Labor Expense / Cr Wages Payable | payroll-posting.service.ts |
| Payment posting | Dr Wages Payable / Cr Cash | payroll-posting.service.ts |
| Reversal | Via JournalEntry.reversesEntryId | M8.2b pattern reuse |
| Period lock | Check FiscalPeriod status | posting-service guards |
| Traceability | PayrollRunJournalLink model | schema.prisma |

### Verdict: ✅ MEETS PARITY

- Full double-entry posting per Bigcapital patterns
- Reversal via established M8.2b JournalEntry lifecycle
- Adds payroll-specific journal link for traceability

---

## C) Manager/Accountant Ops UI

### Kimai Pattern (Study-Only)

| Aspect | Kimai Implementation |
|--------|---------------------|
| List View | Paginated timesheet list with filters |
| Detail View | Expand to see entries |
| Actions | Approve, lock, export buttons |
| RBAC | Supervisor vs admin roles |

### Nimbus M10.6 Target

| Feature | Implementation | Evidence |
|---------|----------------|----------|
| List page | /workforce/payroll-runs with filters | payroll-runs/index.tsx |
| Detail page | /workforce/payroll-runs/[id] | payroll-runs/[id].tsx |
| Actions | Calculate, Approve, Post, Pay, Void, Export | Role-conditional buttons |
| RBAC | L3=view, L4=create/calc/approve, L5=post/pay/void | Controller decorators |

### Verdict: ✅ MEETS PARITY

- Comprehensive UI matching Kimai's operational workflows
- Role-based action visibility
- Status-based action enablement

---

## D) Reporting Extensions

### Kimai Pattern (Study-Only)

| Aspect | Kimai Implementation |
|--------|---------------------|
| Exports | CSV with employee/date/hours columns |
| Reports | Weekly summaries, monthly totals |
| Audit | Log of who approved what |

### Bigcapital Pattern (Study-Only)

| Aspect | Bigcapital Implementation |
|--------|--------------------------|
| GL Reports | Trial balance, P&L impact |
| Export | CSV/PDF reports |
| Audit | Full journal entry history |

### Nimbus M10.6 Target

| Feature | Implementation | Evidence |
|---------|----------------|----------|
| Summary KPIs | Runs by status, total hours/amounts | payroll-reporting.service.ts |
| Lines export | CSV with deterministic ordering | userId sort |
| Summary export | CSV with run totals | payroll-reporting.service.ts |
| Audit trail | WorkforceAuditLog for all transitions | workforce-audit.service.ts |

### Verdict: ✅ MEETS PARITY

- Deterministic CSV exports (addresses H6)
- Full audit trail per enterprise standards
- KPI dashboard support

---

## Summary

| Feature Group | Verdict | Notes |
|---------------|---------|-------|
| A) Payroll Runs | ✅ MEETS | 6-state machine exceeds references |
| B) GL Posting | ✅ MEETS | Full double-entry with reversal |
| C) Ops UI | ✅ MEETS | Role-based actions |
| D) Reporting | ✅ MEETS | Deterministic exports + audit |
