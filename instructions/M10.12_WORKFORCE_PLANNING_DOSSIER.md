# Feature Dossier: M10.12 Labor Forecasting + Staffing Planner

> **Status:** `IN_PROGRESS`
> **Created:** 2026-01-04
> **Author:** Copilot
> **Milestone:** M10.12

---

## 1. Scope

### 1.1 Feature Summary

M10.12 delivers an enterprise-grade workforce planning layer including labor forecasting, staffing plan generation, scheduled vs suggested variance analysis, understaffing/overstaffing alerts, and CSV exports. The feature supports branch-level configuration overrides and enforces RBAC (L4+ for write, L3+ for read).

### 1.2 In Scope

- Labor Targets CRUD with org/branch override logic
- Labor Forecast Snapshot generation (idempotent, deterministic)
- Staffing Plan generation with hourly role headcount
- Variance Report (scheduled shifts vs suggested headcount)
- Alerts generation and resolution
- CSV exports for forecast, plan, variance, alerts
- Admin UI pages (Targets, Planner, Alerts)
- Navigation updates for L3+/L4+ roles

### 1.3 Out of Scope

- Real-time forecast updates (batch/on-demand only)
- AI/ML forecasting (uses simple historical averages)
- Automatic schedule adjustment (manual workflow)
- Push notifications (logs only)

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| services/api/src/workforce | API | New planning services + controllers |
| packages/db/prisma | Shared | 5 new models + migration |
| apps/web/src/pages/workforce | UI | 3 new pages |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| labor_targets | CREATE | Config: covers per staff, labor % targets |
| labor_forecast_snapshots | CREATE | Point-in-time demand forecasts |
| staffing_plans | CREATE | Generated staffing recommendations |
| staffing_plan_lines | CREATE | Hourly role headcount lines |
| staffing_alerts | CREATE | Under/over staffing warnings |

### 1.6 API Endpoints

| Method | Path | RBAC | Description |
|--------|------|------|-------------|
| GET | /workforce/planning/targets | L3+ | List labor targets |
| POST | /workforce/planning/targets | L4+ | Create labor target |
| PATCH | /workforce/planning/targets/:id | L4+ | Update labor target |
| DELETE | /workforce/planning/targets/:id | L4+ | Delete labor target |
| POST | /workforce/planning/forecast/generate | L4+ | Generate forecast snapshot |
| GET | /workforce/planning/forecast | L3+ | Get forecast for date/branch |
| POST | /workforce/planning/plans/generate | L4+ | Generate staffing plan |
| GET | /workforce/planning/plans | L3+ | Get plan for date/branch |
| POST | /workforce/planning/plans/:id/publish | L4+ | Publish plan |
| GET | /workforce/planning/variance | L3+ | Get variance report |
| POST | /workforce/planning/alerts/generate | L4+ | Generate alerts |
| GET | /workforce/planning/alerts | L3+ | List alerts |
| POST | /workforce/planning/alerts/:id/resolve | L4+ | Resolve alert |
| GET | /workforce/planning/export/forecast | L4+ | Export forecast CSV |
| GET | /workforce/planning/export/plan | L4+ | Export plan CSV |
| GET | /workforce/planning/export/variance | L4+ | Export variance CSV |
| GET | /workforce/planning/export/alerts | L4+ | Export alerts CSV |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| LaborTargetsPage | /workforce/labor-targets | CRUD targets |
| StaffingPlannerPage | /workforce/staffing-planner | Generate + view plans |
| StaffingAlertsPage | /workforce/staffing-alerts | View + resolve alerts |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

- ScheduledShift model with role, startAt, endAt, status
- Reservation model with partySize (covers), startAt
- Order model with total, createdAt
- WorkforceReportingService with labor metrics
- Existing CSV export patterns in payroll-export.service.ts

### 2.2 Gaps and Limitations

- No forward-looking demand forecasting
- No suggested staffing levels
- No variance analysis (scheduled vs ideal)
- No staffing alerts/warnings

### 2.3 Related Features

| Feature | Status | Dependency |
|---------|--------|------------|
| M10.1 Shift Scheduling | Complete | Uses ScheduledShift for variance |
| M15 Reservations | Complete | Uses Reservation for covers forecast |
| M10.11 Availability | Complete | None |

---

## 3. Reference Repos

### 3.1 Selected References

| Repo | Domain | License | Tag | Rationale |
|------|--------|---------|-----|-----------|
| Kimai | Time Tracking | AGPL | STUDY-ONLY | Reporting patterns, export formats |
| Nimbus Internal | POS/Workforce | Proprietary | ADAPT | Existing patterns for RBAC, CSV, idempotency |

### 3.2 Concepts Extracted

#### From Kimai (STUDY-ONLY):
- Reports are read-only snapshots, not live queries
- Exports use standardized CSV with UTF-8 BOM
- Time-based data grouped by configurable buckets

#### From Nimbus Internal:
- Use `createHash('sha256')` for inputsHash (see remittance.service.ts)
- CSV escaping pattern with quote handling (see payroll-export.service.ts)
- RBAC via `@Roles('L4', 'L5')` decorator pattern
- Idempotency via unique constraints + findFirst check

---

## 4. Domain Invariants

### 4.1 Business Rules

| ID | Rule | Enforcement |
|----|------|-------------|
| BR-01 | Branch target overrides org-level default | Service logic: query branch first, fallback to orgId+null branchId |
| BR-02 | Forecast is deterministic for same inputs | inputsHash computed from sorted JSON; unique constraint |
| BR-03 | Plan requires existing forecast snapshot | FK constraint + validation |
| BR-04 | Alerts have severity thresholds: LOW (10-20% delta), MED (20-40%), HIGH (>40%) | Service logic |
| BR-05 | Resolve action only valid on unresolved alerts | Validation: resolvedAt must be null |

### 4.2 Data Invariants

| ID | Invariant | How Enforced |
|----|-----------|--------------|
| DI-01 | ForecastSnapshot unique per (orgId, branchId, date, inputsHash) | Prisma @@unique |
| DI-02 | StaffingPlan unique per (orgId, branchId, date, forecastSnapshotId) | Prisma @@unique |
| DI-03 | StaffingAlert unique per (orgId, branchId, date, hour, type) | Prisma @@unique |
| DI-04 | LaborTarget unique per (orgId, branchId, roleKey, dayOfWeek, hourStart) | Prisma @@unique |

### 4.3 State Machine

```
StaffingPlan:
  DRAFT → PUBLISHED (one-way; no reversal)

StaffingAlert:
  ACTIVE → RESOLVED (resolvedAt set)
```

---

## 5. Data Model

### 5.1 Entity Definitions

```prisma
enum StaffingPlanStatus {
  DRAFT
  PUBLISHED
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
}

enum AlertType {
  UNDERSTAFFED
  OVERSTAFFED
}

model LaborTarget {
  id                   String   @id @default(cuid())
  orgId                String
  branchId             String?  // null = org-level default
  roleKey              String   // jobRole slug
  dayOfWeek            Int      // 0=Sunday..6=Saturday
  hourStart            Int      // 0..23
  hourEnd              Int      // 0..24 (exclusive)
  targetCoversPerStaff Int?     // e.g., 20 covers per waiter
  targetLaborPct       Decimal? @db.Decimal(5, 2) // e.g., 30% of revenue
  enabled              Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  org    Org     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch? @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([orgId, branchId, roleKey, dayOfWeek, hourStart])
  @@index([orgId, branchId])
  @@map("labor_targets")
}

model LaborForecastSnapshot {
  id           String   @id @default(cuid())
  orgId        String
  branchId     String
  date         DateTime @db.Date
  timezone     String   @default("UTC")
  inputsHash   String   // sha256 of sorted inputs JSON
  generatedAt  DateTime @default(now())
  totalsJson   Json     // { coversForecast: number[], ordersForecast: number[], dataSources: string[] }
  createdAt    DateTime @default(now())

  org    Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  staffingPlans StaffingPlan[]

  @@unique([orgId, branchId, date, inputsHash])
  @@index([orgId, branchId, date])
  @@map("labor_forecast_snapshots")
}

model StaffingPlan {
  id                    String             @id @default(cuid())
  orgId                 String
  branchId              String
  date                  DateTime           @db.Date
  timezone              String             @default("UTC")
  forecastSnapshotId    String
  status                StaffingPlanStatus @default(DRAFT)
  generatedAt           DateTime           @default(now())
  publishedAt           DateTime?
  publishedById         String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  org              Org                   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch           Branch                @relation(fields: [branchId], references: [id], onDelete: Cascade)
  forecastSnapshot LaborForecastSnapshot @relation(fields: [forecastSnapshotId], references: [id], onDelete: Cascade)
  publishedBy      User?                 @relation(fields: [publishedById], references: [id], onDelete: SetNull)
  lines            StaffingPlanLine[]

  @@unique([orgId, branchId, date, forecastSnapshotId])
  @@index([orgId, branchId, date])
  @@map("staffing_plans")
}

model StaffingPlanLine {
  id                 String @id @default(cuid())
  staffingPlanId     String
  hour               Int    // 0..23
  roleKey            String
  suggestedHeadcount Int
  rationale          Json?  // { basedOn: 'covers', targetValue: 20, forecastedCovers: 80 }

  staffingPlan StaffingPlan @relation(fields: [staffingPlanId], references: [id], onDelete: Cascade)

  @@index([staffingPlanId])
  @@map("staffing_plan_lines")
}

model StaffingAlert {
  id          String        @id @default(cuid())
  orgId       String
  branchId    String
  date        DateTime      @db.Date
  hour        Int           // 0..23
  severity    AlertSeverity
  type        AlertType
  payloadJson Json          // { scheduledCount, suggestedCount, delta, roleKey }
  resolvedAt  DateTime?
  resolvedById String?
  createdAt   DateTime      @default(now())

  org        Org     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch     Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  resolvedBy User?   @relation(fields: [resolvedById], references: [id], onDelete: SetNull)

  @@unique([orgId, branchId, date, hour, type])
  @@index([orgId, branchId, date])
  @@index([resolvedAt])
  @@map("staffing_alerts")
}
```

### 5.2 Indexes

| Table | Index | Type | Rationale |
|-------|-------|------|-----------|
| labor_targets | (orgId, branchId) | btree | Branch override lookup |
| labor_forecast_snapshots | (orgId, branchId, date, inputsHash) | unique | Idempotency |
| staffing_plans | (orgId, branchId, date) | btree | Date-based queries |
| staffing_alerts | (resolvedAt) | btree | Filter unresolved |

---

## 6. Hypotheses (STEP 2)

| ID | Hypothesis | Confidence | Failure Mode | Disproval Method |
|----|------------|------------|--------------|------------------|
| H1 | inputsHash collisions cause wrong idempotency reuse | Low | Same hash for different inputs | E2E test: different inputs → different snapshots |
| H2 | Timezone bug shifts buckets by 1 hour (DST) | Medium | Hour-of-day miscalculation | E2E test: verify hour boundaries match branch timezone |
| H3 | Branch override leaks org-level targets into wrong branch | Medium | Query returns org defaults when branch target exists | E2E test: branch-specific target returned, not org default |
| H4 | Variance mismatches due to shift status filtering | High | CANCELLED shifts counted | Service: filter to PUBLISHED/APPROVED only |
| H5 | CSV export breaks with commas/newlines in values | Medium | Malformed CSV output | E2E test: values with commas properly escaped |
| H6 | Alerts re-generate duplicates without unique constraints | High | Duplicate alerts for same hour/type | DB unique constraint + upsert pattern |
| H7 | Planning endpoints allow L2 access due to missing guard | Medium | RBAC bypass | E2E test: L2 user gets 403 |
| H8 | Long-running aggregation causes test slowness | Medium | Timeout >30s | Add indexes; limit date range in tests |
| H9 | Published plan can be overwritten by re-generation | Medium | Data integrity issue | Service: reject generate if PUBLISHED exists |
| H10 | Forecast with no reservations/orders fails | Low | Null pointer | Service: handle empty data gracefully (return zeros) |

---

## 7. Acceptance Criteria Mapping

| AC | Description | Tests |
|----|-------------|-------|
| AC-01 | Targets CRUD with RBAC and branch override | E2E: create/read/update/delete, 403 for L2, branch override priority |
| AC-02 | Forecast generate idempotent + deterministic | E2E: same inputs → same id; different inputs → different snapshot |
| AC-03 | Plan generate produces hourly role headcount | E2E: verify lines array, headcount > 0 |
| AC-04 | Variance matches scheduled vs suggested | E2E: create shift, verify delta |
| AC-05 | Alerts generate + resolve works | E2E: generate alerts, verify severity, resolve updates resolvedAt |
| AC-06 | CSV export valid headers + content | E2E: verify Content-Type, first row = headers, data rows present |
| AC-07 | Multi-branch correctness | E2E: Cafesserie branch A ≠ branch B results |
| AC-08 | Timezone correctness | E2E: date/hour computed in branch timezone |
| AC-09 | No-hang compliance | Jest timeout 30s; all tests exit cleanly |
