# M9.4 Public Booking + Reporting: Parity Re-Audit

**Audit Date:** 2025-01-XX  
**Author:** ChefCloud Engineering  
**Baseline Commit:** b1c566a (M9.3)  

## Reference Systems Compared

| System | License | Inspection Method |
|--------|---------|-------------------|
| TastyIgniter | MIT | Adapt allowed |
| cal.com | AGPL-3.0 | Study only |
| easyappointments | AGPL-3.0 | Study only |

---

## AC-01: Public Availability Query

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Slot generation | ✅ Per-interval | ✅ 15-min slots | ✅ Configurable | ✅ Policy-based intervals |
| Party size filter | ❌ N/A | ❌ N/A | ❌ N/A | ✅ Capacity-aware |
| Date range limit | ❌ No limit | ✅ advanceBookingDays | ✅ Configurable | ✅ Policy.advanceBookingDays |
| Operating hours | ✅ Business hours | ✅ Availability windows | ✅ Working hours | ✅ Branch openingHours |
| Blocked slots | ⚠️ Manual only | ✅ Busy events | ✅ Blocked slots | ✅ BlockedSlot overlap check |

**Delta:** ChefCloud adds party-size-aware capacity filtering not present in comparison systems.

---

## AC-02: Public Reservation Create

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Guest info capture | ✅ Name, phone, email | ✅ Name, email | ✅ Name, phone, email | ✅ Name, phone, notes |
| Immediate confirm | ✅ Yes | ⚠️ Requires payment | ✅ Yes | ✅ If no deposit |
| Hold for deposit | ❌ N/A | ✅ Pending until paid | ❌ N/A | ✅ HELD status |
| Deposit calculation | ❌ N/A | ✅ Fixed price | ❌ N/A | ✅ Per-guest or fixed |
| Notifications | ✅ Email | ✅ Email/SMS | ✅ Email | ✅ Notification log (external integration) |

**Delta:** ChefCloud implements deposit-aware hold workflow matching cal.com patterns.

---

## AC-03: Access Token Generation

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Token for management | ❌ Account required | ✅ uid in URL | ✅ Hash in URL | ✅ Crypto-random token |
| Token expiry | N/A | ❌ Never expires | ❌ Never expires | ✅ 7 days default |
| One-time tokens | N/A | ❌ Persistent | ❌ Persistent | ✅ Optional scope-based |
| Token revocation | N/A | ❌ Manual | ❌ Manual | ✅ revokeAllTokens() |

**Delta:** ChefCloud adds expiry and revocation capabilities for enhanced security.

---

## AC-04: Token-based Cancel/Reschedule

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Guest self-cancel | ⚠️ Account only | ✅ Via link | ✅ Via link | ✅ Token-gated |
| Guest reschedule | ⚠️ Account only | ✅ Via link | ✅ Via link | ✅ Token-gated |
| Cutoff enforcement | ⚠️ Manual | ✅ Buffer time | ⚠️ Manual | ✅ Policy.cancelCutoffMinutes |
| Deposit forfeit | N/A | ✅ On late cancel | N/A | ✅ Automatic if past cutoff |

**Delta:** ChefCloud enforces policy-based cutoff times with automatic deposit handling.

---

## AC-05: Rate Limiting

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Public endpoint limits | ❌ None | ⚠️ API-level | ❌ None | ✅ 10 req/min sliding |
| IP-based throttle | ❌ | ✅ | ❌ | ✅ |
| Custom limits per route | ❌ | ⚠️ | ❌ | ✅ @UseGuards(RateLimitGuard) |

**Delta:** ChefCloud implements dedicated anti-abuse rate limiting for public booking endpoints.

---

## AC-06: KPI Report Summary

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Total count | ✅ Dashboard | ✅ Analytics | ✅ Reports | ✅ totalReservations |
| No-show tracking | ⚠️ Manual | ⚠️ Limited | ⚠️ Manual | ✅ noShowRate percentage |
| Avg party size | ❌ | ❌ | ❌ | ✅ averagePartySize |
| Status breakdown | ⚠️ List view | ⚠️ Status filter | ✅ Status report | ✅ statusBreakdown |
| Peak hours | ❌ | ✅ Insights | ❌ | ✅ peakHours array |
| Day-of-week | ❌ | ✅ Insights | ❌ | ✅ dayOfWeekBreakdown |
| Conversion rate | ❌ | ⚠️ | ❌ | ✅ conversionRate |

**Delta:** ChefCloud provides comprehensive analytics beyond comparison systems.

---

## AC-07: CSV Export

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Export to CSV | ⚠️ Extension | ✅ Built-in | ✅ Built-in | ✅ /reports/export |
| Date range filter | ⚠️ | ✅ | ✅ | ✅ from/to params |
| Injection protection | ❌ | ⚠️ | ❌ | ✅ escapeCSV() |
| Field selection | ❌ | ⚠️ | ❌ | ⚠️ Fixed columns |

**Delta:** ChefCloud adds CSV injection protection (formula escape).

---

## AC-08: Deposit Report

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Deposit tracking | ❌ | ✅ Payment status | ❌ | ✅ Full lifecycle |
| Forfeiture report | ❌ | ⚠️ | ❌ | ✅ totalForfeited |
| Refund tracking | ❌ | ✅ | ❌ | ✅ totalRefunded |
| Outstanding calc | ❌ | ⚠️ | ❌ | ✅ totalOutstanding |

**Delta:** ChefCloud provides dedicated deposit lifecycle reporting.

---

## AC-09: Public Booking UI

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Embeddable widget | ✅ | ✅ | ✅ | ⚠️ Standalone page |
| Branch selection | ✅ | ⚠️ | ✅ | ✅ Slug-based |
| Mobile responsive | ✅ | ✅ | ✅ | ✅ Tailwind CSS |
| Confirmation page | ✅ | ✅ | ✅ | ✅ In-page state |

**Gap:** Embeddable iframe/widget version not yet implemented. Recommendation: Add /embed/book/[slug] variant in future sprint.

---

## AC-10: RBAC for Reports

| Feature | TastyIgniter | cal.com | easyappointments | ChefCloud M9.4 |
|---------|--------------|---------|------------------|----------------|
| Role-based access | ⚠️ Admin only | ⚠️ Owner/admin | ⚠️ Secretary/admin | ✅ L4+ (Owner, Director) |
| Granular permissions | ❌ | ⚠️ | ❌ | ⚠️ Role level only |

**Delta:** ChefCloud uses structured 5-level RBAC with clear report access at L4+.

---

## Hypothesis Validation (from M9.4_HYPOTHESES.md)

| # | Hypothesis | Status | Notes |
|---|------------|--------|-------|
| H1 | DST handling | ✅ MITIGATED | All dates use ISO 8601 UTC |
| H2 | Capacity mismatch | ✅ MITIGATED | Unified capacity check in CapacityService |
| H3 | Token security | ✅ MITIGATED | randomBytes(32).toString('base64url') |
| H4 | Deposit GL | ⚠️ MONITORING | ledgerAccountId configured per org |
| H5 | Rate limiter leaks | ✅ MITIGATED | Cleanup interval, Map.delete on window close |
| H6 | CSV injection | ✅ MITIGATED | escapeCSV() prefixes formulas with ' |
| H7 | Slug collisions | ✅ MITIGATED | @unique constraint in Prisma schema |

---

## Summary

| Metric | Count |
|--------|-------|
| Total ACs | 10 |
| Fully Covered | 9 |
| Partial (AC-09 embed) | 1 |
| Tests Created | 22 (2+ per AC) |

**Recommendation:** Ship M9.4 as-is. Add embed widget in M9.5 if customer demand.
