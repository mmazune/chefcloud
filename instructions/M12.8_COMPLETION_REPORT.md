# M12.8 Inventory Close Ops Finalization - Completion Report

## Milestone Summary

| Attribute | Value |
|-----------|-------|
| Milestone | M12.8 |
| Title | Inventory Close Ops Finalization (Gate Hardening + Regression Pack) |
| Base Commit | c3a6326 (M12.7) |
| Status | ✅ COMPLETE |

## Hypotheses Tested

| # | Hypothesis | Result |
|---|------------|--------|
| H1 | Preclose snapshot cross-branch leakage | ✅ E2E test added |
| H2 | Close-pack hash differs on Windows (BOM/newlines) | ✅ LF normalization verified |
| H3 | Approval gating regression blocks L5 forceClose | ✅ E2E test validates L5 bypass |
| H4 | Reconciliation pack misses FAILED_GL_POSTINGS detection | ✅ Fixed: Added receipts + waste |
| H5 | Export ordering nondeterministic causing hash drift | ✅ E2E verifies stable hash |
| H6 | Inventory gate runner misses new test files | ✅ Verified pattern includes M12.8 |
| H7 | Tests hang due to unclosed app/server | ✅ Cleanup helper added |
| H8 | GL posting status fields not updated on void | ⚪ Documented for future M12 |
| H9 | Dashboard snapshot stale after reopen | ⚪ Documented for future M12 |
| H10 | Close request approval race condition | ⚪ Documented for future M12 |

## Files Created

| File | Purpose |
|------|---------|
| `instructions/M12.8_HYPOTHESES.md` | 10 hypotheses with test strategies |
| `instructions/M12.8_INVENTORY_CLOSE_OPS_FINALIZATION_DOSSIER.md` | Technical dossier |
| `services/api/test/e2e/inventory-m128-close-ops-finalization.e2e-spec.ts` | Regression E2E tests |

## Files Modified

| File | Change |
|------|--------|
| `services/api/src/inventory/inventory-preclose-check.service.ts` | Added receipts + waste to `checkGLPostingFailed` |
| `services/api/src/inventory/inventory-blockers-engine.service.ts` | Added waste to `FAILED_GL_POSTINGS` check |

## Test Coverage Added

| Test | Category |
|------|----------|
| `blocks close without approved request` | Approval gating |
| `allows close after approval` | Approval flow |
| `rejects forceClose with short reason` | ForceClose validation |
| `allows forceClose with valid reason, emits FORCE_CLOSE_USED event` | ForceClose success |
| `dashboard returns correct status per branch` | Cross-branch isolation |
| `close-pack hash is stable across repeated calls` | Hash stability |
| `blockers check includes FAILED_GL_POSTINGS for all event types` | GL detection |
| `returns 409 for close-pack on OPEN period` | 409 guard |
| `OVERRIDE_USED event is emitted when blocker overridden` | Event emission |

## Key Fixes

### H4: FAILED_GL_POSTINGS Now Checks All Event Types

**Before (M12.7)**:
- Only checked `OrderInventoryDepletion` for failed GL postings

**After (M12.8)**:
- Checks `OrderInventoryDepletion` (COGS)
- Checks `GoodsReceiptV2` (receipts)
- Checks `InventoryWaste` (waste)

## Verification Checklist

- [x] Baseline verified (HEAD == c3a6326)
- [x] Hypotheses documented (10)
- [x] E2E regression pack created
- [x] GL detection fixed for all event types
- [x] Lint errors fixed
- [x] Gate runner pattern verified
- [x] Dossier created
- [x] Completion report created

## Next Steps (Future Milestones)

1. **H8**: Implement void GL status update propagation
2. **H9**: Add dashboard cache invalidation on period reopen
3. **H10**: Add close request approval lock (distributed)

## Commit

```
chore(inventory): M12.8 close ops finalization (regression pack + gate hardening) + tests
```
