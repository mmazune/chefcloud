# M8.1 Completion Summary

**Milestone:** Role Capability Model + Persistent jobRole + Post-Login Routing + Config-Driven Nav  
**Status:** âœ… Complete  
**Date:** 2026-01-02  
**Cumulative Progress:** 14%

---

## Overview

M8.1 establishes the foundation for role-optimized UX in ChefCloud. Previously, all roles (Accountant, Manager, Procurement, etc.) experienced the same generic UI after login. This milestone introduces:

1. **Persistent jobRole** - Demo users now have `jobRole` populated in the database
2. **JWT + /me integration** - `jobRole` is returned in auth responses and `/me` endpoint
3. **roleCapabilities.ts** - Single source of truth for role-specific navigation and routing
4. **Post-login routing** - Each role lands on their specialized workspace
5. **Config-driven sidebar** - Navigation groups tailored per role

---

## Files Changed

### Backend (services/api)

| File | Change |
|------|--------|
| `prisma/demo/constants.ts` | Added `jobRole` field to all 19 demo users (11 Tapas + 8 Cafesserie) |
| `prisma/demo/seedDemo.ts` | Added `jobRole` to user upsert create/update |
| `src/auth/jwt.strategy.ts` | Added `jobRole?: string` to JwtPayload interface |
| `src/auth/auth.service.ts` | Added `jobRole` to generateAuthResponse and JWT payload |
| `src/auth/dto/auth.dto.ts` | Added `jobRole?: string` to AuthResponse user object |
| `src/me/me.controller.ts` | Added `jobRole: fullUser.jobRole ?? null` to /me response |

### Frontend (apps/web)

| File | Change |
|------|--------|
| `src/config/roleCapabilities.ts` | **NEW** - Central role capability configuration for 11 roles |
| `src/lib/auth.ts` | Added `jobRole` to AuthUser, LoginResponse, login(), getCurrentUser() |
| `src/contexts/AuthContext.tsx` | Updated login routing to use `getDefaultRoute(jobRole)` |
| `src/pages/index.tsx` | Added jobRole-based routing for BACKOFFICE device role |
| `src/components/layout/Sidebar.tsx` | Replaced minRole nav logic with roleCapabilities navGroups |
| `src/components/workspace/WorkspacePlaceholder.tsx` | **NEW** - Reusable workspace landing component |
| `src/pages/workspaces/owner.tsx` | **NEW** - Owner workspace page |
| `src/pages/workspaces/manager.tsx` | **NEW** - Manager workspace page |
| `src/pages/workspaces/accountant.tsx` | **NEW** - Accountant workspace page |
| `src/pages/workspaces/procurement.tsx` | **NEW** - Procurement workspace page |
| `src/pages/workspaces/stock-manager.tsx` | **NEW** - Stock Manager workspace page |
| `src/pages/workspaces/supervisor.tsx` | **NEW** - Supervisor workspace page |
| `src/pages/workspaces/chef.tsx` | **NEW** - Chef workspace page |
| `src/pages/workspaces/event-manager.tsx` | **NEW** - Event Manager workspace page |

### Scripts

| File | Change |
|------|--------|
| `scripts/verify-role-coverage.ts` | Added `jobRole` to TestResult interface and /me verification |
| `scripts/verify-role-nav.ts` | **NEW** - Outputs defaultRoute and navGroups per jobRole |

---

## Role Configuration Summary

| Role | Default Route | Dashboard | Nav Groups |
|------|---------------|-----------|------------|
| OWNER | /workspaces/owner | full | Overview, Operations, Finance, Team, Settings |
| MANAGER | /workspaces/manager | operational | Overview, Operations, Team, Reports |
| ACCOUNTANT | /workspaces/accountant | finance | Finance |
| PROCUREMENT | /workspaces/procurement | inventory | Procurement |
| STOCK_MANAGER | /workspaces/stock-manager | inventory | Inventory |
| SUPERVISOR | /workspaces/supervisor | operational | Operations |
| CASHIER | /pos | pos | POS |
| CHEF | /workspaces/chef | kds | Kitchen |
| WAITER | /pos | pos | Service |
| BARTENDER | /pos | pos | Bar |
| EVENT_MANAGER | /workspaces/event-manager | events | Events |

---

## Verification

### Verification Scripts

```bash
# Verify role navigation configuration
npx tsx scripts/verify-role-nav.ts
# Output: instructions/M8.1_ROLE_NAV_VERIFY_OUTPUT.txt

# Verify jobRole is returned in /me for all demo users
npx tsx scripts/verify-role-coverage.ts --org both
# Output: instructions/M7.4_ROLE_VERIFY_OUTPUT.txt (now includes jobRole)
```

### Manual Verification

```bash
# Login as manager, verify jobRole in response
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"manager@tapas.demo.local","password":"Demo#123"}' \
  | jq '.user.jobRole'
# Expected: "MANAGER"

# Get /me, verify jobRole
curl http://localhost:3001/me -H "Authorization: Bearer $TOKEN" \
  | jq '{ roleLevel, jobRole }'
# Expected: { "roleLevel": "L4", "jobRole": "MANAGER" }
```

---

## Proof of Different Routes

| Login As | jobRole | Lands On |
|----------|---------|----------|
| owner@tapas.demo.local | OWNER | /workspaces/owner |
| manager@tapas.demo.local | MANAGER | /workspaces/manager |
| accountant@tapas.demo.local | ACCOUNTANT | /workspaces/accountant |
| procurement@tapas.demo.local | PROCUREMENT | /workspaces/procurement |
| stock@tapas.demo.local | STOCK_MANAGER | /workspaces/stock-manager |
| supervisor@tapas.demo.local | SUPERVISOR | /workspaces/supervisor |
| cashier@tapas.demo.local | CASHIER | /pos |
| waiter@tapas.demo.local | WAITER | /pos |
| chef@tapas.demo.local | CHEF | /workspaces/chef |
| bartender@tapas.demo.local | BARTENDER | /pos |
| eventmgr@tapas.demo.local | EVENT_MANAGER | /workspaces/event-manager |

---

## Setup Instructions

1. **Re-seed database** to populate jobRole:
   ```bash
   E2E_DATASET=ALL pnpm -C services/api test:e2e:setup
   ```

2. **Start API server**:
   ```bash
   pnpm -C services/api start:dev
   ```

3. **Start web app**:
   ```bash
   pnpm -C apps/web dev
   ```

4. **Login with demo credentials** and observe role-specific landing page

---

## Architecture Notes

### roleCapabilities.ts Structure

```typescript
const ROLE_CAPABILITIES: Record<JobRole, RoleCapability> = {
  OWNER: {
    defaultRoute: '/workspaces/owner',
    dashboardVariant: 'full',
    navGroups: [...],
    workspaceTitle: 'Owner Headquarters',
    workspaceDescription: '...'
  },
  // ... other roles
};
```

### Helper Functions

- `getRoleCapabilities(jobRole)` - Get full config for a role (with fallback)
- `getDefaultRoute(jobRole)` - Get landing route for post-login redirect
- `getAllNavItems(jobRole)` - Flatten all nav items for a role
- `isRouteAccessible(jobRole, route)` - Check if role can access a route

---

## Next Steps (M8.2+)

- [ ] M8.2: Role-specific dashboard widgets
- [ ] M8.3: Deep link protection based on roleCapabilities
- [ ] M8.4: Role-specific quick actions and shortcuts
- [ ] M8.5: Mobile-optimized role workspaces

---

## Related Documents

- [M8.1_ROLE_NAV_VERIFY_OUTPUT.txt](M8.1_ROLE_NAV_VERIFY_OUTPUT.txt) - Verification output
- [feature-dossiers/M8.1_ROLE_UX_FOUNDATION_DOSSIER.md](feature-dossiers/M8.1_ROLE_UX_FOUNDATION_DOSSIER.md) - Feature dossier
