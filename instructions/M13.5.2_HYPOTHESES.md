# M13.5.2 Hypotheses

## H1: CashSession requires branchId but controller/service doesn't propagate it
**Confidence**: 95%
**Failure Mode**: CashSession.create fails with Prisma validation error "Argument `branchId` is missing"
**Evidence**: PRE-018 error shows exactly this - service passes orgId but not branchId
**Fix Approach**: Add branchId to service call, derive from req.user.branchId

## H2: Payment capture/void/refund does not recompute Order.paymentStatus atomically
**Confidence**: 90%
**Failure Mode**: Order.paymentStatus stays UNPAID even after full payment
**Evidence**: PRE-019 shows paymentStatus remains UNPAID after payments are captured
**Fix Approach**: Add recomputeOrderPaymentStatus() call after each payment state change

## H3: Partial payments update Payment rows but do not update Order due/paid invariants
**Confidence**: 85%
**Failure Mode**: paidCents/dueCents mismatch in payment summary, PARTIALLY_PAID not set
**Evidence**: Tests expect PARTIALLY_PAID but get UNPAID
**Fix Approach**: Calculate paidCents = sum of CAPTURED payments, update Order.paymentStatus based on comparison with totalCents

## H4: KDS "ALL" station value is treated as a real station and breaks validation/filtering
**Confidence**: 90%
**Failure Mode**: Prisma throws "Invalid value for argument `station`. Expected StationTag."
**Evidence**: PRE-020 shows KDS service passing "ALL" where StationTag enum expected
**Fix Approach**: Treat station="ALL" as undefined (no filter), not as literal enum value

## H5: Fixing paymentStatus introduces regression in tips handling
**Confidence**: 60%
**Failure Mode**: Tips incorrectly affect dueCents calculation
**Invariant**: tipCents must NOT affect dueCents; tips are "on top of" order total
**Fix Approach**: Ensure paidCents calculation includes principal only, tipCents tracked separately

## H6: Fixes risk cross-branch leakage if order/branch scoping not enforced
**Confidence**: 50%
**Failure Mode**: CashSession/Payment from wrong branch returned in queries
**Fix Approach**: Ensure all queries include orgId AND branchId filters

## H7: Tests hang due to unclosed resources introduced by changes
**Confidence**: 20%
**Failure Mode**: Jest does not exit, requires --forceExit
**Mitigation**: All fixes must be stateless, no intervals/timers introduced

---
Created: 2026-01-09 M13.5.2 Release Gate Closure
