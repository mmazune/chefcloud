# Feature Dossier: M10.9 Liability Remittances

> **Status:** `IN_PROGRESS`  
> **Created:** 2026-01-04  
> **Author:** AI Agent  
> **Milestone:** M10.9  

---

## 1. Scope

### 1.1 Feature Summary

M10.9 introduces a remittance engine to **settle liabilities** created during payroll posting (M10.8). When payroll is posted, journals create liabilities (Taxes Payable, Deductions Payable, Employer Contrib Payable). Remittance batches pay these liabilities to authorities/providers (e.g., IRS, benefits providers) with full accounting traceability.

### 1.2 In Scope

- RemittanceBatch entity with state machine: DRAFT → APPROVED → POSTED → PAID (+ VOID)
- RemittanceLine for individual liability settlements
- RemittanceJournalLink for traceability to journal entries
- Idempotency enforcement (no duplicate batches per org+key)
- Period lock enforcement (cannot post into locked fiscal periods)
- Auto-generation of draft batches from payroll runs (optional)
- Admin UI: list, create, detail, approve/post/pay/void actions
- Reporting: KPIs, CSV exports
- RBAC: L4+ for create/edit/approve/export, L5 only for post/pay/void

### 1.3 Out of Scope

- Integration with external payment providers (e.g., ACH, wire transfers)
- Multi-currency remittances (single currency only for now)
- Automated scheduling of remittances
- Component-level payee mapping (minimal implementation; links to componentId optional)

### 1.4 Nimbus Modules Affected

| Module | Type | Description |
|--------|------|-------------|
| services/api/src/workforce | API | RemittanceService, RemittanceController |
| apps/web/src/pages/workforce | UI | Remittance list/create/detail pages |
| packages/db/prisma | Schema | RemittanceBatch, RemittanceLine, RemittanceJournalLink |

### 1.5 Database Tables Affected

| Table | Action | Description |
|-------|--------|-------------|
| remittance_batches | CREATE | Batch entity with status, type, idempotency |
| remittance_lines | CREATE | Line items (liability account, amount, payee) |
| remittance_journal_links | CREATE | Links batch to journal entries |
| compensation_components | ALTER | Add optional remittanceType, payeeName |

### 1.6 API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /orgs/:orgId/remittances | List batches with filters |
| POST | /orgs/:orgId/remittances | Create draft batch |
| GET | /orgs/:orgId/remittances/:id | Get batch detail |
| PATCH | /orgs/:orgId/remittances/:id | Update draft batch |
| DELETE | /orgs/:orgId/remittances/:id | Delete draft batch |
| POST | /orgs/:orgId/remittances/:id/lines | Add line |
| DELETE | /orgs/:orgId/remittances/:id/lines/:lineId | Remove line |
| POST | /orgs/:orgId/remittances/:id/approve | Approve batch |
| POST | /orgs/:orgId/remittances/:id/post | Post batch (no journal yet) |
| POST | /orgs/:orgId/remittances/:id/pay | Pay batch (creates journal) |
| POST | /orgs/:orgId/remittances/:id/void | Void batch (reverses if needed) |
| GET | /orgs/:orgId/remittances/:id/preview | Preview journal entries |
| POST | /orgs/:orgId/remittances/generate-from-payroll | Auto-generate from runs |
| GET | /orgs/:orgId/reports/remittances/kpis | Remittance KPIs |
| GET | /orgs/:orgId/reports/export/remittances | CSV export batches |
| GET | /orgs/:orgId/reports/export/remittance-lines | CSV export lines |

### 1.7 UI Components

| Component | Route | Description |
|-----------|-------|-------------|
| RemittanceList | /workforce/remittances | List + filters |
| RemittanceNew | /workforce/remittances/new | Create draft form |
| RemittanceDetail | /workforce/remittances/[id] | Detail + actions + journals |

---

## 2. Current Nimbus State

### 2.1 What Exists Today

- **M10.8 Payroll GL Posting**: Posts payroll with Dr Labor Expense / Cr Liabilities (Taxes, Deductions, Employer Contrib Payable) + Dr Wages Payable / Cr Cash for payment
- **PayrollRunJournalLink**: Links runs to journal entries
- **JournalEntry + JournalEntryLine**: Full GL accounting with reversals
- **FiscalPeriod + period lock**: Prevents posting to locked periods
- **CompensationComponent**: Defines earnings, taxes, deductions, employer contrib

### 2.2 Gaps and Limitations

- No mechanism to settle the liability accounts (Taxes Payable, Deductions Payable, Employer Contrib Payable)
- No tracking of payments to tax authorities or benefits providers
- No batch remittance workflow

---

## 3. Reference Architecture Comparison

### 3.1 Reference Systems

| System | License | Relevance |
|--------|---------|-----------|
| Apache ODE / BillingAP | Apache 2.0 | ADAPT - payment batch patterns |
| OpenPayd API | Study-only | STUDY - remittance state machine |
| Kill Bill | Apache 2.0 | ADAPT - idempotency, payment lifecycle |

### 3.2 Parity Analysis

| Feature | OpenPayd | Kill Bill | Nimbus Target |
|---------|----------|-----------|---------------|
| Batch state machine | CREATED→PROCESSING→COMPLETED→FAILED | PENDING→SUCCESS→FAILED | DRAFT→APPROVED→POSTED→PAID (+VOID) |
| Idempotency | Client-provided key | Plugin-based | idempotencyKey per org |
| Line-level detail | Yes, per beneficiary | Yes, per invoice item | Yes, per liability account |
| Reversal/Void | Manual cancellation | Refund mechanism | VOID reverses journals |
| Period enforcement | N/A | N/A | Fiscal period lock check |
| Multi-tenant | Per org | Per tenant | Per org + branch |

### 3.3 Design Decisions

**D1: Journal Creation Timing**
- Option A: Create journal on POSTED transition, PAID is status-only
- Option B: POSTED locks batch, PAID creates journal (cash settlement)
- **Chosen: Option B** - Matches real-world workflow where posting = approval, payment = actual cash movement

**D2: Void Reversal**
- If batch has journal (PAID), void must create reversal entries via M8.2b patterns
- If batch is DRAFT/APPROVED/POSTED (no journal), void just marks status

**D3: Line Grouping**
- Lines can be grouped by type (TAX, DEDUCTION, EMPLOYER_CONTRIB) or by component
- Minimal implementation: one line per liability account, componentId optional

---

## 4. Implementation Plan

### 4.1 Phase 1: Schema + Migration
- RemittanceBatch, RemittanceLine, RemittanceJournalLink
- Extend CompensationComponent with remittanceType (optional)

### 4.2 Phase 2: Service Layer
- RemittanceService with state machine, idempotency, journal creation
- Integration with AccountingModule for journal creation/reversal

### 4.3 Phase 3: Controller + Endpoints
- Full CRUD + transitions + preview + exports

### 4.4 Phase 4: Web UI
- List, new, detail pages with actions

### 4.5 Phase 5: Tests
- E2E covering 8 scenarios
- UI smoke tests

---

## 5. Accounting Journal Patterns

### 5.1 On PAID Transition

When a remittance batch transitions to PAID, create journal:

```
Dr Taxes Payable          $xxx
Dr Deductions Payable     $xxx  
Dr Employer Contrib Pay   $xxx
   Cr Cash/Bank                    $xxx (sum of lines)
```

Reference: lines in batch, each line specifies liabilityAccountId and counterAccountId.

### 5.2 On VOID (after PAID)

Reverse the journal entry via M8.2b mechanism:
- Create new journal with opposite debits/credits
- Link via RemittanceJournalLink with type='REVERSAL'

---

## 6. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Rounding drift in totals | Medium | High | Use Prisma.Decimal throughout |
| Duplicate batches | Low | High | Unique idempotencyKey per org |
| Orphan journal links | Low | Medium | Transaction-based creation |
| RBAC bypass for pay/void | Low | High | Explicit L5 checks |
| Branch scoping leakage | Medium | High | Consistent orgId + branchId filters |

---

## 7. Traceability

| Requirement | Implementation | Test |
|-------------|----------------|------|
| State machine | RemittanceService.transitionStatus() | H1, H2, H3 E2E |
| Idempotency | Unique constraint + check | H2 E2E |
| Journal creation | RemittanceService.payBatch() | H3, H4 E2E |
| Journal reversal | RemittanceService.voidBatch() | H5 E2E |
| Period lock | FiscalPeriod.locked check | H6 E2E |
| Multi-tenant | orgId filters in all queries | H7 E2E |
| CSV export | ReportingController endpoints | H8 E2E |
