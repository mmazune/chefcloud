# M10.14 Auto-Scheduler v2 Feature Dossier

## Overview

**Milestone**: M10.14 Workforce: Auto-Scheduler v2
**Target**: Cumulative 64%
**Baseline Commit**: `a6579c9` (M10.13 complete)

## Feature Scope

### A) Deterministic Employee Assignment
Extend M10.13 to optionally assign employees to suggestions:
- Add `assignedUserId`, `assignmentReason`, `assignmentScore` to `AutoScheduleSuggestion`
- Support `mode=UNASSIGNED|ASSIGNED` query parameter on generate
- Deterministic tie-break: lowest weekly hours → lexical userId
- Assignment blocked if constraints violated

### B) Scheduling Constraints Engine
Enforce constraints during assignment and apply:
- `minRestHoursBetweenShifts` (default 10)
- `maxWeeklyHours` (default 48)
- `maxConsecutiveDays` (default 6)
- `maxShiftHours` (default 8 - existing)
- PayPeriod lock check (CLOSED/EXPORTED → 403)

Reasons: OVERLAP, MIN_REST, MAX_WEEKLY, MAX_CONSEC_DAYS, PAY_PERIOD_LOCKED

### C) Publish Workflow
- POST `/workforce/planning/auto-schedule/:runId/publish`
- Marks shifts as published using existing M10.1 semantics
- Idempotent (second call returns same result)
- Creates WorkforceAuditLog entry

### D) Notifications
- Trigger notification logs on publish for assigned employees
- Non-hanging (no await on external services)
- Use existing workforce notification patterns

### E) UI Enhancements
- Mode selector (Unassigned/Assigned)
- Display assigned employee and reason
- Publish button (L4+ only)
- Conflicts/skipped reasons summary

## Reference Comparison

### Kimai (AGPL, Study-Only)
Kimai focuses on time tracking with basic scheduling concepts:
- Does NOT have automated employee assignment
- Uses simple start/end time entries
- Manual approval workflows
- No constraint enforcement engine
- No publish/notification workflow

**Gap Analysis**: Nimbus M10.14 EXCEEDS Kimai by providing:
- Automated deterministic assignment
- Constraint enforcement (min rest, max hours, etc.)
- Publish workflow with notifications
- Availability-aware candidate selection

### Nimbus Internal Components

| Component | Purpose | M10.14 Integration |
|-----------|---------|-------------------|
| M10.1 Scheduling | ScheduledShift CRUD, publish | Extend apply to set employeeId |
| M10.3 Policies | WorkforcePolicy, PayPeriod | Add constraint fields, check locks |
| M10.11 Availability | StaffAvailability, exceptions | Filter candidates |
| M10.13 Auto-Scheduler | Generate/Apply suggestions | Extend with assignment |

## Database Schema Changes

### AutoScheduleSuggestion (Extend)
```prisma
model AutoScheduleSuggestion {
  // ... existing fields ...
  assignedUserId     String?   // M10.14: Assigned employee
  assignmentReason   String?   // M10.14: ONLY_CANDIDATE, LOWEST_WEEKLY_HOURS, etc.
  assignmentScore    Int?      // M10.14: Tie-break score (lower = better)
}
```

### AutoScheduleRun (Extend)
```prisma
model AutoScheduleRun {
  // ... existing fields ...
  assignmentMode     String    @default("UNASSIGNED") // M10.14: UNASSIGNED, ASSIGNED
  publishedAt        DateTime? // M10.14: When shifts were published
  publishedById      String?   // M10.14: Who published
}
```

### WorkforcePolicy (Extend)
```prisma
model WorkforcePolicy {
  // ... existing fields ...
  minRestHoursBetweenShifts Int @default(10)  // M10.14
  maxWeeklyHours            Int @default(48)  // M10.14
  maxConsecutiveDays        Int @default(6)   // M10.14
}
```

## API Endpoints

### Modified
- `POST /workforce/planning/auto-schedule/generate`
  - Add `mode` query param: `UNASSIGNED` | `ASSIGNED`
  - Response includes assignment fields when mode=ASSIGNED

### New
- `POST /workforce/planning/auto-schedule/:runId/publish`
  - RBAC: L4+
  - Idempotent
  - Returns: `{ publishedAt, shiftsPublished, notificationsCreated }`

## Deterministic Assignment Algorithm

```
for each suggestion in sorted(suggestions, by=startAt):
  candidates = filter_available(suggestion.candidateUserIds)
  candidates = filter_no_constraints_violated(candidates, suggestion)
  
  if candidates.length == 0:
    assignmentReason = "NO_ELIGIBLE_CANDIDATES"
    continue
  
  if candidates.length == 1:
    assign(candidates[0])
    assignmentReason = "ONLY_CANDIDATE"
    continue
  
  # Tie-break: lowest weekly hours, then lexical userId
  candidates = sort(candidates, by=[weeklyHours ASC, userId ASC])
  assign(candidates[0])
  assignmentReason = "LOWEST_WEEKLY_HOURS"
```

## Constraint Evaluation Logic

```
function evaluateConstraints(userId, newShift):
  # 1. Overlap check
  if hasOverlappingShift(userId, newShift.startAt, newShift.endAt):
    return { valid: false, reason: "OVERLAP" }
  
  # 2. Min rest check
  prevShift = getLastShiftBefore(userId, newShift.startAt)
  if prevShift and hoursBetween(prevShift.endAt, newShift.startAt) < minRestHours:
    return { valid: false, reason: "MIN_REST" }
  
  # 3. Max weekly hours check
  weeklyHours = getScheduledHoursInPayPeriod(userId, payPeriod)
  if weeklyHours + shiftDuration > maxWeeklyHours:
    return { valid: false, reason: "MAX_WEEKLY" }
  
  # 4. Pay period lock check
  if payPeriod.status in [CLOSED, EXPORTED]:
    return { valid: false, reason: "PAY_PERIOD_LOCKED" }
  
  return { valid: true }
```

## RBAC Matrix

| Endpoint | L1 | L2 | L3 | L4 | L5 |
|----------|----|----|----|----|-----|
| generate (UNASSIGNED) | ❌ | ❌ | ❌ | ✅ | ✅ |
| generate (ASSIGNED) | ❌ | ❌ | ❌ | ✅ | ✅ |
| get/list | ❌ | ❌ | ✅ | ✅ | ✅ |
| apply | ❌ | ❌ | ❌ | ✅ | ✅ |
| publish | ❌ | ❌ | ❌ | ✅ | ✅ |
| void | ❌ | ❌ | ❌ | ✅ | ✅ |

## Parity Checklist

| Feature | Target Behavior | Verification |
|---------|-----------------|--------------|
| Assignment determinism | Same inputs → same assignments | E2E: 2 calls same result |
| Constraint overlap | Skip if existing shift overlaps | E2E: create conflict first |
| Constraint min-rest | Skip if < minRestHours gap | E2E: create prior shift |
| Constraint max-weekly | Skip if exceeds threshold | E2E: pre-schedule hours |
| Pay period lock | Skip if period closed | E2E: close period first |
| Publish idempotency | Second call same result | E2E: call twice, count |
| Notification non-hang | Test completes in 30s | E2E: timeout compliance |
| Multi-branch isolation | No cross-branch data | E2E: 2-branch test |

## Files to Create/Modify

### New Files
- `services/api/src/workforce/workforce-constraints-evaluator.service.ts`
- `services/api/test/e2e/workforce-m1014-auto-scheduler-v2.e2e-spec.ts`
- `apps/web/src/__tests__/pages/workforce/m1014-auto-scheduler-v2.test.tsx`
- `packages/db/prisma/migrations/20260104210000_m1014_auto_scheduler_v2/`

### Modified Files
- `packages/db/prisma/schema.prisma`
- `services/api/src/workforce/workforce-auto-scheduler.service.ts`
- `services/api/src/workforce/workforce-auto-schedule-apply.service.ts`
- `services/api/src/workforce/workforce-auto-scheduler.controller.ts`
- `services/api/src/workforce/workforce.module.ts`
- `apps/web/src/pages/workforce/auto-scheduler.tsx`
