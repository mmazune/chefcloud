# M12.2 Parity Reaudit - InvenTree + Odoo Comparison

## Purpose

Deep-dive comparison for M12.2 Inventory Close Ops v2 features against InvenTree (MIT, adaptable) and Odoo (study-only, for patterns).

## Feature A: Pre-Close Check Engine

### InvenTree Pattern
- **Stock History**: InvenTree maintains append-only stock history
- **No Period Concept**: InvenTree doesn't have accounting periods
- **Validation**: Relies on real-time stock validation, no pre-close checks
- **Adaptation**: Invented feature - no direct equivalent

### Odoo Pattern  
- **Fiscal Periods**: Odoo has fiscal period locks
- **Lock Date**: Prevents posting before a certain date
- **Pre-close Checks**: Not explicit; lock simply prevents changes
- **Audit**: Activity tracking on period changes

### M12.2 Decision
- **Invented**: Pre-close check engine with blockers/warnings
- **Blockers**: Hard stops (stocktakes in progress, in-transit transfers)
- **Warnings**: Soft alerts (GL posting skipped, large deltas)
- **Evidence**: Sample IDs capped at 5, org-scoped

## Feature B: Period Auto-Generation

### InvenTree Pattern
- **No Periods**: No concept of inventory periods
- **N/A**: Nothing to adapt

### Odoo Pattern
- **Fiscal Periods**: Manual creation or fiscal year wizard
- **Auto-create**: Can generate periods for a fiscal year
- **Calendar-based**: Monthly/quarterly boundaries

### M12.2 Decision
- **Adapted from Odoo**: Calendar month boundaries
- **Idempotent**: Skip existing periods
- **Branch-scoped**: Each branch gets its own periods
- **Cap**: Max 24 months per request

## Feature C: Reopen Workflow + Event Log

### InvenTree Pattern
- **No Periods**: Nothing to reopen
- **Stock Adjustments**: Can add correcting entries anytime
- **History**: StockItemTracking model for history

### Odoo Pattern
- **Period Lock**: Once locked, requires special permissions to unlock
- **No Reopen**: Lock is permanent in strict mode
- **Audit Trail**: Activity log (mail.tracking.value)
- **Reason**: Not required for lock/unlock

### M12.2 Decision
- **L5-Only Reopen**: Higher than Odoo (requires owner-level)
- **Reason Required**: Audit trail with mandatory justification
- **Event Log**: Append-only InventoryPeriodEvent model
- **Revision Strategy**: Snapshot revisioning (keep all history)

## Feature D: Close Pack Export

### InvenTree Pattern
- **Stock Reports**: Part list export, stock history export
- **CSV/JSON**: Basic export formats
- **No Bundle**: Individual exports, no combined pack
- **No Hash**: No integrity verification

### Odoo Pattern
- **Inventory Reports**: Multiple report types (valuation, moves)
- **PDF/XLS**: Standard export formats
- **Trial Balance**: Closing entries report
- **No Bundle Hash**: No combined integrity check

### M12.2 Decision
- **Invented**: Close pack concept
- **Bundle Hash**: SHA-256 over normalized concatenated CSVs
- **Index CSV**: Manifest with individual + bundle hashes
- **Audit-grade**: Verifiable, deterministic exports

## Feature E: Web UI Enhancements

### InvenTree Pattern
- **Part Views**: Stock levels, history, adjustments
- **Bulk Actions**: Basic bulk operations
- **No Period UI**: N/A

### Odoo Pattern
- **Inventory Dashboard**: Stock valuation, moves
- **Period Lock UI**: Simple lock/unlock button
- **Reports**: Integrated reporting views

### M12.2 Decision
- **Self-Service**: Complete workflow in single page
- **Pre-close Panel**: Visual blocker/warning display
- **Generate Modal**: Batch period creation
- **Close Pack View**: All exports with verification

## Revision Strategy Deep Dive

### Options Considered

| Option | Pros | Cons | Decision |
|--------|------|------|----------|
| Overwrite | Simple, less storage | History loss | ❌ Rejected |
| Soft Delete | Keeps history | Complex queries | ❌ Rejected |
| Revisioning | Full audit, simple queries | More storage | ✅ Chosen |

### Revisioning Implementation
```prisma
model InventoryValuationSnapshot {
  // ... existing fields
  revision  Int  @default(1)
  
  @@unique([periodId, itemId, locationId, revision])
}

model InventoryPeriodMovementSummary {
  // ... existing fields
  revision  Int  @default(1)
  
  @@unique([periodId, itemId, revision])
}
```

### Query Pattern
```typescript
// Get latest revision snapshots
const snapshots = await prisma.inventoryValuationSnapshot.findMany({
  where: { periodId },
  orderBy: { revision: 'desc' },
  distinct: ['itemId', 'locationId'],
});
```

## Evidence Pointers

| Feature | InvenTree Source | Odoo Source |
|---------|-----------------|-------------|
| Stock History | `stock/models.py` StockItemTracking | `stock.move` model |
| Period Concept | N/A | `account.period` (deprecated) |
| Lock Mechanism | N/A | `account.move` state field |
| Export | Part CSV export | `ir.actions.report` |
| Audit | InvenTreeTree model tracking | `mail.tracking.value` |

## Summary Verdict

| Feature | InvenTree Parity | Odoo Parity | M12.2 Status |
|---------|-----------------|-------------|--------------|
| A) Pre-Close Check | Invented | Partial | ✅ Novel |
| B) Auto-Generate | N/A | Adapted | ✅ Enhanced |
| C) Reopen + Events | N/A | Partial | ✅ Enhanced |
| D) Close Pack | Invented | Invented | ✅ Novel |
| E) UI Enhancements | N/A | Partial | ✅ Enhanced |
