# M12.1 Hypotheses

## Pre-Implementation Hypotheses (MUST be written BEFORE code changes)

| ID | Hypothesis | Confidence | Failure Mode | Mitigation |
|----|------------|------------|--------------|------------|
| H1 | **Period boundary off-by-one**: endDate inclusivity causes missing/extra ledger entries if we use `< endDate` instead of `<= endDate + 23:59:59` | 85% | Snapshot misses entries on last day of period or includes entries from next period | Use `createdAt <= new Date(endDate.setHours(23, 59, 59, 999))` for boundary; test with entries exactly at midnight boundary |
| H2 | **Close is not idempotent**: Re-calling close duplicates valuation snapshots or movement summaries | 90% | Snapshot count doubles on retry; financial totals inflate | Check for existing CLOSED period with same params before creating; return existing if found |
| H3 | **Period lock blocks legitimate void/reversal flows**: Void operations create reversals (new ledger entries), but if reversal timestamp is in closed period, legitimate corrections blocked | 75% | Users cannot void/correct errors in historical periods | Reversals create NEW ledger entries with current timestamp, not historical; verify this pattern exists |
| H4 | **Reconciliation double-counts journals**: GL reconciliation joins incorrectly causing same journal entry to be counted multiple times | 80% | Reconciliation shows inflated GL totals; false WARN/FAIL status | Use DISTINCT on journalEntryId; verify no duplicate links in test data |
| H5 | **Export hash mismatch on Windows**: BOM + CRLF vs LF causes hash mismatch when client computes hash | 90% | Hash header doesn't match client-side computation | Normalize to LF before hashing (same as M10.19/M10.20 pattern) |
| H6 | **Cross-tenant leakage in period queries**: Missing orgId in WHERE clause allows one org to see another's periods or override another's lock | 95% | Security breach; audit failure | Always include orgId in all queries; E2E test with two orgs |
| H7 | **Close ignores in-transit transfers**: Transfers IN_TRANSIT at endDate boundary cause valuation to miss goods that are logically "owned" | 70% | Valuation undercounts inventory; reconciliation shows delta | Block close if IN_TRANSIT transfers older than endDate; document as blocking state |
| H8 | **Tests hang due to app/server not closing**: E2E tests don't properly close NestJS app or leave open handles | 90% | CI hangs; --forceExit required | Use proper afterAll cleanup; no setInterval/setTimeout in test code |
| H9 | **Branch validation missing**: Close operation doesn't verify branchId belongs to orgId | 85% | Cross-org branch manipulation possible | Explicit branch.findFirst({ where: { id: branchId, orgId } }) check |
| H10 | **Decimal precision loss in aggregation**: SUM over ledger entries loses precision due to JavaScript float conversion | 75% | Valuation totals don't match exact ledger sums | Use Prisma Decimal throughout; cast only at export boundary |

## Hypothesis Coverage by Feature

| Feature | Covered By |
|---------|------------|
| A) Inventory Period Model | H1, H2, H6, H9 |
| B) Period Lock Enforcement | H3, H6 |
| C) Close Operation | H1, H2, H7, H9, H10 |
| D) GL Reconciliation | H4, H6 |
| E) Exports | H5 |
| F) Web UI | (UI tests) |
| Testing Infrastructure | H8 |

## Validation Plan

Each hypothesis must be explicitly validated during implementation:

- **H1**: Unit test with entries at 00:00:00 and 23:59:59 of endDate
- **H2**: E2E test calling close twice; assert snapshot count unchanged
- **H3**: Document void flow pattern; verify reversals use current timestamp
- **H4**: E2E test with seeded GL journals; verify no duplicates
- **H5**: E2E test export hash; verify BOM present and hash matches
- **H6**: E2E test with two orgs; verify isolation
- **H7**: Block close if IN_TRANSIT transfers exist; document blocking state
- **H8**: Run with --detectOpenHandles; no forceExit
- **H9**: E2E test close with invalid branchId for org; expect 404
- **H10**: Verify Decimal types in service; compare valuation to manual sum
