# M13.5 POS Finalization Dossier

**Milestone**: M13.5 POS Finalization v1  
**Status**: In Progress  
**Date**: 2026-01-08

---

## Executive Summary

M13.5 completes the POS payments layer with split/partial payments, tips, order settlement tracking, and end-of-day (Z-report) reporting. This brings NimbusPOS to restaurant-grade operational readiness for payment handling.

---

## Feature Scope

### A) Split / Partial Payments
Allow multiple payments per order until `dueCents == 0`.

### B) Tips (v1)
Record tips on payments without affecting order total or dueCents.

### C) Order Settlement State  
Track `paymentStatus` on orders: UNPAID → PARTIALLY_PAID → PAID → REFUNDED.

### D) Z-Report (End-of-Day Reporting)
Provide totals, breakdowns, and CSV exports for end-of-day reconciliation.

---

## Feature-Level Parity Matrix

### A) Split / Partial Payments

| Behavior | Square | Toast | Medusa (MIT) | NimbusPOS M13.5 Decision |
|----------|--------|-------|--------------|--------------------------|
| Multiple payments per order | ✅ "Split Tender" | ✅ "Split Payment" | ✅ via multiple captures | ✅ Allow multiple Payment records per orderId |
| Partial payment creation | ✅ amountMoney <= remainingBalance | ✅ amount <= due | ✅ capture partial amounts | ✅ `amountCents <= dueCents` validation |
| Overpayment handling | ❌ Blocked; change given separately | ❌ Blocked | ❌ Blocked | ❌ Block overpayment; DEFER change logic |
| Due calculation | `total - SUM(captured)` | `total - SUM(paid)` | Manual via cart totals | `orderTotalCents - SUM(capturedCents - refundedCents)` |
| Idempotency on creation | ✅ idempotency_key | ✅ externalId | ✅ idempotency_key | ✅ `@@unique([orgId, idempotencyKey])` |
| Receipt issuance condition | Only when tender complete | Only when paid in full | N/A | Only when `dueCents == 0` |

**Nimbus Decision**: 
- Remove M13.4's `AMOUNT_MISMATCH` check that required exact total
- Add `dueCents` calculation in service with transaction safety
- Block `amountCents > dueCents` with code `OVERPAYMENT_NOT_ALLOWED`

### B) Tips

| Behavior | Square | Toast | Medusa (MIT) | NimbusPOS M13.5 Decision |
|----------|--------|-------|--------------|--------------------------|
| Tip field on payment | ✅ `tip_money` | ✅ `tipAmount` | ❌ Custom metadata | ✅ Add `tipCents` to Payment |
| Tip timing | On create or on capture | On capture typically | N/A | On create (preferred for simplicity) |
| Tip contributes to due | ❌ Tips are extra | ❌ Tips are extra | N/A | ❌ Tips do NOT reduce dueCents |
| Tip limits | Provider-defined | Provider-defined | N/A | ✅ Max 500% of orderTotal to prevent abuse |
| Tip in receipt | ✅ Shown separately | ✅ Shown separately | N/A | ✅ Add `tipCentsTotal` to snapshot |
| Tip in reports | ✅ Breakdown available | ✅ Breakdown available | N/A | ✅ Included in Z-report |

**Nimbus Decision**:
- Add `tipCents Int @default(0)` to Payment model
- Validate `tipCents >= 0 && tipCents <= 5 * orderTotalCents`
- Aggregate `tipCentsTotal` in receipt snapshot and Z-report

### C) Order Settlement State

| Behavior | Square | Toast | Medusa (MIT) | NimbusPOS M13.5 Decision |
|----------|--------|-------|--------------|--------------------------|
| Payment status on order | ✅ OPEN/COMPLETED | ✅ UNPAID/PARTIAL/PAID | ❌ Cart status only | ✅ Add `paymentStatus` enum |
| Status transitions | Automatic on tender | Automatic on payment | Manual | Automatic on capture/refund |
| KDS affected by payment | ❌ Separate lifecycle | ❌ Separate lifecycle | N/A | ❌ KDS uses `OrderStatus`; paymentStatus is separate |
| Refund resets status | To REFUNDED if fully refunded | Yes | N/A | ✅ REFUNDED if `SUM(refundedCents) >= SUM(capturedCents)` |

**Nimbus Decision**:
- Add `paymentStatus` enum: `UNPAID | PARTIALLY_PAID | PAID | REFUNDED`
- Default `UNPAID`; update in transaction with capture/refund
- Keep separate from `OrderStatus` (NEW/SENT/READY/SERVED/CLOSED/VOIDED)

### D) Z-Report (End-of-Day)

| Behavior | Square | Toast | Medusa (MIT) | NimbusPOS M13.5 Decision |
|----------|--------|-------|--------------|--------------------------|
| Gross sales calculation | SUM of order totals | SUM of paid orders | N/A | SUM of `order.total` for PAID orders in range |
| Refunds tracking | Separate line | Separate line | N/A | SUM of `refundedCents` in range |
| Net sales | gross - refunds | gross - refunds | N/A | `grossSalesCents - refundsCents` |
| Tips tracking | Separate line | Separate line | N/A | SUM of `tipCents` in range |
| Payment method breakdown | ✅ Cash/Card/Other | ✅ Cash/Card/Gift | N/A | ✅ By PaymentMethod enum |
| Cash session integration | ✅ Drawer sessions | ✅ Drawer sessions | N/A | ✅ Include session counts/variance |
| Export format | PDF/CSV | PDF/CSV | N/A | CSV with UTF-8 BOM + SHA-256 hash |
| Deterministic export | N/A | N/A | N/A | ✅ Ordered by date, branch, category |

**Nimbus Decision**:
- Add `GET /pos/reports/z` returning structured totals
- Add `GET /pos/export/z-report.csv` with BOM + hash header
- Filter by `from`, `to`, `branchId` (all required for determinism)

---

## Data Model Changes

### Payment (extended)
```prisma
model Payment {
  // ... existing fields ...
  tipCents      Int @default(0)  // M13.5: Tip amount in cents
}
```

### Order (extended)
```prisma
enum OrderPaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  REFUNDED
}

model Order {
  // ... existing fields ...
  paymentStatus OrderPaymentStatus @default(UNPAID) // M13.5
}
```

---

## API Endpoints

### New/Modified Endpoints

| Method | Path | RBAC | Description |
|--------|------|------|-------------|
| POST | `/pos/orders/:id/payments` | L2+ | Create payment (now supports partial) |
| GET | `/pos/orders/:id/payment-summary` | L1+ | Get totals, paid, due, tip, payments |
| GET | `/pos/reports/z` | L4+ | Z-report totals for date range |
| GET | `/pos/export/z-report.csv` | L4+ | CSV export with hash |

---

## Settlement Invariants

1. `orderTotalCents` is immutable (from order.total snapshot)
2. `paidCents = SUM(capturedCents - refundedCents)` for order
3. `dueCents = max(0, orderTotalCents - paidCents)`
4. Overpayment is blocked: `amountCents > dueCents` → 400/409
5. Receipt issuance requires `dueCents == 0`
6. Tips do NOT affect dueCents calculation
7. `paymentStatus` transitions automatically based on paidCents vs orderTotalCents

---

## Security Considerations

- All operations require org/branch scoping
- Transactional updates for capture/refund to prevent race conditions
- Tip upper bound prevents abuse (500% of order total)
- Z-report export requires L4+ (management only)
- Idempotency prevents duplicate payment creation

---

## References

- Square Split Tender: https://developer.squareup.com/docs/payments-api/take-payments
- Toast Split Payment: https://doc.toasttab.com/openapi/orders/
- Medusa Payment Capture: https://github.com/medusajs/medusa (MIT)
