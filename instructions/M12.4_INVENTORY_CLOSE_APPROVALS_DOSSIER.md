# M12.4 Inventory Close Approvals + Dashboard + Alerts - Feature Dossier

**Milestone**: M12.4  
**Date**: 2026-01-07  
**Status**: In Progress  
**Prior Commit**: `2208e7e` (M12.3)

---

## Scope Summary

M12.4 delivers:

1. **M12.2 Closure** - Verify and close out any remaining M12.2 issues
2. **PRE-015 Resolution** - Fix test files using removed `type` field
3. **Period Close Approval Workflow** - Require L5 approval before closing periods
4. **Multi-Branch Close Dashboard** - Aggregated ops view of period status
5. **Notifications/Alerts** - Integrate with existing InventoryAlert system

---

## Feature Group C: Period Close Approval Workflow

### InvenTree Comparison (MIT)

InvenTree's cycle count close workflow:
- Stock counts can be "submitted" for review
- Managers approve/reject counts before adjustments are posted
- Full audit trail via StockHistoryTracker
- Uses status enum: DRAFT → SUBMITTED → APPROVED/REJECTED

### Nimbus Existing Patterns

1. **StocktakeSession** (M11.10) uses similar workflow:
   ```
   DRAFT → IN_PROGRESS → SUBMITTED → APPROVED → POSTED/CANCELLED
   ```
   - L4 creates session, L5 approves posting

2. **Workforce Swaps** (M10.11):
   ```
   PENDING → APPROVED/REJECTED
   ```
   - Employee submits, manager approves

3. **Leave Requests** (M10.x):
   ```
   PENDING → APPROVED/REJECTED/CANCELLED
   ```

4. **Timesheet Approvals** (M10.3):
   - Two-step approval: APPROVED_STEP1 → APPROVED
   - Uses TimesheetApproval model with approvedById, approvedAt

### Nimbus M12.4 Decision

**New Model: InventoryPeriodCloseRequest**

```prisma
enum InventoryPeriodCloseRequestStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

model InventoryPeriodCloseRequest {
  id              String                            @id @default(cuid())
  orgId           String
  branchId        String
  periodId        String                            @unique // One request per period
  status          InventoryPeriodCloseRequestStatus @default(DRAFT)
  requestedById   String
  requestedAt     DateTime?
  approvedById    String?
  approvedAt      DateTime?
  approvalNotes   String?
  rejectionReason String?
  createdAt       DateTime                          @default(now())
  updatedAt       DateTime                          @updatedAt
  
  // Relations
  org         Org             @relation(...)
  branch      Branch          @relation(...)
  period      InventoryPeriod @relation(...)
  requestedBy User            @relation(...)
  approvedBy  User?           @relation(...)
}
```

**Rules:**
- L4+ can create/submit requests
- L5+ can approve/reject
- Closing a period requires APPROVED request OR L5 forceClose with reason ≥10 chars
- All actions write InventoryPeriodEvent entries

---

## Feature Group D: Multi-Branch Close Dashboard

### Existing Dashboard Patterns in Nimbus

1. **Franchise Dashboard** (`/franchise/dashboard`):
   - Multi-branch aggregation per org
   - Shows KPIs per branch
   - Uses summary endpoints returning array of branch rows

2. **Workforce Dashboard** patterns:
   - Policy compliance matrix (per-branch status)
   - Schedule overview (per-branch)

### InvenTree Comparison

InvenTree does not have a dedicated "close dashboard" - their focus is on individual stock count workflows. Nimbus needs enterprise multi-branch visibility.

### Nimbus M12.4 Decision

**Dashboard Endpoint**: `GET /inventory/periods/dashboard`

Query params: `orgId`, `from`, `to`, `branchId` (optional filter)

Response per branch:
```typescript
interface PeriodDashboardRow {
  branchId: string;
  branchName: string;
  currentPeriod: {
    id: string;
    startDate: Date;
    endDate: Date;
    status: 'OPEN' | 'CLOSED';
  } | null;
  precloseStatus: 'READY' | 'BLOCKED' | 'WARNING' | 'NOT_RUN';
  blockerSummary: string[];
  lastClosePack: {
    hash: string;
    generatedAt: Date;
  } | null;
  closeRequest: {
    id: string;
    status: string;
  } | null;
  lastEvent: {
    type: string;
    occurredAt: Date;
    actorName: string;
  } | null;
}
```

---

## Feature Group E: Notifications/Alerts

### Existing InventoryAlert Framework (M11.12)

**Current alert types:**
- DEAD_STOCK
- EXPIRY_SOON
- EXPIRED
- BELOW_REORDER_POINT
- HIGH_WASTE
- HIGH_VARIANCE

**Alert lifecycle:**
- OPEN → ACKNOWLEDGED → RESOLVED
- Unique constraint: `[orgId, branchId, type, entityType, entityId, status]`
- Idempotent: duplicate OPEN alerts are skipped via upsert

### InvenTree Comparison

InvenTree uses Django signals to trigger notifications on model changes. No dedicated "period close blocked" alerts.

### Nimbus M12.4 Decision

**Add new InventoryAlertType values:**
```prisma
enum InventoryAlertType {
  // Existing...
  PERIOD_CLOSE_BLOCKED      // Preclose returned blockers
  PERIOD_CLOSE_APPROVAL_REQ // Close request submitted, needs L5 action
}
```

**Alert creation points (no cron):**

1. When `runPreclose()` returns `BLOCKED`:
   - Create/update idempotent alert: type=PERIOD_CLOSE_BLOCKED, entityType=PERIOD, entityId=periodId
   - Severity: CRITICAL if >5 blockers, else WARN

2. When close request `SUBMITTED`:
   - Create alert: type=PERIOD_CLOSE_APPROVAL_REQ
   - Severity: WARN

3. When request `APPROVED` / `REJECTED` / period `CLOSED`:
   - Resolve related OPEN alerts

---

## Org/Branch Scoping Invariants

All queries MUST include:
- `orgId` from authenticated user context
- `branchId` where entity is branch-scoped

Period lock enforcement from M12.3 remains intact - effectiveAt field and 403 INVENTORY_PERIOD_LOCKED on all inventory write paths.

---

## File Changes Summary (Planned)

### New Files:
- `packages/db/prisma/migrations/20260107230000_m124_close_requests/migration.sql`
- `services/api/src/inventory/inventory-close-requests.service.ts`
- `services/api/src/inventory/inventory-close-requests.controller.ts`
- `services/api/src/inventory/inventory-period-dashboard.service.ts`
- `services/api/test/e2e/inventory-m124-close-approvals-dashboard.e2e-spec.ts`
- `apps/web/src/pages/inventory/periods/dashboard.tsx`
- `apps/web/src/__tests__/pages/inventory/m124-inventory-close-dashboard.test.tsx`
- `instructions/M12.4_HYPOTHESES.md`
- `instructions/M12.4_PARITY_REAUDIT.md`
- `instructions/M12.4_COMPLETION_REPORT.md`

### Modified Files:
- `packages/db/prisma/schema.prisma` - Add InventoryPeriodCloseRequest model + alert type enum values
- `services/api/src/inventory/inventory-periods.controller.ts` - Add dashboard endpoint
- `services/api/src/inventory/inventory-periods.service.ts` - Integrate approval gating
- `services/api/src/inventory/inventory-alerts.service.ts` - Add period close alert methods
- `services/api/src/inventory/inventory.module.ts` - Register new services
- `PRE_EXISTING_ISSUES_LOG.md` - Mark PRE-015 resolved

---

## Evidence Pointers

| Feature | Reference | Decision |
|---------|-----------|----------|
| Approval workflow | StocktakeSession status enum (schema.prisma L154-156) | Use same pattern |
| Multi-branch dashboard | Franchise dashboard service pattern | Aggregate per-branch |
| Alert idempotency | InventoryAlert unique constraint (schema.prisma L7103) | Extend with new types |
| Period events | InventoryPeriodEvent model (schema.prisma L7227) | Log all request actions |

---

**Report Generated**: 2026-01-07  
**Agent**: GitHub Copilot (Claude Opus 4.5)
