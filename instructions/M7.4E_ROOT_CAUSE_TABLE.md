# M7.4E Root Cause Classification Table

> **Date:** 2025-12-24
> **Purpose:** Classify each failure into a bucket and document the fix

---

## Classification Buckets

| Bucket | Description | Count |
|--------|-------------|-------|
| (1) RBAC Mismatch | Verifier expects different RBAC level than backend | 8 |
| (2) Missing/Incorrect Params | DTO validation fails due to wrong param names | 3 |
| (3) Wrong Endpoint Path | 404 - endpoint doesn't exist at that path | 0 |
| (4) Branch/Org Scoping | 200 but empty due to scoping issues | 0 |
| (5) Seed Data Missing | Module not seeded for one org | 3 |
| (6) Backend Bug | 500 error or logic error | 0 |

---

## Detailed Root Cause Table

| # | Endpoint | Roles Affected | Status | Bucket | Root Cause | Fix |
|---|----------|----------------|--------|--------|------------|-----|
| 1 | `GET /inventory/levels` | Tapas L2 (Supervisor, Cashier, Chef) | 403 | (1) | Backend: `@Roles('L3')`, Verifier: `minLevel: 'L2'` | Change verifier to `minLevel: 'L3'` |
| 2 | `GET /inventory/levels` | Cafesserie L2 (Supervisor, Cashier, Chef) | 403 | (1) | Same as above | Same fix |
| 3 | `GET /franchise/rankings` | Cafesserie L4 (Manager, Accountant) | 403 | (1) | Backend: `@Roles('L5')`, Verifier: `minLevel: 'L4'` | Change verifier to `minLevel: 'L5'` |
| 4 | `GET /hr/employees` | Cafesserie L4/L5 (Owner, Manager, Accountant) | 200 Empty | (5) | `seedEmployees()` only seeds Tapas org | Add Cafesserie employees to seed |
| 5 | `GET /franchise/analytics/overview` | Cafesserie L4/L5 | 400 | (2) | Verifier sends `{from, to}`, DTO expects `{startDate, endDate}` | Change verifier params |

---

## Fix Plan

### Fix 1: RBAC Mismatch - Inventory Levels
**File:** `scripts/verify-role-coverage.ts`
**Line:** L2_ENDPOINTS definition
**Change:**
```typescript
// Before
{ endpoint: '/inventory/levels', method: 'GET', minLevel: 'L2', description: 'Inventory levels' },

// After - Move to L3_ENDPOINTS
// Remove from L2_ENDPOINTS, already in L3_ENDPOINTS
```

### Fix 2: RBAC Mismatch - Franchise Rankings  
**File:** `scripts/verify-role-coverage.ts`
**Line:** FRANCHISE_ENDPOINTS definition
**Change:**
```typescript
// Before
{ endpoint: '/franchise/rankings', method: 'GET', params: { period: getCurrentPeriod() }, minLevel: 'L4', description: 'Branch rankings' },

// After
{ endpoint: '/franchise/rankings', method: 'GET', params: { period: getCurrentPeriod() }, minLevel: 'L5', description: 'Branch rankings' },
```

### Fix 3: Seed Data Missing - Cafesserie Employees
**File:** `services/api/prisma/demo/seedComprehensive.ts`
**Function:** `seedEmployees()`
**Change:** Add Cafesserie org employees (mirror Tapas pattern)

### Fix 4: DTO Param Mismatch - Franchise Overview
**File:** `scripts/verify-role-coverage.ts`
**Line:** FRANCHISE_ENDPOINTS definition
**Change:**
```typescript
// Before
{ endpoint: '/franchise/analytics/overview', method: 'GET', params: { from: getDateDaysAgo(30), to: getTodayISO() }, minLevel: 'L4', description: 'Franchise overview' },

// After
{ endpoint: '/franchise/analytics/overview', method: 'GET', params: { startDate: getDateDaysAgoYYYYMMDD(30), endDate: getTodayYYYYMMDD() }, minLevel: 'L4', description: 'Franchise overview' },
```

---

## Accounting Fix

Current summary math doesn't add up:
- Total: 204
- Passed: 184 (90.2%)
- Failed: 11 (5.4%)
- RBAC Denied: 0 (0.0%)
- Errors: 9 (4.4%)

184 + 11 + 0 + 9 = 204 âœ“ (math is correct)

But the verifier should:
1. Track `totalPlanned` separately from `totalExecuted`
2. Track `skipped` with reasons
3. Output reconciliation table
