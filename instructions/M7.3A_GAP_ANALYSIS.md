# M7.3A Gap Analysis - Seed Completeness Issues

**Date:** 2025-12-23  
**Status:** Analysis Complete - Ready for Fixes

---

## Executive Summary

Analysis of current seeding code reveals that **order seeding is mostly complete** for Tapas org in `seedComprehensive.ts`, but has several critical gaps:

1. **✅ GOOD:** Orders already include orderItems and payments (lines 550-680)
2. **❌ GAP:** Cafesserie branches have NO orders seeded
3. **❌ GAP:** No OPEN orders for POS "live" feeling
4. **❌ GAP:** `seed-demo-orders.ts` creates orders WITHOUT orderItems/payments
5. **⚠️ INCONSISTENT:** Payment status uses lowercase "completed" vs backend might expect uppercase

---

## Detailed Findings

### 1. Current Tapas Seeding (seedComprehensive.ts)

**Location:** `services/api/prisma/demo/seedComprehensive.ts:550-680`

**What Works:**
```typescript
// ✅ Creates 8-12 orders per day for last 30 days
// ✅ Each order has 2-5 orderItems with menu items
// ✅ Each order has 1 payment (CASH/CARD/MOMO mix)
// ✅ Payment status: "completed"
// ✅ Order status: "CLOSED"
```

**Code Snippet:**
```typescript
for (let daysAgo = 30; daysAgo >= 0; daysAgo--) {
  const orderDate = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);
  const ordersToday = dayOfWeek === 0 || dayOfWeek === 6 ? 12 : 8;
  
  for (let orderNum = 0; orderNum < ordersToday; orderNum++) {
    // Creates order with:
    - orderItems (2-5 items)
    - subtotal, tax, total calculations
    - payment with method CASH/CARD/MOMO
    - payment status: "completed"
```

**Counts Expected:**
- Orders: ~300 (30 days × 10 avg)
- OrderItems: ~1000 (300 orders × 3.5 avg items)
- Payments: ~300 (1 per order)

---

### 2. ❌ GAP: Cafesserie Has No Orders

**Issue:** `seedComprehensive.ts` only creates orders for Tapas org (ORG_TAPAS_ID).

**Missing:**
- Cafesserie Village Mall branch: 0 orders
- Cafesserie Acacia Mall branch: 0 orders
- Cafesserie Arena Mall branch: 0 orders
- Cafesserie Mombasa branch: 0 orders

**Impact:**
- `/analytics/daily-metrics` returns empty for Cafesserie
- Franchise rankings show all branches with 0 revenue
- Dashboard charts empty for Cafesserie users
- POS has no order history

**Fix Required:**
- Duplicate Tapas order logic for each Cafesserie branch
- Use Cafesserie menu items (already seeded)
- Use Cafesserie users (already seeded)
- Maintain deterministic IDs per branch

---

### 3. ❌ GAP: No OPEN Orders

**Issue:** All seeded orders have `status: 'CLOSED'` - none are OPEN.

**Impact:**
- POS screens show empty "Active Orders" list
- Dashboard doesn't feel "live"
- Staff Insights has no current shift orders
- Testing POS workflows requires manual order creation

**Expected:**
- 5-20 OPEN orders per branch within last 24h
- Mix of statuses: NEW, SENT, SERVED (but not CLOSED)
- Orders should have orderItems but may lack payments
- Should be visible in POS kanban view

**Reference:** `services/api/prisma/demo/seedOrders.ts` (V2.1.1 Patch) creates OPEN orders but has other issues.

---

### 4. ❌ GAP: seed-demo-orders.ts Creates Incomplete Orders

**File:** `services/api/prisma/tapas/seed-demo-orders.ts`

**Issues:**
```typescript
// ❌ Creates orders without orderItems
// ❌ Creates orders without payments
// ❌ Uses Math.random() (non-deterministic)
// ❌ For demo-restaurant org (different from Tapas/Cafesserie)
```

**Code Evidence (lines 1-100):**
```typescript
const orders: any[] = [];
for (let daysAgo = 0; daysAgo < 30; daysAgo++) {
  const ordersPerDay = randomBetween(15, 40); // ❌ Non-deterministic!
  
  orders.push({
    // ... order data
  });
}
// ❌ No orderItems created
// ❌ No payments created
```

**Status:** This file appears to be for a different org and should likely be removed or refactored.

---

### 5. ⚠️ Payment Status String Case

**Current:** `status: "completed"` (lowercase)

**Schema:** `status String @default("pending") // pending, completed, failed, refunded`

**Backend Filters:** Need to verify if analytics endpoints filter by exact string match.

**Potential Issue:**
If backend does: `WHERE status = 'COMPLETED'` but seed uses `"completed"`, payments won't match.

**Fix:** 
- Standardize on lowercase (matches schema default)
- Verify backend analytics queries use lowercase
- If backend uses uppercase, fix seeding to match

---

## Schema Validation

### Order Model
```prisma
model Order {
  id String @id
  branchId String  // ✅ Set in seed
  userId String    // ✅ Set in seed
  status String    // ✅ "CLOSED" in seed
  // ... other fields
  orderItems OrderItem[]  // ✅ Created in seed
  payments Payment[]      // ✅ Created in seed
}
```

### OrderItem Model
```prisma
model OrderItem {
  id String @id
  orderId String      // ✅ References order
  menuItemId String   // ✅ References menu
  quantity Int        // ✅ Set (1-2)
  price Decimal       // ✅ From menuItem.price
  subtotal Decimal    // ✅ price × quantity
}
```

### Payment Model
```prisma
model Payment {
  id String @id
  orderId String         // ✅ References order
  method PaymentMethod   // ✅ CASH/CARD/MOMO
  status String          // ✅ "completed"
  amount Decimal         // ✅ Matches order.total
}
```

**Result:** Schema matches - all required fields are being set correctly for Tapas.

---

## Date Range Analysis

**Seeded Date Range:** Last 30 days from `new Date()`

**UI Default Queries:**
- Dashboard: 7 or 30 days (depends on preset)
- Analytics: 7/30/90 days

**Compatibility:** ✅ **GOOD** - 30-day seed overlaps all UI defaults

**Recommendation:** Extend to 90 days for Tapas (as per SEEDING_REFERENCE.md) to support longer analytics queries.

---

## Determinism Check

**Current Seed (seedComprehensive.ts):**

❌ **NOT DETERMINISTIC:**
```typescript
// Line 579: Math.random() used for item selection
const selectedItems = tapasMenuItems
  .sort(() => Math.random() - 0.5)
  .slice(0, numItems);

// Line 585: Math.random() for quantity
const quantity = 1 + Math.floor(Math.random() * 2);

// Line 621: Math.random() for table selection
const tableId = TABLE_IDS.TAPAS[Math.floor(Math.random() * TABLE_IDS.TAPAS.length)];

// Line 643: Math.random() for payment method
const paymentMethods = ['CASH', 'CARD', 'MOMO'] as const;
await prisma.payment.upsert({
  method: paymentMethods[Math.floor(Math.random() * 3)],
  // ...
});
```

**Impact:**
- Running seed twice produces different order contents
- Record counts same but specific items/methods vary
- Not ideal for testing but acceptable for demo

**Recommendation:** Use seeded RNG from `test/helpers/seeded-rng.ts` for determinism.

---

## API Endpoint Impact

### Endpoints That Need Data

| Endpoint | Requires | Current Status (Tapas) | Current Status (Cafesserie) |
|----------|----------|------------------------|---------------------------|
| `/analytics/daily-metrics` | Orders with payments | ✅ Should work | ❌ Empty (no orders) |
| `/analytics/top-items` | OrderItems | ✅ Should work | ❌ Empty |
| `/analytics/category-mix` | OrderItems with categories | ✅ Should work | ❌ Empty |
| `/analytics/payment-mix` | Payments | ✅ Should work | ❌ Empty |
| `/analytics/peak-hours` | Orders with timestamps | ✅ Should work | ❌ Empty |
| `/franchise/rankings` | Orders per branch | ❌ Only Tapas (not franchise) | ❌ All branches empty |
| `/pos/orders/active` | OPEN orders | ❌ Empty (no OPEN orders) | ❌ Empty |

---

## Required Fixes

### Priority 1: Add Cafesserie Branch Orders (Critical)

**Task:** Duplicate order seeding logic for each Cafesserie branch.

**Implementation:**
```typescript
// For each Cafesserie branch:
const cafesserieBranches = [
  { id: BRANCH_CAFE_VILLAGE_MALL_ID, name: 'Village Mall' },
  { id: BRANCH_CAFE_ACACIA_MALL_ID, name: 'Acacia Mall' },
  { id: BRANCH_CAFE_ARENA_MALL_ID, name: 'Arena Mall' },
  { id: BRANCH_CAFE_MOMBASA_ID, name: 'Mombasa' },
];

for (const branch of cafesserieBranches) {
  await seedOrdersForBranch(prisma, {
    orgId: ORG_CAFESSERIE_ID,
    branchId: branch.id,
    users: cafesserieUsers,
    menuItems: cafesserieMenuItems,
    tables: cafesserieTables[branch.id],
    daysBack: 30,
    ordersPerDay: 8-12,
  });
}
```

**Expected Counts:**
- Village Mall: ~300 orders, ~1000 orderItems, ~300 payments
- Acacia Mall: ~300 orders, ~1000 orderItems, ~300 payments
- Arena Mall: ~300 orders, ~1000 orderItems, ~300 payments
- Mombasa: ~300 orders, ~1000 orderItems, ~300 payments
- **Total:** ~1200 orders, ~4000 orderItems, ~1200 payments

---

### Priority 2: Add OPEN Orders (High)

**Task:** Create 5-20 OPEN orders per branch within last 24 hours.

**Implementation:**
```typescript
await seedOpenOrders(prisma, {
  branchId,
  users: branchUsers,
  menuItems: branchMenuItems,
  tables: branchTables,
  hoursBack: 24,
  count: 10-15,
  statuses: ['NEW', 'SENT', 'SERVED'], // Not CLOSED
});
```

**Characteristics:**
- Created within last 24h
- Mix of NEW (just created), SENT (sent to kitchen), SERVED (ready for payment)
- Have orderItems but NO payments (orders not paid yet)
- Should appear in POS active orders view

**Expected Counts:**
- Tapas: ~12 OPEN orders
- Village Mall: ~12 OPEN orders
- Acacia Mall: ~12 OPEN orders
- Arena Mall: ~12 OPEN orders
- Mombasa: ~12 OPEN orders
- **Total:** ~60 OPEN orders

---

### Priority 3: Standardize Payment Status (Medium)

**Task:** Verify backend analytics queries use lowercase "completed".

**Check Files:**
- `services/api/src/analytics/analytics.service.ts`
- `services/api/src/analytics/analytics.controller.ts`

**If Mismatch Found:**
- Option A: Change seed to use uppercase "COMPLETED"
- Option B: Change backend to use lowercase "completed"

**Recommendation:** Keep lowercase (matches schema default).

---

### Priority 4: Make Seeding Deterministic (Nice-to-Have)

**Task:** Replace Math.random() with seeded RNG.

**Implementation:**
```typescript
import { SeededRNG } from '../../test/helpers/seeded-rng';
const rng = new SeededRNG('m7-3a-orders');

// Instead of Math.random()
const quantity = 1 + Math.floor(rng.next() * 2);
const tableIndex = Math.floor(rng.next() * tables.length);
```

---

## Verification Checklist

After implementing fixes, verify:

### Debug Endpoint
```bash
GET /debug/demo-health?from=2025-11-23&to=2025-12-23
```

**Expected Output:**
```json
{
  "org": { "name": "Tapas Bar Kololo" },
  "counts": {
    "orders": 300,
    "orderItems": 1050,
    "payments": 300,
    "feedback": 30
  },
  "byBranch": [
    { "branchId": "...", "orderCount": 300, "paymentCount": 300 }
  ]
}
```

### Analytics Endpoints
```bash
GET /analytics/top-items?from=...&to=...&branchId=...
# Expected: >= 10 items

GET /analytics/category-mix?from=...&to=...&branchId=...
# Expected: >= 6 categories

GET /analytics/payment-mix?from=...&to=...&branchId=...
# Expected: >= 2 methods (CASH, CARD, or MOMO)

GET /analytics/peak-hours?from=...&to=...&branchId=...
# Expected: 24 hours with non-zero values
```

### POS Endpoints
```bash
GET /pos/orders?status=NEW,SENT,SERVED
# Expected: >= 5 OPEN orders per branch
```

---

## Files to Modify

1. **`services/api/prisma/demo/seedComprehensive.ts`**
   - Extract order seeding to reusable function
   - Add Cafesserie branch order seeding
   - Add OPEN order seeding
   - Verify payment status strings

2. **`services/api/prisma/tapas/seed-demo-orders.ts`** (Optional)
   - Remove or mark as deprecated
   - Currently creates incomplete orders for wrong org

3. **`services/api/src/analytics/analytics.service.ts`** (Verification Only)
   - Check if payment status filters use lowercase "completed"
   - If uppercase "COMPLETED", document the fix needed

---

## Success Criteria

M7.3A is complete when:

- ✅ All Cafesserie branches have 250+ CLOSED orders with orderItems + payments
- ✅ All branches (Tapas + Cafesserie) have 5-15 OPEN orders
- ✅ `/analytics/top-items` returns >= 10 items for all branches
- ✅ `/analytics/category-mix` returns >= 6 categories for all branches
- ✅ `/analytics/payment-mix` returns >= 2 methods for all branches
- ✅ `/analytics/peak-hours` has non-zero values for peak times
- ✅ `/pos/orders?status=NEW,SENT,SERVED` returns >= 5 orders per branch
- ✅ `/debug/demo-health` shows orderItems > 0 and payments > 0
- ✅ Seed is idempotent (run twice: counts identical)

---

**Next Steps:** Implement fixes in seedComprehensive.ts and verify with API running.

**Estimated Changes:** ~300 lines of code (extracting to functions + adding Cafesserie + adding OPEN orders)

---

**Document Version:** 1.0  
**Created By:** GitHub Copilot  
**Last Updated:** 2025-12-23
