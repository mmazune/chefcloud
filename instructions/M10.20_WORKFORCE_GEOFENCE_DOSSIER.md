# M10.20 Workforce Geo-Fence Enforcement Feature Dossier

## Overview
M10.20 implements enterprise-grade geo-fence enforcement for workforce timeclock operations, including manager override workflows and operational reporting.

## Feature Groups

### A) Branch Geo-Fence Configuration
- **Model**: BranchGeoFence
- **Fields**:
  - orgId, branchId (unique per branch)
  - enabled (boolean)
  - centerLat, centerLng (decimal coordinates)
  - radiusMeters (int)
  - enforceClockIn, enforceClockOut (boolean flags)
  - allowManagerOverride (boolean, default true)
  - maxAccuracyMeters (int, default 100)
  - createdById, updatedById, timestamps
- **Endpoints**: CRUD at `/workforce/geo-fence/:branchId`

### B) Timeclock Enforcement + Override
- **Enforcement Logic**:
  - Haversine distance calculation (deterministic)
  - Reason codes: OUTSIDE_GEOFENCE, ACCURACY_TOO_LOW, MISSING_LOCATION
  - Reject with 403 + machine-readable code
- **Override Path**:
  - L4+ roles can override with reason (8-256 chars)
  - TimeEntry fields: clockInOverride, clockInOverrideReason, clockInOverrideById
  - Audit actions: GEOFENCE_OVERRIDE_CLOCKIN, GEOFENCE_OVERRIDE_CLOCKOUT, GEOFENCE_ENFORCEMENT_BLOCKED

### C) Reporting + Exports
- **KPIs**: blocked attempts, overrides count, accuracy failures
- **Endpoints**: `/workforce/reports/geofence-kpis`, `/workforce/reports/export/geofence-events`
- **Export Standards**: UTF-8 BOM, stable ordering, SHA256 hash header

### D) Web UI
- Admin page: `/workforce/geo-fence` for configuration
- Timeclock page: geo status banner + override UI for managers

## Kimai Parity Analysis (Study-Only)
| Feature | Kimai Pattern | Nimbus Implementation |
|---------|--------------|----------------------|
| Geo Location | Optional GPS tracking on entries | Integrated with enforcement |
| Distance Check | Client-side display | Server-side Haversine with reject |
| Override | Not implemented | Manager override with audit trail |
| Export | Time entry export | Dedicated geofence events export |

## Hypotheses

### H1: Distance Calc Rounding Error
- **Confidence**: 70%
- **Failure Mode**: Edge cases at exact radius boundary misclassified
- **Mitigation**: Use consistent rounding, test boundary cases

### H2: Accuracy Gating Blocks Legitimate Users
- **Confidence**: 60%
- **Failure Mode**: null accuracy treated as infinite, blocking users
- **Mitigation**: Treat null accuracy as "unknown", configurable behavior

### H3: RBAC Override Bug
- **Confidence**: 40%
- **Failure Mode**: L1-L3 bypass override check
- **Mitigation**: Server-side role validation before override

### H4: Export Hash Mismatch
- **Confidence**: 50%
- **Failure Mode**: BOM/line ending differences on Windows
- **Mitigation**: Normalize to LF before hashing, exclude BOM

### H5: Branch Scoping Leak
- **Confidence**: 30%
- **Failure Mode**: Read/update another org's geofence
- **Mitigation**: orgId filter on all queries

### H6: Tests Hang
- **Confidence**: 80%
- **Failure Mode**: Open handles from timers/servers
- **Mitigation**: No setInterval, proper app cleanup

### H7: maxAccuracyMeters Too Strict
- **Confidence**: 55%
- **Failure Mode**: Default 100m rejects indoor GPS (often 200m+)
- **Mitigation**: Default to 200m, configurable per branch

## Files to Modify/Create
- `packages/db/prisma/schema.prisma` - BranchGeoFence model, TimeEntry override fields
- `services/api/src/workforce/geofence.service.ts` - NEW
- `services/api/src/workforce/geofence-reporting.service.ts` - NEW
- `services/api/src/workforce/geofence.controller.ts` - NEW
- `services/api/src/workforce/workforce-timeclock.service.ts` - Enforcement integration
- `services/api/src/workforce/workforce.module.ts` - Registration
- `apps/web/src/pages/workforce/geo-fence.tsx` - NEW
- `services/api/test/e2e/workforce-m1020-geofence.e2e-spec.ts` - NEW
