# M12.10 Hypotheses - Release Gate GREEN

## Overview

Hypotheses to validate before fixing PRE-014, PRE-015, PRE-016 to make release gate fully green.

---

## H1: Auth Identity Mismatch (req.user.sub vs req.user.userId)

**Category**: Authentication/Identity  
**Risk**: HIGH  
**Confidence**: 85%

**Description**: JWT payload may use `sub` for user ID while controllers expect `userId`. This causes false 401/500 errors when the identity field is undefined.

**Failure Mode**: 401 Unauthorized or 500 Internal Server Error on authenticated endpoints.

**Test Strategy**:
1. Check JWT payload structure in auth service
2. Verify controllers use consistent field names
3. Look for `req.user.sub` vs `req.user.userId` mismatches

---

## H2: Route Ordering Makes :id Shadow Static Routes

**Category**: Routing  
**Risk**: HIGH  
**Confidence**: 80%

**Description**: If a parameterized route like `/:id` is registered before static routes like `/generate` or `/dashboard`, the :id pattern will capture the static path as an ID, causing 404s.

**Failure Mode**: 404 Not Found on static routes that should work.

**Test Strategy**:
1. Review controller route declarations
2. Ensure static routes are defined before parameterized routes
3. Look for routes returning 404 when they should return 200

---

## H3: Seed Drift Breaks branchSlug/Policy Assumptions

**Category**: Test Data  
**Risk**: HIGH  
**Confidence**: 75%

**Description**: Test seed data may assume specific branchSlug values, policy configurations, or entity IDs that no longer exist or have different structures.

**Failure Mode**: 403 Forbidden or 404 Not Found due to missing/mismatched entities.

**Test Strategy**:
1. Check test factory for branchSlug generation
2. Verify policy creation in beforeAll hooks
3. Ensure test isolation (unique slugs per test run)

---

## H4: New Enforcement Invalidates Old Test Setup

**Category**: Business Logic  
**Risk**: HIGH  
**Confidence**: 90%

**Description**: Recent changes to approval gating, forceClose reason length (>=20 chars), period locks, or other enforcement rules may cause tests written for older behavior to fail.

**Failure Mode**: 403 Forbidden when tests expect 200, or validation errors (400) on previously valid payloads.

**Test Strategy**:
1. Check for forceClose tests with reason < 20 chars
2. Verify approval workflow tests create proper close requests
3. Look for period lock assumptions

---

## H5: Timezone Boundary Errors

**Category**: Date/Time  
**Risk**: MEDIUM  
**Confidence**: 70%

**Description**: Period generation and date comparisons may fail at timezone boundaries when tests use local dates but the API expects UTC.

**Failure Mode**: Period not found, unexpected period status, or date range failures.

**Test Strategy**:
1. Check date construction (new Date() vs Date.UTC())
2. Verify period queries use consistent timezone handling
3. Look for month boundary issues

---

## H6: Test Bootstrap Leaks Open Handles

**Category**: Test Infrastructure  
**Risk**: MEDIUM  
**Confidence**: 65%

**Description**: NestJS app, Prisma connections, or rate limiting guards may leave open handles that cause tests to hang or require --forceExit.

**Failure Mode**: Jest hangs, "open handles" warning, or timeout.

**Test Strategy**:
1. Run with --detectOpenHandles
2. Check afterAll cleanup in test suites
3. Verify RateLimitGuard cleanup (PRE-011)

---

## H7: RBAC roleLevel vs role String Mismatch

**Category**: Authorization  
**Risk**: HIGH  
**Confidence**: 90%

**Description**: Controllers may use `req.user.role` (undefined) instead of `req.user.roleLevel` (L1-L5), causing RBAC checks to fail or default to lowest privilege.

**Failure Mode**: 403 Forbidden on actions that should be allowed for the user's role level.

**Test Strategy**:
1. Check controller methods that access role information
2. Verify roleLevel is used consistently
3. Look for pattern similar to PRE-017

---

## H8: Idempotency Behavior Causes 409/200 Differences

**Category**: Business Logic  
**Risk**: MEDIUM  
**Confidence**: 60%

**Description**: Tests may expect idempotent operations to return 200, but implementation returns 409 (Conflict) for already-existing resources.

**Failure Mode**: Test expects 200 but receives 409, or vice versa.

**Test Strategy**:
1. Check for duplicate creation attempts in tests
2. Verify idempotency key handling
3. Look for close request or period generation duplicates

---

## H9: Missing API Endpoints (Route Not Implemented)

**Category**: API Coverage  
**Risk**: HIGH  
**Confidence**: 95%

**Description**: Tests may be written for endpoints that were planned but never implemented, causing 404 errors.

**Failure Mode**: 404 Not Found on routes that should exist.

**Test Strategy**:
1. Check if tested routes exist in controllers
2. Look for workforce leave admin routes
3. Verify reservation reporting routes

---

## H10: Rate Limiting Interference in Tests

**Category**: Test Infrastructure  
**Risk**: MEDIUM  
**Confidence**: 80%

**Description**: Rate limiting guards may trigger during test runs, causing 429 Too Many Requests instead of expected responses.

**Failure Mode**: 429 status code when test expects 200/404.

**Test Strategy**:
1. Check if rate limiting is disabled in test environment
2. Look for burst request patterns in tests
3. Verify rate limit reset between tests

---

## Outcomes Table

| # | Hypothesis | Result | Evidence |
|---|------------|--------|----------|
| H1 | Auth identity mismatch | TBD | |
| H2 | Route ordering | TBD | |
| H3 | Seed drift | TBD | |
| H4 | New enforcement | TBD | |
| H5 | Timezone boundary | TBD | |
| H6 | Open handles leak | TBD | |
| H7 | roleLevel mismatch | TBD | |
| H8 | Idempotency 409/200 | TBD | |
| H9 | Missing endpoints | TBD | |
| H10 | Rate limiting | TBD | |
