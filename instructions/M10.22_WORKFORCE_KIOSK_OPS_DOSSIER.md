# M10.22 Workforce Kiosk Ops Hardening Dossier

**Feature:** Offline Queue + Device Health + Fraud/Audit Closure  
**Status:** Implementation Planning  
**Prerequisite:** M10.21 Kiosk Timeclock (complete at 1bb4c4c)

---

## Executive Summary

M10.22 hardens the M10.21 kiosk infrastructure for production-grade operations:
- **Offline-safe event queue** with deterministic idempotent replay
- **Device health monitoring** with heartbeat-based computed statuses (no timers)
- **Fraud controls closure** with attempt analytics and anomaly flags
- **Operational reporting** for health metrics and audit exports

---

## Feature Groups

### A) Offline Queue + Replay (Device-local, API-backed)

| Capability | Description | Pattern Source |
|------------|-------------|----------------|
| **KioskEvent model** | Records each event with idempotencyKey, status (ACCEPTED/REJECTED) | Industry standard |
| **KioskEventIngest model** | Batch tracking with diagnostics | OWASP Input Validation |
| **Batch endpoint** | `POST /public/workforce/kiosk/:publicId/events/batch` | Kimai bulk API |
| **Idempotency enforcement** | UNIQUE per (kioskDeviceId, idempotencyKey) | Stripe/AWS patterns |
| **Deterministic response** | Same idempotencyKey → same result, no duplicate entries | Idempotency standard |
| **Web offline queue** | Browser localStorage queue with manual sync | PWA patterns |

**Critical Behaviors:**
- Events include: idempotencyKey, type, occurredAt, pin, geo (optional)
- Server validates: device secret, device enabled, org-scoped PIN, geofence, pay period
- Returns per-event: `{ idempotencyKey, status, code?, timeEntryId? }`
- Re-sending same batch returns same results without duplicating time entries

### B) Device Health + Session Hardening

| Capability | Description | Pattern Source |
|------------|-------------|----------------|
| **Session tracking** | endedReason enum (ROTATED_SECRET, DISABLED, HEARTBEAT_EXPIRED, MANUAL_END) | Session management |
| **Heartbeat endpoint** | Updates lastSeenAt + lastHeartbeatAt | No-timer pattern |
| **Health status computation** | ONLINE/STALE/OFFLINE via query (NOW - lastHeartbeatAt) | DB-computed expiry |
| **Policy thresholds** | kioskHeartbeatStaleSeconds, kioskHeartbeatOfflineSeconds | Configurable |
| **Health reporting** | `GET /workforce/kiosk/devices/health` | Ops visibility |

**Status Computation (no timers):**
- ONLINE: heartbeat within `kioskHeartbeatStaleSeconds` (default 120s)
- STALE: between stale and offline threshold
- OFFLINE: beyond `kioskHeartbeatOfflineSeconds` (default 900s)
- DISABLED: device.enabled = false

### C) Fraud Controls + Audit Closure

| Capability | Description | Pattern Source |
|------------|-------------|----------------|
| **PIN attempt tracking** | KioskPinAttempt with outcome (SUCCESS/INVALID_PIN) | OWASP Auth |
| **Sliding window rate limit** | DB-based count query, no timers | H3 from M10.21 |
| **Extended blocking** | Block after N invalid attempts (e.g., 10/min) | Fraud prevention |
| **Anomaly signals** | High invalid rate, high overrides, outside hours | Analytics |
| **Audit completeness** | All actions logged with kioskDeviceId, branchId, reason codes | OWASP Logging |

**Audit Actions (extend M10.21):**
- KIOSK_EVENT_BATCH_RECEIVED
- KIOSK_EVENT_ACCEPTED
- KIOSK_EVENT_REJECTED
- KIOSK_HEARTBEAT
- KIOSK_SESSION_STARTED / KIOSK_SESSION_ENDED
- KIOSK_OFFLINE_QUEUE_USED

### D) Reporting Extensions

| Endpoint | Description | Auth |
|----------|-------------|------|
| `GET /workforce/reports/kiosk-health` | online/stale/offline counts over time | L4+ |
| `GET /workforce/reports/kiosk-fraud` | invalid_pin_attempts, blocked_attempts, overrides | L4+ |
| `GET /workforce/reports/export/kiosk-events` | CSV with BOM + hash | L4+ |
| `GET /workforce/reports/export/kiosk-attempts` | CSV with BOM + hash | L4+ |

---

## Parity Matrix

### A) Offline Queue + Replay

| Behavior | Kimai (study-only) | M10.22 Target | Implementation |
|----------|-------------------|---------------|----------------|
| Batch event API | ❌ No native | ✅ Full | POST /events/batch |
| Idempotency keys | ❌ No | ✅ UNIQUE constraint | KioskEvent.idempotencyKey |
| Deterministic replay | ❌ No | ✅ Same result on re-send | DB check before action |
| Client offline queue | ❌ Server-only | ✅ localStorage | React state + persistence |
| Sync trigger | N/A | ✅ Manual button | No timers |

### B) Device Health

| Behavior | Kimai (study-only) | M10.22 Target | Implementation |
|----------|-------------------|---------------|----------------|
| Session heartbeat | ❌ No kiosk mode | ✅ Heartbeat endpoint | POST /heartbeat |
| Computed status | N/A | ✅ ONLINE/STALE/OFFLINE | Query-based |
| Policy thresholds | N/A | ✅ Configurable | WorkforcePolicy fields |
| Health dashboard | ❌ No | ✅ Admin endpoint | GET /devices/health |

### C) Fraud Controls

| Behavior | Kimai (study-only) | M10.22 Target | Implementation |
|----------|-------------------|---------------|----------------|
| PIN attempt logging | ✅ (password only) | ✅ KioskPinAttempt | Never store raw PIN |
| Rate limiting | ⚠️ Basic | ✅ DB sliding window | No timers |
| Anomaly detection | ❌ No | ✅ Query-based signals | Analytics endpoints |
| Audit trail | ✅ Partial | ✅ Complete with codes | WorkforceAuditService |

### D) Reporting

| Behavior | Kimai (study-only) | M10.22 Target | Implementation |
|----------|-------------------|---------------|----------------|
| Health metrics | ❌ No | ✅ Time-windowed | Aggregation queries |
| Fraud metrics | ❌ No | ✅ Counts + rates | Analytics endpoint |
| CSV export | ✅ Basic | ✅ BOM + hash | X-Nimbus-Export-Hash |

---

## Prisma Schema Changes (M10.22)

### New Models

```prisma
// M10.22: Kiosk Event (for batch ingest + idempotency)
model KioskEvent {
  id              String   @id @default(cuid())
  orgId           String
  branchId        String
  kioskDeviceId   String
  type            String   // CLOCK_IN, CLOCK_OUT, BREAK_START, BREAK_END
  occurredAt      DateTime // Client event time
  receivedAt      DateTime @default(now()) // Server receive time
  idempotencyKey  String   // Client-generated unique key
  payloadJson     Json?    // Sanitized payload (no secrets)
  status          String   // ACCEPTED, REJECTED
  rejectCode      String?  // INVALID_PIN, OUTSIDE_GEOFENCE, DEVICE_DISABLED, etc.
  timeEntryId     String?  // Linked time entry if created
  breakEntryId    String?  // Linked break entry if created
  userId          String?  // Resolved user from PIN

  org         Org         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  branch      Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  kioskDevice KioskDevice @relation(fields: [kioskDeviceId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([kioskDeviceId, idempotencyKey])
  @@index([orgId, branchId, receivedAt])
  @@index([kioskDeviceId, receivedAt])
  @@map("kiosk_events")
}

// M10.22: Kiosk Event Ingest Batch
model KioskEventIngest {
  id              String   @id @default(cuid())
  kioskDeviceId   String
  batchId         String   // Client-provided batch ID
  eventCount      Int
  acceptedCount   Int      @default(0)
  rejectedCount   Int      @default(0)
  status          String   // RECEIVED, PROCESSED
  diagnostics     String?  // Truncated diagnostic info
  createdAt       DateTime @default(now())

  kioskDevice KioskDevice @relation(fields: [kioskDeviceId], references: [id], onDelete: Cascade)

  @@unique([kioskDeviceId, batchId])
  @@index([kioskDeviceId, createdAt])
  @@map("kiosk_event_ingests")
}
```

### WorkforcePolicy Extensions

```prisma
// Add to WorkforcePolicy model
kioskHeartbeatStaleSeconds    Int @default(120)  // 2 minutes
kioskHeartbeatOfflineSeconds  Int @default(900)  // 15 minutes
```

### KioskPinAttempt Extensions

```prisma
// Extend existing KioskPinAttempt
pinHashPrefix  String?  // First 4 chars of hash (for analytics, never raw PIN)
outcome        String   // SUCCESS, INVALID_PIN (more explicit than boolean)
```

---

## API Endpoints

### Public (Device-authenticated)

| Method | Path | Description |
|--------|------|-------------|
| POST | `/public/workforce/kiosk/:publicId/events/batch` | Batch ingest events |
| POST | `/public/workforce/kiosk/:publicId/heartbeat` | Update device/session heartbeat |

### Admin (RBAC L4+)

| Method | Path | Description |
|--------|------|-------------|
| GET | `/workforce/kiosk/devices/health` | Device health status list |
| GET | `/workforce/reports/kiosk-health` | Health metrics over time |
| GET | `/workforce/reports/kiosk-fraud` | Fraud metrics |
| GET | `/workforce/reports/export/kiosk-events` | CSV export of events |
| GET | `/workforce/reports/export/kiosk-attempts` | CSV export of PIN attempts |

---

## Security Considerations

1. **Never store raw PIN** - Only masked suffix or hash prefix
2. **Idempotency keys** - Prevent duplicate time entries
3. **DB-based rate limiting** - No timers/intervals to avoid Jest hangs
4. **Org-scoped queries** - All queries include orgId filter
5. **Branch binding** - Always from enrolled device, never from client
6. **Export hash** - SHA-256 for tamper detection

---

## Test Coverage Requirements

### E2E Tests (workforce-m1022-kiosk-ops.e2e-spec.ts)

1. Batch ingest idempotency: same key → same result
2. Batch ordering: reject illegal sequence
3. Heartbeat creates/updates session
4. Health endpoint returns computed status
5. Fraud attempts logged and block after threshold
6. Export CSV has BOM and hash

### UI Tests

1. Offline queue increments when API fails
2. Sync clears queue on success
3. No timers/intervals in tests
