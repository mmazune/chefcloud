# M10.8 Payroll GL Posting Dossier

**Feature:** Payroll GL Posting (Full) + Configurable Mappings  
**Date:** 2026-01-04  
**Baseline:** M10.7 (commit a302b98)

---

## 1. Executive Summary

M10.8 replaces the M10.7 stub GL posting service with a full implementation that:
- Posts complete gross-to-net journal entries on APPROVED → POSTED transition
- Posts NET payment journal on POSTED → PAID transition
- Reverses all linked journals on ANY → VOID transition
- Provides configurable GL account mappings per org (optionally per branch)
- Exposes preview endpoint for pre-posting validation
- Maintains full idempotency and audit trail

---

## 2. Feature Groups

### A) Full Payroll GL Posting Engine

**Current State (M10.6/M10.7):**
- payroll-posting.service.ts: Posts simple Dr Labor Expense / Cr Wages Payable
- payroll-gl-stub.service.ts: Stubs for employer contributions and tax withholding
- Only posts gross amount, ignores net breakdown

**Target State (M10.8):**
On APPROVED → POSTED:
1. Dr Labor Expense (6000) = gross earnings
2. Cr Wages Payable (2105) = net pay
3. Cr Taxes Payable (2110) = taxesWithheld
4. Cr Deductions Payable (2115) = preTax + postTax deductions
5. Dr Employer Contrib Expense (6050) = employerContribTotal
6. Cr Employer Contrib Payable (2120) = employerContribTotal

On POSTED → PAID:
- Dr Wages Payable (2105) / Cr Cash (1000) = net pay only
- Taxes and deductions remain as liabilities for remittance

On ANY → VOID:
- Reverse all linked journals (mark REVERSED, create reversal entries)
- Maintain PayrollRunJournalLink audit trail

### B) Payroll Posting Mapping (Configurable)

**Model: PayrollPostingMapping**
- orgId (required)
- branchId (optional for branch overrides)
- laborExpenseAccountId
- wagesPayableAccountId  
- taxesPayableAccountId
- deductionsPayableAccountId
- employerContribExpenseAccountId
- employerContribPayableAccountId
- cashAccountId
- enabled (Boolean)

**Endpoints:**
- GET /workforce/payroll/posting-mapping - Retrieve mapping
- PUT /workforce/payroll/posting-mapping - Upsert mapping
- GET /workforce/payroll/posting-mapping/preview?runId=... - Preview journal lines

### C) UI (Ops Grade)

**Pages:**
- /workforce/payroll-posting - View/edit GL account mappings
- Enhanced /workforce/payroll-runs/[id] with:
  - Posting preview (lines + totals)
  - Linked journal entry IDs
  - Status badges

**RBAC:**
- L4+ can view/edit mappings and preview
- L5 only can perform POST/PAY/VOID transitions

### D) Tests

**E2E Coverage:**
1. Mapping upsert + retrieval
2. Preview endpoint determinism
3. Post idempotency
4. Posted journal totals match gross-to-net
5. Pay posts NET only
6. Void reverses journals
7. Branch-level posting behavior

---

## 3. Reference Patterns

### Accounting Double-Entry for Payroll
Standard payroll journal pattern:
```
ACCRUAL (on post):
  Dr Labor Expense     $GROSS
  Cr Wages Payable     $NET
  Cr Taxes Payable     $TAXES
  Cr Deductions Payable $DEDUCTIONS

EMPLOYER CONTRIB (on post):
  Dr Employer Tax Exp  $EMPLOYER_CONTRIB
  Cr Employer Tax Payable $EMPLOYER_CONTRIB

PAYMENT (on pay):
  Dr Wages Payable     $NET
  Cr Cash              $NET

REVERSAL (on void):
  Reverse all above entries
```

### Nimbus Accounting Patterns (M8.2b)
- JournalEntry with status: DRAFT/POSTED/REVERSED
- Reversal creates new entry linked to original
- FiscalPeriod lock checks before posting
- source='PAYROLL', sourceId=payrollRunId for traceability

---

## 4. Key Invariants

1. **Balance Invariant:** All journal entries must balance (debits = credits)
2. **Net Pay Invariant:** netPay = gross - preTax - taxes - postTax
3. **Accrual Total:** Dr total = gross + employerContrib
4. **Liability Total:** Cr total = net + taxes + deductions + employerContrib
5. **Idempotency:** Same transition on same run produces no duplicate journals
6. **Reversal Completeness:** VOID reverses all linked journals

---

## 5. Files to Modify/Create

### Create
- packages/db/prisma/migrations/20260104170000_m108_payroll_posting_mapping/migration.sql
- services/api/src/workforce/payroll-mapping.service.ts
- services/api/src/workforce/payroll-mapping.controller.ts
- apps/web/src/pages/workforce/payroll-posting.tsx
- services/api/test/e2e/workforce-m108-payroll-gl.e2e-spec.ts
- apps/web/src/__tests__/pages/workforce/m108-payroll-posting.test.tsx

### Modify
- packages/db/prisma/schema.prisma (add PayrollPostingMapping)
- services/api/src/workforce/payroll-posting.service.ts (full implementation)
- services/api/src/workforce/workforce.module.ts
- services/api/src/workforce/payroll-runs.controller.ts (preview endpoint)
- apps/web/src/pages/workforce/payroll-runs/[id].tsx (preview + links)

### Delete/Replace
- services/api/src/workforce/payroll-gl-stub.service.ts (merge into posting service)

---

## 6. Account Code Defaults

| Purpose | Default Code | Account Name |
|---------|--------------|--------------|
| Labor Expense | 6000 | Wages & Salaries |
| Wages Payable | 2105 | Wages Payable |
| Taxes Payable | 2110 | Payroll Taxes Payable |
| Deductions Payable | 2115 | Deductions Payable |
| Employer Contrib Expense | 6050 | Employer Payroll Taxes |
| Employer Contrib Payable | 2120 | Employer Contrib Payable |
| Cash | 1000 | Cash |

---

## 7. RBAC Matrix

| Action | L1 | L2 | L3 | L4 | L5 |
|--------|----|----|----|----|-----|
| View mapping | ❌ | ❌ | ❌ | ✅ | ✅ |
| Edit mapping | ❌ | ❌ | ❌ | ✅ | ✅ |
| Preview posting | ❌ | ❌ | ❌ | ✅ | ✅ |
| Post run | ❌ | ❌ | ❌ | ❌ | ✅ |
| Pay run | ❌ | ❌ | ❌ | ❌ | ✅ |
| Void run | ❌ | ❌ | ❌ | ❌ | ✅ |
