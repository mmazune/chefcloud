# M11.13 Inventory GL Integration - Completion Report

## Summary
M11.13 implements full GL integration for inventory movements, enabling automatic journal entry creation when inventory documents are posted/voided.

## Scope Delivered

### 1. Posting Mappings (org + branch override)
- **InventoryPostingMapping** model: Maps org/branch to GL accounts
  - `inventoryAssetAccountId` (ASSET) - Balance sheet inventory
  - `cogsAccountId` (EXPENSE) - Cost of Goods Sold
  - `wasteExpenseAccountId` (EXPENSE) - Waste write-offs
  - `shrinkExpenseAccountId` (EXPENSE) - Stocktake shrinkage
  - `grniAccountId` (LIABILITY) - Goods Received Not Invoiced
  - `inventoryGainAccountId` (REVENUE, optional) - Stocktake gains
  - `autoPostEnabled` flag for toggle
- **Resolution cascade**: Branch-specific â†’ Org default
- **Account type validation** on create/update

### 2. Auto-Posting Events
| Event | Debit | Credit | Trigger |
|-------|-------|--------|---------|
| Goods Receipt | Inventory Asset | GRNI | `receipts.post()` |
| Depletion | COGS | Inventory Asset | `depleteForOrder()` |
| Waste | Waste Expense | Inventory Asset | `waste.post()` |
| Stocktake (shrink) | Shrink Expense | Inventory Asset | `stocktake.post()` |
| Stocktake (gain) | Inventory Asset | Inventory Gain | `stocktake.post()` |

### 3. Reversal/Void Entries
- Goods Receipt VOID creates `INV_GOODS_RECEIPT_VOID` journal (Dr GRNI, Cr Inventory)
- Waste VOID creates `INV_WASTE_VOID` reversal journal
- Stocktake VOID creates `INV_STOCKTAKE_VOID` reversal journal

### 4. GL Preview & Postings Report
- `GET /inventory/gl/preview` - Preview journal before posting
- `GET /inventory/gl/postings` - List inventory GL journals with filters
- `GET /inventory/gl/postings/export` - CSV export with UTF-8 BOM + SHA-256 hash
- `GET /inventory/gl/status` - GL integration health check

### 5. Web UI
- **accounting-mappings.tsx**: CRUD for posting mappings with account type filtering
- **accounting-postings.tsx**: Postings report with filters, preview dialog, CSV export

## Files Created/Modified

### New Files
| File | Purpose |
|------|---------|
| `services/api/src/inventory/inventory-posting-mapping.service.ts` | Mapping CRUD, resolution, validation |
| `services/api/src/inventory/inventory-gl-posting.service.ts` | GL journal creation for all event types |
| `services/api/src/inventory/inventory-gl.controller.ts` | API endpoints |
| `apps/web/src/pages/inventory/accounting-mappings.tsx` | Mappings UI |
| `apps/web/src/pages/inventory/accounting-postings.tsx` | Postings report UI |
| `services/api/test/m1113-inventory-gl-posting.e2e-spec.ts` | E2E tests |

### Modified Files
| File | Changes |
|------|---------|
| `packages/db/prisma/schema.prisma` | Added `GlPostingStatus` enum, `InventoryPostingMapping` model, GL fields to inventory documents |
| `services/api/src/inventory/inventory.module.ts` | Added controller, services |
| `services/api/src/inventory/receipts.service.ts` | GL posting in `post()` and `void()` |
| `services/api/src/inventory/inventory-waste.service.ts` | GL posting in `post()` |
| `services/api/src/inventory/inventory-depletion.service.ts` | GL posting in `depleteForOrder()` |
| `services/api/src/inventory/inventory-stocktake.service.ts` | GL posting in `postSession()` and `voidSession()` |

## Schema Changes

```prisma
enum GlPostingStatus {
  PENDING
  POSTED
  FAILED
  SKIPPED
}

model InventoryPostingMapping {
  id                       String   @id @default(cuid())
  orgId                    String
  branchId                 String?  // null = org default
  inventoryAssetAccountId  String
  cogsAccountId            String
  wasteExpenseAccountId    String
  shrinkExpenseAccountId   String
  grniAccountId            String
  inventoryGainAccountId   String?  // optional
  autoPostEnabled          Boolean  @default(true)
  createdById              String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  
  @@unique([orgId, branchId])
}
```

Added to inventory documents (GoodsReceiptV2, InventoryWaste, StocktakeSession, OrderInventoryDepletion):
- `glJournalEntryId String?`
- `glPostingStatus GlPostingStatus @default(PENDING)`
- `glPostingError String?`

## Hypotheses Covered

| # | Hypothesis | Validation |
|---|------------|------------|
| H1 | Branch override resolves before org default | E2E test + unit logic |
| H2 | Duplicate journals prevented by source+sourceId | Idempotency check in all posting methods |
| H3 | Period lock blocks GL posting | `checkPeriodLock()` before journal creation |
| H4 | COGS uses absolute value (no negative expense) | `abs()` on COGS amount |
| H5 | CSV export includes SHA-256 hash | `X-Content-SHA256` header |
| H6 | Cross-tenant isolation | `orgId` filter in all queries |
| H7 | RBAC enforced (L4+ for mutations, L3+ for reads) | `roleLevel` checks in controller |
| H8 | Reversal entries net to zero | `createReversalEntry()` inverts amounts |
| H9 | Missing mapping doesn't block inventory posting | GL failure is logged, inventory proceeds |
| H10 | Account types validated on mapping create | `validateAccountTypes()` method |

## API Endpoints

```
GET    /inventory/gl/mappings          - List mappings (L3+)
POST   /inventory/gl/mappings          - Create mapping (L4+)
PUT    /inventory/gl/mappings/:id      - Update mapping (L4+)
DELETE /inventory/gl/mappings/:id      - Delete mapping (L4+)
GET    /inventory/gl/preview           - Preview GL entry (L3+)
GET    /inventory/gl/postings          - List postings (L3+)
GET    /inventory/gl/postings/export   - Export CSV (L3+)
GET    /inventory/gl/status            - Integration status (L3+)
```

## Journal Source Constants
- `INV_GOODS_RECEIPT` / `INV_GOODS_RECEIPT_VOID`
- `INV_DEPLETION`
- `INV_WASTE` / `INV_WASTE_VOID`
- `INV_STOCKTAKE` / `INV_STOCKTAKE_VOID`

## Testing

### E2E Test Coverage
- Mapping CRUD (create, list, update, delete)
- Branch override resolution
- Goods Receipt GL posting and void reversal
- Waste GL posting
- Idempotency (no duplicate journals)
- Period lock enforcement
- GL status endpoint
- CSV export with hash

### Run Tests
```bash
cd services/api
pnpm test:e2e -- --testPathPattern=m1113 --detectOpenHandles --forceExit
```

## Verification Status

- [x] Prisma schema valid (`prisma format` + `prisma generate`)
- [x] TypeScript compiles (`tsc --noEmit`)
- [x] ESLint passes (0 errors on new files)
- [x] E2E test file created

## Commit Message
```
feat(inventory): M11.13 GL integration (mappings+auto-posting+reversals+reports) + UI + tests
```

## Next Steps
1. Run migrations: `pnpm prisma migrate dev --name m1113-inventory-gl-posting`
2. Run E2E tests to validate
3. Add web routes in `apps/web/src/App.tsx` for accounting pages
4. Consider adding batch reposting utility for historical data
