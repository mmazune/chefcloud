# M12.11 Hypotheses Document

**Created:** 2026-01-08
**Objective:** Make release gate 7/7 PASS (currently 5/7)
**Failing Suites:** PRE-015 (workforce-m1017-leave), PRE-016 (reservations-m94-public-booking)

---

## PRE-015: workforce-m1017-leave (26 failed, 4 passed)

### H1: HTTP Method Mismatches (PATCH vs PUT/POST)

**Evidence:**
- Controller uses `@Put('types/:id')` but tests call `.patch('/workforce/leave/types/:id')`
- Controller uses `@Put('policies/:id')` but tests call `.patch('/workforce/leave/policies/:id')`
- Controller uses `@Post('requests/:id/submit')` but tests call `.patch('/workforce/leave/requests/:id/submit')`
- Controller uses `@Post('requests/:id/cancel')` but tests call `.patch('/workforce/leave/requests/:id/cancel')`

**Action:** Change controller to use `@Patch` for update operations (industry-standard for partial updates)

---

### H2: Route Path Mismatches (approvals vs requests)

**Evidence:**
- Test: `GET /workforce/leave/requests/pending` → Controller: `GET /workforce/leave/approvals/pending`
- Test: `PATCH /workforce/leave/requests/:id/approve` → Controller: `POST /workforce/leave/approvals/:id/approve`
- Test: `PATCH /workforce/leave/requests/:id/reject` → Controller: `POST /workforce/leave/approvals/:id/reject`

**Action:** Align controller routes to match test expectations (requests/ prefix)

---

### H3: Missing Endpoints

**Evidence:**
- Test expects: `GET /workforce/leave/requests/user/:id` (view user's requests)
- Test expects: `POST /workforce/leave/balance/adjust` (balance adjustment)
- Test expects: `GET /workforce/leave/balance/history` (ledger history)
- Test expects: `POST /workforce/leave/admin/run-accrual`
- Test expects: `GET /workforce/leave/reports/balance-summary`
- Test expects: `GET /workforce/leave/exports/balance-summary`

**Action:** Add missing route aliases or rename existing routes

---

### H4: 500 Internal Server Error on Leave Type Create

**Evidence:**
Test H2 shows:
```
expected 201 "Created", got 500 "Internal Server Error"
```
When creating leave type with code `'TEMP'`

**Likely Cause:** Missing required field validation or Prisma schema mismatch (e.g., code must be enum value)

**Action:** Check LeaveTypeCode enum values, ensure create() handles field correctly

---

### H5: Service orgId Scoping Issues

**Evidence:**
From M12.10 analysis, `leave-types.service.ts` `findOne()` method fetches by ID then checks orgId post-fetch. This is correct but may have issues in other services.

**Action:** Audit all leave services for proper orgId scoping in queries

---

## PRE-016: reservations-m94-public-booking (8 failed, 13 passed)

### H6: Mock PrismaTestModule vs Real Database

**Evidence:**
- Test imports `PrismaTestModule` (line 25)
- Test overrides `PrismaService` with `TestPrismaService` (line 45-46)
- Uses fake tokens: `const AUTH_L4 = { Authorization: 'Bearer TEST_TOKEN_L4' }`
- Uses fake branch: `const BRANCH_SLUG = 'test-branch-public-m94'`

**Symptoms:**
- 500 errors from endpoints hitting real DB without seeded data
- 429 rate limit errors from ThrottlerTestModule misconfiguration
- 400 errors where test expects 401/403

**Action:** Rewrite test to use:
1. `createE2EApp({ imports: [AppModule] })` (full stack)
2. `loginAs()` for real auth tokens
3. Real seeded branch from demo data
4. Real database with factory-created test data

---

### H7: Rate Limiter Test Module Issues

**Evidence:**
Test imports `ThrottlerTestModule` but still gets 429 responses:
```
expect(res.status).toBe(404);
Received: 429
```

**Action:** Ensure ThrottlerTestModule properly disables rate limiting or test accommodates it

---

## Verification Plan

1. Fix PRE-015 by aligning HTTP methods and routes
2. Rewrite PRE-016 using standard E2E harness pattern
3. Run `node scripts/release-gate-runner.mjs`
4. Confirm 7/7 PASS

---

## Summary Table

| Hypothesis | Suite   | Root Cause                    | Confidence |
|------------|---------|-------------------------------|------------|
| H1         | PRE-015 | PATCH vs PUT/POST mismatch    | HIGH       |
| H2         | PRE-015 | Route path mismatch           | HIGH       |
| H3         | PRE-015 | Missing endpoints             | HIGH       |
| H4         | PRE-015 | 500 on create (code enum?)    | MEDIUM     |
| H5         | PRE-015 | Service orgId scoping         | LOW        |
| H6         | PRE-016 | Mock DB vs real DB            | HIGH       |
| H7         | PRE-016 | Rate limiter misconfiguration | MEDIUM     |
